<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TRUST: src/ThHyd/Schemas_Temps/Piso.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TRUST&#160;<span id="projectnumber">1.8.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">src/ThHyd/Schemas_Temps/Piso.cpp</div>  </div>
</div>
<div class="contents">
<a href="Piso_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/****************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">* Copyright (c) 2021, CEA</span>
<a name="l00003"></a>00003 <span class="comment">* All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment">*</span>
<a name="l00005"></a>00005 <span class="comment">* Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<a name="l00006"></a>00006 <span class="comment">* 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
<a name="l00007"></a>00007 <span class="comment">* 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<a name="l00008"></a>00008 <span class="comment">* 3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
<a name="l00009"></a>00009 <span class="comment">*</span>
<a name="l00010"></a>00010 <span class="comment">* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<a name="l00011"></a>00011 <span class="comment">* IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;</span>
<a name="l00012"></a>00012 <span class="comment">* OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00013"></a>00013 <span class="comment">*</span>
<a name="l00014"></a>00014 <span class="comment">*****************************************************************************/</span>
<a name="l00015"></a>00015 <span class="comment">//</span>
<a name="l00016"></a>00016 <span class="comment">// </span>
<a name="l00017"></a>00017 <span class="comment">// File:        Piso.cpp</span>
<a name="l00018"></a>00018 <span class="comment">// Directory:   $TRUST_ROOT/src/ThHyd/Schemas_Temps</span>
<a name="l00019"></a>00019 <span class="comment">// Version:     /main/29</span>
<a name="l00020"></a>00020 <span class="comment">// </span>
<a name="l00021"></a>00021 <span class="comment">//</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="code" href="Piso_8h.html">Piso.h</a>&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="code" href="Source__PDF__base_8h.html">Source_PDF_base.h</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="Zone__VF_8h.html">Zone_VF.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="EChaine_8h.html">EChaine.h</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;<a class="code" href="Debog_8h.html">Debog.h</a>&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;<a class="code" href="Matrice__Bloc_8h.html">Matrice_Bloc.h</a>&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="code" href="Assembleur__base_8h.html">Assembleur_base.h</a>&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="code" href="Statistiques_8h.html">Statistiques.h</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="Schema__Temps__base_8h.html">Schema_Temps_base.h</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="DoubleTrav_8h.html">DoubleTrav.h</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="Fluide__Dilatable__base_8h.html">Fluide_Dilatable_base.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="Dirichlet_8h.html">Dirichlet.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="Probleme__base_8h.html">Probleme_base.h</a>&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="MD__Vector__std_8h.html">MD_Vector_std.h</a>&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="MD__Vector__composite_8h.html">MD_Vector_composite.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="MD__Vector__tools_8h.html">MD_Vector_tools.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="ConstDoubleTab__parts_8h.html">ConstDoubleTab_parts.h</a>&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="Discretisation__base_8h.html">Discretisation_base.h</a>&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="Piso_8cpp.html#a6bf582bdfde96734f4a98c2821c74ada">00043</a> <a class="code" href="Declare__Inst_8h.html#afcab3f7633508e92f2077d767e19bc60">Implemente_instanciable_sans_constructeur</a>(<a class="code" href="classPiso.html">Piso</a>,<span class="stringliteral">&quot;Piso&quot;</span>,<a class="code" href="classSimpler.html">Simpler</a>);
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="Piso_8cpp.html#a9a8babe22460629e612a866cbc78e8a2">00045</a> <a class="code" href="Declare__Inst_8h.html#afcab3f7633508e92f2077d767e19bc60">Implemente_instanciable_sans_constructeur</a>(<a class="code" href="classImplicite.html">Implicite</a>,<span class="stringliteral">&quot;Implicite&quot;</span>,<a class="code" href="classPiso.html">Piso</a>);
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="classPiso.html#a15a7fa04a9297422ca33322e71606be6">00047</a> <a class="code" href="classPiso.html#a15a7fa04a9297422ca33322e71606be6">Piso::Piso</a>()
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049   <a class="code" href="classPiso.html#a3917d9ddbcb9569b38e0991191938397">nb_corrections_max_</a> = 21;
<a name="l00050"></a>00050   <a class="code" href="classPiso.html#a1b2607a1196d4af9d9594815bd64ba1c" title="on ne fait pas vraiment du piso mais plutot du CN">avancement_crank_</a> = 0;
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00053"></a><a class="code" href="classImplicite.html#a0e8f1135cea1adfb539e3a416dab3a7c">00053</a> <a class="code" href="classImplicite.html#a0e8f1135cea1adfb539e3a416dab3a7c">Implicite::Implicite</a>()
<a name="l00054"></a>00054 {
<a name="l00055"></a>00055   <a class="code" href="classPiso.html#a1b2607a1196d4af9d9594815bd64ba1c" title="on ne fait pas vraiment du piso mais plutot du CN">avancement_crank_</a> = 1;
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="classPiso.html#a691585354fe7b412fb7bef1047e24f42">00058</a> <a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; <a class="code" href="classPiso.html#a691585354fe7b412fb7bef1047e24f42" title="Ecriture de l&#39;objet sur un flot de sortie Methode a surcharger.">Piso::printOn</a>(<a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; os )<span class="keyword"> const</span>
<a name="l00059"></a>00059 <span class="keyword"></span>{
<a name="l00060"></a>00060   <span class="keywordflow">return</span> <a class="code" href="classPiso.html#a691585354fe7b412fb7bef1047e24f42" title="Ecriture de l&#39;objet sur un flot de sortie Methode a surcharger.">Simpler::printOn</a>(os);
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="classPiso.html#ac766ff05fe8e0ebb527ddb2b268acc71">00063</a> <a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; <a class="code" href="classPiso.html#ac766ff05fe8e0ebb527ddb2b268acc71" title="Lecture d&#39;un Objet_U sur un flot d&#39;entree Methode a surcharger.">Piso::readOn</a>(<a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; is )
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065   <a class="code" href="classPiso.html#ac766ff05fe8e0ebb527ddb2b268acc71" title="Lecture d&#39;un Objet_U sur un flot d&#39;entree Methode a surcharger.">Simpler::readOn</a>(is);
<a name="l00066"></a>00066   <span class="keywordflow">return</span> is;
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="classImplicite.html#ad3004f99bfd030de6680e68d8a8d315f">00069</a> <a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; <a class="code" href="classImplicite.html#ad3004f99bfd030de6680e68d8a8d315f" title="Ecriture de l&#39;objet sur un flot de sortie Methode a surcharger.">Implicite::printOn</a>(<a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; os )<span class="keyword"> const</span>
<a name="l00070"></a>00070 <span class="keyword"></span>{
<a name="l00071"></a>00071   <span class="keywordflow">return</span> <a class="code" href="classImplicite.html#ad3004f99bfd030de6680e68d8a8d315f" title="Ecriture de l&#39;objet sur un flot de sortie Methode a surcharger.">Piso::printOn</a>(os);
<a name="l00072"></a>00072 }
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="classImplicite.html#a588de90d1c6043f90c258e888dd212ff">00074</a> <a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; <a class="code" href="classImplicite.html#a588de90d1c6043f90c258e888dd212ff" title="Lecture d&#39;un Objet_U sur un flot d&#39;entree Methode a surcharger.">Implicite::readOn</a>(<a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; is )
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076   <a class="code" href="classImplicite.html#a588de90d1c6043f90c258e888dd212ff" title="Lecture d&#39;un Objet_U sur un flot d&#39;entree Methode a surcharger.">Piso::readOn</a>(is);
<a name="l00077"></a>00077   <span class="keywordflow">return</span> is;
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="classPiso.html#a56b0f47ff76ed5a76c028920686bfc57">00081</a> <a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; <a class="code" href="classPiso.html#a56b0f47ff76ed5a76c028920686bfc57">Piso::lire</a>(<span class="keyword">const</span> <a class="code" href="classMotcle.html" title="Une chaine de caractere (Nom) en majuscules.">Motcle</a>&amp; motlu,<a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; is)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083   <a class="code" href="classMotcles.html" title="Un tableau d&#39;objets de la classe Motcle.">Motcles</a> les_mots(1);
<a name="l00084"></a>00084   {
<a name="l00085"></a>00085     les_mots[0] = <span class="stringliteral">&quot;nb_corrections_max&quot;</span>;
<a name="l00086"></a>00086   }
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   <span class="keywordtype">int</span> rang = les_mots.<a class="code" href="classMotcles.html#afecd68f73e904bc129022a236ff6ab15">search</a>(motlu);
<a name="l00089"></a>00089   <span class="keywordflow">switch</span>(rang)
<a name="l00090"></a>00090     {
<a name="l00091"></a>00091     <span class="keywordflow">case</span> 0:
<a name="l00092"></a>00092       {
<a name="l00093"></a>00093         is &gt;&gt; <a class="code" href="classPiso.html#a3917d9ddbcb9569b38e0991191938397">nb_corrections_max_</a>;
<a name="l00094"></a>00094         <span class="keywordflow">if</span> (nb_corrections_max_ &lt; 2)
<a name="l00095"></a>00095           {
<a name="l00096"></a>00096             <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a>&lt;&lt;<span class="stringliteral">&quot;There must be at least two corrections steps for the PISO algorithm.&quot;</span>&lt;&lt;<a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00097"></a>00097             <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00098"></a>00098           }
<a name="l00099"></a>00099         <span class="keywordflow">break</span>;
<a name="l00100"></a>00100       }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keywordflow">default</span> :
<a name="l00103"></a>00103       {
<a name="l00104"></a>00104         <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Keyword : &quot;</span> &lt;&lt; motlu &lt;&lt; <span class="stringliteral">&quot; is not understood in &quot;</span> &lt;&lt; <a class="code" href="classObjet__U.html#aa58e9a81c0ddc2c1149053b8f96698ac" title="renvoie la chaine identifiant la classe.">que_suis_je</a>() &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00105"></a>00105         <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00106"></a>00106       }
<a name="l00107"></a>00107     }
<a name="l00108"></a>00108   <span class="keywordflow">return</span> is;
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="Piso_8cpp.html#a3529e34f2472e0c0ad392d8ee889c468">00113</a> <span class="keywordtype">void</span> <a class="code" href="Piso_8cpp.html#a3529e34f2472e0c0ad392d8ee889c468">test_imposer_cond_lim</a>(<a class="code" href="classEquation__base.html">Equation_base</a>&amp; eqn,<a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; current2,<span class="keyword">const</span> <span class="keywordtype">char</span> * msg,<span class="keywordtype">int</span> flag)
<a name="l00114"></a>00114 {
<a name="l00115"></a>00115   <span class="keywordflow">return</span>;
<a name="l00116"></a>00116   <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; present = eqn.<a class="code" href="classEquation__base.html#a5a1fce9487b9a8dd17020914100c2c89">inconnue</a>().<a class="code" href="classChamp__Inc.html#a518c3eb1e7a249ae0fc4d1a4e0d072d0" title="Appel a l&#39;objet sous-jacent Renvoie le tableau des valeurs au temps t+i.">futur</a>();
<a name="l00117"></a>00117   <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a> sauv(present);
<a name="l00118"></a>00118   <span class="keyword">const</span> <a class="code" href="classSchema__Temps__base.html" title="classe Schema_Temps_base">Schema_Temps_base</a>&amp; sch = eqn.<a class="code" href="classEquation__base.html#aa8151a96f63719523bf50ddd832e0f8f" title="Renvoie le probleme associe a l&#39;equation.">probleme</a>().<a class="code" href="classProbleme__base.html#a0cf6c541e30cd21c3da32fc122cb0e2b" title="Renvoie le schema en temps associe au probleme. (si il est non nul) (version const)">schema_temps</a>();
<a name="l00119"></a>00119   eqn.<a class="code" href="classEquation__base.html#af265fe0ea30868eb2176a0c887e4efab" title="Renvoie la zone des conditions aux limite discretisee associee a l&#39;equation.">zone_Cl_dis</a>()-&gt;<a class="code" href="classZone__Cl__dis.html#a9a1b2c60317659659ff316f39fd27ed8" title="Appel a l&#39;objet sous-jacent. Impose les conditions aux limites a un temps donne du Champ_Inc...">imposer_cond_lim</a>(eqn.<a class="code" href="classEquation__base.html#a5a1fce9487b9a8dd17020914100c2c89">inconnue</a>(),sch.<a class="code" href="classSchema__Temps__base.html#a5054df01edb6d4f7baec7e612d423834" title="Renvoie le temps courant.">temps_courant</a>()+sch.<a class="code" href="classSchema__Temps__base.html#a0e4f67ef6086c09434ddc161668077b2" title="Renvoie le pas de temps (delta_t) courant.">pas_de_temps</a>());
<a name="l00120"></a>00120   present -= sauv;
<a name="l00121"></a>00121 <span class="comment">// BM, je remplace max_abs par mp_pax_abs: du coup la methode doit etre appelee simultanement par tous les procs.</span>
<a name="l00122"></a>00122   <span class="keywordtype">double</span> ecart_max=<a class="code" href="DoubleVect_8cpp.html#acb21ec8c0b3909c26b20e3f3455e0289">mp_max_abs_vect</a>(present);
<a name="l00123"></a>00123   <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a>&lt;&lt;msg &lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;ecart_max&lt;&lt;<a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125   <span class="keywordflow">if</span> ((ecart_max&gt;1e-10))
<a name="l00126"></a>00126     abort();
<a name="l00127"></a>00127   present = sauv;
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="comment">// Entree Un ; Pn</span>
<a name="l00131"></a>00131 <span class="comment">// Sortie Un+1 = U***_k ; Pn+1 = P**_k</span>
<a name="l00132"></a>00132 <span class="comment">// n designe une etape temporelle</span>
<a name="l00133"></a>00133 
<a name="l00134"></a><a class="code" href="classPiso.html#a15fe8d6f24a8e450b0132ce6227941bb">00134</a> <span class="keywordtype">void</span> <a class="code" href="classPiso.html#a15fe8d6f24a8e450b0132ce6227941bb">Piso::iterer_NS</a>(<a class="code" href="classEquation__base.html">Equation_base</a>&amp; eqn,<a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; current,<a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; pression,
<a name="l00135"></a>00135                      <span class="keywordtype">double</span> dt,<a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; matrice,<span class="keywordtype">double</span> seuil_resol,<a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a>&amp; secmem,<span class="keywordtype">int</span> nb_ite,<span class="keywordtype">int</span>&amp; converge, <span class="keywordtype">int</span>&amp; ok)
<a name="l00136"></a>00136 {
<a name="l00137"></a>00137   converge = 1;
<a name="l00138"></a>00138   <span class="keywordflow">if</span> (nb_ite&gt;1) <span class="keywordflow">return</span>;
<a name="l00139"></a>00139   <a class="code" href="classNavier__Stokes__std.html" title="classe Navier_Stokes_std Cette classe porte les termes de l&#39;equation de la dynamique pour un fluide s...">Navier_Stokes_std</a>&amp; eqnNS = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classNavier__Stokes__std.html" title="classe Navier_Stokes_std Cette classe porte les termes de l&#39;equation de la dynamique pour un fluide s...">Navier_Stokes_std</a>,eqn);
<a name="l00140"></a>00140   <span class="keywordflow">if</span> (eqnNS.<a class="code" href="classEquation__base.html#a324a761eaad25eb00d18e14764a1362e" title="Renvoie la discretisation associee a l&#39;equation.">discretisation</a>().<a class="code" href="classObjet__U.html#aa58e9a81c0ddc2c1149053b8f96698ac" title="renvoie la chaine identifiant la classe.">que_suis_je</a>() == <span class="stringliteral">&quot;PolyMAC&quot;</span>)
<a name="l00141"></a>00141     <span class="keywordflow">return</span> <a class="code" href="classPiso.html#aa65fbb9d1222f4accb3e89fdab842253">iterer_NS_PolyMAC</a>(eqnNS, current, pression, dt, matrice, ok);
<a name="l00142"></a>00142   <a class="code" href="classParametre__implicite.html" title="classe Parametre_implicite Un objet Parametre_implicite est un objet regroupant les differentes optio...">Parametre_implicite</a>&amp; param_eqn = <a class="code" href="classSimpler__Base.html#a41cac35ea9df69f70075c3df820b96a3" title="retourne le parametre_implicte de l&#39;equation si il existe si il n&#39;existe pas le cree... si les params sont vides on copie ceux du simpler">get_and_set_parametre_implicite</a>(eqn);
<a name="l00143"></a>00143   <a class="code" href="classSolveurSys.html">SolveurSys</a>&amp; le_solveur_ = param_eqn.<a class="code" href="classParametre__implicite.html#a7e65b5960b6f41da7e586134f3462666">solveur</a>();
<a name="l00144"></a>00144 
<a name="l00145"></a>00145   <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> gradP(current);
<a name="l00146"></a>00146   <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> correction_en_pression(pression);
<a name="l00147"></a>00147   <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> resu(current);
<a name="l00148"></a>00148   <span class="keywordtype">int</span> is_dilat = eqn.<a class="code" href="classEquation__base.html#aa8151a96f63719523bf50ddd832e0f8f" title="Renvoie le probleme associe a l&#39;equation.">probleme</a>().<a class="code" href="classProbleme__base.html#a4ef1cb4c4eed0aab75358ab7a91e29db">is_dilatable</a>();
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   <span class="keywordtype">double</span> vitesse_norme,vitesse_norme_old ;
<a name="l00151"></a>00151   <span class="keywordtype">double</span> pression_norme,pression_norme_old ;
<a name="l00152"></a>00152   vitesse_norme_old = 1.e10 ;
<a name="l00153"></a>00153   pression_norme_old = 1.e10 ;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 <span class="comment">// int deux_entrees = 0;</span>
<a name="l00156"></a>00156 <span class="comment">// if (current.nb_dim()==2) deux_entrees = 1;</span>
<a name="l00157"></a>00157   <a class="code" href="classOperateur__Grad.html" title="Classe Operateur_Grad Classe generique de la hierarchie des operateurs calculant le gradient d&#39;un cha...">Operateur_Grad</a>&amp; gradient = eqnNS.<a class="code" href="classNavier__Stokes__std.html#a840295836fce939b7861f1353da595ff" title="Renvoie l&#39;operateur de calcul du gradient associe a l&#39;equation.">operateur_gradient</a>();
<a name="l00158"></a>00158   <a class="code" href="classOperateur__Div.html" title="classe Operateur_Div Classe generique de la hierarchie des operateurs calculant la divergence d&#39;un ch...">Operateur_Div</a>&amp; divergence = eqnNS.<a class="code" href="classNavier__Stokes__std.html#a614d41350181667ee295b87a72779c1a" title="Renvoie l&#39;operateur de calcul de la divergence associe a l&#39;equation.">operateur_divergence</a>();
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="comment">// int nb_comp = 1;</span>
<a name="l00161"></a>00161 <span class="comment">// int nb_dim = current.nb_dim();</span>
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="comment">// if(nb_dim==2)    nb_comp = current.dimension(1);</span>
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="comment">// Construction de matrice et resu</span>
<a name="l00166"></a>00166 <span class="comment">// matrice = A[Un] = M/delta_t + CONV +DIFF</span>
<a name="l00167"></a>00167 <span class="comment">// resu =  A[Un]Un -(A[Un]Un-Ss) + Sv -BtPn</span>
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="comment">// &lt;IBM&gt; Taking into account penality term for Immersed Boundary Method</span>
<a name="l00170"></a>00170   <span class="keyword">const</span> <span class="keywordtype">int</span>&amp; i_source_PDF = eqnNS.<a class="code" href="classNavier__Stokes__std.html#a37c99515b7c84417688d74513900aa29">get_i_source_pdf</a>();
<a name="l00171"></a>00171   <span class="keywordflow">if</span> (i_source_PDF != -1)
<a name="l00172"></a>00172     {
<a name="l00173"></a>00173       <a class="code" href="classSource__PDF__base.html" title="class Source_PDF_base Base class for the source terms for the penalisation of the momentum in the Imm...">Source_PDF_base</a>&amp; src = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classSource__PDF__base.html" title="class Source_PDF_base Base class for the source terms for the penalisation of the momentum in the Imm...">Source_PDF_base</a>&amp;<span class="keyword">&gt;</span>((eqnNS.<a class="code" href="classEquation__base.html#a3c8ac50e3e7b6ed29024a43e828a5396" title="Renvoie les termes sources asssocies a l&#39;equation.">sources</a>())[i_source_PDF].<a class="code" href="Source__Generique__Face__PolyMAC_8cpp.html#a7d7b5d77a3caa1af70f5e1c9108de5a1">valeur</a>());
<a name="l00174"></a>00174       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a>&lt;&lt;<span class="stringliteral">&quot;Immersed Interface: Dirichlet velocity in momentum equation for PDF (if any).&quot;</span>&lt;&lt;<a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00175"></a>00175 <span class="comment">// Terme PDF IB value : -rho/delta_t  ksi_gamma/epsilon U_gamma</span>
<a name="l00176"></a>00176       <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a> secmem_pdf(resu);
<a name="l00177"></a>00177       src.<a class="code" href="classSource__PDF__base.html#a91f70302fead64b75f850d113836b257">calculer_pdf</a>(secmem_pdf);
<a name="l00178"></a>00178       resu -= secmem_pdf;
<a name="l00179"></a>00179       resu.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 <span class="comment">// Terme en temps : -rho/delta_t ksi_gamma Un</span>
<a name="l00182"></a>00182       <span class="keywordtype">int</span> i_traitement_special = 101;
<a name="l00183"></a>00183       <span class="keywordflow">if</span> (eqnNS.<a class="code" href="classNavier__Stokes__std.html#ac7db452db8cfdb5f15bf971a47df82f1" title="Renvoie le nombre d&#39;operateurs de l&#39;equation: Pour Navier Stokes Standard c&#39;est 2.">nombre_d_operateurs</a>() &gt; 1)
<a name="l00184"></a>00184         {
<a name="l00185"></a>00185           <span class="keywordflow">if</span> (eqnNS.<a class="code" href="classNavier__Stokes__std.html#a323445e680b6374474d6f58fa841ec0e">vitesse_pour_transport</a>().<a class="code" href="classField__base.html#ae1377124eabe8387aced762115b062bb" title="Renvoie le nom du champ.">le_nom</a>()==<span class="stringliteral">&quot;rho_u&quot;</span>) i_traitement_special = 1;
<a name="l00186"></a>00186         }
<a name="l00187"></a>00187       <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> secmem_pdf_time(resu);
<a name="l00188"></a>00188       src.<a class="code" href="classSource__PDF__base.html#a432d68c2ada2bbb554719237ea08a97c">calculer</a>(secmem_pdf_time, i_traitement_special);
<a name="l00189"></a>00189       secmem_pdf += secmem_pdf_time;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="comment">// Sauvegarde de secmem_pdf</span>
<a name="l00192"></a>00192       secmem_pdf.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00193"></a>00193       src.<a class="code" href="classSource__PDF__base.html#a5142d725b2f97498266dbe6259744463">set_sec_mem_pdf</a>(secmem_pdf);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195       <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a> <a class="code" href="Champ__P1iP1B__implementation_8cpp.html#aa8c8f49390c3cf7c702d71a71bc977e3">coeff</a>;
<a name="l00196"></a>00196       coeff = eqnNS.<a class="code" href="classNavier__Stokes__std.html#a92695b830fb023ee868c67244da19c8c">get_champ_coeff_pdf_som</a>();
<a name="l00197"></a>00197       <span class="keywordflow">if</span> (eqnNS.<a class="code" href="classNavier__Stokes__std.html#ac8869c856f5cd86ec367f7054962db1d">get_gradient_pression_qdm_modifie</a>()==1)
<a name="l00198"></a>00198         {
<a name="l00199"></a>00199           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a>&lt;&lt;<span class="stringliteral">&quot;(IBM) Immersed Interface: modified pressure gradient in momentum equation.&quot;</span>&lt;&lt;finl;
<a name="l00200"></a>00200           gradP/=<a class="code" href="Champ__P1iP1B__implementation_8cpp.html#aa8c8f49390c3cf7c702d71a71bc977e3">coeff</a>;
<a name="l00201"></a>00201         }
<a name="l00202"></a>00202       gradP.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00203"></a>00203     }
<a name="l00204"></a>00204 <span class="comment">// &lt;/IBM&gt;</span>
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="keywordflow">if</span> (eqnNS.<a class="code" href="classNavier__Stokes__std.html#ac20dbb919584c93e60550d51976c39aa">has_interface_blocs</a>()) <span class="comment">//si l&#39;interface blocs est disponible, on l&#39;utilise</span>
<a name="l00208"></a>00208     {
<a name="l00209"></a>00209       eqnNS.<a class="code" href="classEquation__base.html#ac79cbb558992c5e74f38992b703ba727">assembler_blocs_avec_inertie</a>({{ <span class="stringliteral">&quot;vitesse&quot;</span>, &amp;matrice }}, resu);
<a name="l00210"></a>00210       matrice.<a class="code" href="classMatrice__Base.html#a6ccb4d20d3877cf09f5178ff72af5406" title="Operation de multiplication-accumulation (saxpy) matrice vecteur. Operation: r = r + A*x...">ajouter_multvect</a>(current, resu);  <span class="comment">//pour ne pas etre en increment</span>
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212   <span class="keywordflow">else</span> <span class="comment">//sinon, on passe par ajouter/contribuer</span>
<a name="l00213"></a>00213     {
<a name="l00214"></a>00214       gradient.<a class="code" href="classDeriv__Operateur__Grad__base.html#abb2da411c7f8984b95704eeb0d4deeab">valeur</a>().<a class="code" href="classOperateur__base.html#a335cb37e27a57dfeb4ce5626ae291548">calculer</a>(pression,gradP);
<a name="l00215"></a>00215       resu -= gradP;
<a name="l00216"></a>00216       <a class="code" href="classPiso.html#a69f8b346972d34a4995ef3b00e0fc1bb">first_special_treatment</a>( eqn, eqnNS, current, dt, resu );
<a name="l00217"></a>00217       eqnNS.<a class="code" href="classEquation__base.html#a6442c887ca10e6b6e59e0d36140f698c">assembler_avec_inertie</a>(matrice,current,resu);
<a name="l00218"></a>00218     }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220   le_solveur_.<a class="code" href="classDeriv__SolveurSys__base.html#aa1f67fc10fc25960d05d484a67d1bb54">valeur</a>().<a class="code" href="classSolveurSys__base.html#a8737bd7292204c64e4b7bfe4c7bd88ef">reinit</a>();
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="comment">// sometimes we need a second special treatement like for ALE for example</span>
<a name="l00223"></a>00223   <a class="code" href="classPiso.html#ab071312db1a60ab913bc6dbf19e91d81">second_special_treatment</a>( eqn, current, resu, matrice );
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="comment">// Construction de matrice_en_pression_2 = BD-1Bt[Un]</span>
<a name="l00226"></a>00226 <span class="comment">// Assemblage reeffectue seulement pour algorithme Piso (avancement_crank_==0)</span>
<a name="l00227"></a>00227   <a class="code" href="classMatrice.html">Matrice</a>&amp; matrice_en_pression_2 = eqnNS.<a class="code" href="classNavier__Stokes__std.html#ade0331e225bfe2c312d4917eb127e3cd">matrice_pression</a>();
<a name="l00228"></a>00228   <a class="code" href="classSolveurSys.html">SolveurSys</a>&amp; solveur_pression_ = eqnNS.<a class="code" href="classNavier__Stokes__std.html#ae83d9f7a42531293583f32be1efd3d5f" title="Renvoie le solveur en pression&lt;br&gt;(version const)">solveur_pression</a>();
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 
<a name="l00232"></a>00232   <span class="keywordflow">if</span> (<a class="code" href="classPiso.html#a1b2607a1196d4af9d9594815bd64ba1c" title="on ne fait pas vraiment du piso mais plutot du CN">avancement_crank_</a>==0)
<a name="l00233"></a>00233     {
<a name="l00234"></a>00234       <a class="code" href="classSimpler__Base.html#a9551a048f427dd25e9e6e5a054b95038">assembler_matrice_pression_implicite</a>(eqnNS,matrice,matrice_en_pression_2);
<a name="l00235"></a>00235       solveur_pression_.<a class="code" href="classDeriv__SolveurSys__base.html#aa1f67fc10fc25960d05d484a67d1bb54">valeur</a>().<a class="code" href="classSolveurSys__base.html#a8737bd7292204c64e4b7bfe4c7bd88ef">reinit</a>();
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 <span class="comment">// Etape predicteur</span>
<a name="l00239"></a>00239 <span class="comment">// Resolution du systeme A[Un]U* = -BtPn + Sv + Ss</span>
<a name="l00240"></a>00240 <span class="comment">// current = U*</span>
<a name="l00241"></a>00241   le_solveur_.<a class="code" href="classSolveurSys.html#a62ca198f0c5dc599e53b0535761e5138">resoudre_systeme</a>(matrice,resu,current);
<a name="l00242"></a>00242 
<a name="l00243"></a>00243   <a class="code" href="Piso_8cpp.html#a3529e34f2472e0c0ad392d8ee889c468">test_imposer_cond_lim</a>(eqn,current,<span class="stringliteral">&quot;apres resolution &quot;</span>,0);
<a name="l00244"></a>00244   current.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00245"></a>00245   <a class="code" href="Op__Div__VEFP1B__Elem_8cpp.html#a45261662b3b88d5db461b3fc99246e5a">Debog::verifier</a>(<span class="stringliteral">&quot;Piso::iterer_NS current apres solveur&quot;</span>,current);
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 <span class="comment">// Calcul de secmem = BU* (en incompressible) BU* -drho/dt (en quasi-compressible)</span>
<a name="l00248"></a>00248   <span class="keywordflow">if</span> (is_dilat)
<a name="l00249"></a>00249     {
<a name="l00250"></a>00250       <span class="keywordflow">if</span> (<a class="code" href="classSimple.html#a26b2c949c7f539ad0bf3db35c5492df1">with_d_rho_dt_</a>)
<a name="l00251"></a>00251         {
<a name="l00252"></a>00252           <a class="code" href="classFluide__Dilatable__base.html" title="classe Fluide_Dilatable_base Cette classe represente un d&#39;un fluide dilatable, heritant de fluide bas...">Fluide_Dilatable_base</a>&amp; fluide_dil = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classFluide__Dilatable__base.html" title="classe Fluide_Dilatable_base Cette classe represente un d&#39;un fluide dilatable, heritant de fluide bas...">Fluide_Dilatable_base</a>,eqn.<a class="code" href="classEquation__base.html#a181e9899e2d927eb14c835d9d9334f46">milieu</a>());
<a name="l00253"></a>00253           fluide_dil.<a class="code" href="classFluide__Dilatable__base.html#a881172acb09944046107e7c87e8fdcaf">secmembre_divU_Z</a>(secmem);
<a name="l00254"></a>00254           secmem *= -1;
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256       <span class="keywordflow">else</span> secmem = 0;
<a name="l00257"></a>00257       divergence.<a class="code" href="classOperateur__Div.html#aeb7f9d269b7d93314ce9583f0fa1f57d" title="Ajoute la contribution de l&#39;operateur au tableau passe en parametre.">ajouter</a>(current,secmem);
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259   <span class="keywordflow">else</span>
<a name="l00260"></a>00260     divergence.<a class="code" href="classOperateur__Div.html#ad3dbe52ca9c4899797444afeb0fe4ef4" title="Initialise le tableau passe en parametre avec la contribution de l&#39;operateur.">calculer</a>(current,secmem);
<a name="l00261"></a>00261   secmem *= -1;
<a name="l00262"></a>00262   secmem.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00263"></a>00263   <a class="code" href="Op__Div__VEFP1B__Elem_8cpp.html#a45261662b3b88d5db461b3fc99246e5a">Debog::verifier</a>(<span class="stringliteral">&quot;Piso::iterer_NS secmem&quot;</span>,secmem);
<a name="l00264"></a>00264 <span class="comment">// GF il ne faut pas modifier le scd membre le terme en du/dt au bord a deja ete pris en compte dans la resolution precedente</span>
<a name="l00265"></a>00265 <span class="comment">// eqnNS.assembleur_pression().valeur().modifier_secmem(secmem);</span>
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 <span class="comment">// Etape de correction 1</span>
<a name="l00268"></a>00268   <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Solving mass equation :&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00269"></a>00269 <span class="comment">// Description du cas implicite</span>
<a name="l00270"></a>00270 <span class="comment">// Resolution du systeme (BD-1Bt)P&#39; = Bu* (D-1 = M-1 pour le cas implicite)</span>
<a name="l00271"></a>00271 <span class="comment">// correction_en_pression = P&#39; pour Piso et correction_en_pression = delta_t*P&#39; pour implicite</span>
<a name="l00272"></a>00272   solveur_pression_.<a class="code" href="classSolveurSys.html#a62ca198f0c5dc599e53b0535761e5138">resoudre_systeme</a>(matrice_en_pression_2.<a class="code" href="classDeriv__Matrice__Base.html#ae43f3a90ca16518c191f9e7d5ebef912">valeur</a>(),
<a name="l00273"></a>00273                                      secmem,correction_en_pression);
<a name="l00274"></a>00274   correction_en_pression.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00275"></a>00275   <a class="code" href="Op__Div__VEFP1B__Elem_8cpp.html#a45261662b3b88d5db461b3fc99246e5a">Debog::verifier</a>(<span class="stringliteral">&quot;Piso::iterer_NS apres correction_pression&quot;</span>,correction_en_pression);
<a name="l00276"></a>00276 
<a name="l00277"></a>00277   <span class="keywordflow">if</span> (<a class="code" href="classPiso.html#a1b2607a1196d4af9d9594815bd64ba1c" title="on ne fait pas vraiment du piso mais plutot du CN">avancement_crank_</a>==1)
<a name="l00278"></a>00278     {
<a name="l00279"></a>00279 <span class="comment">// calcul de Un+1</span>
<a name="l00280"></a>00280 <span class="comment">// Calcul de Bt(delta_t*delta_P)</span>
<a name="l00281"></a>00281       gradient.<a class="code" href="classDeriv__Operateur__Grad__base.html#abb2da411c7f8984b95704eeb0d4deeab">valeur</a>().<a class="code" href="classOperateur__Grad__base.html#a0db6712837c5be1c0e117c3cf00ed3fc" title="Calcul sans les conditions aux limites ?">multvect</a>(correction_en_pression,gradP);
<a name="l00282"></a>00282       eqn.<a class="code" href="classEquation__base.html#adfedf474c07a92f6b2261ca2f1cee80e" title="Renvoie le solveur de masse associe a l&#39;equation.">solv_masse</a>().<a class="code" href="classSolveur__Masse.html#af7afe8c2d4d5764f7428f2cd4ef43ddb" title="Appel a l&#39;objet sous-jacent. Resoud le systeme lineaire, dont la matrice est la matrice de masse...">appliquer</a>(gradP);
<a name="l00283"></a>00283       <span class="keywordflow">if</span> ((i_source_PDF != -1) &amp;&amp; (eqnNS.<a class="code" href="classNavier__Stokes__std.html#a75155b7c75b12a02fe7f4b7adab3d145">get_correction_vitesse_modifie</a>()==1))
<a name="l00284"></a>00284         {
<a name="l00285"></a>00285           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a>&lt;&lt;<span class="stringliteral">&quot;(IBM) Immersed Interface: modified velocity correction.&quot;</span>&lt;&lt;finl;
<a name="l00286"></a>00286           <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a> <a class="code" href="Champ__P1iP1B__implementation_8cpp.html#aa8c8f49390c3cf7c702d71a71bc977e3">coeff</a>;
<a name="l00287"></a>00287           coeff = eqnNS.<a class="code" href="classNavier__Stokes__std.html#a92695b830fb023ee868c67244da19c8c">get_champ_coeff_pdf_som</a>();
<a name="l00288"></a>00288           gradP/=<a class="code" href="Champ__P1iP1B__implementation_8cpp.html#aa8c8f49390c3cf7c702d71a71bc977e3">coeff</a>;
<a name="l00289"></a>00289           gradP.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 <span class="comment">// Calcul de Un+1 = U* -delta_t*delta_P</span>
<a name="l00293"></a>00293       current -= gradP;
<a name="l00294"></a>00294       eqn.<a class="code" href="classEquation__base.html#adfedf474c07a92f6b2261ca2f1cee80e" title="Renvoie le solveur de masse associe a l&#39;equation.">solv_masse</a>().<a class="code" href="classSolveur__Masse.html#a328dc53fbe227ba188eaf55cd98474b8">corriger_solution</a>(current, current); <span class="comment">//pour CoviMAC : sert a corriger ve</span>
<a name="l00295"></a>00295       current.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00296"></a>00296       divergence.<a class="code" href="classOperateur__Div.html#ad3dbe52ca9c4899797444afeb0fe4ef4" title="Initialise le tableau passe en parametre avec la contribution de l&#39;operateur.">calculer</a>(current,secmem);
<a name="l00297"></a>00297 
<a name="l00298"></a>00298 <span class="comment">// Calcul de Pn+1 = Pn + (delta_t*delta_P)/delat_t</span>
<a name="l00299"></a>00299       <a class="code" href="Op__Div__VEFP1B__Elem_8cpp.html#a45261662b3b88d5db461b3fc99246e5a">Debog::verifier</a>(<span class="stringliteral">&quot;Piso::iterer_NS correction avant dt&quot;</span>,correction_en_pression);
<a name="l00300"></a>00300       correction_en_pression /= dt;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302 <span class="comment">// &lt;IBM&gt; Immersed Interface: modified pressure correction.</span>
<a name="l00303"></a>00303       <span class="keywordflow">if</span> ((i_source_PDF != -1) &amp;&amp; (eqnNS.<a class="code" href="classNavier__Stokes__std.html#ad2d9aea0a2eed5edd398827bcdec240d">get_correction_pression_modifie</a>()==1))
<a name="l00304"></a>00304         {
<a name="l00305"></a>00305           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a>&lt;&lt;<span class="stringliteral">&quot;Immersed Interface: modified pressure correction.&quot;</span>&lt;&lt;finl;
<a name="l00306"></a>00306           <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a> <a class="code" href="Champ__P1iP1B__implementation_8cpp.html#aa8c8f49390c3cf7c702d71a71bc977e3">coeff</a>;
<a name="l00307"></a>00307           coeff = eqnNS.<a class="code" href="classNavier__Stokes__std.html#a92695b830fb023ee868c67244da19c8c">get_champ_coeff_pdf_som</a>();
<a name="l00308"></a>00308           <span class="keyword">const</span> <a class="code" href="classSource__PDF__base.html" title="class Source_PDF_base Base class for the source terms for the penalisation of the momentum in the Imm...">Source_PDF_base</a>&amp; src = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classSource__PDF__base.html" title="class Source_PDF_base Base class for the source terms for the penalisation of the momentum in the Imm...">Source_PDF_base</a>&amp;<span class="keyword">&gt;</span>((eqnNS.<a class="code" href="classEquation__base.html#a3c8ac50e3e7b6ed29024a43e828a5396" title="Renvoie les termes sources asssocies a l&#39;equation.">sources</a>())[i_source_PDF].<a class="code" href="Source__Generique__Face__PolyMAC_8cpp.html#a7d7b5d77a3caa1af70f5e1c9108de5a1">valeur</a>());
<a name="l00309"></a>00309           src.<a class="code" href="classSource__PDF__base.html#a7c7f9d7c41350a7470b8c4c38287ffb0">correct_pressure</a>(coeff,pression,correction_en_pression);
<a name="l00310"></a>00310         }
<a name="l00311"></a>00311       <span class="keywordflow">else</span>
<a name="l00312"></a>00312         {
<a name="l00313"></a>00313           pression += correction_en_pression;
<a name="l00314"></a>00314         }
<a name="l00315"></a>00315 <span class="comment">// &lt;/IBM&gt;</span>
<a name="l00316"></a>00316       eqnNS.<a class="code" href="classNavier__Stokes__std.html#af9f5e0396945755597f147bd424a4a08">assembleur_pression</a>().<a class="code" href="classDeriv__Assembleur__base.html#ac0c74810fc600fc5053e645bf19d4ece">valeur</a>().<a class="code" href="classAssembleur__base.html#ab63a4124e6e959dc5986c566748422f6">modifier_solution</a>(pression);
<a name="l00317"></a>00317       pression.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00318"></a>00318       <a class="code" href="Op__Div__VEFP1B__Elem_8cpp.html#a45261662b3b88d5db461b3fc99246e5a">Debog::verifier</a>(<span class="stringliteral">&quot;Piso::iterer_NS pression finale&quot;</span>,pression);
<a name="l00319"></a>00319       <a class="code" href="Op__Div__VEFP1B__Elem_8cpp.html#a45261662b3b88d5db461b3fc99246e5a">Debog::verifier</a>(<span class="stringliteral">&quot;Piso::iterer_NS current final&quot;</span>,current);
<a name="l00320"></a>00320       <span class="keywordflow">if</span> (is_dilat)
<a name="l00321"></a>00321         {
<a name="l00322"></a>00322 <span class="comment">// on redivise par rho_np_1 avant de sortir</span>
<a name="l00323"></a>00323           <a class="code" href="Simple_8cpp.html#a19649c779397e8157e2b28eda5037367">diviser_par_rho_np1_face</a>(eqn,current);
<a name="l00324"></a>00324         }
<a name="l00325"></a>00325       <span class="keywordflow">return</span>;
<a name="l00326"></a>00326     }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 <span class="comment">// calcul de la correction en vitesse premiere etape (DU&#39; =-Bt P)</span>
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="comment">// Calcul de P* = Pn + P&#39;</span>
<a name="l00331"></a>00331   pression += correction_en_pression;
<a name="l00332"></a>00332   eqnNS.<a class="code" href="classNavier__Stokes__std.html#af9f5e0396945755597f147bd424a4a08">assembleur_pression</a>().<a class="code" href="classDeriv__Assembleur__base.html#ac0c74810fc600fc5053e645bf19d4ece">valeur</a>().<a class="code" href="classAssembleur__base.html#ab63a4124e6e959dc5986c566748422f6">modifier_solution</a>(pression);
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="comment">// Resolution du systeme D[Un]U&#39; = -BtP&#39;</span>
<a name="l00335"></a>00335   <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> correction_en_vitesse(current);
<a name="l00336"></a>00336   <a class="code" href="classSimple.html#aba822b0b0b3d30c62205600a72602b37">calculer_correction_en_vitesse</a>(correction_en_pression,gradP,correction_en_vitesse,matrice,gradient);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="comment">// Calcul de U** = U* + U&#39;</span>
<a name="l00339"></a>00339   current += correction_en_vitesse;
<a name="l00340"></a>00340   <a class="code" href="Piso_8cpp.html#a3529e34f2472e0c0ad392d8ee889c468">test_imposer_cond_lim</a>(eqn,current,<span class="stringliteral">&quot;apres premiere correction &quot;</span>,0);
<a name="l00341"></a>00341   <a class="code" href="Op__Div__VEFP1B__Elem_8cpp.html#a45261662b3b88d5db461b3fc99246e5a">Debog::verifier</a>(<span class="stringliteral">&quot;Piso::iterer_NS arpes cor pression&quot;</span>,pression);
<a name="l00342"></a>00342   <a class="code" href="Op__Div__VEFP1B__Elem_8cpp.html#a45261662b3b88d5db461b3fc99246e5a">Debog::verifier</a>(<span class="stringliteral">&quot;Piso::iterer_NS arpes cor vitesse&quot;</span>,current);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 <span class="comment">// Etape correcteur 2</span>
<a name="l00346"></a>00346   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> compt=0; compt&lt;<a class="code" href="classPiso.html#a3917d9ddbcb9569b38e0991191938397">nb_corrections_max_</a>-1; compt++)
<a name="l00347"></a>00347     {
<a name="l00348"></a>00348       correction_en_vitesse.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00349"></a>00349 
<a name="l00350"></a>00350 <span class="comment">// Resolution du systeme D resu = EU&#39; + (resu2=0) pour stocker resu = D-1EU&#39;</span>
<a name="l00351"></a>00351       <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> resu2(resu);
<a name="l00352"></a>00352       <span class="keywordtype">int</span> status = <a class="code" href="Simpler_8cpp.html#a39ebea1914996e78c68ef4f58c5f7d95">inverser_par_diagonale</a>(matrice,resu2,correction_en_vitesse,resu);
<a name="l00353"></a>00353 
<a name="l00354"></a>00354       <span class="keywordflow">if</span> (status!=0) <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00355"></a>00355 <span class="comment">// calcul de P&#39;&#39;  BD-1Bt P&#39;&#39;= -div(D-1EU&#39;)</span>
<a name="l00356"></a>00356 
<a name="l00357"></a>00357       resu.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00358"></a>00358 <span class="comment">// Calcul de B(D-1EU&#39;)</span>
<a name="l00359"></a>00359       divergence.<a class="code" href="classOperateur__Div.html#ad3dbe52ca9c4899797444afeb0fe4ef4" title="Initialise le tableau passe en parametre avec la contribution de l&#39;operateur.">calculer</a>(resu,secmem);
<a name="l00360"></a>00360       secmem *= -1;
<a name="l00361"></a>00361       secmem.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="comment">// Resolution du systeme (BD-1Bt)P&#39;&#39; = (BD-1E)U&#39;</span>
<a name="l00364"></a>00364 <span class="comment">// correction_en_pression = P&#39;&#39;</span>
<a name="l00365"></a>00365       correction_en_pression = 0;
<a name="l00366"></a>00366       solveur_pression_.<a class="code" href="classSolveurSys.html#a62ca198f0c5dc599e53b0535761e5138">resoudre_systeme</a>(matrice_en_pression_2.<a class="code" href="classDeriv__Matrice__Base.html#ae43f3a90ca16518c191f9e7d5ebef912">valeur</a>(),
<a name="l00367"></a>00367                                          secmem,correction_en_pression);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00370"></a>00370 <span class="preprocessor"></span><span class="comment">// Pour verifier que le calcul du gradient ne modifie pas la pression</span>
<a name="l00371"></a>00371       <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> correction_en_pression_mod(pression);
<a name="l00372"></a>00372       correction_en_pression_mod = correction_en_pression;
<a name="l00373"></a>00373 <span class="preprocessor">#endif</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span><span class="comment">// Resolution du systeme D[Un]U&#39;&#39; = -BtP&#39;&#39;</span>
<a name="l00375"></a>00375 <span class="comment">// correction_en_vitesse = U&#39;&#39;</span>
<a name="l00376"></a>00376       <a class="code" href="classSimple.html#aba822b0b0b3d30c62205600a72602b37">calculer_correction_en_vitesse</a>(correction_en_pression,gradP,correction_en_vitesse,matrice,gradient);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00379"></a>00379 <span class="preprocessor"></span>      correction_en_pression_mod -= correction_en_pression;
<a name="l00380"></a>00380       assert(max_abs(correction_en_pression_mod)==0);
<a name="l00381"></a>00381 <span class="preprocessor">#endif</span>
<a name="l00382"></a>00382 <span class="preprocessor"></span>
<a name="l00383"></a>00383 <span class="comment">// Calcul de U&#39;&#39; = U&#39;&#39; + D-1EU&#39;</span>
<a name="l00384"></a>00384       correction_en_vitesse += resu;
<a name="l00385"></a>00385 <span class="comment">// ajout des increments</span>
<a name="l00386"></a>00386 
<a name="l00387"></a>00387       vitesse_norme = <a class="code" href="DoubleVect_8cpp.html#afaa33f0032aa927d8d54ff9fb002b749">mp_norme_vect</a>(correction_en_vitesse);
<a name="l00388"></a>00388       pression_norme = <a class="code" href="DoubleVect_8cpp.html#afaa33f0032aa927d8d54ff9fb002b749">mp_norme_vect</a>(correction_en_pression);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390       <span class="keywordflow">if</span> ( (vitesse_norme&gt;vitesse_norme_old) || (pression_norme&gt;pression_norme_old) )
<a name="l00391"></a>00391         {
<a name="l00392"></a>00392           <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt;<span class="stringliteral">&quot;PISO : &quot;</span>&lt;&lt; compt+1 &lt;&lt;<span class="stringliteral">&quot; corrections to perform the projection.&quot;</span>&lt;&lt; finl;
<a name="l00393"></a>00393           <span class="keywordflow">if</span> (is_dilat)
<a name="l00394"></a>00394             {
<a name="l00395"></a>00395 <span class="comment">// on redivise par rho_np_1 avant de sortir</span>
<a name="l00396"></a>00396               <a class="code" href="Simple_8cpp.html#a19649c779397e8157e2b28eda5037367">diviser_par_rho_np1_face</a>(eqn,current);
<a name="l00397"></a>00397             }
<a name="l00398"></a>00398           return ;
<a name="l00399"></a>00399         }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401       vitesse_norme_old = vitesse_norme;
<a name="l00402"></a>00402       pression_norme_old = pression_norme;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="comment">// Calcul de P** = P* + P&#39;&#39;</span>
<a name="l00405"></a>00405       pression += correction_en_pression;
<a name="l00406"></a>00406       eqnNS.<a class="code" href="classNavier__Stokes__std.html#af9f5e0396945755597f147bd424a4a08">assembleur_pression</a>().<a class="code" href="classDeriv__Assembleur__base.html#ac0c74810fc600fc5053e645bf19d4ece">valeur</a>().<a class="code" href="classAssembleur__base.html#ab63a4124e6e959dc5986c566748422f6">modifier_solution</a>(pression);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="comment">// Calcul de U*** = U** + U&#39;&#39;</span>
<a name="l00409"></a>00409       current += correction_en_vitesse;
<a name="l00410"></a>00410       <a class="code" href="Piso_8cpp.html#a3529e34f2472e0c0ad392d8ee889c468">test_imposer_cond_lim</a>(eqn,current,<span class="stringliteral">&quot;apres correction (int)__LINE__&quot;</span>,0);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412       <a class="code" href="Op__Div__VEFP1B__Elem_8cpp.html#a45261662b3b88d5db461b3fc99246e5a">Debog::verifier</a>(<span class="stringliteral">&quot;Piso::iterer_NS apres correction pression&quot;</span>,pression);
<a name="l00413"></a>00413       <a class="code" href="Op__Div__VEFP1B__Elem_8cpp.html#a45261662b3b88d5db461b3fc99246e5a">Debog::verifier</a>(<span class="stringliteral">&quot;Piso::iterer_NS apres correction vitesse&quot;</span>,current);
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415   <span class="keywordflow">if</span> (is_dilat)
<a name="l00416"></a>00416     {
<a name="l00417"></a>00417       <a class="code" href="Simple_8cpp.html#a19649c779397e8157e2b28eda5037367">diviser_par_rho_np1_face</a>(eqn,current);
<a name="l00418"></a>00418 <span class="comment">// ref_cast(Navier_Stokes_QC,eqn).impr_impl(eqnNS, Cout);</span>
<a name="l00419"></a>00419     }
<a name="l00420"></a>00420   current.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00421"></a>00421 <span class="comment">// divergence.calculer(current, secmem); Cerr&lt;&lt;&quot; ici DIVU  &quot;&lt;&lt;mp_max_abs_vect(secmem)&lt;&lt;finl;;</span>
<a name="l00422"></a>00422   <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt;<span class="stringliteral">&quot;PISO : &quot;</span>&lt;&lt;nb_corrections_max_&lt;&lt;<span class="stringliteral">&quot; corrections to perform the projection.&quot;</span>&lt;&lt; finl;
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 
<a name="l00425"></a><a class="code" href="classPiso.html#a69f8b346972d34a4995ef3b00e0fc1bb">00425</a> <span class="keywordtype">void</span> <a class="code" href="classPiso.html#a69f8b346972d34a4995ef3b00e0fc1bb">Piso::first_special_treatment</a>(<a class="code" href="classEquation__base.html">Equation_base</a>&amp; eqn, <a class="code" href="classNavier__Stokes__std.html" title="classe Navier_Stokes_std Cette classe porte les termes de l&#39;equation de la dynamique pour un fluide s...">Navier_Stokes_std</a>&amp; eqnNS, <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; current, <span class="keywordtype">double</span> dt, <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a>&amp; resu)
<a name="l00426"></a>00426 {
<a name="l00427"></a>00427 <span class="comment">// nothing to do</span>
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00430"></a><a class="code" href="classPiso.html#ab071312db1a60ab913bc6dbf19e91d81">00430</a> <span class="keywordtype">void</span> <a class="code" href="classPiso.html#ab071312db1a60ab913bc6dbf19e91d81">Piso::second_special_treatment</a>(<a class="code" href="classEquation__base.html">Equation_base</a>&amp; eqn,<a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; current, <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a>&amp; resu, <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; matrice)
<a name="l00431"></a>00431 {
<a name="l00432"></a>00432 <span class="comment">// nothing to do</span>
<a name="l00433"></a>00433 }
<a name="l00434"></a>00434 
<a name="l00435"></a><a class="code" href="classImplicite.html#af25873d9bf82fdab5575818217c5f307">00435</a> <span class="keywordtype">void</span> <a class="code" href="classImplicite.html#af25873d9bf82fdab5575818217c5f307">Implicite::first_special_treatment</a>(<a class="code" href="classEquation__base.html">Equation_base</a>&amp; eqn, <a class="code" href="classNavier__Stokes__std.html" title="classe Navier_Stokes_std Cette classe porte les termes de l&#39;equation de la dynamique pour un fluide s...">Navier_Stokes_std</a>&amp; eqnNS, <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; current, <span class="keywordtype">double</span> dt, <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a>&amp; resu)
<a name="l00436"></a>00436 {
<a name="l00437"></a>00437 <span class="comment">// nothing to do</span>
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00440"></a><a class="code" href="classImplicite.html#a91364b8fb8ba60c3057a99fc6d6ceb02">00440</a> <span class="keywordtype">void</span> <a class="code" href="classImplicite.html#a91364b8fb8ba60c3057a99fc6d6ceb02">Implicite::second_special_treatment</a>(<a class="code" href="classEquation__base.html">Equation_base</a>&amp; eqn,<a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; current, <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a>&amp; resu, <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; matrice)
<a name="l00441"></a>00441 {
<a name="l00442"></a>00442 <span class="comment">// nothing to do</span>
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 <span class="comment">// version PolyMAC de la fonction ci-dessus</span>
<a name="l00446"></a><a class="code" href="classPiso.html#aa65fbb9d1222f4accb3e89fdab842253">00446</a> <span class="keywordtype">void</span> <a class="code" href="classPiso.html#aa65fbb9d1222f4accb3e89fdab842253">Piso::iterer_NS_PolyMAC</a>(<a class="code" href="classNavier__Stokes__std.html" title="classe Navier_Stokes_std Cette classe porte les termes de l&#39;equation de la dynamique pour un fluide s...">Navier_Stokes_std</a>&amp; eqn,<a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; current,<a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; pression, <span class="keywordtype">double</span> dt, <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; matrice, <span class="keywordtype">int</span>&amp; ok)
<a name="l00447"></a>00447 {
<a name="l00448"></a>00448   <a class="code" href="classParametre__implicite.html" title="classe Parametre_implicite Un objet Parametre_implicite est un objet regroupant les differentes optio...">Parametre_implicite</a>&amp; param_eqn = <a class="code" href="classSimpler__Base.html#a41cac35ea9df69f70075c3df820b96a3" title="retourne le parametre_implicte de l&#39;equation si il existe si il n&#39;existe pas le cree... si les params sont vides on copie ceux du simpler">get_and_set_parametre_implicite</a>(eqn);
<a name="l00449"></a>00449   <a class="code" href="classSolveurSys.html">SolveurSys</a>&amp; le_solveur_ = param_eqn.<a class="code" href="classParametre__implicite.html#a7e65b5960b6f41da7e586134f3462666">solveur</a>();
<a name="l00450"></a>00450 
<a name="l00451"></a>00451   <a class="code" href="classNavier__Stokes__std.html" title="classe Navier_Stokes_std Cette classe porte les termes de l&#39;equation de la dynamique pour un fluide s...">Navier_Stokes_std</a>&amp; eqnNS = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classNavier__Stokes__std.html" title="classe Navier_Stokes_std Cette classe porte les termes de l&#39;equation de la dynamique pour un fluide s...">Navier_Stokes_std</a>,eqn);
<a name="l00452"></a>00452   <a class="code" href="classOperateur__Grad.html" title="Classe Operateur_Grad Classe generique de la hierarchie des operateurs calculant le gradient d&#39;un cha...">Operateur_Grad</a>&amp; op_grad = eqnNS.<a class="code" href="classNavier__Stokes__std.html#a840295836fce939b7861f1353da595ff" title="Renvoie l&#39;operateur de calcul du gradient associe a l&#39;equation.">operateur_gradient</a>();
<a name="l00453"></a>00453   <a class="code" href="classOperateur__Div.html" title="classe Operateur_Div Classe generique de la hierarchie des operateurs calculant la divergence d&#39;un ch...">Operateur_Div</a>&amp; op_div = eqnNS.<a class="code" href="classNavier__Stokes__std.html#a614d41350181667ee295b87a72779c1a" title="Renvoie l&#39;operateur de calcul de la divergence associe a l&#39;equation.">operateur_divergence</a>();
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> dv(current), dP(pression); <span class="comment">//corrections en vitesse / pression</span>
<a name="l00456"></a>00456 
<a name="l00457"></a>00457   <span class="comment">/* etape de prediction : current &lt;- v(0) ne verifiant pas div = 0 */</span>
<a name="l00458"></a>00458   <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> secmem_NS(current), v_new(current);
<a name="l00459"></a>00459   op_grad.<a class="code" href="classOperateur__Grad.html#a8e1b52275b21eef3d6fe2ee407381f7e" title="Ajoute la contribution de l&#39;operateur au tableau passe en parametre.">ajouter</a>(pression, secmem_NS);
<a name="l00460"></a>00460   secmem_NS *= -1;
<a name="l00461"></a>00461   eqnNS.<a class="code" href="classEquation__base.html#a6442c887ca10e6b6e59e0d36140f698c">assembler_avec_inertie</a>(matrice, current, secmem_NS);
<a name="l00462"></a>00462   le_solveur_.<a class="code" href="classDeriv__SolveurSys__base.html#aa1f67fc10fc25960d05d484a67d1bb54">valeur</a>().<a class="code" href="classSolveurSys__base.html#a8737bd7292204c64e4b7bfe4c7bd88ef">reinit</a>();
<a name="l00463"></a>00463   le_solveur_.<a class="code" href="classSolveurSys.html#a62ca198f0c5dc599e53b0535761e5138">resoudre_systeme</a>(matrice, secmem_NS, v_new);
<a name="l00464"></a>00464   v_new.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00465"></a>00465 
<a name="l00466"></a>00466   <a class="code" href="classMatrice.html">Matrice</a>&amp; mat_press_orig = eqn.<a class="code" href="classNavier__Stokes__std.html#ade0331e225bfe2c312d4917eb127e3cd">matrice_pression</a>(), mat_press;
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   <span class="comment">/* etapes de correction : current &lt;- v(i) verifiant div = 0 mais approche pour NS, pression &lt;- p(i) correspondant a v(i) */</span>
<a name="l00469"></a>00469   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 1; i++)
<a name="l00470"></a>00470     {
<a name="l00471"></a>00471       <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> sol_M(pression), secmem_M(pression);
<a name="l00472"></a>00472       <span class="comment">/* resolution en (dt * dp(i), dv(i)) */</span>
<a name="l00473"></a>00473 <span class="comment">// second membre : divergence, NS</span>
<a name="l00474"></a>00474       <a class="code" href="classDoubleTab__parts.html">DoubleTab_parts</a> p_sec(secmem_M), p_sol(sol_M), p_v(v_new), p_res(secmem_NS); <span class="comment">//p_sec/sol[0] -&gt; elements, p_sec/sol[1] -&gt; faces</span>
<a name="l00475"></a>00475 <span class="comment">// bloc superieur : div v(i-1)</span>
<a name="l00476"></a>00476       op_div.<a class="code" href="classOperateur__Div.html#aeb7f9d269b7d93314ce9583f0fa1f57d" title="Ajoute la contribution de l&#39;operateur au tableau passe en parametre.">ajouter</a>(v_new, p_sec[0]);
<a name="l00477"></a>00477 <span class="comment">// bloc inferieur : residu de l&#39;etape de prediction</span>
<a name="l00478"></a>00478       p_sec[1] = 0;<span class="comment">//p_res[0];</span>
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 <span class="comment">// matrice (sauf si avancement_crank_ == 1) : prise en compte des contributions des sources (et pas des operateurs!)</span>
<a name="l00481"></a>00481       <span class="keywordflow">if</span> (<a class="code" href="classPiso.html#a1b2607a1196d4af9d9594815bd64ba1c" title="on ne fait pas vraiment du piso mais plutot du CN">avancement_crank_</a> == 0)
<a name="l00482"></a>00482         {
<a name="l00483"></a>00483           matrice.<a class="code" href="classMatrice__Morse.html#acd067e8514e5741f52b18a1d99746d11">get_set_coeff</a>() = 0, eqn.<a class="code" href="classEquation__base.html#a3c8ac50e3e7b6ed29024a43e828a5396" title="Renvoie les termes sources asssocies a l&#39;equation.">sources</a>().<a class="code" href="classSources.html#aa91bceeb92650bc8b60a94f193a9d689" title="contribution a la matrice implicite des termes sources par defaut pas de contribution">contribuer_a_avec</a>(current, matrice);
<a name="l00484"></a>00484           <a class="code" href="classDoubleTrav.html" title="Tableau de travail a n entrees pour n&lt;= 4 C&#39;est un DoubleTab avec allocation dans un pool de memoire g...">DoubleTrav</a> diag(p_sec[1]);
<a name="l00485"></a>00485           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; p_sec[1].dimension(0); j++) diag(j) = dt * matrice(j, j);
<a name="l00486"></a>00486           diag.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00487"></a>00487           eqn.<a class="code" href="classNavier__Stokes__std.html#af9f5e0396945755597f147bd424a4a08">assembleur_pression</a>().<a class="code" href="classDeriv__Assembleur__base.html#ac0c74810fc600fc5053e645bf19d4ece">valeur</a>().<a class="code" href="classAssembleur__base.html#a0710705cb88b7db3620b993a2cb31e05">assembler_mat</a>(mat_press, diag, 1, 1);
<a name="l00488"></a>00488           eqn.<a class="code" href="classNavier__Stokes__std.html#ae83d9f7a42531293583f32be1efd3d5f" title="Renvoie le solveur en pression&lt;br&gt;(version const)">solveur_pression</a>().<a class="code" href="classDeriv__SolveurSys__base.html#aa1f67fc10fc25960d05d484a67d1bb54">valeur</a>().<a class="code" href="classSolveurSys__base.html#a8737bd7292204c64e4b7bfe4c7bd88ef">reinit</a>();
<a name="l00489"></a>00489         }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="comment">// resolution</span>
<a name="l00492"></a>00492       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;PISO : |sec dp| &lt; &quot;</span> &lt;&lt; <a class="code" href="DoubleVect_8cpp.html#acb21ec8c0b3909c26b20e3f3455e0289">mp_max_abs_vect</a>(p_sec[0]) &lt;&lt; <span class="stringliteral">&quot; |sec dv| &lt; &quot;</span> &lt;&lt; <a class="code" href="DoubleVect_8cpp.html#acb21ec8c0b3909c26b20e3f3455e0289">mp_max_abs_vect</a>(p_sec[1]) &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00493"></a>00493       eqn.<a class="code" href="classNavier__Stokes__std.html#ae83d9f7a42531293583f32be1efd3d5f" title="Renvoie le solveur en pression&lt;br&gt;(version const)">solveur_pression</a>().<a class="code" href="classSolveurSys.html#a62ca198f0c5dc599e53b0535761e5138">resoudre_systeme</a>(<a class="code" href="classPiso.html#a1b2607a1196d4af9d9594815bd64ba1c" title="on ne fait pas vraiment du piso mais plutot du CN">avancement_crank_</a> == 1 ? mat_press_orig.<a class="code" href="classDeriv__Matrice__Base.html#ae43f3a90ca16518c191f9e7d5ebef912">valeur</a>() : mat_press.valeur(), secmem_M, sol_M);
<a name="l00494"></a>00494 <span class="comment">// mises a jour : v^(i) = v^(i-1)+dv^(i), p^(i) = p^(i-1) + dp^(i)</span>
<a name="l00495"></a>00495       eqn.<a class="code" href="classNavier__Stokes__std.html#af9f5e0396945755597f147bd424a4a08">assembleur_pression</a>().<a class="code" href="classDeriv__Assembleur__base.html#ac0c74810fc600fc5053e645bf19d4ece">valeur</a>().<a class="code" href="classAssembleur__base.html#a545320f11a7a922a722a5be44ac16e96">corriger_vitesses</a>(sol_M, dv);
<a name="l00496"></a>00496       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;PISO : |dp| &lt; &quot;</span> &lt;&lt; <a class="code" href="DoubleVect_8cpp.html#acb21ec8c0b3909c26b20e3f3455e0289">mp_max_abs_vect</a>(p_sol[0]) / dt &lt;&lt; <span class="stringliteral">&quot; |dv| &lt; &quot;</span> &lt;&lt; <a class="code" href="DoubleVect_8cpp.html#acb21ec8c0b3909c26b20e3f3455e0289">mp_max_abs_vect</a>(dv);
<a name="l00497"></a>00497       v_new += dv, sol_M /= dt, pression -= sol_M;
<a name="l00498"></a>00498 <span class="comment">// </span>
<a name="l00499"></a>00499       p_sec[0] = 0, op_div.<a class="code" href="classOperateur__Div.html#aeb7f9d269b7d93314ce9583f0fa1f57d" title="Ajoute la contribution de l&#39;operateur au tableau passe en parametre.">ajouter</a>(v_new, p_sec[0]);
<a name="l00500"></a>00500       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot; |div v| &lt; &quot;</span> &lt;&lt; <a class="code" href="DoubleVect_8cpp.html#acb21ec8c0b3909c26b20e3f3455e0289">mp_max_abs_vect</a>(p_sec[0]) &lt;&lt; finl;
<a name="l00501"></a>00501       pression.echange_espace_virtuel();
<a name="l00502"></a>00502     }
<a name="l00503"></a>00503   current = v_new;
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Dec 14 2021 19:35:36 for TRUST by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>

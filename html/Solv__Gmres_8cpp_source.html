<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TRUST: src/Kernel/Math/SolvSys/Solv_Gmres.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TRUST&#160;<span id="projectnumber">1.8.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">src/Kernel/Math/SolvSys/Solv_Gmres.cpp</div>  </div>
</div>
<div class="contents">
<a href="Solv__Gmres_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/****************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">* Copyright (c) 2021, CEA</span>
<a name="l00003"></a>00003 <span class="comment">* All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment">*</span>
<a name="l00005"></a>00005 <span class="comment">* Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<a name="l00006"></a>00006 <span class="comment">* 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
<a name="l00007"></a>00007 <span class="comment">* 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<a name="l00008"></a>00008 <span class="comment">* 3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
<a name="l00009"></a>00009 <span class="comment">*</span>
<a name="l00010"></a>00010 <span class="comment">* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<a name="l00011"></a>00011 <span class="comment">* IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;</span>
<a name="l00012"></a>00012 <span class="comment">* OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00013"></a>00013 <span class="comment">*</span>
<a name="l00014"></a>00014 <span class="comment">*****************************************************************************/</span>
<a name="l00015"></a>00015 <span class="comment">//</span>
<a name="l00016"></a>00016 <span class="comment">// </span>
<a name="l00017"></a>00017 <span class="comment">// File:        Solv_Gmres.cpp</span>
<a name="l00018"></a>00018 <span class="comment">// Directory:   $TRUST_ROOT/src/Kernel/Math/SolvSys</span>
<a name="l00019"></a>00019 <span class="comment">// Version:     /main/38</span>
<a name="l00020"></a>00020 <span class="comment">// </span>
<a name="l00021"></a>00021 <span class="comment">//</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="code" href="Solv__Gmres_8h.html">Solv_Gmres.h</a>&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="code" href="Matrice__Morse__Sym_8h.html">Matrice_Morse_Sym.h</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="Matrice__Bloc_8h.html">Matrice_Bloc.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="Motcle_8h.html">Motcle.h</a>&gt;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#ifdef CRAY</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="Solv__Gmres_8cpp.html#a14829a5a3099d0b499340f39a3fd0bc4">00032</a> <a class="code" href="Declare__Inst_8h.html#afcab3f7633508e92f2077d767e19bc60">Implemente_instanciable_sans_constructeur</a>(<a class="code" href="classSolv__Gmres.html">Solv_Gmres</a>,<span class="stringliteral">&quot;Solv_Gmres&quot;</span>,<a class="code" href="classsolv__iteratif.html">solv_iteratif</a>);
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="classSolv__Gmres.html#a33ea3691006e0e9ea8bbd4ee647c016c">00034</a> <a class="code" href="classSolv__Gmres.html#a33ea3691006e0e9ea8bbd4ee647c016c">Solv_Gmres::Solv_Gmres</a>()
<a name="l00035"></a>00035 {
<a name="l00036"></a>00036   <a class="code" href="classsolv__iteratif.html#a726974e9a0579e0c242606430dc320d4">seuil_</a> = 1.e-12;
<a name="l00037"></a>00037   <a class="code" href="classSolv__Gmres.html#a3ac2894e8171b06a5bb7a7b9a0f45d09">is_local_gmres</a>=0;
<a name="l00038"></a>00038   <a class="code" href="classSolv__Gmres.html#afc6e7d925b01a0205ee8ec68c41c38a0">precond_diag</a>=0;
<a name="l00039"></a>00039   <a class="code" href="classSolv__Gmres.html#a2e84b20ee812948e94ab7a9968566f7f">nb_it_max_</a> = 1000000;
<a name="l00040"></a>00040   <a class="code" href="classSolv__Gmres.html#a519c842fff83508aac53ba5d9254b044">controle_residu_</a> =0;
<a name="l00041"></a>00041   <a class="code" href="classSolv__Gmres.html#a8ce3f65b858c50f0064ea8bc421d5749">dim_espace_Krilov_</a>=10;
<a name="l00042"></a>00042 }
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment">// printOn et readOn</span>
<a name="l00045"></a><a class="code" href="classSolv__Gmres.html#a654b5debbed967bbdd53ecee630a20d3">00045</a> <a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; <a class="code" href="classSolv__Gmres.html#a654b5debbed967bbdd53ecee630a20d3" title="Ecriture de l&#39;objet sur un flot de sortie Methode a surcharger.">Solv_Gmres::printOn</a>(<a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; s )<span class="keyword"> const</span>
<a name="l00046"></a>00046 <span class="keyword"></span>{
<a name="l00047"></a>00047   s&lt;&lt;<span class="stringliteral">&quot; { seuil &quot;</span>&lt;&lt;<a class="code" href="classsolv__iteratif.html#a726974e9a0579e0c242606430dc320d4">seuil_</a>;
<a name="l00048"></a>00048   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Gmres.html#afc6e7d925b01a0205ee8ec68c41c38a0">precond_diag</a>)
<a name="l00049"></a>00049     s &lt;&lt;<span class="stringliteral">&quot; diag &quot;</span>;
<a name="l00050"></a>00050   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classSolv__Gmres.html#a3ac2894e8171b06a5bb7a7b9a0f45d09">is_local_gmres</a>) s&lt;&lt;<span class="stringliteral">&quot; sans_precond &quot;</span>;
<a name="l00051"></a>00051 
<a name="l00052"></a>00052   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Gmres.html#a519c842fff83508aac53ba5d9254b044">controle_residu_</a>) s&lt;&lt; <span class="stringliteral">&quot; controle_residu &quot;</span>&lt;&lt;<a class="code" href="classSolv__Gmres.html#a519c842fff83508aac53ba5d9254b044">controle_residu_</a>;
<a name="l00053"></a>00053   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Gmres.html#a2e84b20ee812948e94ab7a9968566f7f">nb_it_max_</a>!=1000000) s&lt;&lt;<span class="stringliteral">&quot; nb_it_max &quot;</span>&lt;&lt;<a class="code" href="classSolv__Gmres.html#a2e84b20ee812948e94ab7a9968566f7f">nb_it_max_</a>;
<a name="l00054"></a>00054   <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>()==1) s&lt;&lt;<span class="stringliteral">&quot; impr &quot;</span>;
<a name="l00055"></a>00055   <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>()==-1) s&lt;&lt;<span class="stringliteral">&quot; quiet &quot;</span>;
<a name="l00056"></a>00056   <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#a824322fe6a2c03aa986b8152aefcf14b" title="Drapeau pour savoir si un stockage disque est a refaire.">save_matrice_</a>) s&lt;&lt; <span class="stringliteral">&quot; save_matrice &quot;</span>;
<a name="l00057"></a>00057   s&lt;&lt;<span class="stringliteral">&quot; dim_espace_krilov &quot;</span>&lt;&lt;<a class="code" href="classSolv__Gmres.html#a8ce3f65b858c50f0064ea8bc421d5749">dim_espace_Krilov_</a>;
<a name="l00058"></a>00058   s&lt;&lt;<span class="stringliteral">&quot; } &quot;</span>;
<a name="l00059"></a>00059   <span class="keywordflow">return</span> s;
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="classSolv__Gmres.html#ab62adc02ce597269dd1ea40f6e00b5ce">00062</a> <a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; <a class="code" href="classSolv__Gmres.html#ab62adc02ce597269dd1ea40f6e00b5ce" title="Lecture d&#39;un Objet_U sur un flot d&#39;entree Methode a surcharger.">Solv_Gmres::readOn</a>(<a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; is )
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064   <a class="code" href="classMotcle.html" title="Une chaine de caractere (Nom) en majuscules.">Motcle</a> accolade_ouverte(<span class="stringliteral">&quot;{&quot;</span>);
<a name="l00065"></a>00065   <a class="code" href="classMotcle.html" title="Une chaine de caractere (Nom) en majuscules.">Motcle</a> accolade_fermee(<span class="stringliteral">&quot;}&quot;</span>);
<a name="l00066"></a>00066   <a class="code" href="classMotcles.html" title="Un tableau d&#39;objets de la classe Motcle.">Motcles</a> les_parametres(9);
<a name="l00067"></a>00067   {
<a name="l00068"></a>00068     les_parametres[0] = <span class="stringliteral">&quot;impr&quot;</span>;
<a name="l00069"></a>00069     les_parametres[1] = <span class="stringliteral">&quot;seuil&quot;</span>;
<a name="l00070"></a>00070     les_parametres[2] = <span class="stringliteral">&quot;diag&quot;</span>;
<a name="l00071"></a>00071     les_parametres[3] = <span class="stringliteral">&quot;sans_precond&quot;</span>;
<a name="l00072"></a>00072     les_parametres[4] = <span class="stringliteral">&quot;nb_it_max&quot;</span>;
<a name="l00073"></a>00073     les_parametres[5] = <span class="stringliteral">&quot;controle_residu&quot;</span>;
<a name="l00074"></a>00074     les_parametres[6] = <span class="stringliteral">&quot;save_matrice|save_matrix&quot;</span>;
<a name="l00075"></a>00075     les_parametres[7] = <span class="stringliteral">&quot;dim_espace_krilov&quot;</span>;
<a name="l00076"></a>00076     les_parametres[8] = <span class="stringliteral">&quot;quiet&quot;</span>;
<a name="l00077"></a>00077   }
<a name="l00078"></a>00078   <span class="keywordtype">int</span> rang;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080   <a class="code" href="classMotcle.html" title="Une chaine de caractere (Nom) en majuscules.">Motcle</a> motlu;
<a name="l00081"></a>00081   is &gt;&gt; motlu;
<a name="l00082"></a>00082   <span class="keywordflow">if</span> (motlu != accolade_ouverte)
<a name="l00083"></a>00083     {
<a name="l00084"></a>00084       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error when reading the GMRES parameters &quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00085"></a>00085       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;One expected &quot;</span> &lt;&lt; accolade_ouverte
<a name="l00086"></a>00086            &lt;&lt; <span class="stringliteral">&quot; instead of : &quot;</span> &lt;&lt; motlu &lt;&lt; finl;
<a name="l00087"></a>00087       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00088"></a>00088     }
<a name="l00089"></a>00089   is &gt;&gt; motlu;
<a name="l00090"></a>00090   <span class="keywordflow">while</span> (motlu != accolade_fermee)
<a name="l00091"></a>00091     {
<a name="l00092"></a>00092       rang = les_parametres.<a class="code" href="classMotcles.html#afecd68f73e904bc129022a236ff6ab15">search</a>(motlu);
<a name="l00093"></a>00093       <span class="keywordflow">switch</span>(rang)
<a name="l00094"></a>00094         {
<a name="l00095"></a>00095         <span class="keywordflow">case</span> 0:
<a name="l00096"></a>00096           {
<a name="l00097"></a>00097             <a class="code" href="classSolveurSys__base.html#a987e97740c779c1ab4192c3c1f1bbd5d">fixer_limpr</a>(1);
<a name="l00098"></a>00098             <span class="keywordflow">break</span>;
<a name="l00099"></a>00099           }
<a name="l00100"></a>00100         <span class="keywordflow">case</span> 8:
<a name="l00101"></a>00101           {
<a name="l00102"></a>00102             <a class="code" href="classSolveurSys__base.html#a987e97740c779c1ab4192c3c1f1bbd5d">fixer_limpr</a>(-1);
<a name="l00103"></a>00103             <span class="keywordflow">break</span>;
<a name="l00104"></a>00104           }
<a name="l00105"></a>00105         <span class="keywordflow">case</span> 1:
<a name="l00106"></a>00106           {
<a name="l00107"></a>00107             is &gt;&gt; <a class="code" href="classsolv__iteratif.html#a726974e9a0579e0c242606430dc320d4">seuil_</a>;
<a name="l00108"></a>00108             <span class="keywordflow">break</span>;
<a name="l00109"></a>00109           }
<a name="l00110"></a>00110         <span class="keywordflow">case</span> 2:
<a name="l00111"></a>00111           {
<a name="l00112"></a>00112             <a class="code" href="classSolv__Gmres.html#a3ac2894e8171b06a5bb7a7b9a0f45d09">is_local_gmres</a>=1;
<a name="l00113"></a>00113             <a class="code" href="classSolv__Gmres.html#afc6e7d925b01a0205ee8ec68c41c38a0">precond_diag</a>=1;
<a name="l00114"></a>00114             <span class="keywordflow">break</span>;
<a name="l00115"></a>00115           }
<a name="l00116"></a>00116         <span class="keywordflow">case</span> 3:
<a name="l00117"></a>00117           {
<a name="l00118"></a>00118             <a class="code" href="classSolv__Gmres.html#a3ac2894e8171b06a5bb7a7b9a0f45d09">is_local_gmres</a>=1;
<a name="l00119"></a>00119             <a class="code" href="classSolv__Gmres.html#afc6e7d925b01a0205ee8ec68c41c38a0">precond_diag</a>=0;
<a name="l00120"></a>00120             <span class="keywordflow">break</span>;
<a name="l00121"></a>00121           }
<a name="l00122"></a>00122         <span class="keywordflow">case</span> 4:
<a name="l00123"></a>00123           {
<a name="l00124"></a>00124             is&gt;&gt;<a class="code" href="classSolv__Gmres.html#a2e84b20ee812948e94ab7a9968566f7f">nb_it_max_</a>;
<a name="l00125"></a>00125             <span class="keywordflow">break</span>;
<a name="l00126"></a>00126           }
<a name="l00127"></a>00127         <span class="keywordflow">case</span> 5:
<a name="l00128"></a>00128           {
<a name="l00129"></a>00129             is&gt;&gt;<a class="code" href="classSolv__Gmres.html#a519c842fff83508aac53ba5d9254b044">controle_residu_</a>;
<a name="l00130"></a>00130             <span class="keywordflow">break</span>;
<a name="l00131"></a>00131           }
<a name="l00132"></a>00132         <span class="keywordflow">case</span> 6:
<a name="l00133"></a>00133           {
<a name="l00134"></a>00134             <a class="code" href="classSolveurSys__base.html#a824322fe6a2c03aa986b8152aefcf14b" title="Drapeau pour savoir si un stockage disque est a refaire.">save_matrice_</a>=1;
<a name="l00135"></a>00135             <span class="keywordflow">break</span>;
<a name="l00136"></a>00136           }
<a name="l00137"></a>00137         <span class="keywordflow">case</span> 7:
<a name="l00138"></a>00138           {
<a name="l00139"></a>00139             is &gt;&gt;<a class="code" href="classSolv__Gmres.html#a8ce3f65b858c50f0064ea8bc421d5749">dim_espace_Krilov_</a>;
<a name="l00140"></a>00140             <span class="keywordflow">break</span>;
<a name="l00141"></a>00141           }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143         <span class="keywordflow">default</span> :
<a name="l00144"></a>00144           {
<a name="l00145"></a>00145             <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error when reading the Gmres parameters &quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00146"></a>00146             <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;One expected a word among &quot;</span> &lt;&lt; les_parametres
<a name="l00147"></a>00147                  &lt;&lt; <span class="stringliteral">&quot; instead of &quot;</span> &lt;&lt; motlu &lt;&lt; finl;
<a name="l00148"></a>00148             <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00149"></a>00149           }
<a name="l00150"></a>00150         }
<a name="l00151"></a>00151       is &gt;&gt; motlu;
<a name="l00152"></a>00152     }
<a name="l00153"></a>00153   <span class="keywordflow">return</span> is;
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 
<a name="l00158"></a><a class="code" href="classSolv__Gmres.html#afabce21994817ecf4c4669057c950b40">00158</a> <span class="keywordtype">int</span> <a class="code" href="classSolv__Gmres.html#afabce21994817ecf4c4669057c950b40">Solv_Gmres::resoudre_systeme</a>(<span class="keyword">const</span> <a class="code" href="classMatrice__Base.html">Matrice_Base</a>&amp; la_matrice,
<a name="l00159"></a>00159                                  <span class="keyword">const</span> <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; secmem,
<a name="l00160"></a>00160                                  <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; solution)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162   <span class="keywordflow">if</span>(<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>,la_matrice))
<a name="l00163"></a>00163     {
<a name="l00164"></a>00164       <span class="keyword">const</span> <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; matrice = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>, la_matrice);
<a name="l00165"></a>00165       <span class="keywordtype">int</span> retour= <a class="code" href="classSolv__Gmres.html#a2a1a062af95a7bb6d4352994753ccc68">Gmres</a>(matrice,secmem,solution);
<a name="l00166"></a>00166       <a class="code" href="classDoubleVect.html">DoubleVect</a> b(secmem);
<a name="l00167"></a>00167       matrice.<a class="code" href="classMatrice__Base.html#a05caa487a25a6d5e7fbd38d4b2f4ee1e" title="Multiplication d&#39;un vecteur par la matrice. Operation: r = A*x.">multvect</a>(solution, b);
<a name="l00168"></a>00168 <span class="comment">// Cerr &lt;&lt; &quot; b :&quot; &lt;&lt; b&lt;&lt; finl;</span>
<a name="l00169"></a>00169 <span class="comment">// Cerr &lt;&lt; &quot; secmem :&quot; &lt;&lt; secmem&lt;&lt; finl;</span>
<a name="l00170"></a>00170       b-=secmem;
<a name="l00171"></a>00171 <span class="comment">// Cerr &lt;&lt; &quot;||residu|| = &quot; &lt;&lt; b.norme() &lt;&lt; finl;</span>
<a name="l00172"></a>00172       <span class="keywordflow">return</span> retour;
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174   <span class="keywordflow">else</span>
<a name="l00175"></a>00175     {
<a name="l00176"></a>00176       <span class="keywordflow">if</span>(<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Bloc.html">Matrice_Bloc</a>,la_matrice))
<a name="l00177"></a>00177         {
<a name="l00178"></a>00178           <span class="keyword">const</span> <a class="code" href="classMatrice__Bloc.html">Matrice_Bloc</a>&amp; matrice = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classMatrice__Bloc.html">Matrice_Bloc</a>,la_matrice);
<a name="l00179"></a>00179           <span class="keywordflow">if</span>(matrice.<a class="code" href="classMatrice__Bloc.html#a02193255787b0ecae7988ca4eada3b4b" title="retourne N_">nb_bloc_lignes</a>()&gt;1)
<a name="l00180"></a>00180             {
<a name="l00181"></a>00181               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a>&lt;&lt;<span class="stringliteral">&quot;Solv_Gmres : WARNING : one is not able to carry out Gmres by blocks&quot;</span>&lt;&lt;<a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00182"></a>00182               <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00183"></a>00183               <span class="keywordflow">return</span>(-1);
<a name="l00184"></a>00184             }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186           <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>() &gt; 1)
<a name="l00187"></a>00187             {
<a name="l00188"></a>00188               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a>&lt;&lt;<span class="stringliteral">&quot;Solv_Gmres : WARNING : one is not able to carry out parallel calculation with Gmres&quot;</span>&lt;&lt;<a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00189"></a>00189               <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00190"></a>00190               <span class="keywordflow">return</span>(-1);
<a name="l00191"></a>00191             }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193           <span class="keyword">const</span> <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; MB00 = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>,matrice.<a class="code" href="classMatrice__Bloc.html#a7ffa38f7b93454432b2df7c616ed0a4e">get_bloc</a>(0,0).<a class="code" href="classDeriv__Matrice__Base.html#ae43f3a90ca16518c191f9e7d5ebef912">valeur</a>());
<a name="l00194"></a>00194           <span class="keywordtype">int</span> retour= <a class="code" href="classSolv__Gmres.html#a2a1a062af95a7bb6d4352994753ccc68">Gmres</a>(MB00,secmem,solution);
<a name="l00195"></a>00195           <span class="keywordflow">return</span> retour;
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197       <span class="keywordflow">else</span>
<a name="l00198"></a>00198         {
<a name="l00199"></a>00199           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a>&lt;&lt;<span class="stringliteral">&quot;Solv_Gmres : WARNING : only linear systems based on Matrice_Morse_Sym or Matrice_Bloc type matrixes can be solved&quot;</span>&lt;&lt;<a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00200"></a>00200           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00201"></a>00201           <span class="keywordflow">return</span>(-1);
<a name="l00202"></a>00202         }
<a name="l00203"></a>00203     }
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="Solv__Gmres_8cpp.html#afbc5853c7d6e7c4d9b3e3b54022af3c6">00208</a> <span class="keywordtype">int</span> <a class="code" href="Solv__Gmres_8cpp.html#afbc5853c7d6e7c4d9b3e3b54022af3c6">gmres_local</a>( <span class="keyword">const</span> <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; A, <span class="keyword">const</span> <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; b,<a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; x1,<span class="keywordtype">double</span>&amp; seuil,<span class="keywordtype">int</span> precond_diag,<span class="keywordtype">int</span>&amp; nb_it_max,<span class="keywordtype">int</span>&amp;
<a name="l00209"></a>00209                  controle_residu,<a class="code" href="Vect_8h.html#adc7c7b04809c9aec2cb897cd2ef06378">VECT</a>(<a class="code" href="classDoubleVect.html">DoubleVect</a>)&amp; v,<span class="keywordtype">int</span> dim_espace_Krilov, <span class="keywordtype">int</span> limpr_=0)
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="comment">// Copied from SouConPhase_field (scalar)//</span>
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213 <span class="comment">// return le_solveur_.resoudre_systeme(A,b,x1);</span>
<a name="l00214"></a>00214 <span class="comment">// A.inverse(b,x1,seuil); return 1;</span>
<a name="l00215"></a>00215 
<a name="l00216"></a>00216   <span class="keywordtype">int</span> i,j,nk,i0,im,it,ii;
<a name="l00217"></a>00217   <span class="keywordtype">double</span> tem=1.,res,ccos,ssin ;
<a name="l00218"></a>00218 <span class="comment">// PL c&#39;est pas joli et c&#39;est de moi mais je ne comprends pas pourquoi</span>
<a name="l00219"></a>00219 <span class="comment">// l&#39;utilisation de b.size_reelle() plante sur la matrice en pression depuis la 1.6.0 (non teste)</span>
<a name="l00220"></a>00220 <span class="comment">// Qu&#39;est ce qui est fait en implicite pour b.size_reelle() soit &gt;=0 ???</span>
<a name="l00221"></a>00221   <span class="keyword">const</span> <span class="keywordtype">int</span> ns=(b.<a class="code" href="classDoubleVect.html#aafef4b3a96cdc428d62c5cedc9af6112">size_reelle_ok</a>()?b.<a class="code" href="classDoubleVect.html#a4a6987db458541cdcd10495955f25263" title="Taille de l&#39;espace &quot;reel&quot; du vecteur. (si md_vector_ est nul, cette valeur est identique a size_arr...">size_reelle</a>():b.<a class="code" href="classArrOfDouble.html#a3c3b33bea0e88b87315c21ee94bee05f" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>());
<a name="l00222"></a>00222 
<a name="l00223"></a>00223   <span class="keywordtype">int</span> nb_ligne_tot=(int)<a class="code" href="classProcess.html#a7d23bc1ef94b3f0623fbc79d034c27fd" title="Calcule la somme de x sur tous les processeurs du groupe courant. Voir aussi mp_max()">Process::mp_sum</a>((<span class="keywordtype">double</span>) ns);
<a name="l00224"></a>00224 <span class="comment">// Ajoute par DJ</span>
<a name="l00225"></a>00225 <span class="comment">// --------------</span>
<a name="l00226"></a>00226 <span class="comment">// int nb_elem_tot = b.size_totale();</span>
<a name="l00227"></a>00227 <span class="comment">// DoubleVect x1(x);</span>
<a name="l00228"></a>00228 <span class="comment">// x1=0.;</span>
<a name="l00229"></a>00229 <span class="comment">// for(int n_elem=0; n_elem&lt;nb_elem_tot; n_elem++)</span>
<a name="l00230"></a>00230 <span class="comment">// {</span>
<a name="l00231"></a>00231 <span class="comment">// x1(n_elem)=x(n_elem);</span>
<a name="l00232"></a>00232 <span class="comment">// }</span>
<a name="l00233"></a>00233 <span class="comment">// --------------</span>
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 <span class="comment">// A present dans le jdd</span>
<a name="l00236"></a>00236   <span class="keywordtype">double</span> epsGMRES=1.e-10*0;
<a name="l00237"></a>00237   <span class="keywordtype">int</span> nkr=<a class="code" href="Double_8h.html#a1c45761573e6cbc97cfacac78d905016">max</a>(10,nb_ligne_tot/2);                         <span class="comment">//!&lt; dimension de l&#39;espace de Krylov nkr=10;</span>
<a name="l00238"></a>00238 <span class="comment"></span><span class="comment">//</span>
<a name="l00239"></a>00239   nkr=dim_espace_Krilov;
<a name="l00240"></a>00240   <span class="keywordtype">int</span> nit1=<a class="code" href="Double_8h.html#a1c45761573e6cbc97cfacac78d905016">max</a>(20,nb_ligne_tot);
<a name="l00241"></a>00241   <span class="keywordtype">int</span> nit=<a class="code" href="Double_8h.html#a2f8edc4561e9744ed4233b205fa7ec32">min</a>(nb_it_max,nit1);
<a name="l00242"></a>00242   <span class="keywordtype">double</span> rec_min = seuil;
<a name="l00243"></a>00243   <span class="keywordtype">double</span> rec_max = 0.1  ;
<a name="l00244"></a>00244   <span class="keywordtype">double</span> res2_old=-1;
<a name="l00245"></a>00245   <span class="keywordflow">if</span> (v.<a class="code" href="classDoubleVect.html#a392c1f20b462563365389d28e0853867" title="Identique a size_reelle()">size</a>()==0)
<a name="l00246"></a>00246     v.dimensionner(nkr);                         <span class="comment">//!&lt; Krilov vectors</span>
<a name="l00247"></a>00247 <span class="comment"></span>  <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a> h(nkr+1,nkr);                <span class="comment">//!&lt; Heisenberg maatrix of coefficients</span>
<a name="l00248"></a>00248 <span class="comment"></span>  <a class="code" href="classDoubleVect.html">DoubleVect</a> r(nkr+1);
<a name="l00249"></a>00249   <a class="code" href="classDoubleVect.html">DoubleVect</a> v0(x1);
<a name="l00250"></a>00250   <a class="code" href="classDoubleVect.html">DoubleVect</a> v1(x1) ;
<a name="l00251"></a>00251   <span class="keywordtype">int</span> ns2=ns;
<a name="l00252"></a>00252   <a class="code" href="classDoubleVect.html">DoubleVect</a> Diag(ns);
<a name="l00253"></a>00253   Diag=1.;
<a name="l00254"></a>00254   <span class="keywordflow">if</span> (precond_diag)
<a name="l00255"></a>00255     <span class="keywordflow">for</span> ( i=0; i&lt;ns; i++)
<a name="l00256"></a>00256       Diag[i]=1./A(i,i);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="comment">// Initialisation</span>
<a name="l00259"></a>00259   v0 = 0. ;
<a name="l00260"></a>00260   v1 = 0. ;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262   A.<a class="code" href="classMatrice__Base.html#a8e710142a55d65a007a89e0ccc36ed62">multvect_</a>(x1,v0);
<a name="l00263"></a>00263   v0 *= -1. ;
<a name="l00264"></a>00264   v0+=b;
<a name="l00265"></a>00265   v0.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00266"></a>00266   <span class="keywordtype">double</span> res0 = <a class="code" href="DoubleVect_8cpp.html#afaa33f0032aa927d8d54ff9fb002b749">mp_norme_vect</a>(v0);
<a name="l00267"></a>00267   <span class="keywordflow">for</span> (ii=0; ii&lt;ns2; ii++)
<a name="l00268"></a>00268     v0(ii)*=Diag(ii);
<a name="l00269"></a>00269   res = <a class="code" href="DoubleVect_8cpp.html#afaa33f0032aa927d8d54ff9fb002b749">mp_norme_vect</a>(v0);
<a name="l00270"></a>00270   <span class="keywordflow">if</span> (limpr_==1)
<a name="l00271"></a>00271     <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a>&lt;&lt;<span class="stringliteral">&quot;Gmres : initial residual = &quot;</span>&lt;&lt;res0&lt;&lt;<a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00272"></a>00272 <span class="comment">// See http://stackoverflow.com/questions/3437085/check-nan-number</span>
<a name="l00273"></a>00273 <span class="comment">// May be could be interesting to implement isnan function somewhere</span>
<a name="l00274"></a>00274   <span class="keywordflow">if</span> (res0!=res0)
<a name="l00275"></a>00275     {
<a name="l00276"></a>00276       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Nan detected in Solv_Gmres::gmres_local()&quot;</span> &lt;&lt; finl;
<a name="l00277"></a>00277       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Contact TRUST support.&quot;</span> &lt;&lt; finl;
<a name="l00278"></a>00278       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280   rec_min = (rec_min&lt;res*epsGMRES) ? res*epsGMRES : rec_min;
<a name="l00281"></a>00281   rec_min = (rec_min&lt;rec_max) ? rec_min : rec_max ;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 <span class="comment">// iterations</span>
<a name="l00284"></a>00284   <span class="keywordflow">for</span>(it=0; it&lt;nit; it++)
<a name="l00285"></a>00285     {
<a name="l00286"></a>00286       <span class="keywordflow">if</span> (res==0) <span class="keywordflow">return</span> 0; <span class="comment">//!&lt; nothing to do</span>
<a name="l00287"></a>00287 <span class="comment"></span>      nk = nkr;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="comment">// ...Orthogonalisation of Arnoldi</span>
<a name="l00290"></a>00290       v0 /= res;
<a name="l00291"></a>00291       r = 0. ;
<a name="l00292"></a>00292       r[0] = res;
<a name="l00293"></a>00293       h=0.;
<a name="l00294"></a>00294       <span class="keywordflow">for</span>(j=0; j&lt;nkr; j++)
<a name="l00295"></a>00295         {
<a name="l00296"></a>00296           v0.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00297"></a>00297           v[j]=v0;
<a name="l00298"></a>00298           A.<a class="code" href="classMatrice__Base.html#a05caa487a25a6d5e7fbd38d4b2f4ee1e" title="Multiplication d&#39;un vecteur par la matrice. Operation: r = A*x.">multvect</a>(v0,v1);
<a name="l00299"></a>00299           <span class="keywordflow">for</span> (ii=0; ii&lt;ns2; ii++) v1(ii)*=Diag(ii);
<a name="l00300"></a>00300           v0 = v1 ;
<a name="l00301"></a>00301 <span class="comment">// Modifie par DJ</span>
<a name="l00302"></a>00302 <span class="comment">// ---------------</span>
<a name="l00303"></a>00303           <span class="keywordflow">for</span>(i=0; i&lt;=j; i++)
<a name="l00304"></a>00304             {
<a name="l00305"></a>00305               <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; vvi=v[i];
<a name="l00306"></a>00306               h(i,j)+=<a class="code" href="DoubleVect_8cpp.html#a07d13cbdadca6b60d5e128653f52a4bb">mp_prodscal</a>(v0,vvi);
<a name="l00307"></a>00307               <span class="keywordflow">for</span> (ii=0; ii&lt;ns; ii++) v0(ii) -= h(i,j) * vvi(ii);
<a name="l00308"></a>00308               v0.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00309"></a>00309             }
<a name="l00310"></a>00310           tem=<a class="code" href="DoubleVect_8cpp.html#afaa33f0032aa927d8d54ff9fb002b749">mp_norme_vect</a>(v0);
<a name="l00311"></a>00311 
<a name="l00312"></a>00312           h(j+1,j) = tem;
<a name="l00313"></a>00313           <span class="keywordflow">if</span>(tem&lt;rec_min)
<a name="l00314"></a>00314             {
<a name="l00315"></a>00315               nk = j+1;
<a name="l00316"></a>00316               <span class="keywordflow">goto</span> l5;
<a name="l00317"></a>00317             }
<a name="l00318"></a>00318           v0 /= tem;
<a name="l00319"></a>00319         }
<a name="l00320"></a>00320 <span class="comment">// ...Triangularisation</span>
<a name="l00321"></a>00321 l5:
<a name="l00322"></a>00322       <span class="keywordflow">for</span>(i=0; i&lt;nk; i++)
<a name="l00323"></a>00323         {
<a name="l00324"></a>00324           im = i+1;
<a name="l00325"></a>00325           tem = 1./sqrt(h(i,i)*h(i,i) + h(im,i)*h(im,i));
<a name="l00326"></a>00326           ccos = h(i,i) * tem;
<a name="l00327"></a>00327           ssin = - h(im,i) * tem;
<a name="l00328"></a>00328           <span class="keywordflow">for</span>(j=i; j&lt;nk; j++)
<a name="l00329"></a>00329             {
<a name="l00330"></a>00330               tem = h(i,j);
<a name="l00331"></a>00331               h(i,j) = ccos * tem - ssin * h(im,j);
<a name="l00332"></a>00332               h(im,j) =  ssin * tem + ccos * h(im,j);
<a name="l00333"></a>00333             }
<a name="l00334"></a>00334           r[im] = ssin * r[i];
<a name="l00335"></a>00335           r[i] *= ccos;
<a name="l00336"></a>00336         }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="comment">// ...Solution of linear system</span>
<a name="l00339"></a>00339       <span class="keywordflow">for</span>(i=nk-1; i&gt;=0; i--)
<a name="l00340"></a>00340         {
<a name="l00341"></a>00341           r[i] /= h(i,i);
<a name="l00342"></a>00342           <span class="keywordflow">for</span>(i0=i-1; i0&gt;=0; i0--)
<a name="l00343"></a>00343             r[i0] -= h(i0,i)* r[i];
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345       <span class="keywordflow">for</span>(i=0; i&lt;nk; i++)
<a name="l00346"></a>00346         {
<a name="l00347"></a>00347           <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; vvi=v[i];
<a name="l00348"></a>00348           <span class="keywordflow">for</span>(ii=0; ii&lt;ns; ii++)  x1(ii) += r[i]*vvi(ii);
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350       x1.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l00351"></a>00351       A.<a class="code" href="classMatrice__Base.html#a8e710142a55d65a007a89e0ccc36ed62">multvect_</a>(x1,v0);
<a name="l00352"></a>00352       v0 *= -1. ;
<a name="l00353"></a>00353       v0+=b;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 <span class="comment">// calcul du residu sans le precond....</span>
<a name="l00356"></a>00356       <span class="keywordtype">double</span> res2=<a class="code" href="DoubleVect_8cpp.html#afaa33f0032aa927d8d54ff9fb002b749">mp_norme_vect</a>(v0);
<a name="l00357"></a>00357       <span class="keywordflow">if</span> ((it&gt;0) &amp;&amp; (controle_residu==1) &amp;&amp; (<a class="code" href="Double_8h.html#a2c495f52155e100aae5a8903602ff590">sup_strict</a>(res2,res2_old)))
<a name="l00358"></a>00358         {
<a name="l00359"></a>00359           <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;The Gmres iterative system is stopped after : &quot;</span> &lt;&lt; it+1 &lt;&lt;<span class="stringliteral">&quot; iterations &quot;</span>&lt;&lt;finl;
<a name="l00360"></a>00360           <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;since an increase of the residue is detected.&quot;</span>&lt;&lt; finl;
<a name="l00361"></a>00361           <span class="keywordflow">return</span> it;
<a name="l00362"></a>00362         }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364       res2_old = res2;
<a name="l00365"></a>00365       <span class="keywordflow">if</span> (limpr_==1)
<a name="l00366"></a>00366         <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a>&lt;&lt;<span class="stringliteral">&quot; - At it = &quot;</span>&lt;&lt; it+1 &lt;&lt;<span class="stringliteral">&quot;, residu scalar = &quot;</span>&lt;&lt; res2 &lt;&lt; finl;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 <span class="comment">// Test d&#39;arret sur le residu</span>
<a name="l00369"></a>00369       <span class="keywordflow">if</span>(res2&lt;rec_min)
<a name="l00370"></a>00370         {
<a name="l00371"></a>00371 <span class="comment">// Ajoute par DJ</span>
<a name="l00372"></a>00372 <span class="comment">// --------------</span>
<a name="l00373"></a>00373           <span class="keywordflow">if</span> (limpr_&gt;-1)
<a name="l00374"></a>00374             {
<a name="l00375"></a>00375               <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Gmres : Number of iterations to reach convergence : &quot;</span> &lt;&lt; it+1 &lt;&lt; finl;
<a name="l00376"></a>00376               <span class="keywordtype">double</span> residu_relatif = (res0&gt;0?res2/res0:res2);
<a name="l00377"></a>00377               <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Final residue: &quot;</span> &lt;&lt; res2 &lt;&lt; <span class="stringliteral">&quot; ( &quot;</span> &lt;&lt; residu_relatif &lt;&lt; <span class="stringliteral">&quot; )&quot;</span> &lt;&lt; finl;
<a name="l00378"></a>00378             }
<a name="l00379"></a>00379           <span class="keywordflow">return</span> it+1;
<a name="l00380"></a>00380         }
<a name="l00381"></a>00381 <span class="comment">// Test d&#39;arret sur le nombre d&#39;iterations max</span>
<a name="l00382"></a>00382       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (it==nit-1)
<a name="l00383"></a>00383         {
<a name="l00384"></a>00384 <span class="comment">// Ajoute par DJ</span>
<a name="l00385"></a>00385 <span class="comment">// --------------</span>
<a name="l00386"></a>00386 <span class="comment">// On fait le choix de mettre a jour c_demi et mutilde_demi meme s&#39;il n&#39;y a pas convergence...</span>
<a name="l00387"></a>00387 
<a name="l00388"></a>00388 <span class="comment">// x=x1;</span>
<a name="l00389"></a>00389 <span class="comment">// --------------</span>
<a name="l00390"></a>00390           <span class="keywordflow">if</span> (limpr_&gt;-1)
<a name="l00391"></a>00391             {
<a name="l00392"></a>00392               <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Gmres : Stopped after &quot;</span>&lt;&lt; it+1 &lt;&lt;<span class="stringliteral">&quot; iterations (=nb_it_max)&quot;</span>&lt;&lt; finl;
<a name="l00393"></a>00393               <span class="keywordtype">double</span> residu_relatif = (res0&gt;0?res2/res0:res2);
<a name="l00394"></a>00394               <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Final residue: &quot;</span> &lt;&lt; res2 &lt;&lt; <span class="stringliteral">&quot; ( &quot;</span> &lt;&lt; residu_relatif &lt;&lt; <span class="stringliteral">&quot; )&quot;</span> &lt;&lt; finl;
<a name="l00395"></a>00395             }
<a name="l00396"></a>00396           <span class="keywordflow">if</span> (it == (nb_ligne_tot-1))
<a name="l00397"></a>00397             {
<a name="l00398"></a>00398               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span>&lt;&lt; finl;
<a name="l00399"></a>00399               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;!!! Gmres stopped after a number of iterations equal to the matrix size. &quot;</span>&lt;&lt; finl;
<a name="l00400"></a>00400               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;!!! Either your matrix is ill-conditioned (try cholesky instead), or your convergence threshold is too low. &quot;</span>&lt;&lt; finl;
<a name="l00401"></a>00401               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span>&lt;&lt; finl;
<a name="l00402"></a>00402               <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>(-1);
<a name="l00403"></a>00403             }
<a name="l00404"></a>00404           <span class="keywordflow">return</span> it+1;
<a name="l00405"></a>00405         }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="comment">// Calcul du residu avec preconditionnement</span>
<a name="l00408"></a>00408       <span class="keywordflow">for</span> (ii=0; ii&lt;ns2; ii++) v0(ii)*=Diag(ii);
<a name="l00409"></a>00409       res = <a class="code" href="DoubleVect_8cpp.html#afaa33f0032aa927d8d54ff9fb002b749">mp_norme_vect</a>(v0);
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411   <span class="keywordflow">return</span> -1;
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 
<a name="l00415"></a><a class="code" href="classSolv__Gmres.html#a2a1a062af95a7bb6d4352994753ccc68">00415</a> <span class="keywordtype">int</span> <a class="code" href="classSolv__Gmres.html#a2a1a062af95a7bb6d4352994753ccc68">Solv_Gmres::Gmres</a>(<span class="keyword">const</span> <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; matrice,
<a name="l00416"></a>00416                       <span class="keyword">const</span> <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; secmem,
<a name="l00417"></a>00417                       <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; solution)
<a name="l00418"></a>00418 {
<a name="l00419"></a>00419   <span class="keywordflow">if</span> (!<a class="code" href="classSolv__Gmres.html#a3ac2894e8171b06a5bb7a7b9a0f45d09">is_local_gmres</a>)
<a name="l00420"></a>00420     <span class="keywordflow">return</span> matrice.<a class="code" href="classMatrice__Morse.html#a53383f880cbb5efcfddc92c1e570fc9c" title="Calcule la solution du systeme lineaire: A * solution = secmem. La methode utilisee est GMRES precond...">inverse</a>(secmem, solution, <a class="code" href="classsolv__iteratif.html#a726974e9a0579e0c242606430dc320d4">seuil_</a>);
<a name="l00421"></a>00421   <span class="keywordflow">else</span>
<a name="l00422"></a>00422     <span class="keywordflow">return</span> <a class="code" href="Solv__Gmres_8cpp.html#afbc5853c7d6e7c4d9b3e3b54022af3c6">gmres_local</a>(matrice,secmem,solution,<a class="code" href="classsolv__iteratif.html#a726974e9a0579e0c242606430dc320d4">seuil_</a>,precond_diag,<a class="code" href="classSolv__Gmres.html#a2e84b20ee812948e94ab7a9968566f7f">nb_it_max_</a>,<a class="code" href="classSolv__Gmres.html#a519c842fff83508aac53ba5d9254b044">controle_residu_</a>,<a class="code" href="classSolv__Gmres.html#a754b8e06f3173c8d1c795f92b81179ff">v</a>,<a class="code" href="classSolv__Gmres.html#a8ce3f65b858c50f0064ea8bc421d5749">dim_espace_Krilov_</a>,<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>());
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Dec 14 2021 19:35:23 for TRUST by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TRUST: src/Kernel/Utilitaires/Comm_Group_MPI.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TRUST&#160;<span id="projectnumber">1.8.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">src/Kernel/Utilitaires/Comm_Group_MPI.cpp</div>  </div>
</div>
<div class="contents">
<a href="Comm__Group__MPI_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/****************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">* Copyright (c) 2020, CEA</span>
<a name="l00003"></a>00003 <span class="comment">* All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment">*</span>
<a name="l00005"></a>00005 <span class="comment">* Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<a name="l00006"></a>00006 <span class="comment">* 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
<a name="l00007"></a>00007 <span class="comment">* 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<a name="l00008"></a>00008 <span class="comment">* 3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
<a name="l00009"></a>00009 <span class="comment">*</span>
<a name="l00010"></a>00010 <span class="comment">* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<a name="l00011"></a>00011 <span class="comment">* IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;</span>
<a name="l00012"></a>00012 <span class="comment">* OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00013"></a>00013 <span class="comment">*</span>
<a name="l00014"></a>00014 <span class="comment">*****************************************************************************/</span>
<a name="l00015"></a>00015 <span class="comment">//</span>
<a name="l00016"></a>00016 <span class="comment">// </span>
<a name="l00017"></a>00017 <span class="comment">// File:        Comm_Group_MPI.cpp</span>
<a name="l00018"></a>00018 <span class="comment">// Directory:   $TRUST_ROOT/src/Kernel/Utilitaires</span>
<a name="l00019"></a>00019 <span class="comment">// Version:     /main/39</span>
<a name="l00020"></a>00020 <span class="comment">// </span>
<a name="l00021"></a>00021 <span class="comment">//</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;<a class="code" href="Comm__Group__MPI_8h.html">Comm_Group_MPI.h</a>&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;petsc_for_kernel.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="code" href="PE__Groups_8h.html">PE_Groups.h</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="stat__counters_8h.html">stat_counters.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="Statistiques_8h.html">Statistiques.h</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="Comm__Group__MPI_8cpp.html#a0f83c3cf9184aee6eb558f6d83c6984a">00030</a> <a class="code" href="Declare__Inst_8h.html#a1a414570e3c7a7f9787a0eba4e9366e8">Implemente_instanciable_sans_constructeur_ni_destructeur</a>(<a class="code" href="classComm__Group__MPI.html" title=": Classe Comm_Group_MPI, derivee de la classe abstraite Comm_Group. Cette classe represente un groupe...">Comm_Group_MPI</a>,<span class="stringliteral">&quot;Comm_Group_MPI&quot;</span>,<a class="code" href="classComm__Group.html" title=": Cette classe decrit un groupe de processeurs sur lesquels une portion de code s&#39;execute simultaneme...">Comm_Group</a>);
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#ifdef INT_is_64_</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#define MPI_ENTIER MPI_LONG</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00037"></a><a class="code" href="Comm__Group__MPI_8cpp.html#a9b683f6cb98289e218b17558829d3e80">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define MPI_ENTIER MPI_INT</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span>MPI_Status  * <a class="code" href="classComm__Group__MPI.html#ac297dcc148131d510d555cf3a19e4c8b">Comm_Group_MPI::mpi_status_</a> = 0;
<a name="l00040"></a>00040 MPI_Request * <a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">Comm_Group_MPI::mpi_requests_</a> = 0;
<a name="l00041"></a>00041 <span class="keywordtype">int</span> <a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">Comm_Group_MPI::mpi_nrequests_</a> = -1;
<a name="l00042"></a>00042 <span class="keywordtype">int</span> <a class="code" href="classComm__Group__MPI.html#aa1fe9449dec78267c37c1b9ca273d519">Comm_Group_MPI::mpi_maxrequests_</a> = -1;
<a name="l00043"></a>00043 <span class="keywordtype">int</span> <a class="code" href="classComm__Group__MPI.html#a875660d93ebcfb12b9a6f32298cdcda3" title="La taille des donnees envoyees/recues pour le send_recv_start courant.">Comm_Group_MPI::current_msg_size_</a>;
<a name="l00044"></a>00044 MPI_Comm <a class="code" href="classComm__Group__MPI.html#a2646c7c94faa11b114305ec5aeb37daf">Comm_Group_MPI::trio_u_world_</a> = MPI_COMM_WORLD;
<a name="l00045"></a>00045 <span class="comment">// By default, we initialize mpi at statup (see set_must_mpi_initialize())</span>
<a name="l00046"></a>00046 <span class="keywordtype">int</span> <a class="code" href="classComm__Group__MPI.html#a1f180b302e5dee0d59b1bc2d92191358">Comm_Group_MPI::must_mpi_initialize_</a> = 1;
<a name="l00047"></a>00047 <span class="comment">//</span>
<a name="l00048"></a>00048 <span class="comment">//</span><span class="comment"></span>
<a name="l00049"></a>00049 <span class="comment">//! Partie non inline du traitement d&#39;erreur mpi.&lt;br&gt;Affichage d&#39;un code d&#39;erreur mpi avec MPI_Error_string.</span>
<a name="l00050"></a><a class="code" href="Comm__Group__MPI_8cpp.html#a5b117da44411e948e8c880a6e924a547">00050</a> <span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="Comm__Group__MPI_8cpp.html#a5b117da44411e948e8c880a6e924a547" title="Partie non inline du traitement d&#39;erreur mpi. Affichage d&#39;un code d&#39;erreur mpi avec MPI_Error_string...">mpi_print_error</a>(<span class="keywordtype">int</span> error_code)
<a name="l00051"></a>00051 {
<a name="l00052"></a>00052   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;mpi_error in Comm_Group_MPI : error_code = &quot;</span> &lt;&lt; error_code &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00053"></a>00053   <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Process::Journal</a>() &lt;&lt; <span class="stringliteral">&quot;mpi_error in Comm_Group_MPI : error_code = &quot;</span> &lt;&lt; error_code &lt;&lt; finl;
<a name="l00054"></a>00054   <a class="code" href="arch_8h.html#a1caaf369d9c5f0817dbaa76b43b8d87b">True_int</a> length = 0;
<a name="l00055"></a>00055   <span class="keywordtype">char</span> <a class="code" href="Reordonner__faces__periodiques_8cpp.html#a137d78a01e63d3b66d1b2ed0de0f4c4c">message</a>[MPI_MAX_ERROR_STRING];
<a name="l00056"></a>00056   MPI_Error_string(error_code, message, &amp; length);
<a name="l00057"></a>00057   <span class="keywordflow">if</span> (length &gt; 0)
<a name="l00058"></a>00058     {
<a name="l00059"></a>00059       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; message &lt;&lt; finl;
<a name="l00060"></a>00060       <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Process::Journal</a>() &lt;&lt; message &lt;&lt; finl;
<a name="l00061"></a>00061     }
<a name="l00062"></a>00062 <span class="comment">// Normalement on aurait pris trio_u_world_, mais on n&#39;y a pas acces ici.</span>
<a name="l00063"></a>00063 <span class="comment">// Pour faire abort, en l&#39;occurence, c&#39;est pas grave mais merci de ne pas</span>
<a name="l00064"></a>00064 <span class="comment">// prendre comme exemple...</span>
<a name="l00065"></a>00065   assert(0);
<a name="l00066"></a>00066   MPI_Abort(MPI_COMM_WORLD,-1);
<a name="l00067"></a>00067   <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="comment">//</span>
<a name="l00071"></a>00071 <span class="comment">//</span>
<a name="l00072"></a>00072 <span class="comment">//</span><span class="comment"></span>
<a name="l00073"></a>00073 <span class="comment">//! Partie inline du traitement d&#39;erreur mpi (on inline le&lt;br&gt;test: sauf exception, il n&#39;y a pas d&#39;appel de fonction&lt;br&gt;supplementaire.</span>
<a name="l00074"></a><a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2">00074</a> <span class="comment"></span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(<span class="keywordtype">int</span> error_code)
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076   <span class="keywordflow">if</span> (error_code != MPI_SUCCESS)
<a name="l00077"></a>00077     <a class="code" href="Comm__Group__MPI_8cpp.html#a5b117da44411e948e8c880a6e924a547" title="Partie non inline du traitement d&#39;erreur mpi. Affichage d&#39;un code d&#39;erreur mpi avec MPI_Error_string...">mpi_print_error</a>(error_code);
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="preprocessor">#endif</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span>
<a name="l00082"></a><a class="code" href="classComm__Group__MPI.html#acbc7953970ce9cde3028f435c9919ce6">00082</a> <a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; <a class="code" href="classComm__Group__MPI.html#acbc7953970ce9cde3028f435c9919ce6" title="Ecriture de l&#39;objet sur un flot de sortie Methode a surcharger.">Comm_Group_MPI::printOn</a>(<a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; os)<span class="keyword"> const</span>
<a name="l00083"></a>00083 <span class="keyword"></span>{
<a name="l00084"></a>00084   <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00085"></a>00085   <span class="keywordflow">return</span> os;
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00088"></a><a class="code" href="classComm__Group__MPI.html#ae0ebf1bf2f718827f697658a6022ad9d">00088</a> <a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; <a class="code" href="classComm__Group__MPI.html#ae0ebf1bf2f718827f697658a6022ad9d" title="Lecture d&#39;un Objet_U sur un flot d&#39;entree Methode a surcharger.">Comm_Group_MPI::readOn</a>(<a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; is)
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090   <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00091"></a>00091   <span class="keywordflow">return</span> is;
<a name="l00092"></a>00092 }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="comment">//</span><span class="comment"></span>
<a name="l00095"></a>00095 <span class="comment">//! Constructeur par defaut. Il faut ensuite appeler init_group()&lt;br&gt;ou init_group_trio() pour finir la construction du groupe.</span>
<a name="l00096"></a><a class="code" href="classComm__Group__MPI.html#ac9fe4b9f0e383fc6397cfc5d108befe7">00096</a> <span class="comment"></span><a class="code" href="classComm__Group__MPI.html#ac9fe4b9f0e383fc6397cfc5d108befe7" title="Constructeur par defaut. Il faut ensuite appeler init_group() ou init_group_trio() pour finir la cons...">Comm_Group_MPI::Comm_Group_MPI</a>()
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="comment">// -1 indique que le groupe n&#39;a pas ete initialise</span>
<a name="l00100"></a>00100   <a class="code" href="classComm__Group__MPI.html#ab0940f1663106b662a89762ab27fcb21" title="Faut-il le faire dans le destructeur ?">must_finalize_</a> = -1;
<a name="l00101"></a>00101   <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>=MPI_COMM_NULL;
<a name="l00102"></a>00102   <a class="code" href="classComm__Group__MPI.html#aeb1df991997795d3f2595ac4a1662306" title="Handle sur le groupe mpi.">mpi_group_</a>=MPI_GROUP_NULL;
<a name="l00103"></a>00103 <span class="preprocessor">#endif</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>}
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="classComm__Group__MPI.html#a139397b34bf7c93b41f0647cc9c2449b">00106</a> <a class="code" href="classComm__Group__MPI.html#a139397b34bf7c93b41f0647cc9c2449b">Comm_Group_MPI::~Comm_Group_MPI</a>()
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span><span class="comment">// Si groupe non initialise, ne rien faire:</span>
<a name="l00110"></a>00110 <span class="comment">// Modif par BM (20/08/2012): ne detruire ces membres statiques que si c&#39;est le groupe principal (fin de l&#39;execution)</span>
<a name="l00111"></a>00111   <span class="keywordflow">if</span> ((<a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>!=MPI_COMM_NULL) &amp;&amp; (<a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a> == <a class="code" href="classComm__Group__MPI.html#a2646c7c94faa11b114305ec5aeb37daf">trio_u_world_</a>))
<a name="l00112"></a>00112     {
<a name="l00113"></a>00113       <span class="keyword">delete</span> [] <a class="code" href="classComm__Group__MPI.html#ac297dcc148131d510d555cf3a19e4c8b">mpi_status_</a>;
<a name="l00114"></a>00114       <a class="code" href="classComm__Group__MPI.html#ac297dcc148131d510d555cf3a19e4c8b">mpi_status_</a>=0;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> r=0; r&lt;<a class="code" href="classComm__Group__MPI.html#aa1fe9449dec78267c37c1b9ca273d519">mpi_maxrequests_</a>; r++)
<a name="l00117"></a>00117         {
<a name="l00118"></a>00118           <span class="keywordflow">if</span>(<a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">mpi_requests_</a>[r]!=MPI_REQUEST_NULL)
<a name="l00119"></a>00119             {
<a name="l00120"></a>00120               MPI_Request_free(&amp;(<a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">mpi_requests_</a>[r]));
<a name="l00121"></a>00121             }
<a name="l00122"></a>00122         }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124       <span class="keyword">delete</span> [] <a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">mpi_requests_</a>;
<a name="l00125"></a>00125       <a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">mpi_requests_</a>=0;
<a name="l00126"></a>00126     }
<a name="l00127"></a>00127 
<a name="l00128"></a>00128   <span class="keywordflow">else</span> <span class="comment">//!&lt; on detruit les groupes non prinicpaux</span>
<a name="l00129"></a>00129 <span class="comment"></span>    {
<a name="l00130"></a>00130 
<a name="l00131"></a>00131       <span class="keywordflow">if</span> (<a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>!=MPI_COMM_NULL)
<a name="l00132"></a>00132         {
<a name="l00133"></a>00133 <span class="comment">// on detruit le group puis le mpi_comm</span>
<a name="l00134"></a>00134           <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Comm_free(&amp;<a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00135"></a>00135           assert(<a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>==MPI_COMM_NULL);
<a name="l00136"></a>00136         }
<a name="l00137"></a>00137       <span class="keywordflow">if</span> (<a class="code" href="classComm__Group__MPI.html#aeb1df991997795d3f2595ac4a1662306" title="Handle sur le groupe mpi.">mpi_group_</a>!=MPI_GROUP_NULL)
<a name="l00138"></a>00138         {
<a name="l00139"></a>00139           <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Group_free( &amp;<a class="code" href="classComm__Group__MPI.html#aeb1df991997795d3f2595ac4a1662306" title="Handle sur le groupe mpi.">mpi_group_</a>));
<a name="l00140"></a>00140           assert(<a class="code" href="classComm__Group__MPI.html#aeb1df991997795d3f2595ac4a1662306" title="Handle sur le groupe mpi.">mpi_group_</a>==MPI_GROUP_NULL);
<a name="l00141"></a>00141         }
<a name="l00142"></a>00142     }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="preprocessor">#endif</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>}
<a name="l00146"></a>00146 <span class="comment"></span>
<a name="l00147"></a>00147 <span class="comment">//! appel a MPI_Abort et rend la main</span>
<a name="l00148"></a><a class="code" href="classComm__Group__MPI.html#ab1805a91e4d4700e4a182704bc1cdc36">00148</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#ab1805a91e4d4700e4a182704bc1cdc36" title="appel a MPI_Abort et rend la main">Comm_Group_MPI::abort</a>()<span class="keyword"> const</span>
<a name="l00149"></a>00149 <span class="keyword"></span>{
<a name="l00150"></a>00150 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>  MPI_Abort(<a class="code" href="classComm__Group__MPI.html#a2646c7c94faa11b114305ec5aeb37daf">trio_u_world_</a>,-1);
<a name="l00152"></a>00152 <span class="preprocessor">#endif</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span>}
<a name="l00154"></a>00154 
<a name="l00155"></a><a class="code" href="classComm__Group__MPI.html#a94080b311a19f8f450eb53af66bedcfe">00155</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a94080b311a19f8f450eb53af66bedcfe">Comm_Group_MPI::mp_collective_op</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> *x, <span class="keywordtype">double</span> *resu, <span class="keywordtype">int</span> n, <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302c">Collective_Op</a> op)<span class="keyword"> const</span>
<a name="l00156"></a>00156 <span class="keyword"></span>{
<a name="l00157"></a>00157 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (n &lt;= 0)
<a name="l00159"></a>00159     <span class="keywordflow">return</span>;
<a name="l00160"></a>00160   <span class="keywordflow">switch</span>(op)
<a name="l00161"></a>00161     {
<a name="l00162"></a>00162 <span class="comment">// Note B.M.: cast en non const a cause de l&#39;interface de MPI,</span>
<a name="l00163"></a>00163 <span class="comment">// plusieurs posts sur newsgroups incitent a penser que c&#39;est ok</span>
<a name="l00164"></a>00164 <span class="comment">// (x ne sera jamais modifie par la librairie, sauf bug !)</span>
<a name="l00165"></a>00165     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302ca55879cc8c9d3898570abc1279177d330">COLL_SUM</a>:
<a name="l00166"></a>00166       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#ac1c8738526e1896276b874fddfbc7b2f">mpi_sumdouble_counter_</a>);
<a name="l00167"></a>00167       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Allreduce((<span class="keywordtype">int</span>*) x, resu, n, MPI_DOUBLE, MPI_SUM, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00168"></a>00168       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#ac1c8738526e1896276b874fddfbc7b2f">mpi_sumdouble_counter_</a>);
<a name="l00169"></a>00169       <span class="keywordflow">break</span>;
<a name="l00170"></a>00170     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302cac56938ec8d65390f71357f084c9be49f">COLL_MIN</a>:
<a name="l00171"></a>00171       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#ad044a342f1b0c425c4f3f01ecd62d441">mpi_mindouble_counter_</a>);
<a name="l00172"></a>00172       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Allreduce((<span class="keywordtype">int</span>*) x, resu, n, MPI_DOUBLE, MPI_MIN, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00173"></a>00173       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#ad044a342f1b0c425c4f3f01ecd62d441">mpi_mindouble_counter_</a>);
<a name="l00174"></a>00174       <span class="keywordflow">break</span>;
<a name="l00175"></a>00175     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302ca97e266ea06542559109eef5e5d642b86">COLL_MAX</a>:
<a name="l00176"></a>00176       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#ab2e1f6892d7627fd27b4bcc9cc9e1559">mpi_maxdouble_counter_</a>);
<a name="l00177"></a>00177       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Allreduce((<span class="keywordtype">int</span>*) x, resu, n, MPI_DOUBLE, MPI_MAX, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00178"></a>00178       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#ab2e1f6892d7627fd27b4bcc9cc9e1559">mpi_maxdouble_counter_</a>);
<a name="l00179"></a>00179       <span class="keywordflow">break</span>;
<a name="l00180"></a>00180     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302ca31173cff9138da25f8a6f87612e14edb">COLL_PARTIAL_SUM</a>:
<a name="l00181"></a>00181       <a class="code" href="classComm__Group__MPI.html#a0b55b5203878fd5a4e99e1e8c79b60b0">internal_collective</a>(x, resu, n, &amp;op, -1 <span class="comment">/* only one operation */</span>, 0 <span class="comment">/* recursion level */</span>);
<a name="l00182"></a>00182       <span class="keywordflow">break</span>;
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184 <span class="preprocessor">#endif</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span>}
<a name="l00186"></a>00186 
<a name="l00187"></a><a class="code" href="classComm__Group__MPI.html#ae3f7d193408fdc960873e1f51ba2b47c">00187</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a94080b311a19f8f450eb53af66bedcfe">Comm_Group_MPI::mp_collective_op</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> *x, <span class="keywordtype">double</span> *resu, <span class="keyword">const</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302c">Collective_Op</a> *op, <span class="keywordtype">int</span> n)<span class="keyword"> const</span>
<a name="l00188"></a>00188 <span class="keyword"></span>{
<a name="l00189"></a>00189 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (n &lt;= 0)
<a name="l00191"></a>00191     <span class="keywordflow">return</span>;
<a name="l00192"></a>00192   <a class="code" href="classComm__Group__MPI.html#a0b55b5203878fd5a4e99e1e8c79b60b0">internal_collective</a>(x, resu, n, op, n <span class="comment">/* n different operations */</span>, 0 <span class="comment">/* recursion level */</span>);
<a name="l00193"></a>00193 <span class="preprocessor">#endif</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>}
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="classComm__Group__MPI.html#af65cdf5dd2f56a60a7dd54c858aad8d8">00196</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a94080b311a19f8f450eb53af66bedcfe">Comm_Group_MPI::mp_collective_op</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> *x, <span class="keywordtype">int</span> *resu, <span class="keywordtype">int</span> n, <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302c">Collective_Op</a> op)<span class="keyword"> const</span>
<a name="l00197"></a>00197 <span class="keyword"></span>{
<a name="l00198"></a>00198 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (n &lt;= 0)
<a name="l00200"></a>00200     <span class="keywordflow">return</span>;
<a name="l00201"></a>00201   <span class="keywordflow">switch</span>(op)
<a name="l00202"></a>00202     {
<a name="l00203"></a>00203 <span class="comment">// Note B.M.: cast en non const a cause de l&#39;interface de MPI,</span>
<a name="l00204"></a>00204 <span class="comment">// plusieurs posts sur newsgroups incitent a penser que c&#39;est ok</span>
<a name="l00205"></a>00205 <span class="comment">// (x ne sera jamais modifie par la librairie, sauf bug !)</span>
<a name="l00206"></a>00206     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302ca55879cc8c9d3898570abc1279177d330">COLL_SUM</a>:
<a name="l00207"></a>00207       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#a8068b7082243a49326eb9037e713fdd6">mpi_sumint_counter_</a>);
<a name="l00208"></a>00208       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Allreduce((<span class="keywordtype">int</span>*) x, resu, n, <a class="code" href="Comm__Group__MPI_8cpp.html#a9b683f6cb98289e218b17558829d3e80">MPI_ENTIER</a>, MPI_SUM, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00209"></a>00209       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#a8068b7082243a49326eb9037e713fdd6">mpi_sumint_counter_</a>);
<a name="l00210"></a>00210       <span class="keywordflow">break</span>;
<a name="l00211"></a>00211     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302cac56938ec8d65390f71357f084c9be49f">COLL_MIN</a>:
<a name="l00212"></a>00212       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#a2b7d385a876eb702b1e0a9121e3165d5">mpi_minint_counter_</a>);
<a name="l00213"></a>00213       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Allreduce((<span class="keywordtype">int</span>*) x, resu, n, <a class="code" href="Comm__Group__MPI_8cpp.html#a9b683f6cb98289e218b17558829d3e80">MPI_ENTIER</a>, MPI_MIN, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00214"></a>00214       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#a2b7d385a876eb702b1e0a9121e3165d5">mpi_minint_counter_</a>);
<a name="l00215"></a>00215       <span class="keywordflow">break</span>;
<a name="l00216"></a>00216     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302ca97e266ea06542559109eef5e5d642b86">COLL_MAX</a>:
<a name="l00217"></a>00217       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#ab05b4986b9cb74b212631b42386663a3">mpi_maxint_counter_</a>);
<a name="l00218"></a>00218       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Allreduce((<span class="keywordtype">int</span>*) x, resu, n, <a class="code" href="Comm__Group__MPI_8cpp.html#a9b683f6cb98289e218b17558829d3e80">MPI_ENTIER</a>, MPI_MAX, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00219"></a>00219       <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#ab05b4986b9cb74b212631b42386663a3">mpi_maxint_counter_</a>);
<a name="l00220"></a>00220       <span class="keywordflow">break</span>;
<a name="l00221"></a>00221     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302ca31173cff9138da25f8a6f87612e14edb">COLL_PARTIAL_SUM</a>:
<a name="l00222"></a>00222       <a class="code" href="classComm__Group__MPI.html#a0b55b5203878fd5a4e99e1e8c79b60b0">internal_collective</a>(x, resu, n, &amp;op, -1 <span class="comment">/* only one operation */</span>, 0 <span class="comment">/* recursion level */</span>);
<a name="l00223"></a>00223       <span class="keywordflow">break</span>;
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225 <span class="preprocessor">#endif</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span>}
<a name="l00227"></a>00227 
<a name="l00228"></a><a class="code" href="classComm__Group__MPI.html#aae9f6a357f7566500da5b1c4f9c6e52e">00228</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a94080b311a19f8f450eb53af66bedcfe">Comm_Group_MPI::mp_collective_op</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> *x, <span class="keywordtype">int</span> *resu, <span class="keyword">const</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302c">Collective_Op</a> *op, <span class="keywordtype">int</span> n)<span class="keyword"> const</span>
<a name="l00229"></a>00229 <span class="keyword"></span>{
<a name="l00230"></a>00230 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (n &lt;= 0)
<a name="l00232"></a>00232     <span class="keywordflow">return</span>;
<a name="l00233"></a>00233   <a class="code" href="classComm__Group__MPI.html#a0b55b5203878fd5a4e99e1e8c79b60b0">internal_collective</a>(x, resu, n, op, n <span class="comment">/* n different operations */</span>, 0 <span class="comment">/* recursion level */</span>);
<a name="l00234"></a>00234 <span class="preprocessor">#endif</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>}
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="comment">//</span>
<a name="l00238"></a>00238 <span class="comment">//</span>
<a name="l00239"></a>00239 <span class="comment">//</span>
<a name="l00240"></a>00240 <span class="comment">//</span>
<a name="l00241"></a>00241 <span class="comment">//</span><span class="comment"></span>
<a name="l00242"></a>00242 <span class="comment">//! Point de synchronisation de tous les processeurs du groupe (permet&lt;br&gt;de verifier que tout le monde est la...). Si check_enabled() est&lt;br&gt;non nul, on utilise le tag pour verifier que tous les processeurs&lt;br&gt;sont bien en train d&#39;attendre le meme tag, sinon c&#39;est une barriere&lt;br&gt;simple. Le tag doit verifier 0 &lt;= tag &lt; max_tag (soit 32).</span>
<a name="l00243"></a><a class="code" href="classComm__Group__MPI.html#ae750d88352c3be971b9742755501ee78">00243</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classProcess.html#aa9e74a5c06a68ea38298a08ea401e7b1" title="Synchronise tous les processeurs du groupe courant&lt;br&gt;(attend que tous les processeurs soient arrives...">Comm_Group_MPI::barrier</a>(<span class="keywordtype">int</span> tag)<span class="keyword"> const</span>
<a name="l00244"></a>00244 <span class="keyword"></span>{
<a name="l00245"></a>00245 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span>  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> max_tag = 32;
<a name="l00247"></a>00247   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#addb19222ff0bbe4318a7f2de393149e7">mpi_barrier_counter_</a>);
<a name="l00248"></a>00248   assert(tag &gt;= 0 &amp;&amp; tag &lt; max_tag);
<a name="l00249"></a>00249   <span class="keywordflow">if</span> (<a class="code" href="classComm__Group.html#a0f230fe65c9f52fd2a168a1ea70e7b15">check_enabled</a>())
<a name="l00250"></a>00250     {
<a name="l00251"></a>00251 <span class="comment">// On fait la barriere avec des mpmin et mpmax pour verifier</span>
<a name="l00252"></a>00252 <span class="comment">// que le tag est le meme sur tous les processeurs :</span>
<a name="l00253"></a>00253 <span class="comment">// ATTENTION : il faut &quot;int&quot; et pas &quot;entier&quot; !!!</span>
<a name="l00254"></a>00254       <span class="keywordtype">int</span> tag_complet = <a class="code" href="classComm__Group.html#ae931965f99ed3a85bdcc7d2864f81318" title="Cette fonction renvoie un nouveau tag de communication pour le groupe. Effet de bord : incremente le ...">get_new_tag</a>() * max_tag + tag;
<a name="l00255"></a>00255       <span class="keywordtype">int</span> min_tag, amax_tag;
<a name="l00256"></a>00256       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Allreduce(&amp; tag_complet, &amp; min_tag, 1, <a class="code" href="Comm__Group__MPI_8cpp.html#a9b683f6cb98289e218b17558829d3e80">MPI_ENTIER</a>, MPI_MIN, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00257"></a>00257       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Allreduce(&amp; tag_complet, &amp; amax_tag, 1, <a class="code" href="Comm__Group__MPI_8cpp.html#a9b683f6cb98289e218b17558829d3e80">MPI_ENTIER</a>, MPI_MAX, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00258"></a>00258       <span class="keywordflow">if</span> (min_tag != tag_complet || amax_tag != tag_complet)
<a name="l00259"></a>00259         {
<a name="l00260"></a>00260           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error in Comm_Group_MPI::barrier(int tag)\n&quot;</span>;
<a name="l00261"></a>00261           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot; the tag is not identical on all the processes.\n&quot;</span>;
<a name="l00262"></a>00262           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot; (Loss of communications synchronisation).&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00263"></a>00263           <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Process::Journal</a>() &lt;&lt; <span class="stringliteral">&quot;Comm_Group_MPI::barrier\n Error : tag = &quot;</span> &lt;&lt; tag &lt;&lt; finl;
<a name="l00264"></a>00264           assert(0);
<a name="l00265"></a>00265           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00266"></a>00266         }
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268   <span class="keywordflow">else</span>
<a name="l00269"></a>00269     {
<a name="l00270"></a>00270 <span class="comment">// Barriere simple sans le tag :</span>
<a name="l00271"></a>00271       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Barrier(<a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#addb19222ff0bbe4318a7f2de393149e7">mpi_barrier_counter_</a>);
<a name="l00274"></a>00274 <span class="preprocessor">#endif</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span>}
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="comment">// Precondition:</span>
<a name="l00278"></a>00278 <span class="comment">// Il ne doit pas y avoir d&#39;autre communication en cours (send_recv_finic</span>
<a name="l00279"></a>00279 <span class="comment">//</span>
<a name="l00280"></a>00280 <span class="comment">//</span>
<a name="l00281"></a>00281 <span class="comment">//</span>
<a name="l00282"></a>00282 <span class="comment">//</span>
<a name="l00283"></a>00283 <span class="comment">//</span>
<a name="l00284"></a>00284 <span class="comment">//</span>
<a name="l00285"></a>00285 <span class="comment">//</span>
<a name="l00286"></a>00286 <span class="comment">//</span>
<a name="l00287"></a>00287 <span class="comment">//</span><span class="comment"></span>
<a name="l00288"></a>00288 <span class="comment">//! Demarre l&#39;envoi et la reception des buffers.&lt;br&gt;Les buffers doivent rester valide jusqu&#39;au retour de send_recv_finish().&lt;br&gt;Le graphe de communication et la taille des buffers doivent etre corrects !&lt;br&gt;send_list : liste des processeurs (numerotation sur groupe courant) a qui envoyer&lt;br&gt;send_size : taille en octets de chaque message&lt;br&gt;send_buffers : adresse des donnees a envoyer.&lt;br&gt;recv_...  : idem pour les donnees en reception.</span>
<a name="l00289"></a><a class="code" href="classComm__Group__MPI.html#a48e08453955c29444fc27ab435a77226">00289</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a48e08453955c29444fc27ab435a77226" title="Demarre l&#39;envoi et la reception des buffers. Les buffers doivent rester valide jusqu&#39;au retour de sen...">Comm_Group_MPI::send_recv_start</a>(<span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; send_list,
<a name="l00290"></a>00290                                      <span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; send_size,
<a name="l00291"></a>00291                                      <span class="keyword">const</span> <span class="keywordtype">char</span> * <span class="keyword">const</span> * <span class="keyword">const</span> send_buffers,
<a name="l00292"></a>00292                                      <span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; recv_list,
<a name="l00293"></a>00293                                      <span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; recv_size,
<a name="l00294"></a>00294                                      <span class="keywordtype">char</span> * <span class="keyword">const</span> * <span class="keyword">const</span> recv_buffers,
<a name="l00295"></a>00295                                      <a class="code" href="classComm__Group.html#a93c4c5b0887e1fc63a123d11e7da0118">TypeHint</a> typehint)<span class="keyword"> const</span>
<a name="l00296"></a>00296 <span class="keyword"></span>{
<a name="l00297"></a>00297 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span>  <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#a72b0d4b3469ad6354c83b3ca05a3cd26">mpi_sendrecv_counter_</a>);
<a name="l00299"></a>00299   assert(<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a> &lt; 0);
<a name="l00300"></a>00300 
<a name="l00301"></a>00301   <span class="keyword">const</span> <span class="keywordtype">int</span> tag = <a class="code" href="classComm__Group.html#ae931965f99ed3a85bdcc7d2864f81318" title="Cette fonction renvoie un nouveau tag de communication pour le groupe. Effet de bord : incremente le ...">get_new_tag</a>();
<a name="l00302"></a>00302   <span class="keywordtype">int</span> i, n;
<a name="l00303"></a>00303   <a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a> = 0;
<a name="l00304"></a>00304   <span class="keywordtype">int</span> msg_size = 0;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306   <span class="keywordtype">int</span> divisor = 0;
<a name="l00307"></a>00307   MPI_Datatype datatype = MPI_CHAR;
<a name="l00308"></a>00308   assert(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) == <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)); <span class="comment">//!&lt; Sinon il faut changer MPI_ENTIER !!!</span>
<a name="l00309"></a>00309 <span class="comment"></span>  <span class="keywordflow">switch</span>(typehint)
<a name="l00310"></a>00310     {
<a name="l00311"></a>00311     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a93c4c5b0887e1fc63a123d11e7da0118a32d85484e767b15e135274275b2194ed">CHAR</a>:
<a name="l00312"></a>00312       divisor = 1;
<a name="l00313"></a>00313       <span class="keywordflow">break</span>;
<a name="l00314"></a>00314     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a93c4c5b0887e1fc63a123d11e7da0118ace1f14aca3731a4ba1a90890825dc33e">INT</a>:
<a name="l00315"></a>00315       divisor = <span class="keyword">sizeof</span>(int);
<a name="l00316"></a>00316       datatype = <a class="code" href="Comm__Group__MPI_8cpp.html#a9b683f6cb98289e218b17558829d3e80">MPI_ENTIER</a>;
<a name="l00317"></a>00317       <span class="keywordflow">break</span>;
<a name="l00318"></a>00318     <span class="keywordflow">case</span> <a class="code" href="classComm__Group.html#a93c4c5b0887e1fc63a123d11e7da0118a3ecf92403be29069ab3826b1a3a6b1e4">DOUBLE</a>:
<a name="l00319"></a>00319       divisor = <span class="keyword">sizeof</span>(double);
<a name="l00320"></a>00320       datatype = MPI_DOUBLE;
<a name="l00321"></a>00321       <span class="keywordflow">break</span>;
<a name="l00322"></a>00322     <span class="keywordflow">default</span>:
<a name="l00323"></a>00323       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00324"></a>00324     }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="comment">// Astuce pour maximiser les chances que ca marche : on declare</span>
<a name="l00327"></a>00327 <span class="comment">// la reception d&#39;abord et l&#39;envoi ensuite.</span>
<a name="l00328"></a>00328   n = recv_list.<a class="code" href="classArrOfInt.html#a0f41611fce0a58c3ef3409dc1af8904d" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>();
<a name="l00329"></a>00329   <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
<a name="l00330"></a>00330     {
<a name="l00331"></a>00331       <span class="keywordtype">int</span> source = recv_list[i];
<a name="l00332"></a>00332       <span class="keywordtype">int</span> <a class="code" href="Nom_8cpp.html#a0e1ea19fb9fa7881d15d84eff4c090e1">sz</a>   = recv_size[i];
<a name="l00333"></a>00333       msg_size += <a class="code" href="Nom_8cpp.html#a0e1ea19fb9fa7881d15d84eff4c090e1">sz</a>;
<a name="l00334"></a>00334       assert(source &gt;= 0 &amp;&amp; source &lt; <a class="code" href="classComm__Group.html#a657c34d2d722170d7e052b594e17654c" title="Renvoie le nombre de processeurs dans le groupe *this.">nproc</a>());
<a name="l00335"></a>00335       assert(<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a> &lt; <a class="code" href="classComm__Group__MPI.html#aa1fe9449dec78267c37c1b9ca273d519">mpi_maxrequests_</a>);
<a name="l00336"></a>00336       assert(sz % divisor == 0);
<a name="l00337"></a>00337       assert(<a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">mpi_requests_</a>[<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a>]==MPI_REQUEST_NULL);
<a name="l00338"></a>00338       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Irecv(recv_buffers[i], sz / divisor,
<a name="l00339"></a>00339                           datatype,
<a name="l00340"></a>00340                           source, tag, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>,
<a name="l00341"></a>00341                           &amp; <a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">mpi_requests_</a>[<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a>]));
<a name="l00342"></a>00342       mpi_nrequests_++;
<a name="l00343"></a>00343     }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345   n = send_list.<a class="code" href="classArrOfInt.html#a0f41611fce0a58c3ef3409dc1af8904d" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>();
<a name="l00346"></a>00346   <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
<a name="l00347"></a>00347     {
<a name="l00348"></a>00348       <span class="keywordtype">int</span> dest = send_list[i];
<a name="l00349"></a>00349       <span class="keywordtype">int</span> <a class="code" href="Nom_8cpp.html#a0e1ea19fb9fa7881d15d84eff4c090e1">sz</a>   = send_size[i];
<a name="l00350"></a>00350       msg_size += <a class="code" href="Nom_8cpp.html#a0e1ea19fb9fa7881d15d84eff4c090e1">sz</a>;
<a name="l00351"></a>00351       assert(dest &gt;= 0 &amp;&amp; dest &lt; <a class="code" href="classComm__Group.html#a657c34d2d722170d7e052b594e17654c" title="Renvoie le nombre de processeurs dans le groupe *this.">nproc</a>());
<a name="l00352"></a>00352       assert(<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a> &lt; <a class="code" href="classComm__Group__MPI.html#aa1fe9449dec78267c37c1b9ca273d519">mpi_maxrequests_</a>);
<a name="l00353"></a>00353       assert(sz % divisor == 0);
<a name="l00354"></a>00354       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Isend((<span class="keywordtype">char</span>*) send_buffers[i], sz / divisor,
<a name="l00355"></a>00355                           datatype,
<a name="l00356"></a>00356                           dest, tag, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>,
<a name="l00357"></a>00357                           &amp; <a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">mpi_requests_</a>[<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a>]));
<a name="l00358"></a>00358       mpi_nrequests_++;
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360   <a class="code" href="classComm__Group__MPI.html#a875660d93ebcfb12b9a6f32298cdcda3" title="La taille des donnees envoyees/recues pour le send_recv_start courant.">current_msg_size_</a> = msg_size;
<a name="l00361"></a>00361 <span class="preprocessor">#endif</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span>}
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="comment">// Precondition:</span>
<a name="l00365"></a>00365 <span class="comment">// il faut avoir appele send_recv_start avant.</span>
<a name="l00366"></a>00366 <span class="comment">//</span>
<a name="l00367"></a>00367 <span class="comment">//</span><span class="comment"></span>
<a name="l00368"></a>00368 <span class="comment">//! Attend que l&#39;ensemble des communications lancees par send_recv_start&lt;br&gt;soient finie.</span>
<a name="l00369"></a><a class="code" href="classComm__Group__MPI.html#a1a460e58d7ebf006d77d6bd8ea3e8f99">00369</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a1a460e58d7ebf006d77d6bd8ea3e8f99" title="Attend que l&#39;ensemble des communications lancees par send_recv_start soient finie.">Comm_Group_MPI::send_recv_finish</a>()<span class="keyword"> const</span>
<a name="l00370"></a>00370 <span class="keyword"></span>{
<a name="l00371"></a>00371 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span>  assert(<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a> &gt;= 0);
<a name="l00373"></a>00373   <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Waitall(<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a>, <a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">mpi_requests_</a>, <a class="code" href="classComm__Group__MPI.html#ac297dcc148131d510d555cf3a19e4c8b">mpi_status_</a>));
<a name="l00374"></a>00374   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#a72b0d4b3469ad6354c83b3ca05a3cd26">mpi_sendrecv_counter_</a>, <a class="code" href="classComm__Group__MPI.html#a875660d93ebcfb12b9a6f32298cdcda3" title="La taille des donnees envoyees/recues pour le send_recv_start courant.">current_msg_size_</a>, <a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a>);
<a name="l00375"></a>00375   <span class="comment">/*</span>
<a name="l00376"></a>00376 <span class="comment">  for (int r=0;r&lt;mpi_nrequests_;r++)</span>
<a name="l00377"></a>00377 <span class="comment">    {</span>
<a name="l00378"></a>00378 <span class="comment">      if ( mpi_requests_[r]!=MPI_REQUEST_NULL)</span>
<a name="l00379"></a>00379 <span class="comment">  {</span>
<a name="l00380"></a>00380 <span class="comment">    MPI_Request_free(&amp;(mpi_requests_[r]));</span>
<a name="l00381"></a>00381 <span class="comment">  }</span>
<a name="l00382"></a>00382 <span class="comment">      mpi_requests_[r]=MPI_REQUEST_NULL;</span>
<a name="l00383"></a>00383 <span class="comment">      }</span>
<a name="l00384"></a>00384 <span class="comment">  */</span>
<a name="l00385"></a>00385   <a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a> = -1;
<a name="l00386"></a>00386 <span class="preprocessor">#endif</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span>}
<a name="l00388"></a>00388 
<a name="l00389"></a>00389 
<a name="l00390"></a>00390 <span class="comment">//</span>
<a name="l00391"></a>00391 <span class="comment">//</span>
<a name="l00392"></a>00392 <span class="comment">//</span>
<a name="l00393"></a>00393 <span class="comment">//</span>
<a name="l00394"></a>00394 <span class="comment">//</span><span class="comment"></span>
<a name="l00395"></a>00395 <span class="comment">//! Envoi blocant.&lt;br&gt;Pour etre bien certain que le code est safe, on force&lt;br&gt;une communication synchrone pour forcer le blocage en mode check (voir check_enabled()).&lt;br&gt;Sinon, on utilise MPI_Send qui est en general non blocant pour les petits messages&lt;br&gt;(donc de meilleures performances).</span>
<a name="l00396"></a><a class="code" href="classComm__Group__MPI.html#a4194fda85c1e5ae4b06d32c82a31128c">00396</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a4194fda85c1e5ae4b06d32c82a31128c" title="Envoi bloquant.">Comm_Group_MPI::send</a>(<span class="keywordtype">int</span> pe, <span class="keyword">const</span> <span class="keywordtype">void</span> *buffer, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> tag)<span class="keyword"> const</span>
<a name="l00397"></a>00397 <span class="keyword"></span>{
<a name="l00398"></a>00398 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00399"></a>00399 <span class="preprocessor"></span>  <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#ac5530206de46421879d71f612e05b217">mpi_send_counter_</a>);
<a name="l00400"></a>00400   assert(<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a> &lt; 0);
<a name="l00401"></a>00401   <span class="keywordtype">int</span> dest = pe;
<a name="l00402"></a>00402   assert(dest &gt;= 0 &amp;&amp; dest &lt; <a class="code" href="classComm__Group.html#a657c34d2d722170d7e052b594e17654c" title="Renvoie le nombre de processeurs dans le groupe *this.">nproc</a>());
<a name="l00403"></a>00403 <span class="comment">// Probleme: oblige de faire un cast de (const void*) en (void*) a cause</span>
<a name="l00404"></a>00404 <span class="comment">// du prototype de MPI_Send</span>
<a name="l00405"></a>00405   <span class="keywordflow">if</span> (<a class="code" href="classComm__Group.html#a0f230fe65c9f52fd2a168a1ea70e7b15">check_enabled</a>())
<a name="l00406"></a>00406     <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Ssend ((<span class="keywordtype">void</span>*)buffer, size, MPI_CHAR, dest, tag, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00407"></a>00407   <span class="keywordflow">else</span>
<a name="l00408"></a>00408     <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Send ((<span class="keywordtype">void</span>*)buffer, size, MPI_CHAR, dest, tag, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00409"></a>00409   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#ac5530206de46421879d71f612e05b217">mpi_send_counter_</a>, size);
<a name="l00410"></a>00410 <span class="preprocessor">#endif</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span>}
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 <span class="comment">//</span><span class="comment"></span>
<a name="l00414"></a>00414 <span class="comment">//! Reception blocante d&#39;un message.</span>
<a name="l00415"></a><a class="code" href="classComm__Group__MPI.html#af4ac3f55a125330c0bee486994e03e59">00415</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#af4ac3f55a125330c0bee486994e03e59" title="Reception bloquante.">Comm_Group_MPI::recv</a>(<span class="keywordtype">int</span> pe, <span class="keywordtype">void</span> *buffer, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> tag)<span class="keyword"> const</span>
<a name="l00416"></a>00416 <span class="keyword"></span>{
<a name="l00417"></a>00417 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span>  <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#a2c07f529bf1a42876875e881efc21e45">mpi_recv_counter_</a>);
<a name="l00419"></a>00419   assert(<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a> &lt; 0);
<a name="l00420"></a>00420   MPI_Status status;
<a name="l00421"></a>00421   <span class="keywordtype">int</span> source = pe;
<a name="l00422"></a>00422   assert(source &gt;= 0 &amp;&amp; source &lt; <a class="code" href="classComm__Group.html#a657c34d2d722170d7e052b594e17654c" title="Renvoie le nombre de processeurs dans le groupe *this.">nproc</a>());
<a name="l00423"></a>00423   <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Recv (buffer, size, MPI_CHAR, source, tag, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>, &amp; status));
<a name="l00424"></a>00424   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#a2c07f529bf1a42876875e881efc21e45">mpi_recv_counter_</a>, size);
<a name="l00425"></a>00425 <span class="preprocessor">#endif</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span>}
<a name="l00427"></a>00427 
<a name="l00428"></a><a class="code" href="classComm__Group__MPI.html#a5eabbd176159e024eee5d7279e8015a8">00428</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a5eabbd176159e024eee5d7279e8015a8">Comm_Group_MPI::broadcast</a>(<span class="keywordtype">void</span> *buffer, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> pe_source)<span class="keyword"> const</span>
<a name="l00429"></a>00429 <span class="keyword"></span>{
<a name="l00430"></a>00430 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00431"></a>00431 <span class="preprocessor"></span>  <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#a5124c7c231089366dd4341827fab90f7">mpi_bcast_counter_</a>);
<a name="l00432"></a>00432   assert(<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a> &lt; 0);
<a name="l00433"></a>00433   <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Bcast (buffer, size, MPI_CHAR, pe_source, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00434"></a>00434   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#a5124c7c231089366dd4341827fab90f7">mpi_bcast_counter_</a>, size);
<a name="l00435"></a>00435 <span class="preprocessor">#endif</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span>}
<a name="l00437"></a>00437 
<a name="l00438"></a><a class="code" href="classComm__Group__MPI.html#a09a155fc5a50eb47ae990728f296c383">00438</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a09a155fc5a50eb47ae990728f296c383">Comm_Group_MPI::all_to_all</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src_buffer, <span class="keywordtype">void</span> *dest_buffer, <span class="keywordtype">int</span> data_size)<span class="keyword"> const</span>
<a name="l00439"></a>00439 <span class="keyword"></span>{
<a name="l00440"></a>00440 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00441"></a>00441 <span class="preprocessor"></span>  <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#a53741c4f88fd2385db3365a9f5b00cec">mpi_alltoall_counter_</a>);
<a name="l00442"></a>00442   assert(src_buffer != dest_buffer);
<a name="l00443"></a>00443   <span class="keywordtype">void</span> * ptr = (<span class="keywordtype">void</span> *) src_buffer; <span class="comment">//!&lt; Cast a cause de l&#39;interface de MPI_Alltoall</span>
<a name="l00444"></a>00444 <span class="comment"></span>  <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Alltoall(ptr, data_size, MPI_CHAR, dest_buffer, data_size, MPI_CHAR, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00445"></a>00445   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#a53741c4f88fd2385db3365a9f5b00cec">mpi_alltoall_counter_</a>, data_size);
<a name="l00446"></a>00446 <span class="preprocessor">#endif</span>
<a name="l00447"></a>00447 <span class="preprocessor"></span>}
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span>
<a name="l00451"></a>00451 <span class="comment">//</span>
<a name="l00452"></a>00452 <span class="comment">//</span>
<a name="l00453"></a>00453 <span class="comment">//</span>
<a name="l00454"></a>00454 <span class="comment">//</span>
<a name="l00455"></a>00455 <span class="comment">//</span><span class="comment"></span>
<a name="l00456"></a>00456 <span class="comment">//! constructeur du groupe &quot;tous&quot;&lt;br&gt;Attention, ce constructeur ne doit etre appele qu&#39;une seule fois.&lt;br&gt;Le groupe est associe a trio_u_world_&lt;br&gt;Si must_mpi_initialize_==0, on suppose que MPI_Init a deja ete appele.&lt;br&gt;Apres l&#39;appel a init_group_trio, il faut enregistrer le groupe dans PE_Groups&lt;br&gt;Voir PE_Groups::initialize()</span>
<a name="l00457"></a><a class="code" href="classComm__Group__MPI.html#a3f698e365013a707b1c8a8c017d57291">00457</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a3f698e365013a707b1c8a8c017d57291" title="constructeur du groupe &quot;tous&quot; Attention, ce constructeur ne doit etre appele qu&#39;une seule fois...">Comm_Group_MPI::init_group_trio</a>()
<a name="l00458"></a>00458 {
<a name="l00459"></a>00459   <a class="code" href="classComm__Group__MPI.html#ab0940f1663106b662a89762ab27fcb21" title="Faut-il le faire dans le destructeur ?">must_finalize_</a> = 0;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461   <span class="keywordflow">if</span> (<a class="code" href="classComm__Group__MPI.html#ac297dcc148131d510d555cf3a19e4c8b">mpi_status_</a> != 0)
<a name="l00462"></a>00462     {
<a name="l00463"></a>00463       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error : the construction of the global Comm_Group_MPI has already been done.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00464"></a>00464       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467   <span class="keywordflow">if</span> (<a class="code" href="classComm__Group__MPI.html#a1f180b302e5dee0d59b1bc2d92191358">must_mpi_initialize_</a>)
<a name="l00468"></a>00468     {
<a name="l00469"></a>00469       <span class="keywordflow">if</span> (<a class="code" href="classComm__Group__MPI.html#a2646c7c94faa11b114305ec5aeb37daf">trio_u_world_</a> != MPI_COMM_WORLD)
<a name="l00470"></a>00470         {
<a name="l00471"></a>00471           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error in Comm_Group_MPI::init_group_trio(...) : you cannot ask to initialize MPI\n&quot;</span>
<a name="l00472"></a>00472                &lt;&lt; <span class="stringliteral">&quot; with something else than MPI_COMM_WORLD !&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00473"></a>00473           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00474"></a>00474         }
<a name="l00475"></a>00475       <a class="code" href="classComm__Group__MPI.html#ab0940f1663106b662a89762ab27fcb21" title="Faut-il le faire dans le destructeur ?">must_finalize_</a> = 1;
<a name="l00476"></a>00476       <a class="code" href="arch_8h.html#a1caaf369d9c5f0817dbaa76b43b8d87b">True_int</a> argc=0;
<a name="l00477"></a>00477       <span class="keywordtype">char</span>** argv=NULL;
<a name="l00478"></a>00478       <span class="keywordtype">int</span> errcode = MPI_Init(&amp;argc, &amp;argv);
<a name="l00479"></a>00479 <span class="comment">// int errcode = MPI_Init(0,0); Message d&#39;erreur sur MPI Voltaire</span>
<a name="l00480"></a>00480       <span class="keywordflow">if</span> (errcode != MPI_SUCCESS)
<a name="l00481"></a>00481         {
<a name="l00482"></a>00482           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error in Comm_Group_MPI::init_group_trio()\n&quot;</span>
<a name="l00483"></a>00483                &lt;&lt; <span class="stringliteral">&quot; MPI_Init() failed (forget to run with mpirun ?)&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00484"></a>00484           <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(errcode);
<a name="l00485"></a>00485         }
<a name="l00486"></a>00486     }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   <a class="code" href="arch_8h.html#a1caaf369d9c5f0817dbaa76b43b8d87b">True_int</a> arank;
<a name="l00489"></a>00489   <a class="code" href="arch_8h.html#a1caaf369d9c5f0817dbaa76b43b8d87b">True_int</a> nbproc;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491   <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Comm_size (<a class="code" href="classComm__Group__MPI.html#a2646c7c94faa11b114305ec5aeb37daf">trio_u_world_</a>, &amp; nbproc));
<a name="l00492"></a>00492   <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Comm_rank (<a class="code" href="classComm__Group__MPI.html#a2646c7c94faa11b114305ec5aeb37daf">trio_u_world_</a>, &amp; arank));
<a name="l00493"></a>00493 
<a name="l00494"></a>00494   <a class="code" href="classComm__Group__MPI.html#a3f698e365013a707b1c8a8c017d57291" title="constructeur du groupe &quot;tous&quot; Attention, ce constructeur ne doit etre appele qu&#39;une seule fois...">Comm_Group::init_group_trio</a>(nbproc, arank);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496   <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a> = <a class="code" href="classComm__Group__MPI.html#a2646c7c94faa11b114305ec5aeb37daf">trio_u_world_</a>;
<a name="l00497"></a>00497   MPI_Comm_group(<a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>, &amp;<a class="code" href="classComm__Group__MPI.html#aeb1df991997795d3f2595ac4a1662306" title="Handle sur le groupe mpi.">mpi_group_</a>);
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 <span class="comment">// Initialisation des variables statiques de la classe</span>
<a name="l00500"></a>00500 <span class="comment">// Un buffer a envoyer et un a recevoir par processeur</span>
<a name="l00501"></a>00501 <span class="comment">// d&#39;ou le maximum...</span>
<a name="l00502"></a>00502   <a class="code" href="classComm__Group__MPI.html#aa1fe9449dec78267c37c1b9ca273d519">mpi_maxrequests_</a> = nbproc * 2;
<a name="l00503"></a>00503   <a class="code" href="classComm__Group__MPI.html#ac297dcc148131d510d555cf3a19e4c8b">mpi_status_</a> = <span class="keyword">new</span> MPI_Status[<a class="code" href="classComm__Group__MPI.html#aa1fe9449dec78267c37c1b9ca273d519">mpi_maxrequests_</a>];
<a name="l00504"></a>00504   <a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">mpi_requests_</a> = <span class="keyword">new</span> MPI_Request[<a class="code" href="classComm__Group__MPI.html#aa1fe9449dec78267c37c1b9ca273d519">mpi_maxrequests_</a>];
<a name="l00505"></a>00505 
<a name="l00506"></a>00506   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> r=0; r&lt;<a class="code" href="classComm__Group__MPI.html#aa1fe9449dec78267c37c1b9ca273d519">mpi_maxrequests_</a>; r++)
<a name="l00507"></a>00507     {
<a name="l00508"></a>00508       <a class="code" href="classComm__Group__MPI.html#aea3f71f58785bac087c1e8c1ff7d6f67">mpi_requests_</a>[r]=MPI_REQUEST_NULL;
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510   <span class="keywordflow">if</span> (arank == 0)
<a name="l00511"></a>00511     {
<a name="l00512"></a>00512       <span class="keywordflow">if</span> (<a class="code" href="classComm__Group__MPI.html#a2646c7c94faa11b114305ec5aeb37daf">trio_u_world_</a> == MPI_COMM_WORLD)
<a name="l00513"></a>00513         {
<a name="l00514"></a>00514           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Initialized MPI with MPI_COMM_WORLD (using all processors)&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00515"></a>00515         }
<a name="l00516"></a>00516       <span class="keywordflow">else</span>
<a name="l00517"></a>00517         {
<a name="l00518"></a>00518           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Initialized MPI with communicator!=MPI_COMM_WORLD: using &quot;</span> &lt;&lt; (int)nbproc &lt;&lt; <span class="stringliteral">&quot; processors&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 <span class="comment">// MPI_Group_free should be done before MPI_Finalize so not included into Comm_Group_MPI destructor</span>
<a name="l00525"></a><a class="code" href="classComm__Group__MPI.html#a6a600cab5400a4111064bb70bd7bbc93">00525</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a6a600cab5400a4111064bb70bd7bbc93">Comm_Group_MPI::free</a>()
<a name="l00526"></a>00526 {
<a name="l00527"></a>00527   <span class="keywordflow">if</span> (<a class="code" href="classComm__Group__MPI.html#aa1fe9449dec78267c37c1b9ca273d519">mpi_maxrequests_</a>!=-1) <span class="comment">//!&lt; Group is created when mpi_maxrequests_&gt;0 (avoid a crash with verifie_pere script)</span>
<a name="l00528"></a>00528 <span class="comment"></span>    <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Group_free(&amp; <a class="code" href="classComm__Group__MPI.html#aeb1df991997795d3f2595ac4a1662306" title="Handle sur le groupe mpi.">mpi_group_</a>));
<a name="l00529"></a>00529 }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531 <span class="comment">// Wrapper to MPI_Alltoallv. data type is MPI_CHAR</span>
<a name="l00532"></a><a class="code" href="classComm__Group__MPI.html#a1c2074239d54b259e624f14413f9e5e9">00532</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a1c2074239d54b259e624f14413f9e5e9">Comm_Group_MPI::all_to_allv</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src_buffer, <span class="keywordtype">int</span> *send_data_size, <span class="keywordtype">int</span> *send_data_offset,
<a name="l00533"></a>00533                                  <span class="keywordtype">void</span> *dest_buffer, <span class="keywordtype">int</span> *recv_data_size, <span class="keywordtype">int</span> *recv_data_offset)<span class="keyword"> const</span>
<a name="l00534"></a>00534 <span class="keyword"></span>{
<a name="l00535"></a>00535   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#a53741c4f88fd2385db3365a9f5b00cec">mpi_alltoall_counter_</a>);
<a name="l00536"></a>00536   assert(src_buffer != dest_buffer);
<a name="l00537"></a>00537   <span class="keywordtype">void</span> * ptr = (<span class="keywordtype">void</span> *) src_buffer; <span class="comment">//!&lt; Cast a cause de l&#39;interface de MPI_Alltoall</span>
<a name="l00538"></a>00538 <span class="comment"></span>
<a name="l00539"></a>00539   <span class="keyword">const</span> <span class="keywordtype">int</span> n = <a class="code" href="classComm__Group.html#a657c34d2d722170d7e052b594e17654c" title="Renvoie le nombre de processeurs dans le groupe *this.">nproc</a>();
<a name="l00540"></a>00540   <span class="keywordtype">int</span> size;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 <span class="preprocessor">#ifdef INT_is_64_</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span>  std::vector&lt;True_int&gt; send_data_size_int(n);
<a name="l00544"></a>00544   std::vector&lt;True_int&gt; send_data_offset_int(n);
<a name="l00545"></a>00545   std::vector&lt;True_int&gt; recv_data_size_int(n);
<a name="l00546"></a>00546   std::vector&lt;True_int&gt; recv_data_offset_int(n);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548   <span class="keyword">auto</span> cast_func = [](<span class="keywordtype">int</span> i) -&gt; <a class="code" href="arch_8h.html#a1caaf369d9c5f0817dbaa76b43b8d87b">True_int</a> { <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><a class="code" href="arch_8h.html#a1caaf369d9c5f0817dbaa76b43b8d87b">True_int</a><span class="keyword">&gt;</span>(i); };
<a name="l00549"></a>00549   std::transform(send_data_size,   send_data_size + n,   send_data_size_int.begin(),   cast_func);
<a name="l00550"></a>00550   std::transform(send_data_offset, send_data_offset + n, send_data_offset_int.begin(), cast_func);
<a name="l00551"></a>00551   std::transform(recv_data_size,   recv_data_size + n,   recv_data_size_int.begin(),   cast_func);
<a name="l00552"></a>00552   std::transform(recv_data_offset, recv_data_offset + n, recv_data_offset_int.begin(), cast_func);
<a name="l00553"></a>00553 
<a name="l00554"></a>00554   <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Alltoallv(ptr, send_data_size_int.data(), send_data_offset_int.data(), MPI_CHAR,
<a name="l00555"></a>00555                           dest_buffer, recv_data_size_int.data(), recv_data_offset_int.data(), MPI_CHAR, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00556"></a>00556   size = send_data_offset_int[n-1] + send_data_size_int[n-1] + recv_data_size_int[n-1] + recv_data_offset_int[n-1];
<a name="l00557"></a>00557 <span class="preprocessor">#else</span>
<a name="l00558"></a>00558 <span class="preprocessor"></span>  <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Alltoallv(ptr, send_data_size, send_data_offset, MPI_CHAR,
<a name="l00559"></a>00559                           dest_buffer, recv_data_size, recv_data_offset, MPI_CHAR, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00560"></a>00560   size = send_data_offset[n-1] + send_data_size[n-1] + recv_data_size[n-1] + recv_data_offset[n-1];
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 <span class="preprocessor">#endif</span>
<a name="l00563"></a>00563 <span class="preprocessor"></span>  <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#a53741c4f88fd2385db3365a9f5b00cec">mpi_alltoall_counter_</a>, size);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 
<a name="l00566"></a>00566 }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568 <span class="comment">//</span>
<a name="l00569"></a>00569 <span class="comment">//</span><span class="comment"></span>
<a name="l00570"></a>00570 <span class="comment">//! pour que trio_u n&#39;utilise qu&#39;une partie des processeurs&lt;br&gt;de MPI_COMM_WORLD, il faut donner un communicateur a utiliser avant&lt;br&gt;d&#39;appeler init_group_trio.</span>
<a name="l00571"></a><a class="code" href="classComm__Group__MPI.html#aa31aef3cb4cff5c721b77eb04dc4cf62">00571</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#aa31aef3cb4cff5c721b77eb04dc4cf62" title="pour que trio_u n&#39;utilise qu&#39;une partie des processeurs de MPI_COMM_WORLD, il faut donner un communic...">Comm_Group_MPI::set_trio_u_world</a>(MPI_Comm world)
<a name="l00572"></a>00572 {
<a name="l00573"></a>00573   <span class="keywordflow">if</span> (<a class="code" href="classComm__Group__MPI.html#ac297dcc148131d510d555cf3a19e4c8b">mpi_status_</a> != 0)
<a name="l00574"></a>00574     {
<a name="l00575"></a>00575       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error : the construction of the global Comm_Group_MPI has already been done\n&quot;</span>
<a name="l00576"></a>00576            &lt;&lt; <span class="stringliteral">&quot; set_trio_u_world call is forbidden&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00577"></a>00577       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00578"></a>00578     }
<a name="l00579"></a>00579 <span class="preprocessor">#ifdef PETSCKSP_H</span>
<a name="l00580"></a>00580 <span class="preprocessor"></span>  PETSC_COMM_WORLD= world;
<a name="l00581"></a>00581 <span class="preprocessor">#endif</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span>  <a class="code" href="classComm__Group__MPI.html#a2646c7c94faa11b114305ec5aeb37daf">trio_u_world_</a> = world;
<a name="l00583"></a>00583 }
<a name="l00584"></a>00584 
<a name="l00585"></a><a class="code" href="classComm__Group__MPI.html#ad97c766c2c2c94d935cef00b71cb1735">00585</a> MPI_Comm <a class="code" href="classComm__Group__MPI.html#ad97c766c2c2c94d935cef00b71cb1735">Comm_Group_MPI::get_trio_u_world</a>()
<a name="l00586"></a>00586 {
<a name="l00587"></a>00587   <span class="keywordflow">return</span> <a class="code" href="classComm__Group__MPI.html#a2646c7c94faa11b114305ec5aeb37daf">trio_u_world_</a>;
<a name="l00588"></a>00588 }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 
<a name="l00592"></a><a class="code" href="classComm__Group__MPI.html#ad10415ea6dbdbfa7603622362d78016a">00592</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#ad10415ea6dbdbfa7603622362d78016a">Comm_Group_MPI::set_must_mpi_initialize</a>(<span class="keywordtype">int</span> flag)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594   <span class="keywordflow">if</span> (<a class="code" href="classComm__Group__MPI.html#ac297dcc148131d510d555cf3a19e4c8b">mpi_status_</a> != 0)
<a name="l00595"></a>00595     {
<a name="l00596"></a>00596       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error : the construction of the global Comm_Group_MPI has already been done\n&quot;</span>
<a name="l00597"></a>00597            &lt;&lt; <span class="stringliteral">&quot; set_must_mpi_initialize() call is forbidden.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00598"></a>00598       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00599"></a>00599     }
<a name="l00600"></a>00600   <a class="code" href="classComm__Group__MPI.html#a1f180b302e5dee0d59b1bc2d92191358">must_mpi_initialize_</a> = flag;
<a name="l00601"></a>00601 }
<a name="l00602"></a>00602 
<a name="l00603"></a><a class="code" href="classComm__Group__MPI.html#a72595b44537b17a2b3be42532fc1cb81">00603</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a72595b44537b17a2b3be42532fc1cb81">Comm_Group_MPI::ptop_send_recv</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> * send_buf, <span class="keywordtype">int</span> send_buf_size, <span class="keywordtype">int</span> send_proc,
<a name="l00604"></a>00604                                     <span class="keywordtype">void</span> * recv_buf, <span class="keywordtype">int</span> recv_buf_size, <span class="keywordtype">int</span> recv_proc)<span class="keyword"> const</span>
<a name="l00605"></a>00605 <span class="keyword"></span>{
<a name="l00606"></a>00606   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#a72b0d4b3469ad6354c83b3ca05a3cd26">mpi_sendrecv_counter_</a>);
<a name="l00607"></a>00607   assert(<a class="code" href="classComm__Group__MPI.html#a7887bc3eb11b7e6e7766175031edba0f">mpi_nrequests_</a> &lt; 0);
<a name="l00608"></a>00608   <span class="keywordtype">int</span> dest = send_proc;
<a name="l00609"></a>00609   <span class="keywordtype">int</span> src = recv_proc;
<a name="l00610"></a>00610   <span class="keywordtype">int</span> tag = 1;
<a name="l00611"></a>00611   MPI_Status status;
<a name="l00612"></a>00612   <span class="keywordflow">if</span> (send_proc &lt; 0 &amp;&amp; recv_proc &lt; 0)
<a name="l00613"></a>00613     {
<a name="l00614"></a>00614 <span class="comment">// do nothing</span>
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (send_proc &lt; 0 &amp;&amp; recv_proc &gt;= 0)
<a name="l00617"></a>00617     {
<a name="l00618"></a>00618       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Recv (recv_buf, recv_buf_size, MPI_CHAR, src, tag, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>, &amp;status));
<a name="l00619"></a>00619     }
<a name="l00620"></a>00620   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (recv_proc &lt; 0 &amp;&amp; send_proc &gt;= 0)
<a name="l00621"></a>00621     {
<a name="l00622"></a>00622       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Send ((<span class="keywordtype">void</span>*)send_buf, send_buf_size, MPI_CHAR, dest, tag, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624   <span class="keywordflow">else</span>
<a name="l00625"></a>00625     {
<a name="l00626"></a>00626       assert(dest &gt;= 0 &amp;&amp; dest &lt; <a class="code" href="classComm__Group.html#a657c34d2d722170d7e052b594e17654c" title="Renvoie le nombre de processeurs dans le groupe *this.">nproc</a>());
<a name="l00627"></a>00627       assert(src &gt;= 0 &amp;&amp; src &lt; <a class="code" href="classComm__Group.html#a657c34d2d722170d7e052b594e17654c" title="Renvoie le nombre de processeurs dans le groupe *this.">nproc</a>());
<a name="l00628"></a>00628 <span class="comment">// Probleme: oblige de faire un cast de (const void*) en (void*) a cause</span>
<a name="l00629"></a>00629 <span class="comment">// du prototype de MPI_Send</span>
<a name="l00630"></a>00630       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Sendrecv((<span class="keywordtype">void</span>*)send_buf, send_buf_size, MPI_CHAR, dest, tag,
<a name="l00631"></a>00631                              recv_buf, recv_buf_size, MPI_CHAR, src, tag, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>,
<a name="l00632"></a>00632                              &amp;status));
<a name="l00633"></a>00633     }
<a name="l00634"></a>00634   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#a72b0d4b3469ad6354c83b3ca05a3cd26">mpi_sendrecv_counter_</a>, send_buf_size + recv_buf_size);
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <span class="comment">//</span>
<a name="l00638"></a>00638 <span class="comment">//</span>
<a name="l00639"></a>00639 <span class="comment">//</span><span class="comment"></span>
<a name="l00640"></a>00640 <span class="comment">//! Construction du groupe de processeurs a partir de la liste.&lt;br&gt;Voir Comm_Group::init_group(const ArrOfInt \&amp;)&lt;br&gt;Methode appelee par PE_Groups::create_group()</span>
<a name="l00641"></a><a class="code" href="classComm__Group__MPI.html#a45db10ac5badf78a0081ace81740bc76">00641</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a45db10ac5badf78a0081ace81740bc76" title="Construction du groupe de processeurs a partir de la liste. Voir Comm_Group::init_group(const ArrOfIn...">Comm_Group_MPI::init_group</a>(<span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; pe_list)
<a name="l00642"></a>00642 {
<a name="l00643"></a>00643   <a class="code" href="classComm__Group__MPI.html#ab0940f1663106b662a89762ab27fcb21" title="Faut-il le faire dans le destructeur ?">must_finalize_</a> = 0;
<a name="l00644"></a>00644 <span class="comment">// Le groupe &quot;tous&quot; doit exister</span>
<a name="l00645"></a>00645   assert(<a class="code" href="classComm__Group__MPI.html#ac297dcc148131d510d555cf3a19e4c8b">mpi_status_</a>);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   <a class="code" href="classComm__Group__MPI.html#a45db10ac5badf78a0081ace81740bc76" title="Construction du groupe de processeurs a partir de la liste. Voir Comm_Group::init_group(const ArrOfIn...">Comm_Group::init_group</a>(pe_list);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649   <span class="keyword">const</span> <a class="code" href="classComm__Group__MPI.html" title=": Classe Comm_Group_MPI, derivee de la classe abstraite Comm_Group. Cette classe represente un groupe...">Comm_Group_MPI</a>&amp; cg = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classComm__Group__MPI.html" title=": Classe Comm_Group_MPI, derivee de la classe abstraite Comm_Group. Cette classe represente un groupe...">Comm_Group_MPI</a>, <a class="code" href="classPE__Groups.html#ae6ca0277a58f2ab34ebfb3216578fa75" title="renvoie une reference au groupe de processeurs actif courant">PE_Groups::current_group</a>());
<a name="l00650"></a>00650 <span class="comment">// On stocke une reference au groupe pere : c&#39;est le groupe courant au moment</span>
<a name="l00651"></a>00651 <span class="comment">// de l&#39;appel a init_group. Le destructeur devra etre appele simultanement</span>
<a name="l00652"></a>00652 <span class="comment">// sur tous les processeurs du meme groupe.</span>
<a name="l00653"></a>00653   <a class="code" href="classComm__Group__MPI.html#ab56caedf91441bc0527ab04407d484f5">groupe_pere_</a> = <a class="code" href="classPE__Groups.html#ae6ca0277a58f2ab34ebfb3216578fa75" title="renvoie une reference au groupe de processeurs actif courant">PE_Groups::current_group</a>();
<a name="l00654"></a>00654 <span class="comment">// Construction du groupe MPI</span>
<a name="l00655"></a>00655   <span class="keyword">const</span> MPI_Group&amp; current_mpi_group = cg.<a class="code" href="classComm__Group__MPI.html#aeb1df991997795d3f2595ac4a1662306" title="Handle sur le groupe mpi.">mpi_group_</a>;
<a name="l00656"></a>00656   <span class="keyword">const</span> MPI_Comm&amp; current_mpi_comm  = cg.<a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>;
<a name="l00657"></a>00657 <span class="comment">// Copie de pe_list au cas ou int != int...</span>
<a name="l00658"></a>00658   <span class="keyword">const</span> <a class="code" href="arch_8h.html#a1caaf369d9c5f0817dbaa76b43b8d87b">True_int</a> nbproc = this-&gt;<a class="code" href="classComm__Group.html#a657c34d2d722170d7e052b594e17654c" title="Renvoie le nombre de processeurs dans le groupe *this.">nproc</a>();
<a name="l00659"></a>00659   <a class="code" href="arch_8h.html#a1caaf369d9c5f0817dbaa76b43b8d87b">True_int</a> *ranks = <span class="keyword">new</span> <a class="code" href="arch_8h.html#a1caaf369d9c5f0817dbaa76b43b8d87b">True_int</a>[nbproc];
<a name="l00660"></a>00660   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nbproc; i++)
<a name="l00661"></a>00661     ranks[i] = pe_list[i];
<a name="l00662"></a>00662   assert(<a class="code" href="classComm__Group__MPI.html#aeb1df991997795d3f2595ac4a1662306" title="Handle sur le groupe mpi.">mpi_group_</a>==MPI_GROUP_NULL);
<a name="l00663"></a>00663   <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Group_incl(current_mpi_group, nbproc, ranks, &amp; <a class="code" href="classComm__Group__MPI.html#aeb1df991997795d3f2595ac4a1662306" title="Handle sur le groupe mpi.">mpi_group_</a>));
<a name="l00664"></a>00664   <span class="keyword">delete</span>[] ranks;
<a name="l00665"></a>00665 <span class="comment">// Construction du communicator</span>
<a name="l00666"></a>00666 <span class="comment">// MPI_Comm_create renvoie MPI_COMM_NULL si le processeur courant</span>
<a name="l00667"></a>00667 <span class="comment">// n&#39;est pas dans le groupe.</span>
<a name="l00668"></a>00668   <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Comm_create(current_mpi_comm, <a class="code" href="classComm__Group__MPI.html#aeb1df991997795d3f2595ac4a1662306" title="Handle sur le groupe mpi.">mpi_group_</a>, &amp; <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a><a class="code" href="classComm__Group__MPI.html#a0b55b5203878fd5a4e99e1e8c79b60b0">00671</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a0b55b5203878fd5a4e99e1e8c79b60b0">Comm_Group_MPI::internal_collective</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> *x, <span class="keywordtype">int</span> *resu, <span class="keywordtype">int</span> nx, <span class="keyword">const</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302c">Collective_Op</a> *op, <span class="keywordtype">int</span> nop, <span class="keywordtype">int</span> level)<span class="keyword"> const</span>
<a name="l00672"></a>00672 <span class="keyword"></span>{
<a name="l00673"></a>00673 <span class="comment">// Pour l&#39;instant algo bourrin, a optimiser...</span>
<a name="l00674"></a>00674   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nx; i++)
<a name="l00675"></a>00675     {
<a name="l00676"></a>00676       <span class="keywordtype">int</span> j = (nop &lt; 0) ? 0 : i;
<a name="l00677"></a>00677       <span class="keywordflow">if</span> (op[j] != <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302ca31173cff9138da25f8a6f87612e14edb">COLL_PARTIAL_SUM</a>)
<a name="l00678"></a>00678         <a class="code" href="classComm__Group__MPI.html#a94080b311a19f8f450eb53af66bedcfe">mp_collective_op</a>(x+i, resu+i, 1, op[j]);
<a name="l00679"></a>00679       <span class="keywordflow">else</span>
<a name="l00680"></a>00680         resu[i] = <a class="code" href="classComm__Group__MPI.html#a66c5b1ccc9305d4f10e06672d4f8f92f" title="Renvoie la somme des x sur les processeurs precedents du groupe (moi non compris). Le resultat sur le premier processeur du groupe est donc toujours 0. Le resultat depend de l&#39;ordre dans lequel les processeurs ont ete fournis dans le constructeur.">mppartial_sum</a>(x[i]);
<a name="l00681"></a>00681     }
<a name="l00682"></a>00682 }
<a name="l00683"></a>00683 
<a name="l00684"></a><a class="code" href="classComm__Group__MPI.html#a2e63b80449dc6ab52adb891be0f24bc1">00684</a> <span class="keywordtype">void</span> <a class="code" href="classComm__Group__MPI.html#a0b55b5203878fd5a4e99e1e8c79b60b0">Comm_Group_MPI::internal_collective</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> *x, <span class="keywordtype">double</span> *resu, <span class="keywordtype">int</span> nx, <span class="keyword">const</span> <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302c">Collective_Op</a> *op, <span class="keywordtype">int</span> nop, <span class="keywordtype">int</span> level)<span class="keyword"> const</span>
<a name="l00685"></a>00685 <span class="keyword"></span>{
<a name="l00686"></a>00686 <span class="comment">// Pour l&#39;instant algo bourrin, a optimiser...</span>
<a name="l00687"></a>00687   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nx; i++)
<a name="l00688"></a>00688     {
<a name="l00689"></a>00689       <span class="keywordtype">int</span> j = (nop &lt; 0) ? 0 : i;
<a name="l00690"></a>00690       <span class="keywordflow">if</span> (op[j] != <a class="code" href="classComm__Group.html#a16a3e8b4b57b4ac0ee1d237b4a7e302ca31173cff9138da25f8a6f87612e14edb">COLL_PARTIAL_SUM</a>)
<a name="l00691"></a>00691         <a class="code" href="classComm__Group__MPI.html#a94080b311a19f8f450eb53af66bedcfe">mp_collective_op</a>(x+i, resu+i, 1, op[j]);
<a name="l00692"></a>00692       <span class="keywordflow">else</span>
<a name="l00693"></a>00693         {
<a name="l00694"></a>00694           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error in Comm_Group_MPI: COLL_PARTIAL_SUM not coded for double&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00695"></a>00695           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00696"></a>00696         }
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698 }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 <span class="comment">//</span>
<a name="l00701"></a>00701 <span class="comment">//</span>
<a name="l00702"></a>00702 <span class="comment">//</span>
<a name="l00703"></a>00703 <span class="comment">//</span><span class="comment"></span>
<a name="l00704"></a>00704 <span class="comment">//! Renvoie la somme des x sur les processeurs precedents du groupe (moi non&lt;br&gt;compris). Le resultat sur le premier processeur du groupe est donc toujours 0.&lt;br&gt;Le resultat depend de l&#39;ordre dans lequel les processeurs ont ete&lt;br&gt;fournis dans le constructeur.</span>
<a name="l00705"></a><a class="code" href="classComm__Group__MPI.html#a66c5b1ccc9305d4f10e06672d4f8f92f">00705</a> <span class="comment"></span><span class="keywordtype">int</span> <a class="code" href="classComm__Group__MPI.html#a66c5b1ccc9305d4f10e06672d4f8f92f" title="Renvoie la somme des x sur les processeurs precedents du groupe (moi non compris). Le resultat sur le premier processeur du groupe est donc toujours 0. Le resultat depend de l&#39;ordre dans lequel les processeurs ont ete fournis dans le constructeur.">Comm_Group_MPI::mppartial_sum</a>(<span class="keywordtype">int</span> x)<span class="keyword"> const</span>
<a name="l00706"></a>00706 <span class="keyword"></span>{
<a name="l00707"></a>00707   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#a8e0d5616fa17fb32b1cf39ea24321f30">mpi_partialsum_counter_</a>);
<a name="l00708"></a>00708 <span class="comment">// ATTENTION : il faut &quot;int&quot; et pas &quot;entier&quot; !!!</span>
<a name="l00709"></a>00709   <span class="keywordtype">int</span> somme = 0;
<a name="l00710"></a>00710   MPI_Status status;
<a name="l00711"></a>00711   <span class="keywordtype">int</span> tag = <a class="code" href="classComm__Group.html#ae931965f99ed3a85bdcc7d2864f81318" title="Cette fonction renvoie un nouveau tag de communication pour le groupe. Effet de bord : incremente le ...">get_new_tag</a>();
<a name="l00712"></a>00712   <span class="keywordtype">int</span> rang = <a class="code" href="classComm__Group.html#a4ce6b03e1167d23c5e0e1e3447012c51" title="Renvoie le rang du processeur local dans le groupe *this. ou -1 si je ne suis pas dans le groupe...">rank</a>();
<a name="l00713"></a>00713   <span class="keywordtype">int</span> np = <a class="code" href="classComm__Group.html#a657c34d2d722170d7e052b594e17654c" title="Renvoie le nombre de processeurs dans le groupe *this.">nproc</a>();
<a name="l00714"></a>00714 
<a name="l00715"></a>00715   <span class="keywordflow">if</span> (rang &gt; 0)
<a name="l00716"></a>00716     {
<a name="l00717"></a>00717 <span class="comment">// Recoit la somme partielle du precedent</span>
<a name="l00718"></a>00718       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Recv(&amp; somme, 1, <a class="code" href="Comm__Group__MPI_8cpp.html#a9b683f6cb98289e218b17558829d3e80">MPI_ENTIER</a>, rang-1, tag, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>, &amp;status));
<a name="l00719"></a>00719     }
<a name="l00720"></a>00720   <span class="keywordflow">if</span> (rang+1 &lt; np)
<a name="l00721"></a>00721     {
<a name="l00722"></a>00722 <span class="comment">// Envoie la somme partielle au suivant</span>
<a name="l00723"></a>00723 <span class="comment">// ATTENTION : il faut &quot;int&quot; et pas &quot;entier&quot; !!!</span>
<a name="l00724"></a>00724       <span class="keywordtype">int</span> s = somme + x;
<a name="l00725"></a>00725       <a class="code" href="Comm__Group__MPI_8cpp.html#a265439e51f8f5520231fb29ce4ec9bc2" title="Partie inline du traitement d&#39;erreur mpi (on inline le test: sauf exception, il n&#39;y a pas d&#39;appel de ...">mpi_error</a>(MPI_Send(&amp; s, 1, <a class="code" href="Comm__Group__MPI_8cpp.html#a9b683f6cb98289e218b17558829d3e80">MPI_ENTIER</a>, rang+1, tag, <a class="code" href="classComm__Group__MPI.html#ab4a35fa2aec8a158b54e0f6a0f138a59" title="Handle sur le communicateur mpi.">mpi_comm_</a>));
<a name="l00726"></a>00726     }
<a name="l00727"></a>00727   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#a8e0d5616fa17fb32b1cf39ea24321f30">mpi_partialsum_counter_</a>);
<a name="l00728"></a>00728   <span class="keywordflow">return</span> somme;
<a name="l00729"></a>00729 }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731 <span class="preprocessor">#endif</span>
<a name="l00732"></a>00732 <span class="preprocessor"></span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Dec 14 2021 19:35:26 for TRUST by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TRUST: src/Kernel/Geometrie/Reordonner_faces_periodiques.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TRUST&#160;<span id="projectnumber">1.8.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">src/Kernel/Geometrie/Reordonner_faces_periodiques.cpp</div>  </div>
</div>
<div class="contents">
<a href="Reordonner__faces__periodiques_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/****************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">* Copyright (c) 2021, CEA</span>
<a name="l00003"></a>00003 <span class="comment">* All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment">*</span>
<a name="l00005"></a>00005 <span class="comment">* Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<a name="l00006"></a>00006 <span class="comment">* 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
<a name="l00007"></a>00007 <span class="comment">* 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<a name="l00008"></a>00008 <span class="comment">* 3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
<a name="l00009"></a>00009 <span class="comment">*</span>
<a name="l00010"></a>00010 <span class="comment">* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<a name="l00011"></a>00011 <span class="comment">* IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;</span>
<a name="l00012"></a>00012 <span class="comment">* OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00013"></a>00013 <span class="comment">*</span>
<a name="l00014"></a>00014 <span class="comment">*****************************************************************************/</span>
<a name="l00015"></a>00015 <span class="comment">//</span>
<a name="l00016"></a>00016 <span class="comment">// </span>
<a name="l00017"></a>00017 <span class="comment">// File:        Reordonner_faces_periodiques.cpp</span>
<a name="l00018"></a>00018 <span class="comment">// Directory:   $TRUST_ROOT/src/Kernel/Geometrie</span>
<a name="l00019"></a>00019 <span class="comment">// Version:     /main/26</span>
<a name="l00020"></a>00020 <span class="comment">// </span>
<a name="l00021"></a>00021 <span class="comment">//</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;<a class="code" href="Reordonner__faces__periodiques_8h.html">Reordonner_faces_periodiques.h</a>&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="code" href="Domaine_8h.html">Domaine.h</a>&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="code" href="Scatter_8h.html">Scatter.h</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="Octree__Double_8h.html">Octree_Double.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="Param_8h.html">Param.h</a>&gt;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a><a class="code" href="Reordonner__faces__periodiques_8cpp.html#a137d78a01e63d3b66d1b2ed0de0f4c4c">00028</a> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="Reordonner__faces__periodiques_8cpp.html#a137d78a01e63d3b66d1b2ed0de0f4c4c">message</a>()
<a name="l00029"></a>00029 {
<a name="l00030"></a>00030   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You need to use the Corriger_frontiere_periodique keyword on the periodic boundaries.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00031"></a>00031   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;See the reference manual to use this keyword on your data file.&quot;</span> &lt;&lt; finl;
<a name="l00032"></a>00032 }
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="Reordonner__faces__periodiques_8cpp.html#a9ccc16e361d118d704a6e7c93ec0b3df">00034</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="Reordonner__faces__periodiques_8cpp.html#a9ccc16e361d118d704a6e7c93ec0b3df">calculer_vecteur_2faces</a>(<span class="keyword">const</span> <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; coord,
<a name="l00035"></a>00035                                            <span class="keyword">const</span> <a class="code" href="classIntTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un IntVect avec calculs de l&#39;indice corespondant Voir les co...">IntTab</a>&amp; faces,
<a name="l00036"></a>00036                                            <span class="keyword">const</span> <span class="keywordtype">int</span> i_face1,
<a name="l00037"></a>00037                                            <span class="keyword">const</span> <span class="keywordtype">int</span> i_face2,
<a name="l00038"></a>00038                                            <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a>&amp; vect)
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040   <span class="keyword">const</span> <span class="keywordtype">int</span> nb_som_faces = faces.<a class="code" href="classIntTab.html#abc3b32c94925a82f69d5b153a356e359" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(1);
<a name="l00041"></a>00041   <span class="keyword">const</span> <span class="keywordtype">int</span> dim = coord.<a class="code" href="classDoubleTab.html#ac3805e2637a3b880ba2d3e650c69dac4" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(1);
<a name="l00042"></a>00042   assert(vect.<a class="code" href="classArrOfDouble.html#a3c3b33bea0e88b87315c21ee94bee05f" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>() == dim);
<a name="l00043"></a>00043   vect = 0.;
<a name="l00044"></a>00044 <span class="comment">// Calcul du vecteur entre le centre de la face i et le centre de la face i+n</span>
<a name="l00045"></a>00045   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; nb_som_faces; j++)
<a name="l00046"></a>00046     {
<a name="l00047"></a>00047       <span class="keyword">const</span> <span class="keywordtype">int</span> sommet1 = faces(i_face1, j);
<a name="l00048"></a>00048       <span class="keyword">const</span> <span class="keywordtype">int</span> sommet2 = faces(i_face2, j);
<a name="l00049"></a>00049       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> compo = 0; compo &lt; dim; compo++)
<a name="l00050"></a>00050         vect[compo] += coord(sommet2, compo) - coord(sommet1, compo);
<a name="l00051"></a>00051     }
<a name="l00052"></a>00052   vect /= nb_som_faces;
<a name="l00053"></a>00053 }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="Reordonner__faces__periodiques_8cpp.html#a01a9b5b584c7cfcd7362404cea1d69a9">00056</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="Reordonner__faces__periodiques_8cpp.html#a01a9b5b584c7cfcd7362404cea1d69a9">local_norme_vect</a>(<span class="keyword">const</span> <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; dv)
<a name="l00057"></a>00057 {
<a name="l00058"></a>00058   <span class="keywordtype">double</span> x=0.0;
<a name="l00059"></a>00059   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt; dv.<a class="code" href="classDoubleVect.html#a4a6987db458541cdcd10495955f25263" title="Taille de l&#39;espace &quot;reel&quot; du vecteur. (si md_vector_ est nul, cette valeur est identique a size_arr...">size_reelle</a>(); i++)
<a name="l00060"></a>00060     x += dv(i)*dv(i);
<a name="l00061"></a>00061   x = sqrt(x);
<a name="l00062"></a>00062   <span class="keywordflow">return</span> x;
<a name="l00063"></a>00063 }
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="classReordonner__faces__periodiques.html#ad93560d3838d3516deb892d88b47dedf">00065</a> <span class="keywordtype">void</span> <a class="code" href="classReordonner__faces__periodiques.html#ad93560d3838d3516deb892d88b47dedf">Reordonner_faces_periodiques::chercher_direction_perio</a>(<a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a>&amp; direction_perio, <span class="keyword">const</span> <a class="code" href="classDomaine.html" title="Classe Domaine Un Domaine represente le domaine (spatial) de resolution d&#39;un Probleme. Un Domaine a un Nom, il est constitue d&#39;une ou plusieurs Zone qui peuvent etre eventuellement decoupees en Sous_Zone. Un Domaine porte l&#39;ensemble des sommets utilises par ses Zones. On peut vouloir resoudre des problemes de type different sur plusieurs domaines, geometriquement les domaines sont alors couples par des surfaces qu&#39;on appelle Raccord.">Domaine</a>&amp; dom, <span class="keyword">const</span> <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>&amp; bord)
<a name="l00066"></a>00066 {
<a name="l00067"></a>00067   <span class="keyword">const</span> <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; sommets = dom.<a class="code" href="classDomaine.html#aecd32c3eecc15cce7d1a0e468dadbf96" title="Renvoie le tableau des coordonnees des noeuds (sommets). (acces en lecture)">coord_sommets</a>();
<a name="l00068"></a>00068   <span class="keyword">const</span> <span class="keywordtype">int</span> dim = sommets.<a class="code" href="classDoubleTab.html#ac3805e2637a3b880ba2d3e650c69dac4" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(1);
<a name="l00069"></a>00069   direction_perio.<a class="code" href="classArrOfDouble.html#a610464f4b3dccac6f814915b526783ed">resize_array</a>(dim);
<a name="l00070"></a>00070   direction_perio = 0.;
<a name="l00071"></a>00071   <span class="keyword">const</span> <a class="code" href="classFrontiere.html" title="Classe Frontiere. Une Frontiere decrit une partie de la frontiere d&#39;une Zone, elle possede un Nom...">Frontiere</a>&amp; front = dom.<a class="code" href="classDomaine.html#a0e62f2bc829542fafa29e3f2c614159c" title="Renvoie la i-ieme zone du domaine. (version const)">zone</a>(0).<a class="code" href="classZone.html#ac338b119d4b0bc4f510a223b9086fe5e">frontiere</a>(bord);
<a name="l00072"></a>00072   <span class="keyword">const</span> <span class="keywordtype">int</span> nb_faces = front.<a class="code" href="classFrontiere.html#aa073fe9dbdddde59471ee7032b256aa2" title="Renvoie le nombre de faces de la frontiere.">nb_faces</a>();
<a name="l00073"></a>00073   <span class="keywordflow">if</span> (nb_faces == 0)
<a name="l00074"></a>00074     <span class="keywordflow">return</span>;
<a name="l00075"></a>00075   <span class="keyword">const</span> <a class="code" href="classIntTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un IntVect avec calculs de l&#39;indice corespondant Voir les co...">IntTab</a>&amp; faces = front.<a class="code" href="classFrontiere.html#ac64479069f0c43a17cb5766a39ce5ba8" title="Renvoie les faces de la frontiere&lt;br&gt;(version const)">faces</a>().<a class="code" href="classFaces.html#a07b8d8db9e3d656b93a21a49c063430c">les_sommets</a>();
<a name="l00076"></a>00076   <span class="keyword">const</span> <span class="keywordtype">int</span> nb_som_face = faces.<a class="code" href="classIntTab.html#abc3b32c94925a82f69d5b153a356e359" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(1);
<a name="l00077"></a>00077   <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a> normale(1, dim);
<a name="l00078"></a>00078   <a class="code" href="classIntTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un IntVect avec calculs de l&#39;indice corespondant Voir les co...">IntTab</a> une_face(1, nb_som_face);
<a name="l00079"></a>00079   <span class="keywordtype">int</span> i;
<a name="l00080"></a>00080   <span class="keywordflow">for</span> (i = 0; i &lt; nb_som_face; i++)
<a name="l00081"></a>00081     une_face(0, i) = faces(0, i);
<a name="l00082"></a>00082   dom.<a class="code" href="classDomaine.html#a0e62f2bc829542fafa29e3f2c614159c" title="Renvoie la i-ieme zone du domaine. (version const)">zone</a>(0).<a class="code" href="classZone.html#a18cf83cd0f9c368dcfa32fb802a0ac94" title="Renvoie un element geometrique du type de ceux qui constituent la zone. (version const)">type_elem</a>().<a class="code" href="classElem__geom.html#ae13918e636dd8b8b6b3c3e033d1bd047" title="Appel a l&#39;objet sous-jacent Calcule les normales aux faces des elements de la zone associee...">calculer_normales</a>(une_face, normale);
<a name="l00083"></a>00083   normale /= <a class="code" href="Reordonner__faces__periodiques_8cpp.html#a01a9b5b584c7cfcd7362404cea1d69a9">local_norme_vect</a>(normale);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085   <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a> delta(nb_faces);
<a name="l00086"></a>00086   <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a> vect(dim);
<a name="l00087"></a>00087   <span class="keywordflow">for</span> (i = 1; i &lt; nb_faces; i++)
<a name="l00088"></a>00088     {
<a name="l00089"></a>00089       <a class="code" href="Reordonner__faces__periodiques_8cpp.html#a9ccc16e361d118d704a6e7c93ec0b3df">calculer_vecteur_2faces</a>(sommets, faces, 0, i, vect);
<a name="l00090"></a>00090       <span class="keywordtype">double</span> x = 0.;
<a name="l00091"></a>00091       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; dim; j++)
<a name="l00092"></a>00092         x += vect[j] * normale(0,j);
<a name="l00093"></a>00093       delta[i] = x;
<a name="l00094"></a>00094     }
<a name="l00095"></a>00095   <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="Double_8h.html#a2f8edc4561e9744ed4233b205fa7ec32">min</a> = <a class="code" href="ArrOfDouble_8cpp.html#abd3998749a1a8dab00dd6ac1798327fb" title="Retourne la valeur minimale.">min_array</a>(delta);
<a name="l00096"></a>00096   <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="Double_8h.html#a1c45761573e6cbc97cfacac78d905016">max</a> = <a class="code" href="ArrOfDouble_8cpp.html#a95241fccf4bed7fb7a4e2340b7735f14" title="Retourne la valeur maximale.">max_array</a>(delta);
<a name="l00097"></a>00097   <span class="keywordtype">double</span> facteur = (<a class="code" href="Double_8h.html#aaecd4ca8a2fe69cc6568af2938b94d2e">dabs</a>(min) &gt; <a class="code" href="Double_8h.html#aaecd4ca8a2fe69cc6568af2938b94d2e">dabs</a>(max)) ? min : max;
<a name="l00098"></a>00098   <span class="keywordflow">for</span> (i = 0; i &lt; dim; i++)
<a name="l00099"></a>00099     direction_perio[i] = normale(0, i) * facteur;
<a name="l00100"></a>00100   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Periodicity direction for &quot;</span> &lt;&lt; dom.<a class="code" href="classDomaine.html#a87e2cdc035a26565e6fe481446aa4cd3" title="Renvoie le nom du domaine.">le_nom</a>() &lt;&lt; <span class="stringliteral">&quot;/&quot;</span> &lt;&lt; bord &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; direction_perio;
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="comment">//</span>
<a name="l00104"></a>00104 <span class="comment">//</span>
<a name="l00105"></a>00105 <span class="comment">//</span>
<a name="l00106"></a>00106 <span class="comment">//</span>
<a name="l00107"></a>00107 <span class="comment">//</span>
<a name="l00108"></a>00108 <span class="comment">//</span>
<a name="l00109"></a>00109 <span class="comment">//</span>
<a name="l00110"></a>00110 <span class="comment">//</span>
<a name="l00111"></a>00111 <span class="comment">//</span>
<a name="l00112"></a>00112 <span class="comment">//</span><span class="comment"></span>
<a name="l00113"></a>00113 <span class="comment">//! Reordonne le tableau &quot;faces&quot; selon la convention des faces periodiques:&lt;br&gt;D&#39;abord les faces d&#39;une extremite, puis dans le meme ordre, les faces jumelles.&lt;br&gt;Attention, l&#39;algorithme est en n carre (lent), et ne fonctionne qu&#39;en sequentiel.&lt;br&gt;Parametre: zone&lt;br&gt;Signification: la zone a laquelle appartiennent les faces&lt;br&gt;Parametre: direction_perio&lt;br&gt;Signification: le vecteur qui separe le centre d&#39;une face au centre de la face opposee&lt;br&gt;Parametre: faces&lt;br&gt;Signification: le tableau des faces (pour chaque face, indices de ses sommets) a reordonner&lt;br&gt;Valeur de retour: 1 si ok, 0 si on n&#39;a pas trouve de face jumelle a une face a precision_geom pres.</span>
<a name="l00114"></a><a class="code" href="classReordonner__faces__periodiques.html#a3d177f6fcafb470513dad54fe4d9f79a">00114</a> <span class="comment"></span><span class="keywordtype">int</span> <a class="code" href="classReordonner__faces__periodiques.html#a3d177f6fcafb470513dad54fe4d9f79a" title="Reordonne le tableau &quot;faces&quot; selon la convention des faces periodiques: D&#39;abord les faces d&#39;une ext...">Reordonner_faces_periodiques::reordonner_faces_periodiques</a>(<span class="keyword">const</span> <a class="code" href="classDomaine.html" title="Classe Domaine Un Domaine represente le domaine (spatial) de resolution d&#39;un Probleme. Un Domaine a un Nom, il est constitue d&#39;une ou plusieurs Zone qui peuvent etre eventuellement decoupees en Sous_Zone. Un Domaine porte l&#39;ensemble des sommets utilises par ses Zones. On peut vouloir resoudre des problemes de type different sur plusieurs domaines, geometriquement les domaines sont alors couples par des surfaces qu&#39;on appelle Raccord.">Domaine</a>&amp; domaine,
<a name="l00115"></a>00115                                                                <a class="code" href="classIntTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un IntVect avec calculs de l&#39;indice corespondant Voir les co...">IntTab</a>&amp; faces,
<a name="l00116"></a>00116                                                                <span class="keyword">const</span> <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a>&amp; direction_perio,
<a name="l00117"></a>00117                                                                <span class="keyword">const</span> <span class="keywordtype">double</span> epsilon)
<a name="l00118"></a>00118 {
<a name="l00119"></a>00119 <span class="comment">// Modif B.M. 04/06/2010: j&#39;autorise l&#39;operation en parallele car c&#39;est utilise par</span>
<a name="l00120"></a>00120 <span class="comment">// l&#39;interprete MaillerParallel...</span>
<a name="l00121"></a>00121 <span class="comment">// PL 18/11/2010: Je deplace neanmoins l&#39;interdiction de l&#39;utilisation de l&#39;interprete en // dans le jeu de donnees (voir ::interpreter_)</span>
<a name="l00122"></a>00122   <span class="keyword">const</span> <span class="keywordtype">int</span> nb_faces = faces.<a class="code" href="classIntTab.html#abc3b32c94925a82f69d5b153a356e359" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(0);
<a name="l00123"></a>00123   <span class="keyword">const</span> <span class="keywordtype">int</span> nb_som_faces = faces.<a class="code" href="classIntTab.html#abc3b32c94925a82f69d5b153a356e359" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(1);
<a name="l00124"></a>00124   <span class="keyword">const</span> <span class="keywordtype">int</span> dim = domaine.<a class="code" href="classDomaine.html#a0846ac03a10b65c4df911fe35a19c02f" title="Renvoie le nombre total de sommets.">les_sommets</a>().<a class="code" href="classDoubleTab.html#ac3805e2637a3b880ba2d3e650c69dac4" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(1);
<a name="l00125"></a>00125 <span class="comment">// Calcul des coordonnees des centres des faces:</span>
<a name="l00126"></a>00126   <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a> centres(nb_faces, 3);
<a name="l00127"></a>00127   {
<a name="l00128"></a>00128     <span class="keyword">const</span> <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a>&amp; coord = domaine.<a class="code" href="classDomaine.html#a0846ac03a10b65c4df911fe35a19c02f" title="Renvoie le nombre total de sommets.">les_sommets</a>();
<a name="l00129"></a>00129     <span class="keyword">const</span> <span class="keywordtype">double</span> inv_nb_som = 1. / (double) nb_som_faces;
<a name="l00130"></a>00130     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nb_faces; i++)
<a name="l00131"></a>00131       {
<a name="l00132"></a>00132         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; nb_som_faces; j++)
<a name="l00133"></a>00133           {
<a name="l00134"></a>00134             <span class="keyword">const</span> <span class="keywordtype">int</span> sommet = faces(i, j);
<a name="l00135"></a>00135             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; dim; k++)
<a name="l00136"></a>00136               centres(i, k) += coord(sommet, k) * inv_nb_som;
<a name="l00137"></a>00137           }
<a name="l00138"></a>00138       }
<a name="l00139"></a>00139   }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <span class="comment">// Construction d&#39;un octree contenant les centres des faces:</span>
<a name="l00142"></a>00142   <a class="code" href="classOctree__Double.html" title=": Un octree permettant de chercher dans l&#39;espace des elements ou des points decrits par des coordonne...">Octree_Double</a> octree;
<a name="l00143"></a>00143   octree.<a class="code" href="classOctree__Double.html#a0b66bd315e7f45a024695b6a2764e7d4" title="construit un octree contenant les points de coordonnees coords. Si include_virtual=1, on stocke coords.dimension_tot(0) elements, sinon on en stocke coords.dimension(0) Si epsilon = 0, on construit un octree de points de taille nulle (chaque point se trouve dans un seul octree_floor) Sinon, on construit un octree d&#39;elements cubiques centres sur les coords, de demie-largeur epsilon. Un point peut alors se trouver dans plusieurs octree_floor.">build_nodes</a>(centres, 0 <span class="comment">/* do not include virtual nodes */</span>);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="comment">// Pour chaque face, on cherche sa face periodique associee (dont le centre</span>
<a name="l00146"></a>00146 <span class="comment">// est decale de direction_perio).</span>
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="comment">// Pour chaque face, son nouvel indice dans le tableau des faces</span>
<a name="l00149"></a>00149   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a> renum_faces(nb_faces);
<a name="l00150"></a>00150   renum_faces= -1;
<a name="l00151"></a>00151   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a> nodes_list;
<a name="l00152"></a>00152   nodes_list.<a class="code" href="classArrOfInt.html#a22d744bcd452d039580d1d9186f02b4e" title="Change le mode l&#39;allocation memoire: reallocation d&#39;un tableau a chaque changement de taille (flag = ...">set_smart_resize</a>(1);
<a name="l00153"></a>00153   <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a> coord(dim);
<a name="l00154"></a>00154   <span class="keywordtype">int</span> count = 0;
<a name="l00155"></a>00155   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i_face = 0; i_face &lt; nb_faces; i_face++)
<a name="l00156"></a>00156     {
<a name="l00157"></a>00157       <span class="keywordflow">if</span> (renum_faces[i_face] &gt;= 0)
<a name="l00158"></a>00158         <span class="keywordflow">continue</span>; <span class="comment">//!&lt; Face deja traitee, on passe Cherche la face opposee dans les deux directions (-1. et +1.)</span>
<a name="l00159"></a>00159 <span class="comment"></span><span class="comment">//</span>
<a name="l00160"></a>00160       <span class="keywordtype">double</span> facteur;
<a name="l00161"></a>00161       <span class="keywordtype">int</span> i_face2 = -1;
<a name="l00162"></a>00162       <span class="keywordflow">for</span> (facteur = -1.; facteur &lt; 1.5; facteur += 2.)
<a name="l00163"></a>00163         {
<a name="l00164"></a>00164           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; dim; i++)
<a name="l00165"></a>00165             coord[i] = centres(i_face, i) + facteur * direction_perio[i];
<a name="l00166"></a>00166           octree.<a class="code" href="classOctree__Double.html#a1dffcace51ca06cb52ff6e2330ab4b2e" title="cherche tous les elements ou points ayant potentiellement une intersection non vide avec la boite don...">search_elements_box</a>(coord, epsilon, nodes_list);
<a name="l00167"></a>00167           i_face2 = octree.<a class="code" href="classOctree__Double.html#a8ba1f6ceba5dae2af587d2f9a766aac2" title="Methode hors classe Cherche parmi les sommets de la liste node_list ceux qui sont a une distance infe...">search_nodes_close_to</a>(coord, centres, nodes_list, epsilon);
<a name="l00168"></a>00168           <span class="keywordflow">if</span> (i_face2 &gt;= 0)
<a name="l00169"></a>00169             <span class="keywordflow">break</span>;
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171       <span class="keywordflow">if</span> (i_face2 &gt;= 0)
<a name="l00172"></a>00172         {
<a name="l00173"></a>00173           <span class="keywordflow">if</span> (renum_faces[i_face2] &gt;= 0)
<a name="l00174"></a>00174             {
<a name="l00175"></a>00175               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;====================================================&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00176"></a>00176               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error in reordonner_faces_periodiques: the face &quot;</span> &lt;&lt; i_face
<a name="l00177"></a>00177                    &lt;&lt; <span class="stringliteral">&quot; of &quot;</span> &lt;&lt; centres(i_face,0) &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; centres(i_face,1) &lt;&lt; <span class="stringliteral">&quot; &quot;</span>
<a name="l00178"></a>00178                    &lt;&lt; ((dim==3)?centres(i_face,2):0.)
<a name="l00179"></a>00179                    &lt;&lt; <span class="stringliteral">&quot; center already has a face twin.&quot;</span>
<a name="l00180"></a>00180                    &lt;&lt; finl;
<a name="l00181"></a>00181               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Possible problem: the boundary is not periodic. Check your mesh.&quot;</span> &lt;&lt; finl;
<a name="l00182"></a>00182               <span class="keywordflow">return</span> 0;
<a name="l00183"></a>00183             }
<a name="l00184"></a>00184           <span class="keywordtype">int</span> f0 = (facteur &gt; 0.) ? i_face : i_face2;
<a name="l00185"></a>00185           <span class="keywordtype">int</span> <a class="code" href="Lois__sodium_8h.html#a3034a1fb8c782842a2b9473c0f02a448">f1</a> = (facteur &gt; 0.) ? i_face2: i_face;
<a name="l00186"></a>00186           renum_faces(f0) = count;
<a name="l00187"></a>00187           renum_faces(f1) = count + nb_faces / 2;
<a name="l00188"></a>00188           count++;
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190       <span class="keywordflow">else</span>
<a name="l00191"></a>00191         {
<a name="l00192"></a>00192           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;====================================================&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00193"></a>00193           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error in reordonner_faces_periodiques: the face &quot;</span> &lt;&lt; i_face &lt;&lt; <span class="stringliteral">&quot; of &quot;</span> &lt;&lt; centres(i_face,0) &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; centres(i_face,1) &lt;&lt; <span class="stringliteral">&quot; &quot;</span>
<a name="l00194"></a>00194                &lt;&lt; ((dim==3)?centres(i_face,2):0.) &lt;&lt; finl;
<a name="l00195"></a>00195           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;center has no face twin into the specified direction in the list of faces.&quot;</span> &lt;&lt; finl;
<a name="l00196"></a>00196           <span class="keywordflow">return</span> 0;
<a name="l00197"></a>00197         }
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199 <span class="comment">// Reordonner les faces:</span>
<a name="l00200"></a>00200   <span class="keyword">const</span> <a class="code" href="classIntTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un IntVect avec calculs de l&#39;indice corespondant Voir les co...">IntTab</a> oldfaces(faces);
<a name="l00201"></a>00201   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nb_faces; i++)
<a name="l00202"></a>00202     {
<a name="l00203"></a>00203       <span class="keyword">const</span> <span class="keywordtype">int</span> new_i = renum_faces(i);
<a name="l00204"></a>00204       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; nb_som_faces; j++)
<a name="l00205"></a>00205         faces(new_i, j) = oldfaces(i, j);
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207   <span class="keywordflow">return</span> 1;
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="comment">//</span>
<a name="l00211"></a>00211 <span class="comment">//</span>
<a name="l00212"></a>00212 <span class="comment">//</span>
<a name="l00213"></a>00213 <span class="comment">//</span>
<a name="l00214"></a>00214 <span class="comment">//</span><span class="comment"></span>
<a name="l00215"></a>00215 <span class="comment">//! essaie de verifier si les faces du bord num_bord sont ordonnees suivant la convention&lt;br&gt;des faces periodiques. On stocke dans vecteur_delta la direction de periodicite presumee (intervalle&lt;br&gt;mesure entre la premiere face et la face jumelle), et erreur le max de l&#39;erreur par rapport a cette&lt;br&gt;mesure pour les autres faces.&lt;br&gt;En parallele, l&#39;erreur est le max sur tous les processeurs&lt;br&gt;Valeur de retour: 1 si ok, 0 si l&#39;erreur est superieure a precision_geom.</span>
<a name="l00216"></a><a class="code" href="classReordonner__faces__periodiques.html#a57cfec8f17ae27a831df8c1a6c27e8cf">00216</a> <span class="comment"></span><span class="keywordtype">int</span> <a class="code" href="classReordonner__faces__periodiques.html#a57cfec8f17ae27a831df8c1a6c27e8cf" title="essaie de verifier si les faces du bord num_bord sont ordonnees suivant la convention des faces perio...">Reordonner_faces_periodiques::check_faces_periodiques</a>(<span class="keyword">const</span> <a class="code" href="classFrontiere.html" title="Classe Frontiere. Une Frontiere decrit une partie de la frontiere d&#39;une Zone, elle possede un Nom...">Frontiere</a>&amp; frontiere,
<a name="l00217"></a>00217                                                           <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a>&amp; vecteur_delta,
<a name="l00218"></a>00218                                                           <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a>&amp; <a class="code" href="Solv__GCP__NS_8cpp.html#ab6aa1075b965c7713d8db20dd3a8e09b">erreur</a>,
<a name="l00219"></a>00219                                                           <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="Solv__Petsc_8cpp.html#ab3f078684998b83967d507d0f453f454">verbose</a>)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221   <span class="keyword">const</span> <span class="keywordtype">int</span> dim = <a class="code" href="classObjet__U.html#a3e23491c01f2f39245fb6f3b6d6d9b17">Objet_U::dimension</a>;
<a name="l00222"></a>00222   vecteur_delta.<a class="code" href="classArrOfDouble.html#a610464f4b3dccac6f814915b526783ed">resize_array</a>(dim);
<a name="l00223"></a>00223   vecteur_delta = 0.;
<a name="l00224"></a>00224   erreur.<a class="code" href="classArrOfDouble.html#a610464f4b3dccac6f814915b526783ed">resize_array</a>(dim);
<a name="l00225"></a>00225   erreur = 0.;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227   <span class="keywordflow">if</span> (verbose &amp;&amp; <a class="code" href="classProcess.html#acd052b99706c577f8a5b6656217cf4c2" title="renvoie 1 si on est sur le processeur maitre du groupe courant (c&#39;est a dire me() == 0)...">Process::je_suis_maitre</a>())
<a name="l00228"></a>00228     {
<a name="l00229"></a>00229       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Check periodic faces to the boundary : &quot;</span> &lt;&lt; frontiere.<a class="code" href="classFrontiere.html#a2868774681d6f050479a95cbc7cd6fc9" title="Renvoie le nom de la frontiere.">le_nom</a>() &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231   <span class="keyword">const</span> <a class="code" href="classIntTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un IntVect avec calculs de l&#39;indice corespondant Voir les co...">IntTab</a>&amp; faces = frontiere.<a class="code" href="classFrontiere.html#ac64479069f0c43a17cb5766a39ce5ba8" title="Renvoie les faces de la frontiere&lt;br&gt;(version const)">faces</a>().<a class="code" href="classFaces.html#a07b8d8db9e3d656b93a21a49c063430c">les_sommets</a>();
<a name="l00232"></a>00232   <span class="keyword">const</span> <span class="keywordtype">int</span> nb_faces = faces.<a class="code" href="classIntTab.html#abc3b32c94925a82f69d5b153a356e359" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(0);
<a name="l00233"></a>00233   <span class="keywordflow">if</span> (nb_faces % 2 != 0)
<a name="l00234"></a>00234     {
<a name="l00235"></a>00235       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error in Check_faces_periodiques to the boundary &quot;</span> &lt;&lt; frontiere.<a class="code" href="classFrontiere.html#a2868774681d6f050479a95cbc7cd6fc9" title="Renvoie le nom de la frontiere.">le_nom</a>()
<a name="l00236"></a>00236            &lt;&lt; <span class="stringliteral">&quot;\n The number of faces is odd : &quot;</span> &lt;&lt; nb_faces &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00237"></a>00237       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239   <span class="keyword">const</span> <span class="keywordtype">int</span> n = nb_faces / 2;
<a name="l00240"></a>00240   <span class="keyword">const</span> <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a> coord = frontiere.<a class="code" href="classFrontiere.html#a510866aace5f3ed9482553db1a08a3c9" title="Renvoie la Zone associee a la frontiere. (version const)">zone</a>().<a class="code" href="classZone.html#a379ad2206b5a13a4f4f3df6d44c7546a" title="Renvoie le domaine dont la zone fait partie. (version const)">domaine</a>().<a class="code" href="classDomaine.html#a0846ac03a10b65c4df911fe35a19c02f" title="Renvoie le nombre total de sommets.">les_sommets</a>();
<a name="l00241"></a>00241 
<a name="l00242"></a>00242   <span class="keywordtype">int</span> i;
<a name="l00243"></a>00243 <span class="comment">// Calculer un vecteur delta (tous les procs n&#39;ont pas forcement des faces de ce bord)</span>
<a name="l00244"></a>00244   vecteur_delta = -1.e37;
<a name="l00245"></a>00245   <span class="keywordflow">if</span> (n &gt; 0)
<a name="l00246"></a>00246     <a class="code" href="Reordonner__faces__periodiques_8cpp.html#a9ccc16e361d118d704a6e7c93ec0b3df">calculer_vecteur_2faces</a>(coord, faces, 0, n, vecteur_delta);
<a name="l00247"></a>00247   <span class="keywordflow">for</span> (i = 0; i &lt; dim; i++)
<a name="l00248"></a>00248     vecteur_delta[i] = <a class="code" href="classProcess.html#a1e9d9f9899b71927cfafae14c7bd048d" title="Calcule le max de x sur tous les processeurs du groupe courant. Remarques : Cette methode doit etre a...">Process::mp_max</a>(vecteur_delta[i]);
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="comment">// Calculer pour chaque face l&#39;erreur par rapport a ce vecteur delta.</span>
<a name="l00251"></a>00251   <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a> vect(dim);
<a name="l00252"></a>00252   <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
<a name="l00253"></a>00253     {
<a name="l00254"></a>00254       <a class="code" href="Reordonner__faces__periodiques_8cpp.html#a9ccc16e361d118d704a6e7c93ec0b3df">calculer_vecteur_2faces</a>(coord, faces, i, i+n, vect);
<a name="l00255"></a>00255 <span class="comment">// Calcul de la difference entre vect et vecteur_delta:</span>
<a name="l00256"></a>00256       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> compo = 0; compo &lt; dim; compo++)
<a name="l00257"></a>00257         erreur[compo] = <a class="code" href="Double_8h.html#a1c45761573e6cbc97cfacac78d905016">max</a>(erreur[compo], <a class="code" href="Double_8h.html#aaecd4ca8a2fe69cc6568af2938b94d2e">dabs</a>(vecteur_delta[compo] - vect[compo]));
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259   <span class="keywordtype">double</span> maxerr = 0.;
<a name="l00260"></a>00260 <span class="comment">// Calcul du max sur tous les procs:</span>
<a name="l00261"></a>00261   <span class="keywordflow">for</span> (i = 0; i &lt; dim; i++)
<a name="l00262"></a>00262     {
<a name="l00263"></a>00263       erreur[i] = <a class="code" href="classProcess.html#a1e9d9f9899b71927cfafae14c7bd048d" title="Calcule le max de x sur tous les processeurs du groupe courant. Remarques : Cette methode doit etre a...">Process::mp_max</a>(erreur[i]);
<a name="l00264"></a>00264       maxerr = <a class="code" href="Double_8h.html#a1c45761573e6cbc97cfacac78d905016">max</a>(maxerr, erreur[i]);
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267   <span class="keywordflow">if</span> (verbose &amp;&amp; <a class="code" href="classProcess.html#acd052b99706c577f8a5b6656217cf4c2" title="renvoie 1 si on est sur le processeur maitre du groupe courant (c&#39;est a dire me() == 0)...">Process::je_suis_maitre</a>())
<a name="l00268"></a>00268     {
<a name="l00269"></a>00269       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot; Delta vector = [ &quot;</span>;
<a name="l00270"></a>00270       <span class="keywordflow">for</span> (i = 0; i &lt; dim; i++) <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; vecteur_delta[i] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l00271"></a>00271       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;]  error = [ &quot;</span>;
<a name="l00272"></a>00272       <span class="keywordflow">for</span> (i = 0; i &lt; dim; i++) <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; erreur[i] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l00273"></a>00273       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;]&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275   <span class="keywordflow">if</span> (!(maxerr &lt; <a class="code" href="classObjet__U.html#a7447e25c68cc8d3a1c06cf99f0565cff">Objet_U::precision_geom</a>))
<a name="l00276"></a>00276     {
<a name="l00277"></a>00277       <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#acd052b99706c577f8a5b6656217cf4c2" title="renvoie 1 si on est sur le processeur maitre du groupe courant (c&#39;est a dire me() == 0)...">Process::je_suis_maitre</a>())
<a name="l00278"></a>00278         {
<a name="l00279"></a>00279           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot; This boundary is not detected as periodic (geometric error &gt; precision_geom)&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00280"></a>00280           <a class="code" href="Reordonner__faces__periodiques_8cpp.html#a137d78a01e63d3b66d1b2ed0de0f4c4c">message</a>();
<a name="l00281"></a>00281           <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()&gt;1) <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Or you forgot to define the periodic boundary in the Decouper keyword.&quot;</span> &lt;&lt; finl;
<a name="l00282"></a>00282         } <span class="comment">//!&lt; attendre qu&#39;on ait ecrit pour continuer (sinon risque de exit() avant d&#39;avoir affiche le message)</span>
<a name="l00283"></a>00283 <span class="comment"></span>      <a class="code" href="classProcess.html#aa9e74a5c06a68ea38298a08ea401e7b1" title="Synchronise tous les processeurs du groupe courant&lt;br&gt;(attend que tous les processeurs soient arrives...">Process::barrier</a>();
<a name="l00284"></a>00284       <span class="keywordflow">return</span> 0;
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286   <span class="keywordflow">return</span> 1;
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a><a class="code" href="classReordonner__faces__periodiques.html#aee6a67196132bed17c8d786d6c39316c">00289</a> <span class="keywordtype">void</span> <a class="code" href="classReordonner__faces__periodiques.html#aee6a67196132bed17c8d786d6c39316c">Reordonner_faces_periodiques::renum_som_perio</a>(<span class="keyword">const</span> <a class="code" href="classDomaine.html" title="Classe Domaine Un Domaine represente le domaine (spatial) de resolution d&#39;un Probleme. Un Domaine a un Nom, il est constitue d&#39;une ou plusieurs Zone qui peuvent etre eventuellement decoupees en Sous_Zone. Un Domaine porte l&#39;ensemble des sommets utilises par ses Zones. On peut vouloir resoudre des problemes de type different sur plusieurs domaines, geometriquement les domaines sont alors couples par des surfaces qu&#39;on appelle Raccord.">Domaine</a>&amp; domaine,
<a name="l00290"></a>00290                                                    <span class="keyword">const</span> <a class="code" href="classNoms.html" title="Un tableau de chaine de caracteres (VECT(Nom))">Noms</a>&amp; liste_bords_periodiques,
<a name="l00291"></a>00291                                                    <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; renum_som_perio,
<a name="l00292"></a>00292                                                    <span class="keyword">const</span> <span class="keywordtype">int</span> calculer_espace_virtuel)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294   <span class="keywordtype">int</span> i;
<a name="l00295"></a>00295   <span class="keyword">const</span> <span class="keywordtype">int</span> nb_som = domaine.<a class="code" href="classDomaine.html#abc4abc8b8db5bebeb161fae4162a89ce" title="Renvoie le nombre de sommets.">nb_som</a>();
<a name="l00296"></a>00296   <a class="code" href="classIntTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un IntVect avec calculs de l&#39;indice corespondant Voir les co...">IntTab</a> renum(nb_som);
<a name="l00297"></a>00297   <span class="keywordflow">for</span> (i = 0; i &lt; nb_som; i++)
<a name="l00298"></a>00298     renum[i] = renum_som_perio[i];
<a name="l00299"></a>00299 
<a name="l00300"></a>00300   <span class="keyword">const</span> <a class="code" href="classDoubleTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un DoubleVect avec calculs de l&#39;indice corespondant Voir les...">DoubleTab</a> coord = domaine.<a class="code" href="classDomaine.html#aecd32c3eecc15cce7d1a0e468dadbf96" title="Renvoie le tableau des coordonnees des noeuds (sommets). (acces en lecture)">coord_sommets</a>();
<a name="l00301"></a>00301   <span class="keyword">const</span> <span class="keywordtype">int</span> dim = coord.<a class="code" href="classDoubleTab.html#ac3805e2637a3b880ba2d3e650c69dac4" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(1);
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 <span class="comment">// Etape 1: pour chaque sommet reel, trouver un sommet associe (si plusieurs directions</span>
<a name="l00304"></a>00304 <span class="comment">// de periodicite, un sommet peut etre associe a plusieurs autres).</span>
<a name="l00305"></a>00305 
<a name="l00306"></a>00306   <span class="keyword">const</span> <span class="keywordtype">int</span> nb_bords_perio = liste_bords_periodiques.<a class="code" href="classvect__impl.html#a78155bfbd6b61f4710b9830641ed1694">size</a>();
<a name="l00307"></a>00307   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i_bord = 0; i_bord &lt; nb_bords_perio; i_bord++)
<a name="l00308"></a>00308     {
<a name="l00309"></a>00309       <span class="keyword">const</span> <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>&amp; nom_bord = liste_bords_periodiques[i_bord];
<a name="l00310"></a>00310       <span class="keyword">const</span> <a class="code" href="classFrontiere.html" title="Classe Frontiere. Une Frontiere decrit une partie de la frontiere d&#39;une Zone, elle possede un Nom...">Frontiere</a>&amp; front = domaine.<a class="code" href="classDomaine.html#a0e62f2bc829542fafa29e3f2c614159c" title="Renvoie la i-ieme zone du domaine. (version const)">zone</a>(0).<a class="code" href="classZone.html#af2f1e6a14af55249979da674e7aac11a" title="Renvoie le i-ieme bord de la zone&lt;br&gt;(version const)">bord</a>(nom_bord);
<a name="l00311"></a>00311 <span class="comment">// Direction periodique de ce bord:</span>
<a name="l00312"></a>00312       <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a> delta;
<a name="l00313"></a>00313       <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a> <a class="code" href="Solv__GCP__NS_8cpp.html#ab6aa1075b965c7713d8db20dd3a8e09b">erreur</a>;
<a name="l00314"></a>00314       <span class="keywordflow">if</span> (!<a class="code" href="classReordonner__faces__periodiques.html#a57cfec8f17ae27a831df8c1a6c27e8cf" title="essaie de verifier si les faces du bord num_bord sont ordonnees suivant la convention des faces perio...">check_faces_periodiques</a>(front, delta, erreur, 1 <span class="comment">/* verbose */</span>))
<a name="l00315"></a>00315         <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00316"></a>00316 <span class="comment">// Tableau pointant vers tous les sommets de toutes les faces</span>
<a name="l00317"></a>00317 <span class="comment">// (on cast le IntTab en ArrOfInt)</span>
<a name="l00318"></a>00318       <span class="keyword">const</span> <a class="code" href="classIntTab.html" title="Tableau a n entrees pour n&lt;= 4 Repose sur un IntVect avec calculs de l&#39;indice corespondant Voir les co...">IntTab</a>&amp; faces_sommets = front.<a class="code" href="classFrontiere.html#a6d1f96137ddae39a46985a8c3e53bcf5" title="Renvoie les sommets des faces de la frontiere.">les_sommets_des_faces</a>();
<a name="l00319"></a>00319       <span class="keyword">const</span> <span class="keywordtype">int</span> nb_som_face = faces_sommets.<a class="code" href="classIntTab.html#abc3b32c94925a82f69d5b153a356e359" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(1);
<a name="l00320"></a>00320       <span class="keyword">const</span> <span class="keywordtype">int</span> nb_faces = faces_sommets.<a class="code" href="classIntTab.html#abc3b32c94925a82f69d5b153a356e359" title="Returns one of the &quot;real&quot; dimensions of the multi-dimensionnal array, as defined by: dimension(0) = s...">dimension</a>(0) / 2;
<a name="l00321"></a>00321 <span class="comment">// Boucle sur les faces d&#39;un cote du domaine (premiere moitie des faces)</span>
<a name="l00322"></a>00322       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i_face = 0; i_face &lt; nb_faces; i_face++)
<a name="l00323"></a>00323         {
<a name="l00324"></a>00324 
<a name="l00325"></a>00325           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i_som = 0; i_som &lt; nb_som_face; i_som++)
<a name="l00326"></a>00326             {
<a name="l00327"></a>00327               <span class="keyword">const</span> <span class="keywordtype">int</span> sommet = faces_sommets(i_face, i_som);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 <span class="comment">// Trouver le sommet associe</span>
<a name="l00330"></a>00330 <span class="comment">// Comme les frontieres sont ordonnees (voir check_faces_periodiques),</span>
<a name="l00331"></a>00331 <span class="comment">// le sommet est forcement un des sommets de la face opposee.</span>
<a name="l00332"></a>00332 <span class="comment">// Le vecteur qui va de &quot;sommet&quot; a &quot;sommet_oppose&quot; doit etre egal a &quot;delta&quot;</span>
<a name="l00333"></a>00333 <span class="comment">// la direction de periodicite.</span>
<a name="l00334"></a>00334               <span class="keyword">const</span> <span class="keywordtype">int</span> i_face_opposee = i_face + nb_faces;
<a name="l00335"></a>00335               <span class="keywordtype">int</span> sommet_opp = -1;
<a name="l00336"></a>00336               <span class="keywordtype">int</span> i_som_opp;
<a name="l00337"></a>00337               <span class="keywordflow">for</span> (i_som_opp = 0; i_som_opp &lt; nb_som_face; i_som_opp++)
<a name="l00338"></a>00338                 {
<a name="l00339"></a>00339                   sommet_opp = faces_sommets(i_face_opposee, i_som_opp);
<a name="l00340"></a>00340                   <span class="keywordflow">for</span> (i = 0; i &lt; dim; i++)
<a name="l00341"></a>00341                     {
<a name="l00342"></a>00342                       <span class="keywordtype">double</span> epsilon = <a class="code" href="Double_8h.html#aaecd4ca8a2fe69cc6568af2938b94d2e">dabs</a>((coord(sommet_opp, i) - coord(sommet, i)) - delta[i]);
<a name="l00343"></a>00343                       <span class="keywordflow">if</span> (epsilon &gt; <a class="code" href="classObjet__U.html#a7447e25c68cc8d3a1c06cf99f0565cff">Objet_U::precision_geom</a>)
<a name="l00344"></a>00344                         <span class="keywordflow">break</span>;
<a name="l00345"></a>00345                     }
<a name="l00346"></a>00346                   <span class="keywordflow">if</span> (i == dim)
<a name="l00347"></a>00347 <span class="comment">// On a trouve le sommet oppose</span>
<a name="l00348"></a>00348                     <span class="keywordflow">break</span>;
<a name="l00349"></a>00349                 }
<a name="l00350"></a>00350               <span class="keywordflow">if</span> (i_som_opp &gt;= nb_som_face)
<a name="l00351"></a>00351                 {
<a name="l00352"></a>00352                   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;[PE&quot;</span> &lt;&lt; <a class="code" href="classProcess.html#ab55ba07167ec807ed3a145cac0f5dca4" title="renvoie mon rang dans le groupe de communication courant. Voir Comm_Group::rank() et PE_Groups::curre...">Process::me</a>() &lt;&lt; <span class="stringliteral">&quot;] Error in Reordonner_faces_periodiques::renum_som_perio\n&quot;</span>
<a name="l00353"></a>00353                        &lt;&lt; <span class="stringliteral">&quot; An opposite node has not been found\n&quot;</span>
<a name="l00354"></a>00354                        &lt;&lt; <span class="stringliteral">&quot; Boundary &quot;</span> &lt;&lt; nom_bord &lt;&lt; <span class="stringliteral">&quot;\n Face 1: &quot;</span> &lt;&lt; i_face &lt;&lt; <span class="stringliteral">&quot;\n Node: &quot;</span> &lt;&lt; sommet &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00355"></a>00355                   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot; May be you should define the periodic boundary &quot;</span> &lt;&lt; nom_bord &lt;&lt; finl;
<a name="l00356"></a>00356                   <a class="code" href="Reordonner__faces__periodiques_8cpp.html#a137d78a01e63d3b66d1b2ed0de0f4c4c">message</a>();
<a name="l00357"></a>00357                   <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00358"></a>00358                 }
<a name="l00359"></a>00359               renum[sommet_opp] = sommet;
<a name="l00360"></a>00360             }
<a name="l00361"></a>00361         }
<a name="l00362"></a>00362     }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="comment">// Deuxieme etape: faire pointer tous les sommets periodiques lies entre eux vers le meme sommet</span>
<a name="l00365"></a>00365 
<a name="l00366"></a>00366   <span class="keywordflow">for</span> (i = 0; i &lt; nb_som; i++)
<a name="l00367"></a>00367     {
<a name="l00368"></a>00368       <span class="keywordtype">int</span> j = renum[i];
<a name="l00369"></a>00369 <span class="comment">// Parcourir les sommet relies pour cette chaine:</span>
<a name="l00370"></a>00370       <span class="keywordflow">while</span> (j != renum[j])
<a name="l00371"></a>00371         j = renum[j];
<a name="l00372"></a>00372       renum[i] = j;
<a name="l00373"></a>00373     }
<a name="l00374"></a>00374 <span class="comment">// Calcul des valeurs pour les sommets virtuels.</span>
<a name="l00375"></a>00375 <span class="comment">// Les sommets opposes aux sommets virtuels doivent etre connus, donc erreurs fatales.</span>
<a name="l00376"></a>00376   <span class="keywordflow">if</span> (calculer_espace_virtuel)
<a name="l00377"></a>00377     {
<a name="l00378"></a>00378       <span class="keyword">const</span> <a class="code" href="classMD__Vector.html" title=": Cette classe est un DERIV mais l&#39;objet pointe est partage entre plusieurs instances de cette classe...">MD_Vector</a>&amp; md_sommets = domaine.<a class="code" href="classDomaine.html#a0846ac03a10b65c4df911fe35a19c02f" title="Renvoie le nombre total de sommets.">les_sommets</a>().<a class="code" href="classDoubleVect.html#a0d16d30580c90526e4895388fb44be5d">get_md_vector</a>();
<a name="l00379"></a>00379       <a class="code" href="classScatter.html#a33c68e7eff97ee92b457b50e8e3ad58d" title="Construit la structure items_communs + espaces virtuels d&#39;un tableau contenant des indices d&#39;items ge...">Scatter::construire_espace_virtuel_traduction</a>(md_sommets, md_sommets, renum, 1 <span class="comment">/* erreurs fatales */</span>);
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 <span class="comment">// Recopie du resultat dans le tableau renum_som_perio</span>
<a name="l00383"></a>00383   assert(renum.<a class="code" href="classIntTab.html#a71e9b9ddc1793094b1b3f109377952b1" title="Returns the total dimensions of the multi-dimensionnal array, including virtual items (used in parall...">dimension_tot</a>(0) == domaine.<a class="code" href="classDomaine.html#a394e61cf1993665886de0fbbd0c0178e" title="Renvoie le nombre total de sommets.">nb_som_tot</a>());
<a name="l00384"></a>00384   renum_som_perio = renum;
<a name="l00385"></a>00385 }
<a name="l00386"></a>00386 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Dec 14 2021 19:35:20 for TRUST by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>

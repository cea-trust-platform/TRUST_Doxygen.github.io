<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TRUST: src/Kernel/Math/SolvSys/Solv_Petsc.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TRUST&#160;<span id="projectnumber">1.8.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">src/Kernel/Math/SolvSys/Solv_Petsc.cpp</div>  </div>
</div>
<div class="contents">
<a href="Solv__Petsc_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/****************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">* Copyright (c) 2021, CEA</span>
<a name="l00003"></a>00003 <span class="comment">* All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment">*</span>
<a name="l00005"></a>00005 <span class="comment">* Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<a name="l00006"></a>00006 <span class="comment">* 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
<a name="l00007"></a>00007 <span class="comment">* 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<a name="l00008"></a>00008 <span class="comment">* 3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
<a name="l00009"></a>00009 <span class="comment">*</span>
<a name="l00010"></a>00010 <span class="comment">* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<a name="l00011"></a>00011 <span class="comment">* IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;</span>
<a name="l00012"></a>00012 <span class="comment">* OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00013"></a>00013 <span class="comment">*</span>
<a name="l00014"></a>00014 <span class="comment">*****************************************************************************/</span>
<a name="l00015"></a>00015 <span class="comment">//</span>
<a name="l00016"></a>00016 <span class="comment">// </span>
<a name="l00017"></a>00017 <span class="comment">// File:        Solv_Petsc.cpp</span>
<a name="l00018"></a>00018 <span class="comment">// Directory:   $TRUST_ROOT/src/Kernel/Math/SolvSys</span>
<a name="l00019"></a>00019 <span class="comment">// Version:     /main/95</span>
<a name="l00020"></a>00020 <span class="comment">// </span>
<a name="l00021"></a>00021 <span class="comment">//</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="code" href="Solv__Petsc_8h.html">Solv_Petsc.h</a>&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;tuple&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#ifdef PETSCKSP_H</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor">#include &lt;petscis.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;petscdmshell.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;petscsection.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#endif</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="Matrice__Petsc_8h.html">Matrice_Petsc.h</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="Matrice__Morse__Sym_8h.html">Matrice_Morse_Sym.h</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="stat__counters_8h.html">stat_counters.h</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="Matrice__Bloc__Sym_8h.html">Matrice_Bloc_Sym.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="Matrice__Bloc_8h.html">Matrice_Bloc.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="Motcle_8h.html">Motcle.h</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="SChaine_8h.html">SChaine.h</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="communications_8h.html">communications.h</a>&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="SFichier_8h.html">SFichier.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="MD__Vector__tools_8h.html">MD_Vector_tools.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="PE__Groups_8h.html">PE_Groups.h</a>&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="Comm__Group__MPI_8h.html">Comm_Group_MPI.h</a>&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="DoubleTrav_8h.html">DoubleTrav.h</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="MD__Vector__composite_8h.html">MD_Vector_composite.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;ctime&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;<a class="code" href="EFichier_8h.html">EFichier.h</a>&gt;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="Solv__Petsc_8cpp.html#a08b9e8af78b9bd02e9dac91649c99326">00050</a> <a class="code" href="Declare__Inst_8h.html#a1a414570e3c7a7f9787a0eba4e9366e8">Implemente_instanciable_sans_constructeur_ni_destructeur</a>(<a class="code" href="classSolv__Petsc.html">Solv_Petsc</a>,<span class="stringliteral">&quot;Solv_Petsc&quot;</span>,<a class="code" href="classSolveurSys__base.html">SolveurSys_base</a>);
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="comment">// printOn</span>
<a name="l00053"></a><a class="code" href="classSolv__Petsc.html#adceae0b645dc68471855a23b96529ee9">00053</a> <a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; <a class="code" href="classSolv__Petsc.html#adceae0b645dc68471855a23b96529ee9" title="Ecriture de l&#39;objet sur un flot de sortie Methode a surcharger.">Solv_Petsc::printOn</a>(<a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; s )<span class="keyword"> const</span>
<a name="l00054"></a>00054 <span class="keyword"></span>{
<a name="l00055"></a>00055   s &lt;&lt; <a class="code" href="classSolv__Petsc.html#a7a8cc27d5092ae780209ddb0059a2e29" title="Chaine des mots cles lus.">chaine_lue_</a>;
<a name="l00056"></a>00056   <span class="keywordflow">return</span> s;
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">// readOn</span>
<a name="l00060"></a><a class="code" href="classSolv__Petsc.html#a43058b9e8c6070b68572b20eaafc1a39">00060</a> <a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; <a class="code" href="classSolv__Petsc.html#a43058b9e8c6070b68572b20eaafc1a39" title="Lecture d&#39;un Objet_U sur un flot d&#39;entree Methode a surcharger.">Solv_Petsc::readOn</a>(<a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; is)
<a name="l00061"></a>00061 {
<a name="l00062"></a>00062   <a class="code" href="classSolv__Petsc.html#a35a8ad922fb450f5b693f9ce1e31875c">create_solver</a>(is);
<a name="l00063"></a>00063   <span class="keywordflow">return</span> is;
<a name="l00064"></a>00064 }
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">00066</a> <span class="keywordtype">void</span> <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(<a class="code" href="classoption.html">option</a> o)
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068   <span class="keywordflow">if</span> (o.<a class="code" href="classoption.html#a111fcb2f43490d4a2b9c4227a6412b2f">defined</a>)
<a name="l00069"></a>00069     {
<a name="l00070"></a>00070       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error! Option &quot;</span> &lt;&lt; o.<a class="code" href="classoption.html#a38c4ce51346daeda4a76db767d8aac75">name</a> &lt;&lt; <span class="stringliteral">&quot; should not be defined with the preconditioner of this solver.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00071"></a>00071       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Change your data file.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00072"></a>00072       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00073"></a>00073     }
<a name="l00074"></a>00074 }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">// check to see if a string is a number</span>
<a name="l00077"></a>00077 <span class="preprocessor">#ifdef PETSCKSP_H</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">bool</span> is_number(<span class="keyword">const</span> std::string&amp; s)
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080   std::string::const_iterator it = s.begin();
<a name="l00081"></a>00081   <span class="keywordflow">while</span> (it != s.end() &amp;&amp; std::isdigit(*it)) ++it;
<a name="l00082"></a>00082   <span class="keywordflow">return</span> !s.empty() &amp;&amp; it == s.end();
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 <span class="preprocessor">#endif</span>
<a name="l00085"></a><a class="code" href="Solv__Petsc_8cpp.html#ab3f078684998b83967d507d0f453f454">00085</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="Solv__Petsc_8cpp.html#ab3f078684998b83967d507d0f453f454">verbose</a> = <span class="keyword">false</span>;
<a name="l00086"></a>00086 <span class="comment">// Lecture et creation du solveur</span>
<a name="l00087"></a><a class="code" href="classSolv__Petsc.html#a35a8ad922fb450f5b693f9ce1e31875c">00087</a> <span class="keywordtype">void</span> <a class="code" href="classSolv__Petsc.html#a35a8ad922fb450f5b693f9ce1e31875c">Solv_Petsc::create_solver</a>(<a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; entree)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>) verbose = <span class="keyword">true</span>;
<a name="l00090"></a>00090 <span class="preprocessor">#ifdef PETSCKSP_H</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>  lecture(entree);
<a name="l00092"></a>00092   <a class="code" href="classEChaine.html" title="Une entree dont la source est une chaine de caracteres. Le constructeur cree sa propre copie de la ch...">EChaine</a> is(get_chaine_lue());
<a name="l00093"></a>00093 
<a name="l00094"></a>00094   <a class="code" href="classMotcle.html" title="Une chaine de caractere (Nom) en majuscules.">Motcle</a> accolade_ouverte(<span class="stringliteral">&quot;{&quot;</span>);
<a name="l00095"></a>00095   <a class="code" href="classMotcle.html" title="Une chaine de caractere (Nom) en majuscules.">Motcle</a> accolade_fermee(<span class="stringliteral">&quot;}&quot;</span>);
<a name="l00096"></a>00096   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> pc(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00097"></a>00097   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> motlu;
<a name="l00098"></a>00098   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> ksp;
<a name="l00099"></a>00099   is &gt;&gt; ksp;   <span class="comment">//!&lt; On lit le solveur en premier puis les options du solveur: PETSC ksp { ... }</span>
<a name="l00100"></a>00100 <span class="comment"></span>  is &gt;&gt; motlu; <span class="comment">//!&lt; On lit l&#39;accolade</span>
<a name="l00101"></a>00101 <span class="comment"></span>  <span class="keywordflow">if</span> (motlu != accolade_ouverte)
<a name="l00102"></a>00102     {
<a name="l00103"></a>00103       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error while reading the parameters of the solver of PETSC &quot;</span> &lt;&lt; ksp &lt;&lt; <span class="stringliteral">&quot; { ... }&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00104"></a>00104       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;We expected &quot;</span> &lt;&lt; accolade_ouverte &lt;&lt; <span class="stringliteral">&quot; instead of &quot;</span> &lt;&lt; motlu &lt;&lt; finl;
<a name="l00105"></a>00105       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00106"></a>00106     }
<a name="l00107"></a>00107 <span class="comment">// Verification si Petsc est bien initialise (permet d&#39;eviter un crash en sequentiel sur les machines batch)</span>
<a name="l00108"></a>00108   PetscBool isInitialized;
<a name="l00109"></a>00109   PetscInitialized(&amp;isInitialized);
<a name="l00110"></a>00110   <span class="keywordflow">if</span> (!isInitialized)
<a name="l00111"></a>00111     {
<a name="l00112"></a>00112       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;On this queuing system cluster, you need to use mpirun even on sequential mode&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00113"></a>00113       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;(mpirun -np 1 ...) with a PETSc solver or the calculation will crash. &quot;</span> &lt;&lt; finl;
<a name="l00114"></a>00114       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You can use the trust script as a workaround:&quot;</span> &lt;&lt; finl;
<a name="l00115"></a>00115       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;trust &quot;</span> &lt;&lt; <a class="code" href="classObjet__U.html#a7c27c4f80259eeef76ff8fe2d3bc61f7" title="Renvoie une reference constante vers le nom du cas. Cette methode est statique.">nom_du_cas</a>() &lt;&lt; finl;
<a name="l00116"></a>00116       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00117"></a>00117     }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="comment">// Creation du solveur et association avec le preconditionneur</span>
<a name="l00120"></a>00120   <span class="keywordflow">if</span> (option_prefix_==<span class="stringliteral">&quot;??&quot;</span>) <span class="comment">//!&lt; Prefix non fixe</span>
<a name="l00121"></a>00121 <span class="comment"></span>    {
<a name="l00122"></a>00122       <a class="code" href="classSolv__Petsc.html#acc3475bd78fb4ceace2d10ff68de1dd8" title="Compte les solveurs crees et utilises pour le prefix des options.">numero_solveur</a>++;
<a name="l00123"></a>00123       option_prefix_=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00124"></a>00124       <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#acc3475bd78fb4ceace2d10ff68de1dd8" title="Compte les solveurs crees et utilises pour le prefix des options.">numero_solveur</a> &gt; 1)
<a name="l00125"></a>00125         {
<a name="l00126"></a>00126 <span class="comment">// On cree un prefix pour les options si plus d&#39;un solveur pour les differencier. Exemple:</span>
<a name="l00127"></a>00127 <span class="comment">// premier solveur -ksp_type ... -pc_type ...</span>
<a name="l00128"></a>00128 <span class="comment">// deuxieme solveur -solver2_ksp_type ... -solver2_pc-type ...</span>
<a name="l00129"></a>00129 <span class="comment">// troisieme solveur -solveur3_ksp_type ...</span>
<a name="l00130"></a>00130           option_prefix_ += <span class="stringliteral">&quot;solver&quot;</span>;
<a name="l00131"></a>00131           option_prefix_ += (<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>) <a class="code" href="classSolv__Petsc.html#acc3475bd78fb4ceace2d10ff68de1dd8" title="Compte les solveurs crees et utilises pour le prefix des options.">numero_solveur</a>;
<a name="l00132"></a>00132           option_prefix_ += <span class="stringliteral">&quot;_&quot;</span>;
<a name="l00133"></a>00133         }
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136   <span class="comment">/************************/</span>
<a name="l00137"></a>00137   <span class="comment">/* Set PETSC_COMM_WORLD */</span>
<a name="l00138"></a>00138   <span class="comment">/************************/</span>
<a name="l00139"></a>00139 <span class="comment">// Recuperation du communicateur du groupe courant</span>
<a name="l00140"></a>00140 <span class="preprocessor">#ifdef MPI_</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classComm__Group__MPI.html" title=": Classe Comm_Group_MPI, derivee de la classe abstraite Comm_Group. Cette classe represente un groupe...">Comm_Group_MPI</a>,<a class="code" href="classPE__Groups.html#ae6ca0277a58f2ab34ebfb3216578fa75" title="renvoie une reference au groupe de processeurs actif courant">PE_Groups::current_group</a>()))
<a name="l00142"></a>00142     PETSC_COMM_WORLD = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classComm__Group__MPI.html" title=": Classe Comm_Group_MPI, derivee de la classe abstraite Comm_Group. Cette classe represente un groupe...">Comm_Group_MPI</a>,<a class="code" href="classPE__Groups.html#ae6ca0277a58f2ab34ebfb3216578fa75" title="renvoie une reference au groupe de processeurs actif courant">PE_Groups::current_group</a>()).get_mpi_comm();
<a name="l00143"></a>00143 <span class="preprocessor">#endif</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span>
<a name="l00145"></a>00145   KSPCreate(PETSC_COMM_WORLD, &amp;SolveurPetsc_);
<a name="l00146"></a>00146   KSPGetPC(SolveurPetsc_, &amp;PreconditionneurPetsc_);
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="comment">// Add options if PETSc solver is used:</span>
<a name="l00149"></a>00149   <span class="keywordflow">if</span> (<a class="code" href="classPE__Groups.html#a6fe714bb78ca65d4731c8b95db492172">PE_Groups::get_nb_groups</a>()==1 &amp;&amp; !<a class="code" href="classObjet__U.html#a622f9039952e1be36aee2ac0c48955fc" title="Flag to disable the writing of the .TU files.">disable_TU</a> )
<a name="l00150"></a>00150     {
<a name="l00151"></a>00151 <span class="comment">// _petsc.TU is only printed if one group calculation (e.g. Execute_parallel failed)</span>
<a name="l00152"></a>00152       <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> petsc_TU(<span class="stringliteral">&quot;:&quot;</span>);
<a name="l00153"></a>00153       petsc_TU+=<a class="code" href="classObjet__U.html#a7c27c4f80259eeef76ff8fe2d3bc61f7" title="Renvoie une reference constante vers le nom du cas. Cette methode est statique.">nom_du_cas</a>();
<a name="l00154"></a>00154       petsc_TU+=<span class="stringliteral">&quot;_petsc.TU&quot;</span>;
<a name="l00155"></a>00155       add_option(<span class="stringliteral">&quot;log_view&quot;</span>,petsc_TU);  <span class="comment">//!&lt; Monitor performances at the end of the calculation</span>
<a name="l00156"></a>00156 <span class="comment"></span>      PetscLogAllBegin();               <span class="comment">//!&lt; Necessary cause if not Event logs not printed in petsc_TU file ... I don&#39;t know why...</span>
<a name="l00157"></a>00157 <span class="comment"></span>    }
<a name="l00158"></a>00158 <span class="preprocessor">#ifdef NDEBUG</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span><span class="comment">// PETSc 3.14 active par defaut les exceptions, on desactive en production ?</span>
<a name="l00160"></a>00160 <span class="comment">// PetscSetFPTrap(PETSC_FP_TRAP_OFF);</span>
<a name="l00161"></a>00161 <span class="comment">// Utiliser -fp_trap 0 a l&#39;execution plutot: Segfault vu sur petsc gmres { precond diag ... }</span>
<a name="l00162"></a>00162 <span class="preprocessor">#endif</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span><span class="comment">// add_option(&quot;on_error_abort&quot;,&quot;&quot;); // ne marche pas semble t&#39;il</span>
<a name="l00164"></a>00164 <span class="comment">// On doit pouvoir lire des mots cles de base (GCP, GMRES, CHOLESKY)</span>
<a name="l00165"></a>00165 <span class="comment">// mais egalement pouvoir appeler les options Petsc avec une chaine { -ksp_type cg -pc_type sor ... }</span>
<a name="l00166"></a>00166 <span class="comment">// Les options non reconnues doivent arreter le code</span>
<a name="l00167"></a>00167 <span class="comment">// Reprendre le formalisme de GCP { precond ssor { omega val } seuil val }</span>
<a name="l00168"></a>00168   <a class="code" href="classMotcles.html" title="Un tableau d&#39;objets de la classe Motcle.">Motcles</a> les_solveurs(20);
<a name="l00169"></a>00169   {
<a name="l00170"></a>00170     les_solveurs[0] = <span class="stringliteral">&quot;CLI&quot;</span>;
<a name="l00171"></a>00171     les_solveurs[1] = <span class="stringliteral">&quot;GCP&quot;</span>;
<a name="l00172"></a>00172     les_solveurs[2] = <span class="stringliteral">&quot;GMRES&quot;</span>;
<a name="l00173"></a>00173     les_solveurs[3] = <span class="stringliteral">&quot;CHOLESKY&quot;</span>;
<a name="l00174"></a>00174     les_solveurs[4] = <span class="stringliteral">&quot;CHOLESKY_OUT_OF_CORE&quot;</span>;
<a name="l00175"></a>00175     les_solveurs[5] = <span class="stringliteral">&quot;BICGSTAB&quot;</span>;
<a name="l00176"></a>00176     les_solveurs[6] = <span class="stringliteral">&quot;IBICGSTAB&quot;</span>;
<a name="l00177"></a>00177     les_solveurs[7] = <span class="stringliteral">&quot;CHOLESKY_SUPERLU&quot;</span>;
<a name="l00178"></a>00178     les_solveurs[8] = <span class="stringliteral">&quot;PGMRES&quot;</span>;
<a name="l00179"></a>00179     les_solveurs[9] = <span class="stringliteral">&quot;LU&quot;</span>;
<a name="l00180"></a>00180     les_solveurs[10] = <span class="stringliteral">&quot;PIPECG&quot;</span>;
<a name="l00181"></a>00181     les_solveurs[11] = <span class="stringliteral">&quot;CHOLESKY_LAPACK&quot;</span>;
<a name="l00182"></a>00182     les_solveurs[12] = <span class="stringliteral">&quot;CHOLESKY_UMFPACK&quot;</span>;
<a name="l00183"></a>00183     les_solveurs[13] = <span class="stringliteral">&quot;CHOLESKY_PASTIX&quot;</span>;
<a name="l00184"></a>00184     les_solveurs[14] = <span class="stringliteral">&quot;CLI_VERBOSE&quot;</span>;
<a name="l00185"></a>00185     les_solveurs[15] = <span class="stringliteral">&quot;CLI_QUIET&quot;</span>;
<a name="l00186"></a>00186     les_solveurs[16] = <span class="stringliteral">&quot;CHOLESKY_MUMPS_BLR&quot;</span>;
<a name="l00187"></a>00187     les_solveurs[17] = <span class="stringliteral">&quot;CHOLESKY_CHOLMOD&quot;</span>;
<a name="l00188"></a>00188     les_solveurs[18] = <span class="stringliteral">&quot;PIPECG2&quot;</span>;
<a name="l00189"></a>00189     les_solveurs[19] = <span class="stringliteral">&quot;FGMRES&quot;</span>;
<a name="l00190"></a>00190   }
<a name="l00191"></a>00191   <span class="keywordtype">int</span> solver_supported_on_gpu_by_petsc=0;
<a name="l00192"></a>00192   <span class="keywordtype">int</span> solver_supported_on_gpu_by_amgx=0;
<a name="l00193"></a>00193   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> amgx_option=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00194"></a>00194   <span class="keywordtype">int</span> rang=les_solveurs.<a class="code" href="classMotcles.html#afecd68f73e904bc129022a236ff6ab15">search</a>(ksp);
<a name="l00195"></a>00195   <a class="code" href="classObjet__U.html#a469dbcad1d4a98a67e4246dce8e264ad" title="Donne un nom a l&#39;Objet_U Methode virtuelle a surcharger.">nommer</a>(les_solveurs[rang]);
<a name="l00196"></a>00196   <span class="keywordflow">switch</span>(rang)
<a name="l00197"></a>00197     {
<a name="l00198"></a>00198     <span class="keywordflow">case</span> 0:
<a name="l00199"></a>00199     <span class="keywordflow">case</span> 14:
<a name="l00200"></a>00200     <span class="keywordflow">case</span> 15:
<a name="l00201"></a>00201       {
<a name="l00202"></a>00202         <span class="keywordflow">if</span> (rang == 15) <a class="code" href="classSolveurSys__base.html#a987e97740c779c1ab4192c3c1f1bbd5d">fixer_limpr</a>(-1);  <span class="comment">//!&lt; Quiet</span>
<a name="l00203"></a>00203 <span class="comment"></span>        <span class="keywordflow">else</span> <a class="code" href="classSolveurSys__base.html#a987e97740c779c1ab4192c3c1f1bbd5d">fixer_limpr</a>(1); <span class="comment">//!&lt; On imprime le residu</span>
<a name="l00204"></a>00204 <span class="comment"></span>        solver_supported_on_gpu_by_petsc=1; <span class="comment">//!&lt; Not really, reserved to expert...</span>
<a name="l00205"></a>00205 <span class="comment"></span>        solver_supported_on_gpu_by_amgx=1;  <span class="comment">//!&lt; Not really, reserved to expert...</span>
<a name="l00206"></a>00206 <span class="comment"></span>        <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>() &gt;= 0) <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Reading of the &quot;</span> &lt;&lt; (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a> ? <span class="stringliteral">&quot;AmgX&quot;</span> : <span class="stringliteral">&quot;Petsc&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; commands:&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00207"></a>00207         <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> <a class="code" href="Source__Generique__Face__PolyMAC_8cpp.html#a7d7b5d77a3caa1af70f5e1c9108de5a1">valeur</a>;
<a name="l00208"></a>00208         is &gt;&gt; motlu;
<a name="l00209"></a>00209         <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l00210"></a>00210           {
<a name="l00211"></a>00211             <span class="keywordflow">while</span> (motlu!=accolade_fermee)
<a name="l00212"></a>00212               {
<a name="l00213"></a>00213 <span class="comment">// -config file.json</span>
<a name="l00214"></a>00214                 <span class="keywordflow">if</span> (motlu == <span class="stringliteral">&quot;-file&quot;</span>)
<a name="l00215"></a>00215                   {
<a name="l00216"></a>00216                     is &gt;&gt; motlu;
<a name="l00217"></a>00217                     <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#acd052b99706c577f8a5b6656217cf4c2" title="renvoie 1 si on est sur le processeur maitre du groupe courant (c&#39;est a dire me() == 0)...">Process::je_suis_maitre</a>())
<a name="l00218"></a>00218                       {
<a name="l00219"></a>00219                         <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Reading AmgX config file &quot;</span> &lt;&lt; motlu &lt;&lt; <span class="stringliteral">&quot; :&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00220"></a>00220                         <a class="code" href="classEFichier.html" title="Fichier en lecture Cette classe est a la classe C++ ifstream ce que la classe Entree est a la classe ...">EFichier</a> config_amgx(motlu);
<a name="l00221"></a>00221                         std::string line;
<a name="l00222"></a>00222                         <span class="keywordflow">while</span> (!config_amgx.<a class="code" href="classEntree__Fichier__base.html#a5e6b0d743eb5c7986090c615bd7ad584">eof</a>())
<a name="l00223"></a>00223                           {
<a name="l00224"></a>00224                             std::getline(config_amgx.<a class="code" href="classEntree__Fichier__base.html#a9e5abc201d0864efb7e22b593556f432">get_ifstream</a>(), line);
<a name="l00225"></a>00225                             <span class="keywordflow">if</span> (line.find(<span class="stringliteral">&quot;#&quot;</span>) &amp;&amp; line.find(<span class="stringliteral">&quot;config_version&quot;</span>))
<a name="l00226"></a>00226                               {
<a name="l00227"></a>00227                                 <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; line.c_str() &lt;&lt; finl;
<a name="l00228"></a>00228                                 amgx_option+=line.c_str();
<a name="l00229"></a>00229                                 amgx_option+=<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00230"></a>00230                               }
<a name="l00231"></a>00231                           }
<a name="l00232"></a>00232                       }
<a name="l00233"></a>00233                   }
<a name="l00234"></a>00234                 <span class="keywordflow">else</span>
<a name="l00235"></a>00235                   {
<a name="l00236"></a>00236                     amgx_option += motlu;
<a name="l00237"></a>00237                     amgx_option += <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00238"></a>00238                   }
<a name="l00239"></a>00239                 is &gt;&gt; motlu;
<a name="l00240"></a>00240               }
<a name="l00241"></a>00241           }
<a name="l00242"></a>00242         <span class="keywordflow">else</span>
<a name="l00243"></a>00243           <span class="keywordflow">while</span> (motlu!=accolade_fermee)
<a name="l00244"></a>00244             {
<a name="l00245"></a>00245               is &gt;&gt; <a class="code" href="Source__Generique__Face__PolyMAC_8cpp.html#a7d7b5d77a3caa1af70f5e1c9108de5a1">valeur</a>;
<a name="l00246"></a>00246 <span class="comment">// &quot;-option val&quot; ou &quot;-option&quot; ?</span>
<a name="l00247"></a>00247               <span class="keywordflow">if</span> (valeur.debute_par(<span class="stringliteral">&quot;-&quot;</span>) || valeur==accolade_fermee)
<a name="l00248"></a>00248                 {
<a name="l00249"></a>00249                   add_option(motlu.suffix(<span class="stringliteral">&quot;-&quot;</span>), <span class="stringliteral">&quot;&quot;</span>, 1);
<a name="l00250"></a>00250                   motlu = <a class="code" href="Source__Generique__Face__PolyMAC_8cpp.html#a7d7b5d77a3caa1af70f5e1c9108de5a1">valeur</a>;
<a name="l00251"></a>00251                 }
<a name="l00252"></a>00252               <span class="keywordflow">else</span>
<a name="l00253"></a>00253                 {
<a name="l00254"></a>00254                   <span class="keywordflow">if</span> (motlu == <span class="stringliteral">&quot;-ksp_type&quot;</span> &amp;&amp; valeur==<span class="stringliteral">&quot;preonly&quot;</span>) <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>=<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6a1ff272a9a5361e482e6748be5e449bbd">cli</a>; <span class="comment">//!&lt; Activate direct solveur if using -ksp_preonly ...</span>
<a name="l00255"></a>00255 <span class="comment"></span>                  add_option(motlu.suffix(<span class="stringliteral">&quot;-&quot;</span>), <a class="code" href="Source__Generique__Face__PolyMAC_8cpp.html#a7d7b5d77a3caa1af70f5e1c9108de5a1">valeur</a>, 1);
<a name="l00256"></a>00256                   is &gt;&gt; motlu;
<a name="l00257"></a>00257                 }
<a name="l00258"></a>00258             }
<a name="l00259"></a>00259 <span class="comment">// Pour faciliter le debugage:</span>
<a name="l00260"></a>00260         <span class="keywordflow">if</span> (rang == 14) <span class="comment">//!&lt; Verbose</span>
<a name="l00261"></a>00261 <span class="comment"></span>          {
<a name="l00262"></a>00262             add_option(<span class="stringliteral">&quot;ksp_view&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00263"></a>00263             add_option(<span class="stringliteral">&quot;options_view&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00264"></a>00264             add_option(<span class="stringliteral">&quot;options_left&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00265"></a>00265           }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267         <span class="keywordflow">break</span>;
<a name="l00268"></a>00268       }
<a name="l00269"></a>00269     <span class="keywordflow">case</span> 1:
<a name="l00270"></a>00270       {
<a name="l00271"></a>00271         KSPSetType(SolveurPetsc_, KSPCG);
<a name="l00272"></a>00272 <span class="comment">// Residu=||Ax-b|| comme dans TRUST pour GCP sinon on ne peut comparer les convergences</span>
<a name="l00273"></a>00273         KSPSetNormType(SolveurPetsc_, KSP_NORM_UNPRECONDITIONED);
<a name="l00274"></a>00274 <span class="comment">// Merge the two inner products needed in CG into a single MPI_Allreduce() call:</span>
<a name="l00275"></a>00275 <span class="comment">// Gain interessant a partir de 4000 coeurs</span>
<a name="l00276"></a>00276         <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()&gt;=4000)
<a name="l00277"></a>00277           {
<a name="l00278"></a>00278 <span class="comment">// add_option(&quot;ksp_cg_single_reduction&quot;,&quot;&quot;); Pour Petsc &lt; 3.3, la fonction KSPCGUseSingleReduction n&#39;etait pas disponible</span>
<a name="l00279"></a>00279             KSPCGUseSingleReduction(SolveurPetsc_,(PetscBool)1);
<a name="l00280"></a>00280           }
<a name="l00281"></a>00281 <span class="comment">// But It requires two extra work vectors than the conventional implementation in PETSc.</span>
<a name="l00282"></a>00282         solver_supported_on_gpu_by_petsc=1;
<a name="l00283"></a>00283         solver_supported_on_gpu_by_amgx=1;
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>) amgx_option+=<span class="stringliteral">&quot;solver(s)=PCG\n&quot;</span>; <span class="comment">//!&lt; CG avec preconditionnement if (amgx_) amgx_option+=&quot;solver(s)=PCGF\n&quot;; // Flexible CG avec preconditionnement</span>
<a name="l00285"></a>00285 <span class="comment"></span><span class="comment">//</span>
<a name="l00286"></a>00286         <span class="keywordflow">break</span>;
<a name="l00287"></a>00287       }
<a name="l00288"></a>00288     <span class="keywordflow">case</span> 10:
<a name="l00289"></a>00289       {
<a name="l00290"></a>00290         KSPSetType(SolveurPetsc_, KSPPIPECG);
<a name="l00291"></a>00291 <span class="comment">// Residu=||Ax-b|| comme dans TRUST pour GCP sinon on ne peut comparer les convergences</span>
<a name="l00292"></a>00292         KSPSetNormType(SolveurPetsc_, KSP_NORM_UNPRECONDITIONED);
<a name="l00293"></a>00293         <span class="keywordflow">break</span>;
<a name="l00294"></a>00294       }
<a name="l00295"></a>00295     <span class="keywordflow">case</span> 18:
<a name="l00296"></a>00296       {
<a name="l00297"></a>00297         KSPSetType(SolveurPetsc_, KSPPIPECG2);
<a name="l00298"></a>00298 <span class="comment">// Residu=||Ax-b|| comme dans TRUST pour GCP sinon on ne peut comparer les convergences</span>
<a name="l00299"></a>00299         KSPSetNormType(SolveurPetsc_, KSP_NORM_UNPRECONDITIONED);
<a name="l00300"></a>00300         <span class="keywordflow">break</span>;
<a name="l00301"></a>00301       }
<a name="l00302"></a>00302     <span class="keywordflow">case</span> 2:
<a name="l00303"></a>00303       {
<a name="l00304"></a>00304         KSPSetType(SolveurPetsc_, KSPGMRES);
<a name="l00305"></a>00305 <span class="comment">// Le preconditionnement a droite permet que le residu utilise pour la convergence</span>
<a name="l00306"></a>00306 <span class="comment">// soit le residu reel ||Ax-b|| et non le residu preconditionne pour certains solveurs</span>
<a name="l00307"></a>00307 <span class="comment">// avec un preconditionnement a gauche (ex: GMRES). Ainsi, on peut comparer strictement</span>
<a name="l00308"></a>00308 <span class="comment">// les performances des solveurs (TRUST ou PETSC) entre eux</span>
<a name="l00309"></a>00309         KSPSetPCSide(SolveurPetsc_, PC_RIGHT);
<a name="l00310"></a>00310         KSPSetNormType(SolveurPetsc_, KSP_NORM_UNPRECONDITIONED);
<a name="l00311"></a>00311         solver_supported_on_gpu_by_petsc=1;
<a name="l00312"></a>00312         solver_supported_on_gpu_by_amgx=1;
<a name="l00313"></a>00313         <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l00314"></a>00314           {
<a name="l00315"></a>00315             amgx_option+=<span class="stringliteral">&quot;solver(s)=GMRES\n&quot;</span>; <span class="comment">//!&lt; GMRES</span>
<a name="l00316"></a>00316 <span class="comment"></span>            <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>(<span class="stringliteral">&quot;Gmres solver on GPU with AmgX fails to return a valid solution. Try GCP, BiCGSTAB or FGMRES solvers.&quot;</span>);
<a name="l00317"></a>00317           }
<a name="l00318"></a>00318         <span class="keywordflow">break</span>;
<a name="l00319"></a>00319       }
<a name="l00320"></a>00320     <span class="keywordflow">case</span> 19:
<a name="l00321"></a>00321       {
<a name="l00322"></a>00322         KSPSetType(SolveurPetsc_, KSPFGMRES);
<a name="l00323"></a>00323         KSPSetPCSide(SolveurPetsc_, PC_RIGHT);
<a name="l00324"></a>00324         KSPSetNormType(SolveurPetsc_, KSP_NORM_UNPRECONDITIONED);
<a name="l00325"></a>00325         solver_supported_on_gpu_by_petsc=1;
<a name="l00326"></a>00326         solver_supported_on_gpu_by_amgx=1;
<a name="l00327"></a>00327         <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>) amgx_option+=<span class="stringliteral">&quot;solver(s)=FGMRES\n&quot;</span>; <span class="comment">//!&lt; FGMRES</span>
<a name="l00328"></a>00328 <span class="comment"></span>        <span class="keywordflow">break</span>;
<a name="l00329"></a>00329       }
<a name="l00330"></a>00330     <span class="keywordflow">case</span> 8:
<a name="l00331"></a>00331       {
<a name="l00332"></a>00332         KSPSetType(SolveurPetsc_, KSPPGMRES);
<a name="l00333"></a>00333 <span class="comment">// PGMRES ne peut etre que preconditionne a gauche (CAx=Cb)</span>
<a name="l00334"></a>00334 <span class="comment">// et on ne peut avoir que le residu preconditionne (||CAx-Cb||)</span>
<a name="l00335"></a>00335 <span class="comment">// -&gt; on ne peut comparer la convergence avec le GMRES...</span>
<a name="l00336"></a>00336         KSPSetPCSide(SolveurPetsc_, PC_LEFT);
<a name="l00337"></a>00337 <span class="comment">// KSPSetNormType(SolveurPetsc, KSP_NORM_UNPRECONDITIONED);</span>
<a name="l00338"></a>00338         solver_supported_on_gpu_by_petsc=1;
<a name="l00339"></a>00339         <span class="keywordflow">break</span>;
<a name="l00340"></a>00340       }
<a name="l00341"></a>00341     <span class="keywordflow">case</span> 3:
<a name="l00342"></a>00342     <span class="keywordflow">case</span> 4:
<a name="l00343"></a>00343     <span class="keywordflow">case</span> 9:
<a name="l00344"></a>00344     <span class="keywordflow">case</span> 16:
<a name="l00345"></a>00345       {
<a name="l00346"></a>00346 <span class="comment">// Si MUMPS est present, on le prend par defaut (solveur_direct_=1) sinon SuperLU (solveur_direct_=2):</span>
<a name="l00347"></a>00347 <span class="preprocessor">#ifdef PETSC_HAVE_MUMPS</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span>        <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> = <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6a1cb49f862e7fcd552eed7f0145c86db1">mumps</a>;
<a name="l00349"></a>00349 <span class="comment">// Ajout de l&#39;option</span>
<a name="l00350"></a>00350 <span class="comment">// Par defaut le cas PAR_Canal_incline_VEF plante sur 4 processeurs si -mat_mumps_icntl_14 inferieur a 35...</span>
<a name="l00351"></a>00351 <span class="comment">// On revient a 75 car parfois VEF_258 plante... C&#39;est pas clair au niveau memoire...</span>
<a name="l00352"></a>00352 <span class="comment">// Passage a Petsc 3.3 necessite d&#39;augmenter a plus de 75 car sinon Aero_192 crashe...</span>
<a name="l00353"></a>00353 <span class="comment">// A 90, le cas les_Re180Pr071_T0Q_jdd2 plante sur forchat (32bits)</span>
<a name="l00354"></a>00354 <span class="comment">// On differencie sequentiel (peu de memoire, mais estimation juste)</span>
<a name="l00355"></a>00355 <span class="comment">// et le calcul parallele (voir peut etre une separation entre plus et moins de 16 processeurs...)</span>
<a name="l00356"></a>00356 <span class="comment">// Peut etre equiper le script trust d&#39;une detection des erreurs INFO(1)=-9 ...</span>
<a name="l00357"></a>00357 <span class="comment">// On passe de 35 a 40 pour faire passer le cas cavite_entrainee_2D_jdd2 (suite passage a MUMPS 5.2.0)</span>
<a name="l00358"></a>00358         <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>() == 1)
<a name="l00359"></a>00359           add_option(<span class="stringliteral">&quot;mat_mumps_icntl_14&quot;</span>, <span class="stringliteral">&quot;40&quot;</span>);
<a name="l00360"></a>00360         <span class="keywordflow">else</span>
<a name="l00361"></a>00361           add_option(<span class="stringliteral">&quot;mat_mumps_icntl_14&quot;</span>, <span class="stringliteral">&quot;90&quot;</span>);
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="comment">// Option out_of_core</span>
<a name="l00364"></a>00364         <span class="keywordflow">if</span> (rang == 4) add_option(<span class="stringliteral">&quot;mat_mumps_icntl_22&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 <span class="comment">// Option BLR</span>
<a name="l00367"></a>00367         <span class="keywordflow">if</span> (rang == 16)
<a name="l00368"></a>00368           {
<a name="l00369"></a>00369             <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a>
<a name="l00370"></a>00370                 &lt;&lt; <span class="stringliteral">&quot;Activating BLR factorization. For more info, see http://mumps.enseeiht.fr/doc/userguide_5.1.2.pdf (page 18, 51, 52).&quot;</span>
<a name="l00371"></a>00371                 &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00372"></a>00372             add_option(<span class="stringliteral">&quot;mat_mumps_icntl_35&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>);
<a name="l00373"></a>00373           }
<a name="l00374"></a>00374 <span class="preprocessor">#else</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span>        <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>=<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6ae182fa5e69fe3b70815223024f19cd1b">superlu_dist</a>;
<a name="l00376"></a>00376 <span class="preprocessor">#endif</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span>        KSPSetType(SolveurPetsc_, KSPPREONLY);
<a name="l00378"></a>00378         <span class="keywordflow">break</span>;
<a name="l00379"></a>00379       }
<a name="l00380"></a>00380     <span class="keywordflow">case</span> 5:
<a name="l00381"></a>00381       {
<a name="l00382"></a>00382         KSPSetType(SolveurPetsc_, KSPBCGS);
<a name="l00383"></a>00383         solver_supported_on_gpu_by_petsc=1;
<a name="l00384"></a>00384         solver_supported_on_gpu_by_amgx=1;
<a name="l00385"></a>00385 <span class="comment">// if (amgx_) amgx_option+=&quot;solver(s)=BICGSTAB\n&quot;; // BICGSTAB sans preconditionnement</span>
<a name="l00386"></a>00386         <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>) amgx_option+=<span class="stringliteral">&quot;solver(s)=PBICGSTAB\n&quot;</span>; <span class="comment">//!&lt; BICGSTAB avec precondtionnement</span>
<a name="l00387"></a>00387 <span class="comment"></span>        <span class="keywordflow">break</span>;
<a name="l00388"></a>00388       }
<a name="l00389"></a>00389     <span class="keywordflow">case</span> 6:
<a name="l00390"></a>00390       {
<a name="l00391"></a>00391         KSPSetType(SolveurPetsc_, KSPIBCGS); <span class="comment">//!&lt; 1 point de synchro au lieu de 3 pour KSPBCGS Pour optimiser encore les comms, voir: http://www.mcs.anl.gov/petsc/petsc-as/snapshots/petsc-3.0.0/docs/manualpages/KSP/KSPIBCGS.html</span>
<a name="l00392"></a>00392 <span class="comment"></span><span class="comment">//</span>
<a name="l00393"></a>00393 <span class="comment">//</span>
<a name="l00394"></a>00394         KSPSetLagNorm(SolveurPetsc_, PETSC_TRUE);
<a name="l00395"></a>00395         <span class="keywordflow">break</span>;
<a name="l00396"></a>00396       }
<a name="l00397"></a>00397     <span class="keywordflow">case</span> 7:
<a name="l00398"></a>00398       {
<a name="l00399"></a>00399         <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>=<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6ae182fa5e69fe3b70815223024f19cd1b">superlu_dist</a>;
<a name="l00400"></a>00400 <span class="comment">// SuperLU_dist, parallel but not faster than MUMPS</span>
<a name="l00401"></a>00401 <span class="preprocessor">#ifdef PETSC_HAVE_OPENMP</span>
<a name="l00402"></a>00402 <span class="preprocessor"></span><span class="comment">// Version GPU disponible de SuperLU si OpenMP active (necessaire)</span>
<a name="l00403"></a>00403         solver_supported_on_gpu_by_petsc=1;
<a name="l00404"></a>00404 <span class="preprocessor">#endif</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>        KSPSetType(SolveurPetsc_, KSPPREONLY);
<a name="l00406"></a>00406         <span class="keywordflow">break</span>;
<a name="l00407"></a>00407       }
<a name="l00408"></a>00408     <span class="keywordflow">case</span> 11:
<a name="l00409"></a>00409       {
<a name="l00410"></a>00410         <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()&gt;1) <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>(<span class="stringliteral">&quot;Cholesky_lapack can&#39;t be used for parallel calculation.&quot;</span>);
<a name="l00411"></a>00411         <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>=<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6aaf77cfaeac95d5bb680e1b2603d23ae1">petsc</a>;
<a name="l00412"></a>00412 <span class="comment">// Lapack, old and slow (non pas vrai sur petites matrices d&#39;ordre 100 - 10000 !)</span>
<a name="l00413"></a>00413         add_option(<span class="stringliteral">&quot;pc_factor_nonzeros_along_diagonal&quot;</span>, <span class="stringliteral">&quot;&quot;</span>); <span class="comment">//!&lt; Moins robuste que MUMPS pour un pivot nul donc on reordonne pour eviter</span>
<a name="l00414"></a>00414 <span class="comment"></span>        KSPSetType(SolveurPetsc_, KSPPREONLY);
<a name="l00415"></a>00415         <span class="keywordflow">break</span>;
<a name="l00416"></a>00416       }
<a name="l00417"></a>00417     <span class="keywordflow">case</span> 12:
<a name="l00418"></a>00418       {
<a name="l00419"></a>00419         <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()&gt;1) <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>(<span class="stringliteral">&quot;Cholesky_umfpack can&#39;t be used for parallel calculation.&quot;</span>);
<a name="l00420"></a>00420         <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>=<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6ad25605924f9b1643dcc298a4eba5a84f">umfpack</a>;
<a name="l00421"></a>00421 <span class="comment">// Umfpack, sequential only but fast...</span>
<a name="l00422"></a>00422         KSPSetType(SolveurPetsc_, KSPPREONLY);
<a name="l00423"></a>00423 <span class="comment">// more robustness</span>
<a name="l00424"></a>00424         add_option(<span class="stringliteral">&quot;mat_umfpack_pivot_tolerance&quot;</span>,<span class="stringliteral">&quot;1.0&quot;</span>);
<a name="l00425"></a>00425         <span class="keywordflow">break</span>;
<a name="l00426"></a>00426       }
<a name="l00427"></a>00427     <span class="keywordflow">case</span> 13:
<a name="l00428"></a>00428       {
<a name="l00429"></a>00429         <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>=<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6aa663c1c6ebfd318f067db896735d4481">pastix</a>;
<a name="l00430"></a>00430 <span class="comment">// Pastix supports sbaij but seems slow...</span>
<a name="l00431"></a>00431         KSPSetType(SolveurPetsc_, KSPPREONLY);
<a name="l00432"></a>00432         <span class="keywordflow">break</span>;
<a name="l00433"></a>00433       }
<a name="l00434"></a>00434     <span class="keywordflow">case</span> 17:
<a name="l00435"></a>00435       {
<a name="l00436"></a>00436         <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()&gt;1) <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>(<span class="stringliteral">&quot;Cholesky_cholmod can&#39;t be used for parallel calculation.&quot;</span>);
<a name="l00437"></a>00437         <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>=<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6abc3895945aa136c66ea71a53a6fae6c7">cholmod</a>;
<a name="l00438"></a>00438 <span class="comment">// Cholmod Cholesky (pas LU), sequentiel, supporte multi-GPU</span>
<a name="l00439"></a>00439         <span class="keywordflow">if</span> (!matrice_symetrique_)
<a name="l00440"></a>00440           {
<a name="l00441"></a>00441             <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; ksp &lt;&lt; <span class="stringliteral">&quot; is only supported for symmetric linear system.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00442"></a>00442             <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00443"></a>00443           }
<a name="l00444"></a>00444         solver_supported_on_gpu_by_petsc=1;
<a name="l00445"></a>00445         KSPSetType(SolveurPetsc_, KSPPREONLY);
<a name="l00446"></a>00446         <span class="keywordflow">break</span>;
<a name="l00447"></a>00447       }
<a name="l00448"></a>00448     <span class="keywordflow">default</span>:
<a name="l00449"></a>00449       {
<a name="l00450"></a>00450         <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; ksp &lt;&lt; <span class="stringliteral">&quot; : solver not officially recognized by TRUST among those possible for the moment:&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00451"></a>00451         <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; les_solveurs &lt;&lt; finl;
<a name="l00452"></a>00452         <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You can try to access directly to Petsc solvers with the command line:&quot;</span> &lt;&lt; finl;
<a name="l00453"></a>00453         <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;PETSC CLI { -ksp_type solver_name -pc_type preconditioning_name -ksp_atol threshold -ksp_monitor }&quot;</span> &lt;&lt; finl;
<a name="l00454"></a>00454         <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;See the reference manual for all Petsc options.&quot;</span> &lt;&lt; finl;
<a name="l00455"></a>00455         <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00456"></a>00456       }
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 <span class="comment">// On verifie que le solveur est supporte sur GPU:</span>
<a name="l00460"></a>00460   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a5f603c229087d42c8bb2fee48290526f" title="Utilisation des solveurs GPU de PETSc.">gpu_</a>)
<a name="l00461"></a>00461     {
<a name="l00462"></a>00462 <span class="preprocessor">#ifdef PETSC_HAVE_CUDA</span>
<a name="l00463"></a>00463 <span class="preprocessor"></span>      <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;GPU capabilities of PETSc will be used.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00464"></a>00464 <span class="preprocessor">#else</span>
<a name="l00465"></a>00465 <span class="preprocessor"></span>      <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You can not use petsc_gpu keyword cause GPU&quot;</span> &lt;&lt; finl;
<a name="l00466"></a>00466       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;capabilities will not work on your workstation with PETSc.&quot;</span> &lt;&lt; finl;
<a name="l00467"></a>00467       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Check if you have a NVidia video card and its driver up to date.&quot;</span> &lt;&lt; finl;
<a name="l00468"></a>00468       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Check petsc.log file under $TRUST_ROOT/lib/src/LIBPETSC for more details.&quot;</span> &lt;&lt; finl;
<a name="l00469"></a>00469       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00470"></a>00470 <span class="preprocessor">#endif</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (solver_supported_on_gpu_by_petsc==0)
<a name="l00472"></a>00472         {
<a name="l00473"></a>00473           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; les_solveurs[rang] &lt;&lt; <span class="stringliteral">&quot; is not supported yet by PETSc on GPU.&quot;</span> &lt;&lt; finl;
<a name="l00474"></a>00474           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00475"></a>00475         }
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l00478"></a>00478     {
<a name="l00479"></a>00479 <span class="preprocessor">#ifdef PETSC_HAVE_CUDA</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span>      <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;GPU capabilities of AmgX will be used.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00481"></a>00481 <span class="preprocessor">#else</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span>      <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You can not use amgx keyword cause GPU&quot;</span> &lt;&lt; finl;
<a name="l00483"></a>00483       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;capabilities will not work on your workstation with AmgX.&quot;</span> &lt;&lt; finl;
<a name="l00484"></a>00484       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Check if you have a NVidia video card and its driver up to date.&quot;</span> &lt;&lt; finl;
<a name="l00485"></a>00485       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Check petsc.log file under $TRUST_ROOT/lib/src/LIBPETSC for more details.&quot;</span> &lt;&lt; finl;
<a name="l00486"></a>00486       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00487"></a>00487 <span class="preprocessor">#endif</span>
<a name="l00488"></a>00488 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (solver_supported_on_gpu_by_amgx==0)
<a name="l00489"></a>00489         {
<a name="l00490"></a>00490           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; les_solveurs[rang] &lt;&lt; <span class="stringliteral">&quot; is not supported yet by AmgX on GPU.&quot;</span> &lt;&lt; finl;
<a name="l00491"></a>00491           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00492"></a>00492         }
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495   <span class="keywordtype">int</span> convergence_with_seuil=0; <span class="comment">//!&lt; Keyword to check the convergence via seuil or nb_it_max On continue a lire</span>
<a name="l00496"></a>00496 <span class="comment"></span><span class="comment">//</span>
<a name="l00497"></a>00497   <span class="keywordflow">if</span> (motlu==accolade_ouverte)
<a name="l00498"></a>00498     {
<a name="l00499"></a>00499 <span class="comment">// Temporaire essayer de faire converger les noms de parametres des differentes solveurs (GCP, GMRES,...)</span>
<a name="l00500"></a>00500       <a class="code" href="classMotcles.html" title="Un tableau d&#39;objets de la classe Motcle.">Motcles</a> les_parametres_solveur(27);
<a name="l00501"></a>00501       {
<a name="l00502"></a>00502         les_parametres_solveur[0] = <span class="stringliteral">&quot;impr&quot;</span>;
<a name="l00503"></a>00503         les_parametres_solveur[1] = <span class="stringliteral">&quot;seuil&quot;</span>; <span class="comment">//!&lt; Seuil absolu (atol)</span>
<a name="l00504"></a>00504 <span class="comment"></span>        les_parametres_solveur[2] = <span class="stringliteral">&quot;precond&quot;</span>;
<a name="l00505"></a>00505         les_parametres_solveur[3] = <span class="stringliteral">&quot;precond_nul&quot;</span>; <span class="comment">//!&lt; To accept the TRUST syntax</span>
<a name="l00506"></a>00506 <span class="comment"></span>        les_parametres_solveur[4] = <span class="stringliteral">&quot;nb_it_max&quot;</span>;
<a name="l00507"></a>00507         les_parametres_solveur[5] = <span class="stringliteral">&quot;save_matrix_petsc_format&quot;</span>;
<a name="l00508"></a>00508         les_parametres_solveur[6] = <span class="stringliteral">&quot;factored_matrix&quot;</span>; <span class="comment">//!&lt; Experimental</span>
<a name="l00509"></a>00509 <span class="comment"></span>        les_parametres_solveur[7] = <span class="stringliteral">&quot;read_matrix&quot;</span>;
<a name="l00510"></a>00510         les_parametres_solveur[8] = <span class="stringliteral">&quot;controle_residu&quot;</span>;
<a name="l00511"></a>00511         les_parametres_solveur[9] = <span class="stringliteral">&quot;cli&quot;</span>;
<a name="l00512"></a>00512         les_parametres_solveur[10] = <span class="stringliteral">&quot;ordering&quot;</span>;
<a name="l00513"></a>00513         les_parametres_solveur[11] = <span class="stringliteral">&quot;petsc_decide&quot;</span>; <span class="comment">//!&lt; Experimental</span>
<a name="l00514"></a>00514 <span class="comment"></span>        les_parametres_solveur[12] = <span class="stringliteral">&quot;aij&quot;</span>;
<a name="l00515"></a>00515         les_parametres_solveur[13] = <span class="stringliteral">&quot;nb_cpus&quot;</span>;
<a name="l00516"></a>00516         les_parametres_solveur[14] = <span class="stringliteral">&quot;divtol&quot;</span>;
<a name="l00517"></a>00517         les_parametres_solveur[15] = <span class="stringliteral">&quot;save_matrice|save_matrix&quot;</span>;
<a name="l00518"></a>00518         les_parametres_solveur[16] = <span class="stringliteral">&quot;quiet&quot;</span>;
<a name="l00519"></a>00519         les_parametres_solveur[17] = <span class="stringliteral">&quot;restart&quot;</span>;
<a name="l00520"></a>00520         les_parametres_solveur[18] = <span class="stringliteral">&quot;cli_verbose&quot;</span>;
<a name="l00521"></a>00521         les_parametres_solveur[19] = <span class="stringliteral">&quot;dropping_parameter&quot;</span>;
<a name="l00522"></a>00522         les_parametres_solveur[20] = <span class="stringliteral">&quot;rtol&quot;</span>; <span class="comment">//!&lt; Seuil relatif</span>
<a name="l00523"></a>00523 <span class="comment"></span>        les_parametres_solveur[21] = <span class="stringliteral">&quot;atol&quot;</span>; <span class="comment">//!&lt; Seuil absolu &lt;=&gt; seuil</span>
<a name="l00524"></a>00524 <span class="comment"></span>        les_parametres_solveur[22] = <span class="stringliteral">&quot;ignore_new_nonzero&quot;</span>;
<a name="l00525"></a>00525         les_parametres_solveur[23] = <span class="stringliteral">&quot;rebuild_matrix&quot;</span>;
<a name="l00526"></a>00526         les_parametres_solveur[24] = <span class="stringliteral">&quot;allow_realloc&quot;</span>;
<a name="l00527"></a>00527         les_parametres_solveur[25] = <span class="stringliteral">&quot;clean_matrix&quot;</span>;
<a name="l00528"></a>00528         les_parametres_solveur[26] = <span class="stringliteral">&quot;save_matrix_mtx_format&quot;</span>;
<a name="l00529"></a>00529       }
<a name="l00530"></a>00530       <a class="code" href="classoption__double.html">option_double</a> omega(<span class="stringliteral">&quot;omega&quot;</span>,1.5);
<a name="l00531"></a>00531       <a class="code" href="classoption__int.html">option_int</a>    level(<span class="stringliteral">&quot;level&quot;</span>,1);
<a name="l00532"></a>00532       <a class="code" href="classoption__double.html">option_double</a> epsilon(<span class="stringliteral">&quot;epsilon&quot;</span>,0.1);
<a name="l00533"></a>00533       <a class="code" href="classoption__string.html">option_string</a> ordering(<span class="stringliteral">&quot;ordering&quot;</span>,(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)<span class="stringliteral">&quot;&quot;</span>);
<a name="l00534"></a>00534       controle_residu_=0;
<a name="l00535"></a>00535 
<a name="l00536"></a>00536       is &gt;&gt; motlu;
<a name="l00537"></a>00537       <span class="keywordflow">while</span> (motlu!=accolade_fermee)
<a name="l00538"></a>00538         {
<a name="l00539"></a>00539           <span class="keywordflow">switch</span>(les_parametres_solveur.<a class="code" href="classMotcles.html#afecd68f73e904bc129022a236ff6ab15">search</a>(motlu))
<a name="l00540"></a>00540             {
<a name="l00541"></a>00541             <span class="keywordflow">case</span> 16:
<a name="l00542"></a>00542               {
<a name="l00543"></a>00543                 <a class="code" href="classSolveurSys__base.html#a987e97740c779c1ab4192c3c1f1bbd5d">fixer_limpr</a>(-1);
<a name="l00544"></a>00544                 <span class="keywordflow">break</span>;
<a name="l00545"></a>00545               }
<a name="l00546"></a>00546             <span class="keywordflow">case</span> 0:
<a name="l00547"></a>00547               {
<a name="l00548"></a>00548                 <a class="code" href="classSolveurSys__base.html#a987e97740c779c1ab4192c3c1f1bbd5d">fixer_limpr</a>(1);
<a name="l00549"></a>00549 <span class="comment">// Si MUMPS on ajoute des impressions sur la decomposition</span>
<a name="l00550"></a>00550                 <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>==<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6a1cb49f862e7fcd552eed7f0145c86db1">mumps</a>)
<a name="l00551"></a>00551                   add_option(<span class="stringliteral">&quot;mat_mumps_icntl_4&quot;</span>,<span class="stringliteral">&quot;3&quot;</span>);
<a name="l00552"></a>00552                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>==<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6ae182fa5e69fe3b70815223024f19cd1b">superlu_dist</a>)
<a name="l00553"></a>00553                   add_option(<span class="stringliteral">&quot;mat_superlu_dist_statprint&quot;</span>,<span class="stringliteral">&quot;&quot;</span>);
<a name="l00554"></a>00554                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>==<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6aaf77cfaeac95d5bb680e1b2603d23ae1">petsc</a>)
<a name="l00555"></a>00555                   {}
<a name="l00556"></a>00556                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>==<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6ad25605924f9b1643dcc298a4eba5a84f">umfpack</a>)
<a name="l00557"></a>00557                   add_option(<span class="stringliteral">&quot;mat_umfpack_prl&quot;</span>,<span class="stringliteral">&quot;2&quot;</span>);
<a name="l00558"></a>00558                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>==<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6aa663c1c6ebfd318f067db896735d4481">pastix</a>)
<a name="l00559"></a>00559                   add_option(<span class="stringliteral">&quot;mat_pastix_verbose&quot;</span>,<span class="stringliteral">&quot;2&quot;</span>);
<a name="l00560"></a>00560                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>==<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6abc3895945aa136c66ea71a53a6fae6c7">cholmod</a>)
<a name="l00561"></a>00561                   add_option(<span class="stringliteral">&quot;mat_cholmod_print&quot;</span>,<span class="stringliteral">&quot;3&quot;</span>);
<a name="l00562"></a>00562                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>)
<a name="l00563"></a>00563                   {
<a name="l00564"></a>00564                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;impr not coded yet for this direct solver.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00565"></a>00565                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00566"></a>00566                   }
<a name="l00567"></a>00567                 <span class="keywordflow">break</span>;
<a name="l00568"></a>00568               }
<a name="l00569"></a>00569             <span class="keywordflow">case</span> 1:
<a name="l00570"></a>00570             <span class="keywordflow">case</span> 21:
<a name="l00571"></a>00571               {
<a name="l00572"></a>00572                 <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>)
<a name="l00573"></a>00573                   {
<a name="l00574"></a>00574                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Definition of &quot;</span> &lt;&lt; les_parametres_solveur(les_parametres_solveur.<a class="code" href="classMotcles.html#afecd68f73e904bc129022a236ff6ab15">search</a>(motlu)) &lt;&lt; <span class="stringliteral">&quot; is useless for a direct method.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00575"></a>00575                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Suppress the keyword.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00576"></a>00576                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00577"></a>00577                   }
<a name="l00578"></a>00578                 is &gt;&gt; seuil_;
<a name="l00579"></a>00579                 convergence_with_seuil=1;
<a name="l00580"></a>00580                 <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l00581"></a>00581                   {
<a name="l00582"></a>00582                     amgx_option+=<span class="stringliteral">&quot;s:convergence=ABSOLUTE\ns:tolerance=&quot;</span>;
<a name="l00583"></a>00583                     amgx_option+=<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>(seuil_,<span class="stringliteral">&quot;%e&quot;</span>)+<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00584"></a>00584                   }
<a name="l00585"></a>00585                 <span class="keywordflow">break</span>;
<a name="l00586"></a>00586               }
<a name="l00587"></a>00587             <span class="keywordflow">case</span> 2:
<a name="l00588"></a>00588               {
<a name="l00589"></a>00589                 is &gt;&gt; pc;
<a name="l00590"></a>00590                 is &gt;&gt; motlu;
<a name="l00591"></a>00591                 <span class="keywordflow">if</span> (motlu != accolade_ouverte)
<a name="l00592"></a>00592                   {
<a name="l00593"></a>00593                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error while reading the parameters of the PETSC preconditioner: precond &quot;</span> &lt;&lt; pc &lt;&lt; <span class="stringliteral">&quot; { ... }&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00594"></a>00594                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;We expected &quot;</span> &lt;&lt; accolade_ouverte &lt;&lt; <span class="stringliteral">&quot; instead of &quot;</span> &lt;&lt; motlu &lt;&lt; finl;
<a name="l00595"></a>00595                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00596"></a>00596                   }
<a name="l00597"></a>00597                 is &gt;&gt; motlu;
<a name="l00598"></a>00598                 <span class="keywordflow">while</span> (motlu!=accolade_fermee)
<a name="l00599"></a>00599                   {
<a name="l00600"></a>00600                     <a class="code" href="classMotcles.html" title="Un tableau d&#39;objets de la classe Motcle.">Motcles</a> les_parametres_precond(4);
<a name="l00601"></a>00601                     {
<a name="l00602"></a>00602                       les_parametres_precond[0] = omega.<a class="code" href="classoption.html#a38c4ce51346daeda4a76db767d8aac75">name</a>;
<a name="l00603"></a>00603                       les_parametres_precond[1] = level.<a class="code" href="classoption.html#a38c4ce51346daeda4a76db767d8aac75">name</a>;
<a name="l00604"></a>00604                       les_parametres_precond[2] = epsilon.<a class="code" href="classoption.html#a38c4ce51346daeda4a76db767d8aac75">name</a>;
<a name="l00605"></a>00605                       les_parametres_precond[3] = ordering.<a class="code" href="classoption.html#a38c4ce51346daeda4a76db767d8aac75">name</a>;
<a name="l00606"></a>00606                     }
<a name="l00607"></a>00607                     <span class="keywordtype">double</span> tmp_int;
<a name="l00608"></a>00608                     <span class="keywordtype">double</span> tmp_double;
<a name="l00609"></a>00609                     <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> tmp_string;
<a name="l00610"></a>00610                     <span class="keywordflow">switch</span>(les_parametres_precond.<a class="code" href="classMotcles.html#afecd68f73e904bc129022a236ff6ab15">search</a>(motlu))
<a name="l00611"></a>00611                       {
<a name="l00612"></a>00612                       <span class="keywordflow">case</span> 0:
<a name="l00613"></a>00613                         {
<a name="l00614"></a>00614                           is &gt;&gt; tmp_double;
<a name="l00615"></a>00615                           omega.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>()=tmp_double;
<a name="l00616"></a>00616                           omega.<a class="code" href="classoption.html#a111fcb2f43490d4a2b9c4227a6412b2f">defined</a>=1;
<a name="l00617"></a>00617                           <span class="keywordflow">break</span>;
<a name="l00618"></a>00618                         }
<a name="l00619"></a>00619                       <span class="keywordflow">case</span> 1:
<a name="l00620"></a>00620                         {
<a name="l00621"></a>00621                           is &gt;&gt; tmp_int   ;
<a name="l00622"></a>00622                           level.<a class="code" href="classoption__int.html#a3f9d1b5b2aa020c5db15e82bd3e829e2">value</a>()=(int)tmp_int;
<a name="l00623"></a>00623                           level.<a class="code" href="classoption.html#a111fcb2f43490d4a2b9c4227a6412b2f">defined</a>=1;
<a name="l00624"></a>00624                           <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l00625"></a>00625                             {
<a name="l00626"></a>00626                               <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> ilu_sparsity_level=<span class="stringliteral">&quot;p:ilu_sparsity_level=&quot;</span>;
<a name="l00627"></a>00627                               ilu_sparsity_level+=(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)level.<a class="code" href="classoption__int.html#a3f9d1b5b2aa020c5db15e82bd3e829e2">value</a>();
<a name="l00628"></a>00628                               amgx_option+=ilu_sparsity_level+<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00629"></a>00629                               <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> coloring_level=<span class="stringliteral">&quot;p:coloring_level=&quot;</span>; <span class="comment">//!&lt; 1 par defaut</span>
<a name="l00630"></a>00630 <span class="comment"></span>                              coloring_level+=<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>(level.<a class="code" href="classoption__int.html#a3f9d1b5b2aa020c5db15e82bd3e829e2">value</a>()+1);    <span class="comment">//!&lt; Doit valoir ilu_sparsity_level+1 pour MULTICOLOT_INU (voir AmgX reference guide)</span>
<a name="l00631"></a>00631 <span class="comment"></span>                              amgx_option+=coloring_level+<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00632"></a>00632                             }
<a name="l00633"></a>00633                           <span class="keywordflow">break</span>;
<a name="l00634"></a>00634                         }
<a name="l00635"></a>00635                       <span class="keywordflow">case</span> 2:
<a name="l00636"></a>00636                         {
<a name="l00637"></a>00637                           is &gt;&gt; tmp_double;
<a name="l00638"></a>00638                           epsilon.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>()=tmp_double;
<a name="l00639"></a>00639                           epsilon.<a class="code" href="classoption.html#a111fcb2f43490d4a2b9c4227a6412b2f">defined</a>=1;
<a name="l00640"></a>00640                           <span class="keywordflow">break</span>;
<a name="l00641"></a>00641                         }
<a name="l00642"></a>00642                       <span class="keywordflow">case</span> 3:
<a name="l00643"></a>00643                         {
<a name="l00644"></a>00644                           is &gt;&gt; tmp_string;
<a name="l00645"></a>00645                           ordering.<a class="code" href="classoption__string.html#ac0fa274649cf7c52c0def6c9095a30ce">value</a>()=tmp_string;
<a name="l00646"></a>00646                           ordering.<a class="code" href="classoption.html#a111fcb2f43490d4a2b9c4227a6412b2f">defined</a>=1;
<a name="l00647"></a>00647                           <span class="keywordflow">break</span>;
<a name="l00648"></a>00648                         }
<a name="l00649"></a>00649                       <span class="keywordflow">default</span>:
<a name="l00650"></a>00650                         {
<a name="l00651"></a>00651                           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; motlu &lt;&lt; <span class="stringliteral">&quot; : unrecognized option among all of those possible on Petsc preconditioner:&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00652"></a>00652                           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; les_parametres_precond &lt;&lt; finl;
<a name="l00653"></a>00653                           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00654"></a>00654                         }
<a name="l00655"></a>00655                       }
<a name="l00656"></a>00656                     is &gt;&gt; motlu;
<a name="l00657"></a>00657                   }
<a name="l00658"></a>00658                 <span class="keywordflow">break</span>;
<a name="l00659"></a>00659               }
<a name="l00660"></a>00660             <span class="keywordflow">case</span> 3:
<a name="l00661"></a>00661               {
<a name="l00662"></a>00662                 pc=<span class="stringliteral">&quot;null&quot;</span>;
<a name="l00663"></a>00663                 <span class="keywordflow">break</span>;
<a name="l00664"></a>00664               }
<a name="l00665"></a>00665             <span class="keywordflow">case</span> 4:
<a name="l00666"></a>00666               {
<a name="l00667"></a>00667                 is &gt;&gt; nb_it_max_;
<a name="l00668"></a>00668                 convergence_with_nb_it_max_=1;
<a name="l00669"></a>00669                 <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l00670"></a>00670                   {
<a name="l00671"></a>00671                     amgx_option+=<span class="stringliteral">&quot;s:max_iters=&quot;</span>;
<a name="l00672"></a>00672                     amgx_option+=<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>(nb_it_max_)+<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00673"></a>00673                   }
<a name="l00674"></a>00674                 <span class="keywordflow">break</span>;
<a name="l00675"></a>00675               }
<a name="l00676"></a>00676             <span class="keywordflow">case</span> 15:
<a name="l00677"></a>00677               {
<a name="l00678"></a>00678                 <a class="code" href="classSolveurSys__base.html#a824322fe6a2c03aa986b8152aefcf14b" title="Drapeau pour savoir si un stockage disque est a refaire.">save_matrice_</a>=1;
<a name="l00679"></a>00679                 <span class="keywordflow">break</span>;
<a name="l00680"></a>00680               }
<a name="l00681"></a>00681             <span class="keywordflow">case</span> 5:
<a name="l00682"></a>00682               {
<a name="l00683"></a>00683 <span class="comment">// on sauvegarde au format petsc</span>
<a name="l00684"></a>00684                 save_matrix_=1;
<a name="l00685"></a>00685                 <span class="keywordflow">break</span>;
<a name="l00686"></a>00686               }
<a name="l00687"></a>00687             <span class="keywordflow">case</span> 26:
<a name="l00688"></a>00688               {
<a name="l00689"></a>00689 <span class="comment">// on sauvegarde au format matrix market</span>
<a name="l00690"></a>00690                 save_matrix_=2;
<a name="l00691"></a>00691                 <span class="keywordflow">break</span>;
<a name="l00692"></a>00692               }
<a name="l00693"></a>00693             <span class="keywordflow">case</span> 6:
<a name="l00694"></a>00694               {
<a name="l00695"></a>00695                 <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()&gt;1)
<a name="l00696"></a>00696                   {
<a name="l00697"></a>00697                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;factored_matrix option is not available for parallel calculation.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00698"></a>00698                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00699"></a>00699                   }
<a name="l00700"></a>00700                 <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>!=<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6aaf77cfaeac95d5bb680e1b2603d23ae1">petsc</a>)
<a name="l00701"></a>00701                   {
<a name="l00702"></a>00702 <span class="comment">// Switch to PETSc Cholesky cause MUMPS or SUPERLU don&#39;t give access to LU ?</span>
<a name="l00703"></a>00703                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Only cholesky_lapack keyword may be used with the option factored_matrix.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00704"></a>00704                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00705"></a>00705                   }
<a name="l00706"></a>00706                 is &gt;&gt; factored_matrix_;
<a name="l00707"></a>00707                 <span class="keywordflow">break</span>;
<a name="l00708"></a>00708               }
<a name="l00709"></a>00709             <span class="keywordflow">case</span> 7:
<a name="l00710"></a>00710               {
<a name="l00711"></a>00711                 <a class="code" href="classSolv__Petsc.html#a9c92c7b3025ccb3f301489141a442211" title="Read constant matrix in a file.">read_matrix_</a>=1;
<a name="l00712"></a>00712                 <span class="keywordflow">break</span>;
<a name="l00713"></a>00713               }
<a name="l00714"></a>00714             <span class="keywordflow">case</span> 8:
<a name="l00715"></a>00715               {
<a name="l00716"></a>00716                 is &gt;&gt; controle_residu_;
<a name="l00717"></a>00717                 <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Option controle_residu not implemented yet.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00718"></a>00718                 <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00719"></a>00719                 <span class="keywordflow">break</span>;
<a name="l00720"></a>00720               }
<a name="l00721"></a>00721             <span class="keywordflow">case</span> 9:
<a name="l00722"></a>00722               {
<a name="l00723"></a>00723                 is &gt;&gt; motlu; <span class="comment">//!&lt; On lit l&#39;accolade</span>
<a name="l00724"></a>00724 <span class="comment"></span>                <span class="keywordflow">if</span> (motlu != accolade_ouverte)
<a name="l00725"></a>00725                   {
<a name="l00726"></a>00726                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;We expected &quot;</span> &lt;&lt; accolade_ouverte &lt;&lt; <span class="stringliteral">&quot; instead of &quot;</span> &lt;&lt; motlu &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00727"></a>00727                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00728"></a>00728                   }
<a name="l00729"></a>00729                 <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Reading of the Petsc commands:&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00730"></a>00730                 <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> <a class="code" href="Source__Generique__Face__PolyMAC_8cpp.html#a7d7b5d77a3caa1af70f5e1c9108de5a1">valeur</a>;
<a name="l00731"></a>00731                 is &gt;&gt; motlu;
<a name="l00732"></a>00732                 <span class="keywordflow">while</span> (motlu!=accolade_fermee)
<a name="l00733"></a>00733                   {
<a name="l00734"></a>00734                     is &gt;&gt; <a class="code" href="Source__Generique__Face__PolyMAC_8cpp.html#a7d7b5d77a3caa1af70f5e1c9108de5a1">valeur</a>;
<a name="l00735"></a>00735 <span class="comment">// &quot;-option val&quot; ou &quot;-option&quot; ?</span>
<a name="l00736"></a>00736 <span class="comment">// adding a test to support negative value</span>
<a name="l00737"></a>00737                     <span class="keywordtype">bool</span> negative_value = is_number(valeur.getSuffix(<span class="stringliteral">&quot;-&quot;</span>).getString());
<a name="l00738"></a>00738                     <span class="keywordflow">if</span> ((valeur.debute_par(<span class="stringliteral">&quot;-&quot;</span>) &amp;&amp; !negative_value) || valeur==accolade_fermee)
<a name="l00739"></a>00739                       {
<a name="l00740"></a>00740                         add_option(motlu.suffix(<span class="stringliteral">&quot;-&quot;</span>), <span class="stringliteral">&quot;&quot;</span>);
<a name="l00741"></a>00741                         motlu = <a class="code" href="Source__Generique__Face__PolyMAC_8cpp.html#a7d7b5d77a3caa1af70f5e1c9108de5a1">valeur</a>;
<a name="l00742"></a>00742                       }
<a name="l00743"></a>00743                     <span class="keywordflow">else</span>
<a name="l00744"></a>00744                       {
<a name="l00745"></a>00745                         add_option(motlu.suffix(<span class="stringliteral">&quot;-&quot;</span>), <a class="code" href="Source__Generique__Face__PolyMAC_8cpp.html#a7d7b5d77a3caa1af70f5e1c9108de5a1">valeur</a>);
<a name="l00746"></a>00746                         is &gt;&gt; motlu;
<a name="l00747"></a>00747                       }
<a name="l00748"></a>00748                   }
<a name="l00749"></a>00749                 <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>()&gt;-1)
<a name="l00750"></a>00750                   <a class="code" href="classSolveurSys__base.html#a987e97740c779c1ab4192c3c1f1bbd5d">fixer_limpr</a>(1); <span class="comment">//!&lt; On imprime le residu si CLI Pour faciliter le debugage:</span>
<a name="l00751"></a>00751 <span class="comment"></span><span class="comment">//</span>
<a name="l00752"></a>00752                 <span class="keywordflow">if</span> (rang == 18) <span class="comment">//!&lt; Verbose</span>
<a name="l00753"></a>00753 <span class="comment"></span>                  {
<a name="l00754"></a>00754 
<a name="l00755"></a>00755                     add_option(<span class="stringliteral">&quot;ksp_view&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00756"></a>00756                     add_option(<span class="stringliteral">&quot;options_view&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00757"></a>00757                     add_option(<span class="stringliteral">&quot;options_left&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00758"></a>00758                   }
<a name="l00759"></a>00759                 <span class="keywordflow">break</span>;
<a name="l00760"></a>00760               }
<a name="l00761"></a>00761             <span class="keywordflow">case</span> 10:
<a name="l00762"></a>00762               {
<a name="l00763"></a>00763                 is &gt;&gt; motlu;
<a name="l00764"></a>00764 <span class="comment">// Si pas MUMPS on previent</span>
<a name="l00765"></a>00765                 <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>!=<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6a1cb49f862e7fcd552eed7f0145c86db1">mumps</a>)
<a name="l00766"></a>00766                   {
<a name="l00767"></a>00767                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Ordering keyword for a solver is limited to Cholesky only.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00768"></a>00768                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00769"></a>00769                   }
<a name="l00770"></a>00770                 <a class="code" href="classMotcles.html" title="Un tableau d&#39;objets de la classe Motcle.">Motcles</a> mumps_ordering(6);
<a name="l00771"></a>00771                 {
<a name="l00772"></a>00772 <span class="comment">// NB: Il y&#39;a d&#39;autres ordering (voir doc MUMPS)</span>
<a name="l00773"></a>00773                   mumps_ordering[0] = <span class="stringliteral">&quot;amd&quot;</span>;
<a name="l00774"></a>00774                   mumps_ordering[1] = <span class="stringliteral">&quot;pt-scotch&quot;</span>;
<a name="l00775"></a>00775                   mumps_ordering[2] = <span class="stringliteral">&quot;parmetis&quot;</span>;
<a name="l00776"></a>00776                   mumps_ordering[3] = <span class="stringliteral">&quot;scotch&quot;</span>;
<a name="l00777"></a>00777                   mumps_ordering[4] = <span class="stringliteral">&quot;pord&quot;</span>;
<a name="l00778"></a>00778                   mumps_ordering[5] = <span class="stringliteral">&quot;metis&quot;</span>;
<a name="l00779"></a>00779                 }
<a name="l00780"></a>00780                 <span class="keywordtype">int</span> rang_mumps=mumps_ordering.<a class="code" href="classMotcles.html#afecd68f73e904bc129022a236ff6ab15">search</a>(motlu);
<a name="l00781"></a>00781 <span class="comment">// MUMPS fait un choix automatique par defaut (selon type et taille de la matrice, et nombre de processeurs) mais a savoir que:</span>
<a name="l00782"></a>00782 <span class="comment">// Sur le cas Cx et PAR_Cx 4 cores, Scotch en sequentiel et PT-Scotch en parallele sont les meilleurs choix</span>
<a name="l00783"></a>00783 <span class="comment">// Sur les gros cas, parfois Metis plus rapide pour A=LU et Scotch pour x=A-1B...</span>
<a name="l00784"></a>00784                 <span class="keywordflow">if</span> (rang_mumps==-1)
<a name="l00785"></a>00785                   {
<a name="l00786"></a>00786                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; motlu &lt;&lt; <span class="stringliteral">&quot; : unrecognized ordering from those available for the MUMPS solver Cholesky:&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00787"></a>00787                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; mumps_ordering &lt;&lt; finl;
<a name="l00788"></a>00788                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00789"></a>00789                   }
<a name="l00790"></a>00790                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rang_mumps==1 || rang_mumps==2)
<a name="l00791"></a>00791                   {
<a name="l00792"></a>00792                     <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()==1)
<a name="l00793"></a>00793                       {
<a name="l00794"></a>00794                         <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You can&#39;t use the parallel ordering &quot;</span> &lt;&lt; motlu &lt;&lt; <span class="stringliteral">&quot; during a sequential calculation.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00795"></a>00795                         <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00796"></a>00796                       }
<a name="l00797"></a>00797                     add_option(<span class="stringliteral">&quot;mat_mumps_icntl_28&quot;</span>,<span class="stringliteral">&quot;2&quot;</span>);  <span class="comment">//!&lt; Parallel analysis</span>
<a name="l00798"></a>00798 <span class="comment"></span>                    add_option(<span class="stringliteral">&quot;mat_mumps_icntl_29&quot;</span>,(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)rang_mumps);        <span class="comment">//!&lt; Parallel ordering</span>
<a name="l00799"></a>00799 <span class="comment"></span>                  }
<a name="l00800"></a>00800                 <span class="keywordflow">else</span>
<a name="l00801"></a>00801                   {
<a name="l00802"></a>00802                     add_option(<span class="stringliteral">&quot;mat_mumps_icntl_28&quot;</span>,<span class="stringliteral">&quot;1&quot;</span>);  <span class="comment">//!&lt; Sequential analysis</span>
<a name="l00803"></a>00803 <span class="comment"></span>                    add_option(<span class="stringliteral">&quot;mat_mumps_icntl_7&quot;</span>,(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)rang_mumps); <span class="comment">//!&lt; Sequential ordering</span>
<a name="l00804"></a>00804 <span class="comment"></span>                  }
<a name="l00805"></a>00805                 <span class="keywordflow">break</span>;
<a name="l00806"></a>00806               }
<a name="l00807"></a>00807             <span class="keywordflow">case</span> 11:
<a name="l00808"></a>00808               {
<a name="l00809"></a>00809                 is &gt;&gt; petsc_decide_;
<a name="l00810"></a>00810                 different_partition_ = petsc_decide_; <span class="comment">//!&lt; If Petsc decides the matrix partition, the partition is often different than the TRUST partition</span>
<a name="l00811"></a>00811 <span class="comment"></span>                <span class="keywordflow">break</span>;
<a name="l00812"></a>00812               }
<a name="l00813"></a>00813             <span class="keywordflow">case</span> 12:
<a name="l00814"></a>00814               {
<a name="l00815"></a>00815                 mataij_=1;
<a name="l00816"></a>00816                 <span class="keywordflow">break</span>;
<a name="l00817"></a>00817               }
<a name="l00818"></a>00818             <span class="keywordflow">case</span> 13:
<a name="l00819"></a>00819               {
<a name="l00820"></a>00820                 is &gt;&gt; motlu;
<a name="l00821"></a>00821                 is &gt;&gt; petsc_nb_cpus_;
<a name="l00822"></a>00822                 different_partition_ = 1; <span class="comment">//!&lt; If user decides a different number of CPUs to solve PETSc matrix, the matrix partition will be different than the TRUST partition</span>
<a name="l00823"></a>00823 <span class="comment"></span>                <span class="keywordflow">if</span> (motlu==<span class="stringliteral">&quot;first&quot;</span>)
<a name="l00824"></a>00824                   petsc_cpus_selection_=1;
<a name="l00825"></a>00825                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (motlu==<span class="stringliteral">&quot;every&quot;</span>)
<a name="l00826"></a>00826                   petsc_cpus_selection_=2;
<a name="l00827"></a>00827                 <span class="keywordflow">else</span>
<a name="l00828"></a>00828                   {
<a name="l00829"></a>00829                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;We should read the option first or every after the keyword nb_cpus.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00830"></a>00830                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Or we read: &quot;</span> &lt;&lt; motlu &lt;&lt; finl;
<a name="l00831"></a>00831                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00832"></a>00832                   }
<a name="l00833"></a>00833                 <span class="keywordflow">if</span> (petsc_nb_cpus_&lt;1 || petsc_nb_cpus_&gt;<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>())
<a name="l00834"></a>00834                   {
<a name="l00835"></a>00835                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Incorrect number of CPUs selected for solving the PETSc matrix: &quot;</span> &lt;&lt; petsc_nb_cpus_ &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00836"></a>00836                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00837"></a>00837                   }
<a name="l00838"></a>00838                 <span class="keywordflow">break</span>;
<a name="l00839"></a>00839               }
<a name="l00840"></a>00840             <span class="keywordflow">case</span> 14:
<a name="l00841"></a>00841               {
<a name="l00842"></a>00842                 is &gt;&gt; divtol_; <span class="comment">//!&lt; See http://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/KSP/KSPSetTolerances.html</span>
<a name="l00843"></a>00843 <span class="comment"></span>                <span class="keywordflow">break</span>;
<a name="l00844"></a>00844               }
<a name="l00845"></a>00845             <span class="keywordflow">case</span> 17:
<a name="l00846"></a>00846               {
<a name="l00847"></a>00847                 KSPType type_ksp_method;
<a name="l00848"></a>00848                 KSPGetType(SolveurPetsc_, &amp;type_ksp_method);
<a name="l00849"></a>00849                 <span class="keywordflow">if</span> ((<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)type_ksp_method != <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>(<span class="stringliteral">&quot;gmres&quot;</span>) &amp;&amp; ((<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)type_ksp_method != <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>(<span class="stringliteral">&quot;fgmres&quot;</span>)))
<a name="l00850"></a>00850                   {
<a name="l00851"></a>00851                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;restart option is available only with [f]gmres methods&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00852"></a>00852                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00853"></a>00853                   }
<a name="l00854"></a>00854                 <span class="keywordtype">int</span> restart_gmres;
<a name="l00855"></a>00855                 is &gt;&gt; restart_gmres;
<a name="l00856"></a>00856                 KSPGMRESSetRestart(SolveurPetsc_,restart_gmres);
<a name="l00857"></a>00857                 <span class="keywordflow">break</span>;
<a name="l00858"></a>00858               }
<a name="l00859"></a>00859             <span class="keywordflow">case</span> 19:
<a name="l00860"></a>00860               {
<a name="l00861"></a>00861 <span class="comment">// Si pas MUMPS on previent</span>
<a name="l00862"></a>00862                 <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>!=<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6a1cb49f862e7fcd552eed7f0145c86db1">mumps</a>)
<a name="l00863"></a>00863                   {
<a name="l00864"></a>00864                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; les_parametres_solveur[rang] &lt;&lt; <span class="stringliteral">&quot; keyword for a solver is limited to &quot;</span> &lt;&lt; les_solveurs[14] &lt;&lt; <span class="stringliteral">&quot; only.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00865"></a>00865                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00866"></a>00866                   }
<a name="l00867"></a>00867                 <span class="keywordtype">double</span> dropping_parameter;
<a name="l00868"></a>00868                 is &gt;&gt; dropping_parameter;
<a name="l00869"></a>00869                 add_option(<span class="stringliteral">&quot;mat_mumps_cntl_7&quot;</span>,dropping_parameter);    <span class="comment">//!&lt; Dropping parameter</span>
<a name="l00870"></a>00870 <span class="comment"></span>                <span class="keywordflow">break</span>;
<a name="l00871"></a>00871               }
<a name="l00872"></a>00872             <span class="keywordflow">case</span> 20:
<a name="l00873"></a>00873               {
<a name="l00874"></a>00874                 <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>)
<a name="l00875"></a>00875                   {
<a name="l00876"></a>00876                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Definition of &quot;</span> &lt;&lt; les_parametres_solveur(les_parametres_solveur.<a class="code" href="classMotcles.html#afecd68f73e904bc129022a236ff6ab15">search</a>(motlu)) &lt;&lt; <span class="stringliteral">&quot; is useless for a direct method.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00877"></a>00877                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Suppress the keyword.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00878"></a>00878                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00879"></a>00879                   }
<a name="l00880"></a>00880                 is &gt;&gt; seuil_relatif_;
<a name="l00881"></a>00881                 convergence_with_seuil=1;
<a name="l00882"></a>00882                 <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l00883"></a>00883                   {
<a name="l00884"></a>00884                     amgx_option+=<span class="stringliteral">&quot;s:convergence=RELATIVE_INI_CORE\ns:tolerance=&quot;</span>;
<a name="l00885"></a>00885                     amgx_option+=<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>(seuil_relatif_,<span class="stringliteral">&quot;%e&quot;</span>)+<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00886"></a>00886                   }
<a name="l00887"></a>00887                 <span class="keywordflow">break</span>;
<a name="l00888"></a>00888               }
<a name="l00889"></a>00889             <span class="keywordflow">case</span> 22:
<a name="l00890"></a>00890               <span class="keywordtype">int</span> flag;
<a name="l00891"></a>00891               is &gt;&gt; flag;
<a name="l00892"></a>00892               <a class="code" href="classSolv__Petsc.html#a1d87d8f7f3be6d318bc343e11059cde2">ignore_new_nonzero_</a> = (bool)flag;
<a name="l00893"></a>00893               <span class="keywordflow">break</span>;
<a name="l00894"></a>00894             <span class="keywordflow">case</span> 23:
<a name="l00895"></a>00895               is &gt;&gt; flag;
<a name="l00896"></a>00896               <a class="code" href="classSolv__Petsc.html#a895816a337ad6bc6fcdfb82037e6a837">rebuild_matrix_</a> = (bool)flag;
<a name="l00897"></a>00897               <span class="keywordflow">break</span>;
<a name="l00898"></a>00898             <span class="keywordflow">case</span> 24:
<a name="l00899"></a>00899               is &gt;&gt; flag;
<a name="l00900"></a>00900               <a class="code" href="classSolv__Petsc.html#a45df7a11f976ea94cbb622ae8fcbd181">allow_realloc_</a> = (bool)flag;
<a name="l00901"></a>00901               <span class="keywordflow">break</span>;
<a name="l00902"></a>00902             <span class="keywordflow">case</span> 25:
<a name="l00903"></a>00903               is &gt;&gt; flag;
<a name="l00904"></a>00904               <a class="code" href="classSolv__Petsc.html#af13cee34da6194e79945d3a950ee2ed0">clean_matrix_</a> = (bool)flag;
<a name="l00905"></a>00905               <span class="keywordflow">break</span>;
<a name="l00906"></a>00906             <span class="keywordflow">default</span>:
<a name="l00907"></a>00907               {
<a name="l00908"></a>00908                 <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; motlu &lt;&lt; <span class="stringliteral">&quot; : unrecognized option from those available in the Petsc solver:&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00909"></a>00909                 <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; les_parametres_solveur &lt;&lt; finl;
<a name="l00910"></a>00910                 <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00911"></a>00911               }
<a name="l00912"></a>00912             }
<a name="l00913"></a>00913           is &gt;&gt; motlu;
<a name="l00914"></a>00914         }
<a name="l00915"></a>00915 <span class="comment">// Some checks</span>
<a name="l00916"></a>00916       <span class="keywordflow">if</span> (petsc_decide_ &amp;&amp; petsc_cpus_selection_)
<a name="l00917"></a>00917         {
<a name="l00918"></a>00918           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You can&#39;t use petsc_decide and nb_cpus option together.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00919"></a>00919           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00920"></a>00920         }
<a name="l00921"></a>00921 
<a name="l00922"></a>00922       <span class="keywordtype">int</span> pc_supported_on_gpu_by_petsc=0;
<a name="l00923"></a>00923       <span class="keywordtype">int</span> pc_supported_on_gpu_by_amgx=0;
<a name="l00924"></a>00924       <a class="code" href="classMotcles.html" title="Un tableau d&#39;objets de la classe Motcle.">Motcles</a> les_precond(12);
<a name="l00925"></a>00925       {
<a name="l00926"></a>00926         les_precond[0] = <span class="stringliteral">&quot;NULL&quot;</span>;               <span class="comment">//!&lt; Pas de preconditionnement</span>
<a name="l00927"></a>00927 <span class="comment"></span>        les_precond[1] = <span class="stringliteral">&quot;ILU&quot;</span>;                <span class="comment">//!&lt; Incomplete LU</span>
<a name="l00928"></a>00928 <span class="comment"></span>        les_precond[2] = <span class="stringliteral">&quot;SSOR&quot;</span>;               <span class="comment">//!&lt; Symetric Successive Over Relaxation</span>
<a name="l00929"></a>00929 <span class="comment"></span>        les_precond[3] = <span class="stringliteral">&quot;EISENSTAT&quot;</span>;          <span class="comment">//!&lt; Symetric Successive Over Relaxation avec Eiseinstat trick</span>
<a name="l00930"></a>00930 <span class="comment"></span>        les_precond[4] = <span class="stringliteral">&quot;SPAI&quot;</span>;               <span class="comment">//!&lt; Sparse Approximate Inverse</span>
<a name="l00931"></a>00931 <span class="comment"></span>        les_precond[5] = <span class="stringliteral">&quot;PILUT&quot;</span>;              <span class="comment">//!&lt; Dual-threshold incomplete LU factorisation</span>
<a name="l00932"></a>00932 <span class="comment"></span>        les_precond[6] = <span class="stringliteral">&quot;DIAG&quot;</span>;               <span class="comment">//!&lt; Diagonal precondtioner</span>
<a name="l00933"></a>00933 <span class="comment"></span>        les_precond[7] = <span class="stringliteral">&quot;BOOMERAMG&quot;</span>;          <span class="comment">//!&lt; Multigrid preconditioner</span>
<a name="l00934"></a>00934 <span class="comment"></span>        les_precond[8] = <span class="stringliteral">&quot;BLOCK_JACOBI_ICC&quot;</span>;   <span class="comment">//!&lt; Block Jacobi ICC preconditioner (code dans PETSc, optimise)</span>
<a name="l00935"></a>00935 <span class="comment"></span>        les_precond[9] = <span class="stringliteral">&quot;BLOCK_JACOBI_ILU&quot;</span>;   <span class="comment">//!&lt; Block Jacobi ILU preconditioner (code dans PETSc, optimise)</span>
<a name="l00936"></a>00936 <span class="comment"></span>        les_precond[10] = <span class="stringliteral">&quot;C-AMG&quot;</span>;    <span class="comment">//!&lt; Classical AMG</span>
<a name="l00937"></a>00937 <span class="comment"></span>        les_precond[11] = <span class="stringliteral">&quot;SA-AMG&quot;</span>;   <span class="comment">//!&lt; Aggregated AMG</span>
<a name="l00938"></a>00938 <span class="comment"></span>      }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940       <span class="keywordflow">if</span> (pc!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00941"></a>00941         {
<a name="l00942"></a>00942 <span class="comment">// On empeche le choix d&#39;un preconditionneur avec une methode directe</span>
<a name="l00943"></a>00943 <span class="comment">// puisque celle ci EST le preconditionneur KSPREONLY</span>
<a name="l00944"></a>00944           <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>)
<a name="l00945"></a>00945             {
<a name="l00946"></a>00946               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Using precond keyword with a direct method like Cholesky is useless&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00947"></a>00947               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;because for PETSc the LU factorization is used as a preconditioner.&quot;</span> &lt;&lt; finl;
<a name="l00948"></a>00948               <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l00949"></a>00949             }
<a name="l00950"></a>00950 <span class="comment">// Option du preconditionneur</span>
<a name="l00951"></a>00951           rang = les_precond.<a class="code" href="classMotcles.html#afecd68f73e904bc129022a236ff6ab15">search</a>(pc);
<a name="l00952"></a>00952           <span class="keywordflow">switch</span>(rang)
<a name="l00953"></a>00953             {
<a name="l00954"></a>00954             <span class="keywordflow">case</span> 0:
<a name="l00955"></a>00955               {
<a name="l00956"></a>00956                 PCSetType(PreconditionneurPetsc_, PCNONE);
<a name="l00957"></a>00957                 pc_supported_on_gpu_by_petsc=1;
<a name="l00958"></a>00958                 solver_supported_on_gpu_by_amgx=1;
<a name="l00959"></a>00959                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(omega);
<a name="l00960"></a>00960                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(level);
<a name="l00961"></a>00961                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(epsilon);
<a name="l00962"></a>00962                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(ordering);
<a name="l00963"></a>00963                 <span class="keywordflow">break</span>;
<a name="l00964"></a>00964               }
<a name="l00965"></a>00965             <span class="keywordflow">case</span> 1:
<a name="l00966"></a>00966               {
<a name="l00967"></a>00967 <span class="comment">// Cout &lt;&lt; &quot;See http://www.ncsa.uiuc.edu/UserInfo/Resources/Software/Math/HYPRE/docs-1.6.0/HYPRE_usr_manual/node33.html&quot; &lt;&lt; finl;</span>
<a name="l00968"></a>00968 <span class="comment">// Cout &lt;&lt; &quot;to have some advices on the incomplete LU factorisation level: ILU(level)&quot; &lt;&lt; finl;</span>
<a name="l00969"></a>00969 <span class="comment">// On n&#39;attaque pas le ILU de Petsc qui n&#39;est pas parallele</span>
<a name="l00970"></a>00970 <span class="comment">// On prend celui de Hypre (Euclid=PILU(k)) en passant par les commandes en ligne</span>
<a name="l00971"></a>00971 <span class="comment">// car peu de parametres peuvent etre fixes sinon</span>
<a name="l00972"></a>00972 <span class="comment">// PCSetType(PreconditionneurPetsc_, PCHYPRE);</span>
<a name="l00973"></a>00973 <span class="comment">// PCHYPRESetType(PreconditionneurPetsc_, &quot;euclid&quot;);</span>
<a name="l00974"></a>00974 <span class="comment">// add_option(&quot;pc_hypre_euclid_levels&quot;,(Nom)level.value());</span>
<a name="l00975"></a>00975 <span class="comment">// check_not_defined(omega);</span>
<a name="l00976"></a>00976 <span class="comment">// check_not_defined(epsilon);</span>
<a name="l00977"></a>00977 <span class="comment">// check_not_defined(ordering);</span>
<a name="l00978"></a>00978 <span class="comment">// </span>
<a name="l00979"></a>00979 <span class="comment">// CHANGES in the PETSc 3.6 version: Removed -pc_hypre_type euclid due to bit-rot</span>
<a name="l00980"></a>00980                 pc_supported_on_gpu_by_amgx=1;
<a name="l00981"></a>00981                 <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l00982"></a>00982                   {
<a name="l00983"></a>00983                     amgx_option+=<span class="stringliteral">&quot;s:preconditioner(p)=MULTICOLOR_DILU\n&quot;</span>;
<a name="l00984"></a>00984                   }
<a name="l00985"></a>00985                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a5f603c229087d42c8bb2fee48290526f" title="Utilisation des solveurs GPU de PETSc.">gpu_</a>)
<a name="l00986"></a>00986                   {
<a name="l00987"></a>00987                     add_option(<span class="stringliteral">&quot;pc_type&quot;</span>,<span class="stringliteral">&quot;ilu&quot;</span>);
<a name="l00988"></a>00988                     add_option(<span class="stringliteral">&quot;pc_factor_mat_solver_type&quot;</span>,<span class="stringliteral">&quot;cusparse&quot;</span>);
<a name="l00989"></a>00989                     add_option(<span class="stringliteral">&quot;pc_factor_levels&quot;</span>,(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)level.<a class="code" href="classoption__int.html#a3f9d1b5b2aa020c5db15e82bd3e829e2">value</a>());
<a name="l00990"></a>00990                   }
<a name="l00991"></a>00991                 <span class="keywordflow">else</span>
<a name="l00992"></a>00992                   {
<a name="l00993"></a>00993                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error: CHANGES in the PETSc 3.6 version: Removed -pc_hypre_type euclid due to bit-rot.&quot;</span>
<a name="l00994"></a>00994                          &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l00995"></a>00995                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;So the ILU { level k } preconditioner no longer available. &quot;</span> &lt;&lt; finl;
<a name="l00996"></a>00996                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Change your data file.&quot;</span> &lt;&lt; finl;
<a name="l00997"></a>00997                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l00998"></a>00998                   }
<a name="l00999"></a>00999                 <span class="keywordflow">break</span>;
<a name="l01000"></a>01000               }
<a name="l01001"></a>01001             <span class="keywordflow">case</span> 2:
<a name="l01002"></a>01002               {
<a name="l01003"></a>01003                 PCSetType(PreconditionneurPetsc_, PCSOR);
<a name="l01004"></a>01004                 <span class="keywordflow">if</span> (omega.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>()&gt;=1. &amp;&amp; omega.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>()&lt;=2.)
<a name="l01005"></a>01005                   {
<a name="l01006"></a>01006                     PCSORSetOmega(PreconditionneurPetsc_, omega.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>());
<a name="l01007"></a>01007                   }
<a name="l01008"></a>01008                 <span class="keywordflow">else</span>
<a name="l01009"></a>01009                   {
<a name="l01010"></a>01010                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;omega value for SSOR should be between 1 and 2&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01011"></a>01011                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l01012"></a>01012                   }
<a name="l01013"></a>01013                 pc_supported_on_gpu_by_amgx=1;
<a name="l01014"></a>01014                 <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l01015"></a>01015                   {
<a name="l01016"></a>01016                     amgx_option+=<span class="stringliteral">&quot;s:preconditioner(p)=GS\n&quot;</span>; <span class="comment">//!&lt; Dans AMGX, c&#39;est un Gauss Seidel... MULTICOLOR_GS lent</span>
<a name="l01017"></a>01017 <span class="comment"></span>                    <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> relaxation_factor=<span class="stringliteral">&quot;p:relaxation_factor=&quot;</span>; <span class="comment">//!&lt; Defaut 0.9</span>
<a name="l01018"></a>01018 <span class="comment"></span>                    relaxation_factor+=<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>(omega.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>()-1); <span class="comment">//!&lt; Astuce moyenne... ToDo faire un GS ?</span>
<a name="l01019"></a>01019 <span class="comment"></span>                    amgx_option+=relaxation_factor+<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01020"></a>01020                     <span class="keywordflow">if</span> (matrice_symetrique_) amgx_option+=<span class="stringliteral">&quot;p:symmetric_GS=1\n&quot;</span>;
<a name="l01021"></a>01021                   }
<a name="l01022"></a>01022                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(level);
<a name="l01023"></a>01023                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(epsilon);
<a name="l01024"></a>01024                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(ordering);
<a name="l01025"></a>01025                 <span class="keywordflow">break</span>;
<a name="l01026"></a>01026               }
<a name="l01027"></a>01027             <span class="keywordflow">case</span> 3:
<a name="l01028"></a>01028               {
<a name="l01029"></a>01029                 PCSetType(PreconditionneurPetsc_, PCEISENSTAT);
<a name="l01030"></a>01030                 <span class="keywordflow">if</span> (omega.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>()&gt;=1. &amp;&amp; omega.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>()&lt;=2.)
<a name="l01031"></a>01031                   {
<a name="l01032"></a>01032                     PCEisenstatSetOmega(PreconditionneurPetsc_, omega.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>());
<a name="l01033"></a>01033                   }
<a name="l01034"></a>01034                 <span class="keywordflow">else</span>
<a name="l01035"></a>01035                   {
<a name="l01036"></a>01036                     <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;omega value for EISENSTAT should be between 1 and 2&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01037"></a>01037                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l01038"></a>01038                   }
<a name="l01039"></a>01039                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(level);
<a name="l01040"></a>01040                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(epsilon);
<a name="l01041"></a>01041                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(ordering);
<a name="l01042"></a>01042                 <span class="keywordflow">break</span>;
<a name="l01043"></a>01043               }
<a name="l01044"></a>01044             <span class="keywordflow">case</span> 4:
<a name="l01045"></a>01045               {
<a name="l01046"></a>01046                 PCSetType(PreconditionneurPetsc_, PCHYPRE);
<a name="l01047"></a>01047                 PCHYPRESetType(PreconditionneurPetsc_, <span class="stringliteral">&quot;parasails&quot;</span>);
<a name="l01048"></a>01048                 add_option(<span class="stringliteral">&quot;pc_hypre_parasails_nlevels&quot;</span>,(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)level.<a class="code" href="classoption__int.html#a3f9d1b5b2aa020c5db15e82bd3e829e2">value</a>());     <span class="comment">//!&lt; Higher values of level [&gt;=0] leads to more accurate, but more expensive preconditioners (default 1)</span>
<a name="l01049"></a>01049 <span class="comment"></span>                add_option(<span class="stringliteral">&quot;pc_hypre_parasails_thresh&quot;</span>,(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)epsilon.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>());   <span class="comment">//!&lt; Lower values of eps [0-1] leads to more accurate, but more expensive preconditioners (default 0.1)</span>
<a name="l01050"></a>01050 <span class="comment"></span>                add_option(<span class="stringliteral">&quot;pc_hypre_parasails_sym&quot;</span>,<span class="stringliteral">&quot;SPD&quot;</span>); <span class="comment">//!&lt; Matrice symetrique definie positive</span>
<a name="l01051"></a>01051 <span class="comment"></span>                <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(omega);
<a name="l01052"></a>01052                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(ordering);
<a name="l01053"></a>01053                 <span class="keywordflow">break</span>;
<a name="l01054"></a>01054               }
<a name="l01055"></a>01055             <span class="keywordflow">case</span> 5:
<a name="l01056"></a>01056               {
<a name="l01057"></a>01057                 PCSetType(PreconditionneurPetsc_, PCHYPRE);
<a name="l01058"></a>01058                 PCHYPRESetType(PreconditionneurPetsc_, <span class="stringliteral">&quot;pilut&quot;</span>);
<a name="l01059"></a>01059                 add_option(<span class="stringliteral">&quot;pc_hypre_pilut_factorrowsize&quot;</span>,(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)level.<a class="code" href="classoption__int.html#a3f9d1b5b2aa020c5db15e82bd3e829e2">value</a>());        <span class="comment">//!&lt; Maximum nonzeros retained in each row of L and U (default 20)</span>
<a name="l01060"></a>01060 <span class="comment"></span>                add_option(<span class="stringliteral">&quot;pc_hypre_pilut_tol&quot;</span>,(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)epsilon.<a class="code" href="classoption__double.html#a3e595172f5d65c3c381fa1bae24d8e32">value</a>());                <span class="comment">//!&lt; Values below the value are dropped in L and U (default 1.e-7)</span>
<a name="l01061"></a>01061 <span class="comment"></span>                <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(omega);
<a name="l01062"></a>01062                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(ordering);
<a name="l01063"></a>01063 <span class="comment">// </span>
<a name="l01064"></a>01064 <span class="comment">// ERROR VALGRIND</span>
<a name="l01065"></a>01065 <span class="comment">// Cerr &lt;&lt; &quot;Error VALGRIND with PETSc Dual Threashold Incomplete LU factorization.&quot; &lt;&lt; finl;</span>
<a name="l01066"></a>01066 <span class="comment">// Cerr &lt;&lt; &quot;So the PILUT { level k epsilon thresh } preconditioner no longer available. &quot; &lt;&lt; finl;</span>
<a name="l01067"></a>01067 <span class="comment">// Cerr &lt;&lt; &quot;Change your data file.&quot; &lt;&lt; finl;</span>
<a name="l01068"></a>01068 <span class="comment">// Process::exit();</span>
<a name="l01069"></a>01069                 <span class="keywordflow">break</span>;
<a name="l01070"></a>01070               }
<a name="l01071"></a>01071             <span class="keywordflow">case</span> 6:
<a name="l01072"></a>01072               {
<a name="l01073"></a>01073                 PCSetType(PreconditionneurPetsc_, PCJACOBI);
<a name="l01074"></a>01074                 pc_supported_on_gpu_by_petsc=1;
<a name="l01075"></a>01075                 pc_supported_on_gpu_by_amgx=1;
<a name="l01076"></a>01076                 <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l01077"></a>01077                   {
<a name="l01078"></a>01078                     amgx_option += <span class="stringliteral">&quot;s:preconditioner(p)=BLOCK_JACOBI\n&quot;</span>;
<a name="l01079"></a>01079                     <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>(<span class="stringliteral">&quot;Diagonal preconditioner on GPI with AmgX is slow to converge. Try SSOR preconditioner.&quot;</span>);
<a name="l01080"></a>01080                   }
<a name="l01081"></a>01081                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(omega);
<a name="l01082"></a>01082                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(level);
<a name="l01083"></a>01083                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(epsilon);
<a name="l01084"></a>01084                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(ordering);
<a name="l01085"></a>01085                 <span class="keywordflow">break</span>;
<a name="l01086"></a>01086               }
<a name="l01087"></a>01087             <span class="keywordflow">case</span> 9: <span class="comment">//!&lt; ilu</span>
<a name="l01088"></a>01088 <span class="comment"></span>            <span class="keywordflow">case</span> 8: <span class="comment">//!&lt; icc</span>
<a name="l01089"></a>01089 <span class="comment"></span>              {
<a name="l01090"></a>01090                 <span class="keywordflow">if</span> (rang==9) preconditionnement_non_symetrique_ = 1;
<a name="l01091"></a>01091                 pc_supported_on_gpu_by_amgx=1;
<a name="l01092"></a>01092                 pc_supported_on_gpu_by_petsc=1;
<a name="l01093"></a>01093                 <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l01094"></a>01094                   amgx_option+=<span class="stringliteral">&quot;s:preconditioner(p)=MULTICOLOR_DILU\n&quot;</span>; <span class="comment">//!&lt; MULTICOLOR_ILU plante...</span>
<a name="l01095"></a>01095 <span class="comment"></span>                <span class="keywordflow">else</span>
<a name="l01096"></a>01096                   {
<a name="l01097"></a>01097                     add_option(<span class="stringliteral">&quot;sub_pc_type&quot;</span>,rang==8 ? <span class="stringliteral">&quot;icc&quot;</span> : <span class="stringliteral">&quot;ilu&quot;</span>);
<a name="l01098"></a>01098                     add_option(<span class="stringliteral">&quot;sub_pc_factor_levels&quot;</span>,(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)level.<a class="code" href="classoption__int.html#a3f9d1b5b2aa020c5db15e82bd3e829e2">value</a>());
<a name="l01099"></a>01099 <span class="comment">// On fixe le precondtionnement non symetrique pour appliquer eventuellement un ordering autre que celui par defaut (natural)</span>
<a name="l01100"></a>01100 <span class="comment">// Un ordering rcm peut ameliorer par exemple la convergence</span>
<a name="l01101"></a>01101 <span class="comment">// Voir le remplissage de la matrice avec -mat_view_draw -draw_pause -1</span>
<a name="l01102"></a>01102                     <span class="keywordflow">if</span> (ordering.<a class="code" href="classoption__string.html#ac0fa274649cf7c52c0def6c9095a30ce">value</a>()!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l01103"></a>01103                       {
<a name="l01104"></a>01104                         add_option(<span class="stringliteral">&quot;sub_pc_factor_mat_ordering_type&quot;</span>,ordering.<a class="code" href="classoption__string.html#ac0fa274649cf7c52c0def6c9095a30ce">value</a>());
<a name="l01105"></a>01105 <span class="comment">// Le preconditionnement natural (defaut) ne necessite pas une matrice de preconditionnement symetrique, les autres si:</span>
<a name="l01106"></a>01106                         preconditionnement_non_symetrique_=1;
<a name="l01107"></a>01107                       }
<a name="l01108"></a>01108 
<a name="l01109"></a>01109                   }
<a name="l01110"></a>01110                 PCSetType(PreconditionneurPetsc_, PCBJACOBI);
<a name="l01111"></a>01111                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(omega);
<a name="l01112"></a>01112                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(epsilon);
<a name="l01113"></a>01113                 <span class="keywordflow">break</span>;
<a name="l01114"></a>01114               }
<a name="l01115"></a>01115             <span class="keywordflow">case</span> 7:
<a name="l01116"></a>01116               {
<a name="l01117"></a>01117                 PCSetType(PreconditionneurPetsc_, PCHYPRE);
<a name="l01118"></a>01118                 PCHYPRESetType(PreconditionneurPetsc_, <span class="stringliteral">&quot;boomeramg&quot;</span>); <span class="comment">//!&lt; Classical C-AMG Changement pc_hypre_boomeramg_relax_type_all pour PETSc 3.10, la matrice de preconditionnement etant seqaij, symetric-SOR/jacobi (defaut) provoque KSP_DIVERGED_INDEFINITE_PC Voir: https://lists.mcs.anl.gov/mailman/htdig/petsc-users/2012-December/015922.html</span>
<a name="l01119"></a>01119 <span class="comment"></span><span class="comment">//</span>
<a name="l01120"></a>01120 <span class="comment">//</span>
<a name="l01121"></a>01121 <span class="comment">//</span>
<a name="l01122"></a>01122                 add_option(<span class="stringliteral">&quot;pc_hypre_boomeramg_relax_type_all&quot;</span>, <span class="stringliteral">&quot;Jacobi&quot;</span>);
<a name="l01123"></a>01123 <span class="comment">// Voir https://mooseframework.inl.gov/application_development/hypre.html</span>
<a name="l01124"></a>01124                 <span class="keywordflow">if</span> (<a class="code" href="classObjet__U.html#a3e23491c01f2f39245fb6f3b6d6d9b17">dimension</a>==3) <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Warning, on massive parallel calculation for best performance, consider playing with -pc_hypre_boomeramg_strong_threshold 0.7 or 0.8 or 0.9&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01125"></a>01125                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(omega);
<a name="l01126"></a>01126                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(level);
<a name="l01127"></a>01127                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(epsilon);
<a name="l01128"></a>01128                 <a class="code" href="Solv__Petsc_8cpp.html#a7316e7bc8604a4493102b9edb122675d">check_not_defined</a>(ordering);
<a name="l01129"></a>01129                 <span class="comment">/*</span>
<a name="l01130"></a>01130 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_max_iter&quot;,&quot;1&quot;);</span>
<a name="l01131"></a>01131 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_strong_threshold&quot;,&quot;0.7&quot;);</span>
<a name="l01132"></a>01132 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_grid_sweeps_up&quot;,&quot;1&quot;);</span>
<a name="l01133"></a>01133 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_grid_sweeps_down&quot;,&quot;1&quot;);</span>
<a name="l01134"></a>01134 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_agg_nl&quot;,&quot;2&quot;);</span>
<a name="l01135"></a>01135 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_agg_num_paths&quot;,&quot;1&quot;);</span>
<a name="l01136"></a>01136 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_max_levels&quot;,&quot;25&quot;);</span>
<a name="l01137"></a>01137 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_coarsen_type&quot;,&quot;HMIS&quot;);</span>
<a name="l01138"></a>01138 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_interp_type&quot;,&quot;ext+i&quot;);</span>
<a name="l01139"></a>01139 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_P_max&quot;,&quot;2&quot;);</span>
<a name="l01140"></a>01140 <span class="comment">// Page 16: https://prace-ri.eu/wp-content/uploads/WP294-PETSc4FOAM-A-Library-to-plug-in-PETSc-into-the-OpenFOAM-Framework.pdf</span>
<a name="l01141"></a>01141 <span class="comment">                add_option(&quot;pc_hypre_boomeramg_truncfactor&quot;,&quot;0.2&quot;);*/</span>
<a name="l01142"></a>01142                 <span class="keywordflow">break</span>;
<a name="l01143"></a>01143               }
<a name="l01144"></a>01144             <span class="keywordflow">case</span> 10: <span class="comment">//!&lt; Classical AMG</span>
<a name="l01145"></a>01145 <span class="comment"></span>            <span class="keywordflow">case</span> 11: <span class="comment">//!&lt; Aggregated AMG</span>
<a name="l01146"></a>01146 <span class="comment"></span>              {
<a name="l01147"></a>01147                 pc_supported_on_gpu_by_amgx=1;
<a name="l01148"></a>01148                 pc_supported_on_gpu_by_petsc=1;
<a name="l01149"></a>01149                 preconditionnement_non_symetrique_ = 1;
<a name="l01150"></a>01150                 <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>)
<a name="l01151"></a>01151                   {
<a name="l01152"></a>01152                     amgx_option+=<span class="stringliteral">&quot;s:preconditioner(p)=AMG\n&quot;</span>;
<a name="l01153"></a>01153                     amgx_option+=<span class="stringliteral">&quot;s:use_scalar_norm=1\n&quot;</span>;
<a name="l01154"></a>01154                     amgx_option+=<span class="stringliteral">&quot;p:error_scaling=0\n&quot;</span>;
<a name="l01155"></a>01155                     amgx_option+=<span class="stringliteral">&quot;p:print_grid_stats=1\n&quot;</span>;
<a name="l01156"></a>01156                     amgx_option+=<span class="stringliteral">&quot;p:max_iters=1\n&quot;</span>;
<a name="l01157"></a>01157                     amgx_option+=<span class="stringliteral">&quot;p:cycle=V\n&quot;</span>;
<a name="l01158"></a>01158                     amgx_option+=<span class="stringliteral">&quot;p:min_coarse_rows=2\n&quot;</span>;
<a name="l01159"></a>01159                     amgx_option+=<span class="stringliteral">&quot;p:max_levels=100\n&quot;</span>;
<a name="l01160"></a>01160                     amgx_option+=<span class="stringliteral">&quot;p:smoother(smoother)=BLOCK_JACOBI\n&quot;</span>;
<a name="l01161"></a>01161                     amgx_option+=<span class="stringliteral">&quot;p:presweeps=1\n&quot;</span>;
<a name="l01162"></a>01162                     amgx_option+=<span class="stringliteral">&quot;p:postsweeps=1\n&quot;</span>;
<a name="l01163"></a>01163                     amgx_option+=<span class="stringliteral">&quot;p:coarsest_sweeps=1\n&quot;</span>;
<a name="l01164"></a>01164                     amgx_option+=<span class="stringliteral">&quot;p:coarse_solver=DENSE_LU_SOLVER\n&quot;</span>;
<a name="l01165"></a>01165                     amgx_option+=<span class="stringliteral">&quot;p:dense_lu_num_rows=2\n&quot;</span>;
<a name="l01166"></a>01166                     <span class="keywordflow">if</span> (rang==10) <span class="comment">//!&lt; C-AMG</span>
<a name="l01167"></a>01167 <span class="comment"></span>                      {
<a name="l01168"></a>01168                         amgx_option+=<span class="stringliteral">&quot;p:algorithm=CLASSICAL\n&quot;</span>;
<a name="l01169"></a>01169                         amgx_option+=<span class="stringliteral">&quot;p:selector=HMIS\n&quot;</span>;
<a name="l01170"></a>01170                         amgx_option+=<span class="stringliteral">&quot;p:interpolator=D2\n&quot;</span>;
<a name="l01171"></a>01171                         amgx_option+=<span class="stringliteral">&quot;p:strength=AHAT\n&quot;</span>;
<a name="l01172"></a>01172                       }
<a name="l01173"></a>01173                     <span class="keywordflow">else</span> <span class="comment">//!&lt; SA-AMG</span>
<a name="l01174"></a>01174 <span class="comment"></span>                      {
<a name="l01175"></a>01175                         amgx_option+=<span class="stringliteral">&quot;p:algorithm=AGGREGATION\n&quot;</span>;
<a name="l01176"></a>01176                         amgx_option+=<span class="stringliteral">&quot;p:selector=SIZE_2\n&quot;</span>;
<a name="l01177"></a>01177                         amgx_option+=<span class="stringliteral">&quot;p:max_matching_iterations=100000\n&quot;</span>;
<a name="l01178"></a>01178                         amgx_option+=<span class="stringliteral">&quot;p:max_unassigned_percentage=0.0\n&quot;</span>;
<a name="l01179"></a>01179                       }
<a name="l01180"></a>01180                     amgx_option+=<span class="stringliteral">&quot;smoother:relaxation_factor=0.8\n&quot;</span>;
<a name="l01181"></a>01181                   }
<a name="l01182"></a>01182                 <span class="keywordflow">else</span>
<a name="l01183"></a>01183                   {
<a name="l01184"></a>01184 <span class="comment">// ToDo : trouver des parametres pour PETSc afin d&#39;avoir une comparaison possible CPU vs GPU (meme its par exemple):</span>
<a name="l01185"></a>01185                     add_option(<span class="stringliteral">&quot;pc_type&quot;</span>,<span class="stringliteral">&quot;gamg&quot;</span>);
<a name="l01186"></a>01186                     <span class="keywordflow">if</span> (rang==10) <span class="comment">//!&lt; C-AMG</span>
<a name="l01187"></a>01187 <span class="comment"></span>                      {
<a name="l01188"></a>01188                         add_option(<span class="stringliteral">&quot;pc_gamg_type&quot;</span>,<span class="stringliteral">&quot;classical&quot;</span>);
<a name="l01189"></a>01189                       }
<a name="l01190"></a>01190                     <span class="keywordflow">else</span> <span class="comment">//!&lt; SA-AMG</span>
<a name="l01191"></a>01191 <span class="comment"></span>                      {
<a name="l01192"></a>01192                         add_option(<span class="stringliteral">&quot;pc_gamg_type&quot;</span>,<span class="stringliteral">&quot;agg&quot;</span>);
<a name="l01193"></a>01193                         add_option(<span class="stringliteral">&quot;pc_gamg_agg_nsmooths&quot;</span>,<span class="stringliteral">&quot;0&quot;</span>);
<a name="l01194"></a>01194 <span class="comment">// add_option(&quot;pc_gamg_agg_nsmooths&quot;,&quot;1&quot;); //Crash</span>
<a name="l01195"></a>01195                       }
<a name="l01196"></a>01196                   }
<a name="l01197"></a>01197                 <span class="keywordflow">break</span>;
<a name="l01198"></a>01198               }
<a name="l01199"></a>01199             <span class="keywordflow">default</span>:
<a name="l01200"></a>01200               {
<a name="l01201"></a>01201                 <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; pc &lt;&lt; <span class="stringliteral">&quot; : preconditioner not officially recognized by TRUST among those possible for the moment:&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01202"></a>01202                 <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; les_precond &lt;&lt; finl;
<a name="l01203"></a>01203                 <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You can try to access directly to Petsc preconditioners with the command line.&quot;</span> &lt;&lt; finl;
<a name="l01204"></a>01204                 <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;See the reference manual of Petsc to do this.&quot;</span> &lt;&lt; finl;
<a name="l01205"></a>01205                 <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l01206"></a>01206               }
<a name="l01207"></a>01207             }
<a name="l01208"></a>01208         }
<a name="l01209"></a>01209       <span class="keywordflow">else</span>
<a name="l01210"></a>01210         {
<a name="l01211"></a>01211           <span class="keywordflow">if</span> (!<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>)
<a name="l01212"></a>01212             {
<a name="l01213"></a>01213               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You forgot to define a preconditioner with the keyword precond.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01214"></a>01214               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;If you don&#39;t want a preconditioner, add for the solver definition:&quot;</span> &lt;&lt; finl;
<a name="l01215"></a>01215               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;precond null&quot;</span> &lt;&lt; finl;
<a name="l01216"></a>01216               <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l01217"></a>01217             }
<a name="l01218"></a>01218           <span class="keywordflow">else</span>
<a name="l01219"></a>01219             {
<a name="l01220"></a>01220 <span class="comment">// Pour un solveur direct le preconditionner EST le solveur:</span>
<a name="l01221"></a>01221               pc_supported_on_gpu_by_petsc = solver_supported_on_gpu_by_petsc;
<a name="l01222"></a>01222               pc_supported_on_gpu_by_amgx = solver_supported_on_gpu_by_amgx;
<a name="l01223"></a>01223             }
<a name="l01224"></a>01224         }
<a name="l01225"></a>01225 <span class="comment">// On verifie que les preconditionneurs sont supportes sur GPU:</span>
<a name="l01226"></a>01226       <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a5f603c229087d42c8bb2fee48290526f" title="Utilisation des solveurs GPU de PETSc.">gpu_</a> &amp;&amp; pc_supported_on_gpu_by_petsc==0)
<a name="l01227"></a>01227         {
<a name="l01228"></a>01228           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; les_precond[rang] &lt;&lt; <span class="stringliteral">&quot; is not supported yet by PETSc on GPU.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01229"></a>01229           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l01230"></a>01230         }
<a name="l01231"></a>01231       <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a> &amp;&amp; pc_supported_on_gpu_by_amgx==0)
<a name="l01232"></a>01232         {
<a name="l01233"></a>01233           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; les_precond[rang] &lt;&lt; <span class="stringliteral">&quot; is not supported yet by AmgX on GPU.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01234"></a>01234           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l01235"></a>01235         }
<a name="l01236"></a>01236     }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238 <span class="comment">// On fixe des parametres du solveur et du preconditionneur selon que l&#39;on ait un solveur direct ou iteratif</span>
<a name="l01239"></a>01239 <span class="comment">// KSPSetInitialGuessNonzero : Resout Ax=B en supposant x nul ou non</span>
<a name="l01240"></a>01240 <span class="comment">// KSPSetTolerances : Pour fixer les criteres de convergence du solveur iteratif</span>
<a name="l01241"></a>01241   <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>)
<a name="l01242"></a>01242     {
<a name="l01243"></a>01243       KSPSetInitialGuessNonzero(SolveurPetsc_, PETSC_FALSE);
<a name="l01244"></a>01244       PCSetType(PreconditionneurPetsc_, PCLU);
<a name="l01245"></a>01245     }
<a name="l01246"></a>01246   <span class="keywordflow">else</span>
<a name="l01247"></a>01247     {
<a name="l01248"></a>01248       KSPSetInitialGuessNonzero(SolveurPetsc_, PETSC_TRUE);
<a name="l01249"></a>01249       <span class="keywordflow">if</span> (convergence_with_nb_it_max_)
<a name="l01250"></a>01250         {
<a name="l01251"></a>01251           <span class="keywordflow">if</span> (convergence_with_seuil)
<a name="l01252"></a>01252             {
<a name="l01253"></a>01253               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You can only define solver convergence either by seuil or by nb_it_max.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01254"></a>01254               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;So suppress seuil keyword or nb_it_max keyword.&quot;</span> &lt;&lt; finl;
<a name="l01255"></a>01255               <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l01256"></a>01256             }
<a name="l01257"></a>01257 <span class="comment">// Convergence is defined with nb_it_max, the norm is checked after nb_it_max iterations:</span>
<a name="l01258"></a>01258           seuil_ = <a class="code" href="Double_8h.html#ae0ee0cebfad5968da0ad6cc7a49e16b6">DMAXFLOAT</a>;
<a name="l01259"></a>01259           add_option(<span class="stringliteral">&quot;ksp_check_norm_iteration&quot;</span>,(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)(nb_it_max_-1));
<a name="l01260"></a>01260           nb_it_max_ = <a class="code" href="Solv__Petsc_8h.html#a6781e64c30c60e9d2a75349c3546c14b">NB_IT_MAX_DEFINED</a>;
<a name="l01261"></a>01261         }
<a name="l01262"></a>01262 <span class="comment">// Convergence si residu(it) &lt; MAX (seuil_relatif_ * residu(0), seuil_);</span>
<a name="l01263"></a>01263       <span class="keywordflow">if</span> (seuil_==0 &amp;&amp; seuil_relatif_==0) seuil_=1.e-12; <span class="comment">//!&lt; Si aucun seuil defini, on prend un seuil absolu de 1.e-12 (comme avant)</span>
<a name="l01264"></a>01264 <span class="comment"></span>      KSPSetTolerances(SolveurPetsc_, seuil_relatif_, seuil_, (divtol_==0 ? PETSC_DEFAULT : divtol_), nb_it_max_);
<a name="l01265"></a>01265     }
<a name="l01266"></a>01266 <span class="comment">// Change le calcul du test de convergence relative (||Ax-b||/||Ax(0)-b|| au lieu de ||Ax-b||/||b||)</span>
<a name="l01267"></a>01267 <span class="comment">// Peu utilisee dans TRUST car on utilise la convergence sur la norme absolue</span>
<a name="l01268"></a>01268 <span class="comment">// Mais cela corrige une erreur KSP_DIVERGED_DTOL quand ||Ax-b||/||b||&gt;10000=div_tol par defaut dans PETSc (rencontree sur Etude REV_4)</span>
<a name="l01269"></a>01269 <span class="comment">// add_option(sys, &quot;ksp_converged_use_initial_residual_norm&quot;,1); // Before PETSc 3.5</span>
<a name="l01270"></a>01270   KSPConvergedDefaultSetUIRNorm(SolveurPetsc_); <span class="comment">//!&lt; After PETSc 3.5, a function is available</span>
<a name="l01271"></a>01271 <span class="comment"></span>
<a name="l01272"></a>01272 <span class="comment">// Surcharge eventuelle par la ligne de commande</span>
<a name="l01273"></a>01273   KSPSetOptionsPrefix(SolveurPetsc_, option_prefix_);
<a name="l01274"></a>01274   KSPSetFromOptions(SolveurPetsc_);
<a name="l01275"></a>01275   PCSetOptionsPrefix(PreconditionneurPetsc_, option_prefix_);
<a name="l01276"></a>01276   PCSetFromOptions(PreconditionneurPetsc_);
<a name="l01277"></a>01277 
<a name="l01278"></a>01278 <span class="comment">// Setting the names:</span>
<a name="l01279"></a>01279   KSPType type_ksp;
<a name="l01280"></a>01280   KSPGetType(SolveurPetsc_, &amp;type_ksp);
<a name="l01281"></a>01281   type_ksp_=(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)type_ksp;
<a name="l01282"></a>01282 
<a name="l01283"></a>01283   PCType type_pc;
<a name="l01284"></a>01284   PCGetType(PreconditionneurPetsc_, &amp;type_pc);
<a name="l01285"></a>01285   type_pc_=(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)type_pc;
<a name="l01286"></a>01286 
<a name="l01287"></a>01287 <span class="comment">// Creation du fichier de config .amgx (NB: les objets PETSc sont crees mais ne seront pas utilises)</span>
<a name="l01288"></a>01288   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a> &amp;&amp; <a class="code" href="classProcess.html#acd052b99706c577f8a5b6656217cf4c2" title="renvoie 1 si on est sur le processeur maitre du groupe courant (c&#39;est a dire me() == 0)...">Process::je_suis_maitre</a>())
<a name="l01289"></a>01289     {
<a name="l01290"></a>01290       <a class="code" href="classSFichier.html" title="Cette classe est a la classe C++ ofstream ce que la classe Sortie est a la classe C++ ostream Elle re...">SFichier</a> s(<a class="code" href="classSolv__Petsc.html#af626ce7ac5babfaf8333057766ac15cf" title="Nom du fichier de config eventuel.">config</a>());
<a name="l01291"></a>01291 <span class="comment">// Syntax: See https://github.com/NVIDIA/AMGX/raw/master/doc/AMGX_Reference.pdf</span>
<a name="l01292"></a>01292       s &lt;&lt; <span class="stringliteral">&quot;# AmgX config file&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a> &lt;&lt; <span class="stringliteral">&quot;config_version=2&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a> &lt;&lt; amgx_option;
<a name="l01293"></a>01293       <span class="keywordflow">if</span> (!amgx_option.contient(<span class="stringliteral">&quot;s:print_config&quot;</span>))     s &lt;&lt; <span class="stringliteral">&quot;s:print_config=1&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01294"></a>01294       <span class="keywordflow">if</span> (!amgx_option.contient(<span class="stringliteral">&quot;s:store_res_history&quot;</span>)) s &lt;&lt; <span class="stringliteral">&quot;s:store_res_history=1&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01295"></a>01295       <span class="keywordflow">if</span> (!amgx_option.contient(<span class="stringliteral">&quot;s:monitor_residual&quot;</span>))  s &lt;&lt; <span class="stringliteral">&quot;s:monitor_residual=1&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01296"></a>01296       <span class="keywordflow">if</span> (!amgx_option.contient(<span class="stringliteral">&quot;s:print_solve_stats&quot;</span>)) s &lt;&lt; <span class="stringliteral">&quot;s:print_solve_stats=1&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01297"></a>01297       <span class="keywordflow">if</span> (!amgx_option.contient(<span class="stringliteral">&quot;s:obtain_timings&quot;</span>))    s &lt;&lt; <span class="stringliteral">&quot;s:obtain_timings=1&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01298"></a>01298       <span class="keywordflow">if</span> (!amgx_option.contient(<span class="stringliteral">&quot;s:max_iters&quot;</span>))         s &lt;&lt; <span class="stringliteral">&quot;s:max_iters=10000&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>; <span class="comment">//!&lt; 100 par defaut trop bas...</span>
<a name="l01299"></a>01299 <span class="comment"></span>      s &lt;&lt; <span class="stringliteral">&quot;# determinism_flag=1&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>; <span class="comment">//!&lt; Plus lent de 15% mais resultat deterministique et repetable</span>
<a name="l01300"></a>01300 <span class="comment"></span>      s &lt;&lt; <span class="stringliteral">&quot;# communicator=MPI_DIRECT&quot;</span> &lt;&lt; finl; <span class="comment">//!&lt; MPI_CUDA aware</span>
<a name="l01301"></a>01301 <span class="comment"></span>      <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Writing the AmgX config file: &quot;</span> &lt;&lt; <a class="code" href="classSolv__Petsc.html#af626ce7ac5babfaf8333057766ac15cf" title="Nom du fichier de config eventuel.">config</a>() &lt;&lt; finl;
<a name="l01302"></a>01302     }
<a name="l01303"></a>01303 <span class="preprocessor">#else</span>
<a name="l01304"></a>01304 <span class="preprocessor"></span>  <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error, the code is not built with PETSc support.&quot;</span> &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01305"></a>01305   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Contact TRUST support.&quot;</span> &lt;&lt; finl;
<a name="l01306"></a>01306   <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l01307"></a>01307 <span class="preprocessor">#endif</span>
<a name="l01308"></a>01308 <span class="preprocessor"></span>
<a name="l01309"></a>01309 }
<a name="l01310"></a><a class="code" href="classSolv__Petsc.html#af626ce7ac5babfaf8333057766ac15cf">01310</a> <span class="keyword">const</span> <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> <a class="code" href="classSolv__Petsc.html#af626ce7ac5babfaf8333057766ac15cf" title="Nom du fichier de config eventuel.">Solv_Petsc::config</a>()
<a name="l01311"></a>01311 {
<a name="l01312"></a>01312   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> str(<a class="code" href="classObjet__U.html#a7c27c4f80259eeef76ff8fe2d3bc61f7" title="Renvoie une reference constante vers le nom du cas. Cette methode est statique.">Objet_U::nom_du_cas</a>());
<a name="l01313"></a>01313   str+=<span class="stringliteral">&quot;_solver&quot;</span>;
<a name="l01314"></a>01314   str+=(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)<a class="code" href="classSolv__Petsc.html#a7384c2681936b980c3fa393793e47e87" title="Nombre d&#39;instances en cours de la classe.">instance</a>;
<a name="l01315"></a>01315   str+=<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a> ? <span class="stringliteral">&quot;.amgx&quot;</span> : <span class="stringliteral">&quot;.petsc&quot;</span>;
<a name="l01316"></a>01316   <span class="keywordflow">return</span> str;
<a name="l01317"></a>01317 }
<a name="l01318"></a>01318 
<a name="l01319"></a>01319 <span class="keywordtype">int</span> <a class="code" href="classSolv__Petsc.html#a7384c2681936b980c3fa393793e47e87" title="Nombre d&#39;instances en cours de la classe.">Solv_Petsc::instance</a>=-1;
<a name="l01320"></a>01320 <span class="keywordtype">int</span> <a class="code" href="classSolv__Petsc.html#acc3475bd78fb4ceace2d10ff68de1dd8" title="Compte les solveurs crees et utilises pour le prefix des options.">Solv_Petsc::numero_solveur</a>=0;
<a name="l01321"></a>01321 <span class="preprocessor">#ifdef PETSCKSP_H</span>
<a name="l01322"></a>01322 <span class="preprocessor"></span>PetscLogStage Solv_Petsc::KSPSolve_Stage_=0;
<a name="l01323"></a>01323 
<a name="l01324"></a>01324 <span class="comment">// Sortie Maple d&#39;une matrice morse</span>
<a name="l01325"></a>01325 <span class="keywordtype">void</span> sortie_maple(<a class="code" href="classSortie.html" title="Classe de base des flux de sortie. Elle sait ecrire des types simples&lt;br&gt;(entiers, flottants) et des Ob...">Sortie</a>&amp; s, <span class="keyword">const</span> <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; M)
<a name="l01326"></a>01326 {
<a name="l01327"></a>01327   s.<a class="code" href="classSortie.html#a846ea173fd5e5b18fa2a0764f39724e3">precision</a>(30);
<a name="l01328"></a>01328   s&lt;&lt;<span class="stringliteral">&quot;B:=matrix([&quot;</span>;
<a name="l01329"></a>01329   <span class="keywordtype">int</span> M_nb_lignes=M.<a class="code" href="classMatrice__Morse.html#a1f9bd6aedb226c86b7299689fa5b821a">nb_lignes</a>();
<a name="l01330"></a>01330   <span class="keywordtype">int</span> M_nb_colonnes=M.<a class="code" href="classMatrice__Morse.html#a94caf9937bc5a110a7179cb3e9eaa9d9">nb_colonnes</a>();
<a name="l01331"></a>01331   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;M_nb_lignes; i++)
<a name="l01332"></a>01332     {
<a name="l01333"></a>01333       s&lt;&lt;<span class="stringliteral">&quot;[&quot;</span>;
<a name="l01334"></a>01334       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j=0 ; j&lt;M_nb_colonnes; j++ )
<a name="l01335"></a>01335         {
<a name="l01336"></a>01336           s&lt;&lt;M(i,j);
<a name="l01337"></a>01337           <span class="keywordflow">if</span> (j!=(M_nb_colonnes-1)) s&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>;
<a name="l01338"></a>01338         }
<a name="l01339"></a>01339       s&lt;&lt;<span class="stringliteral">&quot;]&quot;</span>;
<a name="l01340"></a>01340       <span class="keywordflow">if</span> (i!=(M_nb_lignes-1)) s&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>;
<a name="l01341"></a>01341     }
<a name="l01342"></a>01342   s&lt;&lt;<span class="stringliteral">&quot;]):&quot;</span>&lt;&lt;<a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01343"></a>01343 }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345 <span class="keywordtype">void</span> <a class="code" href="ILU_8cpp.html#af795a7defe79185059ecd10e52645585">Solv_Petsc::MorseSymToMorse</a>(<span class="keyword">const</span> <a class="code" href="classMatrice__Morse__Sym.html" title="Classe Matrice_Morse_Sym Represente une matrice M (creuse) symetrique stockee au format Morse Symetri...">Matrice_Morse_Sym</a>&amp; MS, <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; M)
<a name="l01346"></a>01346 {
<a name="l01347"></a>01347   M = MS;
<a name="l01348"></a>01348   <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a> mattmp(MS);
<a name="l01349"></a>01349   M.<a class="code" href="classMatrice__Morse.html#a9859a88c59daf0b968b3c5090e18f264" title="*this = a transposee.">transpose</a>(mattmp);
<a name="l01350"></a>01350   <span class="keywordtype">int</span> ordre = M.<a class="code" href="classMatrice__Morse.html#a24a51a119cc5068408773a983ce5f13a" title="Renvoie l&#39;ordre de la matrice: - le nombre de lignes si la matrice est carree - 0 sinon...">ordre</a>();
<a name="l01351"></a>01351   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ordre; i++)
<a name="l01352"></a>01352     <span class="keywordflow">if</span> (M.<a class="code" href="classMatrice__Morse.html#aebca6e5632d935408e1f81674209a86c">nb_vois</a>(i))
<a name="l01353"></a>01353       M(i, i) = 0.;
<a name="l01354"></a>01354   M = mattmp + M;
<a name="l01355"></a>01355 }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357 <span class="comment">// Save Matrix and RHS in a .petsc file:</span>
<a name="l01358"></a>01358 <span class="keywordtype">void</span> Solv_Petsc::SaveObjectsToFile()
<a name="l01359"></a>01359 {
<a name="l01360"></a>01360   MatInfo Info;
<a name="l01361"></a>01361   MatGetInfo(MatricePetsc_,MAT_GLOBAL_SUM,&amp;Info);
<a name="l01362"></a>01362   <span class="keywordtype">int</span> nnz = (int)Info.nz_allocated;
<a name="l01363"></a>01363 
<a name="l01364"></a>01364   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> filename(<span class="stringliteral">&quot;Matrix_&quot;</span>);
<a name="l01365"></a>01365   filename+=(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)nb_rows_tot_;
<a name="l01366"></a>01366   filename+=<span class="stringliteral">&quot;_rows_&quot;</span>;
<a name="l01367"></a>01367   filename+=(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">nproc</a>();
<a name="l01368"></a>01368   filename+=<span class="stringliteral">&quot;_cpus.petsc&quot;</span>;
<a name="l01369"></a>01369 
<a name="l01370"></a>01370   PetscViewer viewer;
<a name="l01371"></a>01371   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Writing the global PETSc matrix (&quot;</span> &lt;&lt; nb_rows_tot_&lt;&lt; <span class="stringliteral">&quot; rows and &quot;</span> &lt;&lt; nnz &lt;&lt; <span class="stringliteral">&quot; nnz) in the binary file &quot;</span> &lt;&lt; filename &lt;&lt; <a class="code" href="EntreeSortie_8h.html#a7f716d3c5b6411631d5d0700ead09467">finl</a>;
<a name="l01372"></a>01372 <span class="comment">// To go faster with MPI IO ?</span>
<a name="l01373"></a>01373 <span class="comment">// PetscViewerCreate(PETSC_COMM_WORLD,&amp;viewer);</span>
<a name="l01374"></a>01374 <span class="comment">// PetscViewerFileSetName(viewer,filename);</span>
<a name="l01375"></a>01375 <span class="comment">// PetscViewerBinarySetMPIIO(viewer);</span>
<a name="l01376"></a>01376 <span class="comment">// Save the matrix:</span>
<a name="l01377"></a>01377   PetscViewerBinaryOpen(PETSC_COMM_WORLD,filename,FILE_MODE_WRITE,&amp;viewer);
<a name="l01378"></a>01378   MatView(MatricePetsc_, viewer);
<a name="l01379"></a>01379   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Writing also the RHS in the file &quot;</span> &lt;&lt; filename &lt;&lt; finl;
<a name="l01380"></a>01380 <span class="comment">// Save also the RHS:</span>
<a name="l01381"></a>01381   VecView(SecondMembrePetsc_, viewer);
<a name="l01382"></a>01382   PetscViewerDestroy(&amp;viewer);
<a name="l01383"></a>01383 
<a name="l01384"></a>01384 <span class="comment">// ASCII output for small matrix(debugging)</span>
<a name="l01385"></a>01385   <span class="keywordflow">if</span> (nb_rows_tot_&lt;20)
<a name="l01386"></a>01386     {
<a name="l01387"></a>01387       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;The global PETSc matrix is small so we also print it:&quot;</span> &lt;&lt; finl;
<a name="l01388"></a>01388       MatView(MatricePetsc_, PETSC_VIEWER_STDOUT_WORLD);
<a name="l01389"></a>01389     }
<a name="l01390"></a>01390 }
<a name="l01391"></a>01391 
<a name="l01392"></a>01392 <span class="comment">// Read a PETSc matrix in a file and</span>
<a name="l01393"></a>01393 <span class="comment">// returns the local number of rows</span>
<a name="l01394"></a>01394 <span class="keywordtype">void</span> Solv_Petsc::RestoreMatrixFromFile()
<a name="l01395"></a>01395 {
<a name="l01396"></a>01396   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> filename(<span class="stringliteral">&quot;Matrix_&quot;</span>);
<a name="l01397"></a>01397   filename+=(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)nb_rows_tot_;
<a name="l01398"></a>01398   filename+=<span class="stringliteral">&quot;_rows_&quot;</span>;
<a name="l01399"></a>01399   filename+=(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">nproc</a>();
<a name="l01400"></a>01400   filename+=<span class="stringliteral">&quot;_cpus.petsc&quot;</span>;
<a name="l01401"></a>01401   add_option(<span class="stringliteral">&quot;viewer_binary_skip_info&quot;</span>,<span class="stringliteral">&quot;&quot;</span>); <span class="comment">//!&lt; Skip reading .info file to avoid -vecload_block_size unused option</span>
<a name="l01402"></a>01402 <span class="comment"></span>
<a name="l01403"></a>01403   PetscViewer viewer;
<a name="l01404"></a>01404   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Reading the global PETSc matrix in the binary file &quot;</span> &lt;&lt; filename &lt;&lt; finl;
<a name="l01405"></a>01405   PetscViewerBinaryOpen(PETSC_COMM_WORLD,filename,FILE_MODE_READ,&amp;viewer);
<a name="l01406"></a>01406   MatCreate(PETSC_COMM_WORLD,&amp;MatricePetsc_);
<a name="l01407"></a>01407   <span class="keywordflow">if</span> (petsc_decide_)
<a name="l01408"></a>01408     MatSetSizes(MatricePetsc_, PETSC_DECIDE, PETSC_DECIDE, nb_rows_tot_, nb_rows_tot_);
<a name="l01409"></a>01409   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (petsc_cpus_selection_)
<a name="l01410"></a>01410     {
<a name="l01411"></a>01411       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Reading a PETSc matrix with a different number of CPUs is not implemented yet.&quot;</span> &lt;&lt; finl;
<a name="l01412"></a>01412       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Contact TRUST support.&quot;</span> &lt;&lt; finl;
<a name="l01413"></a>01413       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l01414"></a>01414     }
<a name="l01415"></a>01415   <span class="keywordflow">else</span>
<a name="l01416"></a>01416     MatSetSizes(MatricePetsc_, nb_rows_, nb_rows_, PETSC_DECIDE, PETSC_DECIDE);
<a name="l01417"></a>01417   MatLoad(MatricePetsc_, viewer);
<a name="l01418"></a>01418   PetscViewerDestroy(&amp;viewer);
<a name="l01419"></a>01419   <span class="keywordflow">if</span> (!matrice_symetrique_)
<a name="l01420"></a>01420     {
<a name="l01421"></a>01421       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Reading a non symmetric PETSc matrix is not supported yet in TRUST.&quot;</span> &lt;&lt; finl;
<a name="l01422"></a>01422       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l01423"></a>01423     }
<a name="l01424"></a>01424 <span class="comment">// Conversion AIJ to SBAIJ:</span>
<a name="l01425"></a>01425   MatSetOption(MatricePetsc_, MAT_SYMMETRIC, PETSC_TRUE);
<a name="l01426"></a>01426   MatConvert(MatricePetsc_, MATSBAIJ, MAT_INPLACE_MATRIX, &amp;MatricePetsc_);
<a name="l01427"></a>01427   <span class="keywordtype">int</span> nb_rows_tot,nb_cols_tot;
<a name="l01428"></a>01428   MatGetSize(MatricePetsc_,&amp;nb_rows_tot,&amp;nb_cols_tot);
<a name="l01429"></a>01429   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;The matrix read has &quot;</span> &lt;&lt; nb_rows_tot &lt;&lt; <span class="stringliteral">&quot; rows.&quot;</span> &lt;&lt; finl;
<a name="l01430"></a>01430 }
<a name="l01431"></a>01431 
<a name="l01432"></a>01432 
<a name="l01433"></a>01433 <span class="comment">// Remplissage de chaine_lue_ Petsc ksp { ... }</span>
<a name="l01434"></a>01434 <span class="comment">// chaine_lue_=&quot;ksp { ... }&quot;</span>
<a name="l01435"></a>01435 <span class="keywordtype">void</span> Solv_Petsc::lecture(<a class="code" href="classEntree.html" title="Classe de definition des operateurs et methodes pour toute lecture dans un flot d&#39;entree (fichier...">Entree</a>&amp; is)
<a name="l01436"></a>01436 {
<a name="l01437"></a>01437 <span class="comment">// Lecture de la chaine de mot cles</span>
<a name="l01438"></a>01438   <a class="code" href="classMotcle.html" title="Une chaine de caractere (Nom) en majuscules.">Motcle</a> accolade_ouverte(<span class="stringliteral">&quot;{&quot;</span>);
<a name="l01439"></a>01439   <a class="code" href="classMotcle.html" title="Une chaine de caractere (Nom) en majuscules.">Motcle</a> accolade_fermee(<span class="stringliteral">&quot;}&quot;</span>);
<a name="l01440"></a>01440   <a class="code" href="classMotcle.html" title="Une chaine de caractere (Nom) en majuscules.">Motcle</a> motlu;
<a name="l01441"></a>01441   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> nomlu;
<a name="l01442"></a>01442   is &gt;&gt; motlu;
<a name="l01443"></a>01443   <a class="code" href="classSChaine.html" title="Cette classe derivee de Sortie empile ce qu&#39;on lui envoie dans une chaine de caracteres. On recupere le contenu de la chaine avec get_str().">SChaine</a> prov;
<a name="l01444"></a>01444   prov&lt;&lt;motlu;
<a name="l01445"></a>01445   is &gt;&gt; motlu;
<a name="l01446"></a>01446   <span class="keywordflow">if</span> (motlu != accolade_ouverte)
<a name="l01447"></a>01447     {
<a name="l01448"></a>01448       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error while reading parameters of Petsc: &quot;</span> &lt;&lt; finl;
<a name="l01449"></a>01449       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;We expected &quot;</span> &lt;&lt; accolade_ouverte &lt;&lt; <span class="stringliteral">&quot; instead of &quot;</span> &lt;&lt; motlu &lt;&lt; finl;
<a name="l01450"></a>01450       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l01451"></a>01451     }
<a name="l01452"></a>01452   prov&lt;&lt;<span class="stringliteral">&quot; { &quot;</span>;
<a name="l01453"></a>01453   <span class="keywordtype">int</span> nb_acco=1;
<a name="l01454"></a>01454   <span class="keywordflow">while</span> (nb_acco!=0)
<a name="l01455"></a>01455     {
<a name="l01456"></a>01456       is &gt;&gt; nomlu;
<a name="l01457"></a>01457       prov&lt;&lt;nomlu&lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l01458"></a>01458       <span class="keywordflow">if</span> (nomlu==accolade_ouverte)
<a name="l01459"></a>01459         nb_acco++;
<a name="l01460"></a>01460       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nomlu==accolade_fermee)
<a name="l01461"></a>01461         nb_acco--;
<a name="l01462"></a>01462     }
<a name="l01463"></a>01463   <a class="code" href="classSolv__Petsc.html#a7a8cc27d5092ae780209ddb0059a2e29" title="Chaine des mots cles lus.">chaine_lue_</a>=prov.<a class="code" href="classSChaine.html#a8ed820eca8d79e52fb50520d02637315" title="returns a copy of the string stored by the SChaine">get_str</a>();
<a name="l01464"></a>01464 }
<a name="l01465"></a>01465 
<a name="l01466"></a>01466 
<a name="l01467"></a>01467 <span class="comment">// SV</span>
<a name="l01468"></a>01468 <span class="comment">// Since PETSc 3.10 The option ksp_view is not taken into account for (at least) instance = 2</span>
<a name="l01469"></a>01469 <span class="comment">// I don&#39;t understand why ??!!</span>
<a name="l01470"></a>01470 <span class="comment">// So I introduce this fix : if the option ksp_view is in PETSc Options then we call the KSPView function</span>
<a name="l01471"></a>01471 <span class="keywordtype">bool</span> Solv_Petsc::enable_ksp_view( <span class="keywordtype">void</span> )
<a name="l01472"></a>01472 {
<a name="l01473"></a>01473   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> <a class="code" href="classoption.html">option</a>=<span class="stringliteral">&quot;-ksp_view&quot;</span>;
<a name="l01474"></a>01474   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> empty=<span class="stringliteral">&quot;                                                                                                 &quot;</span>;
<a name="l01475"></a>01475   <span class="keywordtype">char</span> *option_value = strdup( empty );
<a name="l01476"></a>01476   PetscBool enable; <span class="comment">//!&lt; enable this option ?</span>
<a name="l01477"></a>01477 <span class="comment"></span>  PetscOptionsGetString( PETSC_NULL, PETSC_NULL, option, option_value, empty.<a class="code" href="classNom.html#ae63e1d728a7586acac3935b15759eadc" title="Renvoie le nombre de caracteres de la chaine du Nom y compris le caractere zero de fin de chaine...">longueur</a>( ), &amp;enable );
<a name="l01478"></a>01478   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> actual_value( option_value );
<a name="l01479"></a>01479   free( option_value );
<a name="l01480"></a>01480   <span class="keywordflow">return</span> enable ;
<a name="l01481"></a>01481 }
<a name="l01482"></a>01482 
<a name="l01483"></a>01483 <span class="keywordtype">int</span> Solv_Petsc::add_option(<span class="keyword">const</span> <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>&amp; astring, <span class="keyword">const</span> <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>&amp; value, <span class="keywordtype">int</span> <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6a1ff272a9a5361e482e6748be5e449bbd">cli</a>)
<a name="l01484"></a>01484 {
<a name="l01485"></a>01485   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> option=<span class="stringliteral">&quot;-&quot;</span>;
<a name="l01486"></a>01486 <span class="comment">// Ajout du prefix si l&#39;option concerne KSP, PC, Mat ou Vec:</span>
<a name="l01487"></a>01487   <span class="keywordflow">if</span> (astring.<a class="code" href="classNom.html#a41b0ba18fb90d481c0828ed4372de8ee">debute_par</a>(<span class="stringliteral">&quot;ksp_&quot;</span>) ||
<a name="l01488"></a>01488       astring.<a class="code" href="classNom.html#a41b0ba18fb90d481c0828ed4372de8ee">debute_par</a>(<span class="stringliteral">&quot;sub_ksp_&quot;</span>) ||
<a name="l01489"></a>01489       astring.<a class="code" href="classNom.html#a41b0ba18fb90d481c0828ed4372de8ee">debute_par</a>(<span class="stringliteral">&quot;pc_&quot;</span>) ||
<a name="l01490"></a>01490       astring.<a class="code" href="classNom.html#a41b0ba18fb90d481c0828ed4372de8ee">debute_par</a>(<span class="stringliteral">&quot;sub_pc_&quot;</span>) ||
<a name="l01491"></a>01491       astring.<a class="code" href="classNom.html#a41b0ba18fb90d481c0828ed4372de8ee">debute_par</a>(<span class="stringliteral">&quot;mat_&quot;</span>) ||
<a name="l01492"></a>01492       astring.<a class="code" href="classNom.html#a41b0ba18fb90d481c0828ed4372de8ee">debute_par</a>(<span class="stringliteral">&quot;vec_&quot;</span>) || <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6a1ff272a9a5361e482e6748be5e449bbd">cli</a>)
<a name="l01493"></a>01493     option+=option_prefix_;
<a name="l01494"></a>01494 
<a name="l01495"></a>01495   option+=astring;
<a name="l01496"></a>01496 <span class="comment">// Attention il ne retourne pas de code d&#39;erreur si l&#39;option est mal orthographiee!!</span>
<a name="l01497"></a>01497 <span class="comment">// Il ne dit pas non plus qu&#39;elle est unused avec -options_left</span>
<a name="l01498"></a>01498 <span class="comment">// Nouveau 1.6.3 pour la ligne de commande reste prioritaire, on ne change une option</span>
<a name="l01499"></a>01499 <span class="comment">// que si elle n&#39;a pas deja ete specifiee...</span>
<a name="l01500"></a>01500   PetscBool flg;
<a name="l01501"></a>01501   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> vide=<span class="stringliteral">&quot;                                                                                                 &quot;</span>;
<a name="l01502"></a>01502   <span class="keywordtype">char</span>* tmp=strdup(vide);
<a name="l01503"></a>01503   PetscOptionsGetString(PETSC_NULL,PETSC_NULL,option,tmp,vide.<a class="code" href="classNom.html#ae63e1d728a7586acac3935b15759eadc" title="Renvoie le nombre de caracteres de la chaine du Nom y compris le caractere zero de fin de chaine...">longueur</a>(),&amp;flg);
<a name="l01504"></a>01504   <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> actual_value(tmp);
<a name="l01505"></a>01505   free(tmp);
<a name="l01506"></a>01506   <span class="keywordflow">if</span> (actual_value==vide)
<a name="l01507"></a>01507     {
<a name="l01508"></a>01508       <span class="keywordflow">if</span> (value==<span class="stringliteral">&quot;&quot;</span>)
<a name="l01509"></a>01509         {
<a name="l01510"></a>01510           PetscOptionsSetValue(PETSC_NULL, option, PETSC_NULL);
<a name="l01511"></a>01511           <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>() &gt;= 0) <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Option Petsc: &quot;</span> &lt;&lt; option &lt;&lt; finl;
<a name="l01512"></a>01512         }
<a name="l01513"></a>01513       <span class="keywordflow">else</span>
<a name="l01514"></a>01514         {
<a name="l01515"></a>01515           PetscOptionsSetValue(PETSC_NULL, option, value);
<a name="l01516"></a>01516           <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>() &gt;= 0) <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Option Petsc: &quot;</span> &lt;&lt; option &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; value &lt;&lt; finl;
<a name="l01517"></a>01517         }
<a name="l01518"></a>01518       <span class="keywordflow">return</span> 1;
<a name="l01519"></a>01519     }
<a name="l01520"></a>01520   <span class="keywordflow">else</span>
<a name="l01521"></a>01521     {
<a name="l01522"></a>01522       <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>() &gt;= 0) <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Option Petsc: &quot;</span> &lt;&lt; option &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; value &lt;&lt; <span class="stringliteral">&quot; not taken cause &quot;</span> &lt;&lt; option &lt;&lt; <span class="stringliteral">&quot; already defined to &quot;</span> &lt;&lt; actual_value &lt;&lt; finl;
<a name="l01523"></a>01523       <span class="keywordflow">return</span> 0;
<a name="l01524"></a>01524     }
<a name="l01525"></a>01525 }
<a name="l01526"></a>01526 
<a name="l01527"></a>01527 <span class="preprocessor">#ifndef PETSC_HAVE_HYPRE</span>
<a name="l01528"></a>01528 <span class="preprocessor"></span><span class="comment">// Pour que le code puisse compiler/tourner si on prend PETSc sans aucun autre package externe:</span>
<a name="l01529"></a>01529 <span class="keywordtype">int</span> PCHYPRESetType(PC,<span class="keyword">const</span> <span class="keywordtype">char</span>[])
<a name="l01530"></a>01530 {
<a name="l01531"></a>01531   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;HYPRE preconditioners are not available in this TRUST version.&quot;</span> &lt;&lt; finl;
<a name="l01532"></a>01532   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;May be, HYPRE library has been deactivated during the PETSc build process.&quot;</span> &lt;&lt; finl;
<a name="l01533"></a>01533   <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l01534"></a>01534   <span class="keywordflow">return</span> 0;
<a name="l01535"></a>01535 }
<a name="l01536"></a>01536 <span class="preprocessor">#endif</span>
<a name="l01537"></a>01537 <span class="preprocessor"></span>
<a name="l01538"></a>01538 
<a name="l01539"></a>01539 
<a name="l01540"></a>01540 <span class="comment">// Routine de monitoring appele par Petsc</span>
<a name="l01541"></a>01541 PetscErrorCode MyKSPMonitor(KSP SolveurPetsc, PetscInt it, PetscReal residu, <span class="keywordtype">void</span> *dummy)
<a name="l01542"></a>01542 {
<a name="l01543"></a>01543   <span class="keywordflow">if</span> (it==0)
<a name="l01544"></a>01544     <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Norm of the residue: &quot;</span> &lt;&lt; residu &lt;&lt; <span class="stringliteral">&quot; (1)&quot;</span>;
<a name="l01545"></a>01545   <span class="keywordflow">else</span>
<a name="l01546"></a>01546     <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; residu &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l01547"></a>01547   <span class="keywordflow">if</span> ((it % 15) == 0) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; finl ;
<a name="l01548"></a>01548   <span class="keywordflow">return</span> 0;
<a name="l01549"></a>01549 }
<a name="l01550"></a>01550 <span class="preprocessor">#endif</span>
<a name="l01551"></a>01551 <span class="preprocessor"></span>
<a name="l01552"></a>01552 <span class="comment">// Solve system</span>
<a name="l01553"></a><a class="code" href="classSolv__Petsc.html#a93bea0874ab4fd2b24d063370db00dbe">01553</a> <span class="keywordtype">int</span> <a class="code" href="classSolv__Petsc.html#a93bea0874ab4fd2b24d063370db00dbe">Solv_Petsc::resoudre_systeme</a>(<span class="keyword">const</span> <a class="code" href="classMatrice__Base.html">Matrice_Base</a>&amp; la_matrice, <span class="keyword">const</span> <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; secmem, <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; solution)
<a name="l01554"></a>01554 {
<a name="l01555"></a>01555 <span class="preprocessor">#ifdef PETSCKSP_H</span>
<a name="l01556"></a>01556 <span class="preprocessor"></span><span class="comment">// Si on utilise un solver petsc on le signale pour les stats finales</span>
<a name="l01557"></a>01557   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#affcd058809786918ed173aaf681d0843">begin_count</a>(<a class="code" href="stat__counters_8cpp.html#a1374e3dd206f6a5ece6b44542e3edc34">solv_sys_petsc_counter_</a>);
<a name="l01558"></a>01558   <a class="code" href="Statistiques_8h.html#a7bb2ce53a9ec088bba93ddcfce2b8cb1">statistiques</a>().<a class="code" href="classStatistiques.html#a0faf52d1b518f5b0b2177f22efcc222d" title="Arret du compteur counter_id. On ajoute quantity a la somme des &#39;quantity&#39; (par defaut 0) stockees po...">end_count</a>(<a class="code" href="stat__counters_8cpp.html#a1374e3dd206f6a5ece6b44542e3edc34">solv_sys_petsc_counter_</a>,1,1);
<a name="l01559"></a>01559   std::clock_t start = std::clock();
<a name="l01560"></a>01560   <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#a38702b1b2d16396977155f67cef5fe26">nouvelle_matrice</a>())
<a name="l01561"></a>01561     {
<a name="l01562"></a>01562       matrice_symetrique_ = 1;      <span class="comment">//!&lt; On suppose que la matrice est symetrique</span>
<a name="l01563"></a>01563 <span class="comment"></span>
<a name="l01564"></a>01564 <span class="comment">// Construction de la numerotation globale:</span>
<a name="l01565"></a>01565       construit_renum(secmem);
<a name="l01566"></a>01566 
<a name="l01567"></a>01567 <span class="comment">// Matrice morse intermedaire de conversion</span>
<a name="l01568"></a>01568       <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a> matrice_morse_intermediaire;
<a name="l01569"></a>01569       <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a9c92c7b3025ccb3f301489141a442211" title="Read constant matrix in a file.">read_matrix_</a>)
<a name="l01570"></a>01570         {
<a name="l01571"></a>01571 <span class="comment">// New in 1.6.9, it is possible to read the matrix</span>
<a name="l01572"></a>01572 <span class="comment">// Read the PETSc matrix</span>
<a name="l01573"></a>01573           RestoreMatrixFromFile();
<a name="l01574"></a>01574           <span class="keywordtype">int</span> nb_local_rows, nb_local_cols;
<a name="l01575"></a>01575           MatGetLocalSize(MatricePetsc_, &amp;nb_local_rows, &amp;nb_local_cols);
<a name="l01576"></a>01576           <span class="keywordflow">if</span> (nb_local_rows != nb_items_to_keep_)
<a name="l01577"></a>01577             {
<a name="l01578"></a>01578               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;The matrix read has &quot;</span> &lt;&lt; nb_local_rows &lt;&lt; <span class="stringliteral">&quot; local columns whereas&quot;</span> &lt;&lt; finl;
<a name="l01579"></a>01579               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;the RHS/Solution vectors have a size of &quot;</span> &lt;&lt; nb_items_to_keep_ &lt;&lt; <span class="stringliteral">&quot;.&quot;</span> &lt;&lt; finl;
<a name="l01580"></a>01580               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Check your data file or the file containing the PETSc matrix.&quot;</span> &lt;&lt; finl;
<a name="l01581"></a>01581               <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l01582"></a>01582             }
<a name="l01583"></a>01583         }
<a name="l01584"></a>01584       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Petsc.html">Matrice_Petsc</a>, la_matrice))
<a name="l01585"></a>01585         {
<a name="l01586"></a>01586 <span class="comment">// Matrice deja au format Petsc</span>
<a name="l01587"></a>01587           MatricePetsc_ = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classMatrice__Petsc.html">Matrice_Petsc</a>, la_matrice).getMat();
<a name="l01588"></a>01588           <a class="code" href="classSolv__Petsc.html#a9c92c7b3025ccb3f301489141a442211" title="Read constant matrix in a file.">read_matrix_</a> = 1; <span class="comment">//!&lt; flag reutilise comme si on avait lu la matrice</span>
<a name="l01589"></a>01589 <span class="comment"></span>        }
<a name="l01590"></a>01590       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Morse__Sym.html" title="Classe Matrice_Morse_Sym Represente une matrice M (creuse) symetrique stockee au format Morse Symetri...">Matrice_Morse_Sym</a>, la_matrice))
<a name="l01591"></a>01591         {
<a name="l01592"></a>01592 <span class="comment">// Exemple: matrice de pression en VEFPreP1B</span>
<a name="l01593"></a>01593           <span class="keyword">const</span> <a class="code" href="classMatrice__Morse__Sym.html" title="Classe Matrice_Morse_Sym Represente une matrice M (creuse) symetrique stockee au format Morse Symetri...">Matrice_Morse_Sym</a>&amp; matrice_morse_sym = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classMatrice__Morse__Sym.html" title="Classe Matrice_Morse_Sym Represente une matrice M (creuse) symetrique stockee au format Morse Symetri...">Matrice_Morse_Sym</a>, la_matrice);
<a name="l01594"></a>01594           assert(matrice_morse_sym.<a class="code" href="classMatrice__Sym.html#a5cbcf1c7de27ffb81664ea574a37ebdc">get_est_definie</a>());
<a name="l01595"></a>01595           <a class="code" href="ILU_8cpp.html#af795a7defe79185059ecd10e52645585">MorseSymToMorse</a>(matrice_morse_sym, matrice_morse_intermediaire);
<a name="l01596"></a>01596         }
<a name="l01597"></a>01597       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Bloc__Sym.html">Matrice_Bloc_Sym</a>, la_matrice))
<a name="l01598"></a>01598         {
<a name="l01599"></a>01599 <span class="comment">// Exemple : matrice de pression en VEF P0+P1+Pa</span>
<a name="l01600"></a>01600           <span class="keyword">const</span> <a class="code" href="classMatrice__Bloc__Sym.html">Matrice_Bloc_Sym</a>&amp; matrice = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classMatrice__Bloc__Sym.html">Matrice_Bloc_Sym</a>, la_matrice);
<a name="l01601"></a>01601 <span class="comment">// Conversion de la matrice Matrice_Bloc_Sym au format Matrice_Morse_Sym</span>
<a name="l01602"></a>01602           <a class="code" href="classMatrice__Morse__Sym.html" title="Classe Matrice_Morse_Sym Represente une matrice M (creuse) symetrique stockee au format Morse Symetri...">Matrice_Morse_Sym</a> matrice_morse_sym;
<a name="l01603"></a>01603           matrice.<a class="code" href="classMatrice__Bloc__Sym.html#a96c35afa279fe2fed65738f0afd7f16e">BlocSymToMatMorseSym</a>(matrice_morse_sym);
<a name="l01604"></a>01604           <a class="code" href="ILU_8cpp.html#af795a7defe79185059ecd10e52645585">MorseSymToMorse</a>(matrice_morse_sym, matrice_morse_intermediaire);
<a name="l01605"></a>01605           matrice_morse_sym.<a class="code" href="classMatrice__Morse.html#ae95f9ed88a8a3fc637cd2a705cead9c8" title="Size the matrix with n lines and n columns and nnz zero-values coefficients.">dimensionner</a>(0, 0); <span class="comment">//!&lt; Destruction de la matrice morse sym desormais inutile</span>
<a name="l01606"></a>01606 <span class="comment"></span>        }
<a name="l01607"></a>01607       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>, la_matrice))
<a name="l01608"></a>01608         {
<a name="l01609"></a>01609 <span class="comment">// Exemple : matrice implicite</span>
<a name="l01610"></a>01610           matrice_symetrique_ = 0;
<a name="l01611"></a>01611         }
<a name="l01612"></a>01612       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Bloc.html">Matrice_Bloc</a>, la_matrice))
<a name="l01613"></a>01613         {
<a name="l01614"></a>01614 <span class="comment">// Exemple : matrice de pression en VDF</span>
<a name="l01615"></a>01615           <span class="keyword">const</span> <a class="code" href="classMatrice__Bloc.html">Matrice_Bloc</a>&amp; matrice_bloc = <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classMatrice__Bloc.html">Matrice_Bloc</a>, la_matrice);
<a name="l01616"></a>01616           <span class="keywordflow">if</span> (!<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Morse__Sym.html" title="Classe Matrice_Morse_Sym Represente une matrice M (creuse) symetrique stockee au format Morse Symetri...">Matrice_Morse_Sym</a>, matrice_bloc.<a class="code" href="classMatrice__Bloc.html#a7ffa38f7b93454432b2df7c616ed0a4e">get_bloc</a>(0, 0).<a class="code" href="classDeriv__Matrice__Base.html#ae43f3a90ca16518c191f9e7d5ebef912">valeur</a>()))
<a name="l01617"></a>01617             matrice_symetrique_ = 0;
<a name="l01618"></a>01618           <span class="keywordflow">else</span>
<a name="l01619"></a>01619             {
<a name="l01620"></a>01620 <span class="comment">// Pour un solveur direct, operation si la matrice n&#39;est pas definie (en incompressible VDF, rien n&#39;etait fait...)</span>
<a name="l01621"></a>01621               <a class="code" href="classMatrice__Morse__Sym.html" title="Classe Matrice_Morse_Sym Represente une matrice M (creuse) symetrique stockee au format Morse Symetri...">Matrice_Morse_Sym</a>&amp; mat00 = <a class="code" href="Cast_8h.html#ad3836a067c92103af8df5ad8f35959a6">ref_cast_non_const</a>(<a class="code" href="classMatrice__Morse__Sym.html" title="Classe Matrice_Morse_Sym Represente une matrice M (creuse) symetrique stockee au format Morse Symetri...">Matrice_Morse_Sym</a>, matrice_bloc.<a class="code" href="classMatrice__Bloc.html#a7ffa38f7b93454432b2df7c616ed0a4e">get_bloc</a>(0, 0).<a class="code" href="classDeriv__Matrice__Base.html#ae43f3a90ca16518c191f9e7d5ebef912">valeur</a>());
<a name="l01622"></a>01622               <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> &amp;&amp; mat00.<a class="code" href="classMatrice__Sym.html#a5cbcf1c7de27ffb81664ea574a37ebdc">get_est_definie</a>() == 0 &amp;&amp; <a class="code" href="classProcess.html#acd052b99706c577f8a5b6656217cf4c2" title="renvoie 1 si on est sur le processeur maitre du groupe courant (c&#39;est a dire me() == 0)...">Process::je_suis_maitre</a>())
<a name="l01623"></a>01623                 mat00(0, 0) *= 2;
<a name="l01624"></a>01624             }
<a name="l01625"></a>01625           matrice_bloc.<a class="code" href="classMatrice__Bloc.html#ae4f204b5e4a9e70301e459233150e07f">BlocToMatMorse</a>(matrice_morse_intermediaire);
<a name="l01626"></a>01626         }
<a name="l01627"></a>01627       <span class="keywordflow">else</span>
<a name="l01628"></a>01628         {
<a name="l01629"></a>01629           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Solv_Petsc : Warning, we do not know yet treat a matrix of type &quot;</span> &lt;&lt; la_matrice.<a class="code" href="classObjet__U.html#aa58e9a81c0ddc2c1149053b8f96698ac" title="renvoie la chaine identifiant la classe.">que_suis_je</a>()
<a name="l01630"></a>01630                &lt;&lt; finl;
<a name="l01631"></a>01631           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l01632"></a>01632         }
<a name="l01633"></a>01633       <span class="keywordflow">if</span> (verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;[Petsc] Time to convert matrix: &quot;</span> &lt;&lt; (std::clock() - start) / (<span class="keywordtype">double</span>) CLOCKS_PER_SEC &lt;&lt; finl;
<a name="l01634"></a>01634 
<a name="l01635"></a>01635 <span class="comment">// Verification stockage de la matrice</span>
<a name="l01636"></a>01636       check_aij(matrice_morse_intermediaire);
<a name="l01637"></a>01637 
<a name="l01638"></a>01638       <span class="keywordtype">bool</span> la_matrice_est_morse_non_symetrique =
<a name="l01639"></a>01639         <a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>, la_matrice) &amp;&amp; !<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Morse__Sym.html" title="Classe Matrice_Morse_Sym Represente une matrice M (creuse) symetrique stockee au format Morse Symetri...">Matrice_Morse_Sym</a>, la_matrice);
<a name="l01640"></a>01640       <span class="keyword">const</span> <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; matrice_morse = la_matrice_est_morse_non_symetrique ? <a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>, la_matrice)
<a name="l01641"></a>01641                                            : matrice_morse_intermediaire;
<a name="l01642"></a>01642 
<a name="l01643"></a>01643 <span class="comment">// Verification stencil de la matrice</span>
<a name="l01644"></a>01644       nouveau_stencil_ = (MatricePetsc_ == NULL ? <span class="keyword">true</span> : check_stencil(matrice_morse));
<a name="l01645"></a>01645 
<a name="l01646"></a>01646       <span class="keywordflow">if</span> (SecondMembrePetsc_ == NULL)
<a name="l01647"></a>01647         {
<a name="l01648"></a>01648 <span class="comment">// Build x and b during the first matrix creation</span>
<a name="l01649"></a>01649           Create_vectors(secmem);
<a name="l01650"></a>01650 <span class="comment">// Creation de Champs (fields) pour pouvoir utiliser des preconditionneurs PCFIELDSPLIT</span>
<a name="l01651"></a>01651           Create_DM(secmem);
<a name="l01652"></a>01652         }
<a name="l01653"></a>01653 <span class="comment">// Construit ou update la matrice</span>
<a name="l01654"></a>01654       <span class="keywordflow">if</span> (nouveau_stencil_)
<a name="l01655"></a>01655         Create_objects(matrice_morse);
<a name="l01656"></a>01656       <span class="keywordflow">else</span>
<a name="l01657"></a>01657         Update_matrix(MatricePetsc_, matrice_morse);
<a name="l01658"></a>01658       <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>() == 1)
<a name="l01659"></a>01659         {
<a name="l01660"></a>01660           <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Order of the PETSc matrix : &quot;</span> &lt;&lt; nb_rows_tot_ &lt;&lt; <span class="stringliteral">&quot; (~ &quot;</span>
<a name="l01661"></a>01661                &lt;&lt; (petsc_cpus_selection_ ? (int) (nb_rows_tot_ / petsc_nb_cpus_) : nb_rows_)
<a name="l01662"></a>01662                &lt;&lt; <span class="stringliteral">&quot; unknowns per PETSc process ) &quot;</span> &lt;&lt; (nouveau_stencil_ ? <span class="stringliteral">&quot;New stencil.&quot;</span> : <span class="stringliteral">&quot;Same stencil.&quot;</span>) &lt;&lt; finl;
<a name="l01663"></a>01663         }
<a name="l01664"></a>01664     }
<a name="l01665"></a>01665   start = std::clock();
<a name="l01666"></a>01666 <span class="comment">// Assemblage du second membre et de la solution</span>
<a name="l01667"></a>01667 <span class="comment">// ToDo calculer ix au moment de item_to_keep_</span>
<a name="l01668"></a>01668   <span class="keywordtype">int</span> size=secmem.<a class="code" href="classArrOfDouble.html#a3c3b33bea0e88b87315c21ee94bee05f" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>();
<a name="l01669"></a>01669   <span class="keywordtype">int</span> colonne_globale=decalage_local_global_;
<a name="l01670"></a>01670   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a> ix(size);
<a name="l01671"></a>01671   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;size; i++)
<a name="l01672"></a>01672     <span class="keywordflow">if</span> (items_to_keep_[i])
<a name="l01673"></a>01673       {
<a name="l01674"></a>01674         ix[i] = colonne_globale;
<a name="l01675"></a>01675         colonne_globale++;
<a name="l01676"></a>01676       }
<a name="l01677"></a>01677     <span class="keywordflow">else</span>
<a name="l01678"></a>01678       ix[i] = -1;
<a name="l01679"></a>01679   VecSetOption(SecondMembrePetsc_, VEC_IGNORE_NEGATIVE_INDICES, PETSC_TRUE);
<a name="l01680"></a>01680   VecSetValues(SecondMembrePetsc_, size, ix.<a class="code" href="classArrOfInt.html#ad0b31250e60cd9040ea60be55db73c3d" title="Renvoie un pointeur sur le premier element du tableau. Le pointeur est nul si le tableau est &quot;detach...">addr</a>(), secmem.<a class="code" href="classArrOfDouble.html#a95357a1390c11dbd481d385257f2e983" title="Renvoie un pointeur sur le premier element du tableau. Le pointeur est nul si le tableau est &quot;detach...">addr</a>(), INSERT_VALUES);
<a name="l01681"></a>01681   VecSetOption(SolutionPetsc_, VEC_IGNORE_NEGATIVE_INDICES, PETSC_TRUE);
<a name="l01682"></a>01682   VecSetValues(SolutionPetsc_, size, ix.<a class="code" href="classArrOfInt.html#ad0b31250e60cd9040ea60be55db73c3d" title="Renvoie un pointeur sur le premier element du tableau. Le pointeur est nul si le tableau est &quot;detach...">addr</a>(), solution.<a class="code" href="classArrOfDouble.html#a95357a1390c11dbd481d385257f2e983" title="Renvoie un pointeur sur le premier element du tableau. Le pointeur est nul si le tableau est &quot;detach...">addr</a>(), INSERT_VALUES);
<a name="l01683"></a>01683   VecAssemblyBegin(SecondMembrePetsc_);
<a name="l01684"></a>01684   VecAssemblyEnd(SecondMembrePetsc_);
<a name="l01685"></a>01685   VecAssemblyBegin(SolutionPetsc_);
<a name="l01686"></a>01686   VecAssemblyEnd(SolutionPetsc_);
<a name="l01687"></a>01687   <span class="keywordflow">if</span> (verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;[Petsc] Time to update vectors: &quot;</span> &lt;&lt; (std::clock() - start) / (<span class="keywordtype">double</span>) CLOCKS_PER_SEC &lt;&lt; finl;
<a name="l01688"></a>01688 
<a name="l01689"></a>01689 <span class="comment">// VecView(SecondMembrePetsc_,PETSC_VIEWER_STDOUT_WORLD);</span>
<a name="l01690"></a>01690 <span class="comment">// VecView(SolutionPetsc_,PETSC_VIEWER_STDOUT_WORLD);</span>
<a name="l01691"></a>01691 
<a name="l01692"></a>01692 <span class="comment">// Save the matrix and the RHS</span>
<a name="l01693"></a>01693 <span class="comment">// if the matrix has changed...</span>
<a name="l01694"></a>01694   <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#a38702b1b2d16396977155f67cef5fe26">nouvelle_matrice</a>())
<a name="l01695"></a>01695     {
<a name="l01696"></a>01696       start = std::clock();
<a name="l01697"></a>01697       <span class="keywordflow">if</span> (save_matrix_==1)
<a name="l01698"></a>01698         SaveObjectsToFile();
<a name="l01699"></a>01699       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (save_matrix_==2)
<a name="l01700"></a>01700         {
<a name="l01701"></a>01701 <span class="comment">// Format matrix market ToDo : method</span>
<a name="l01702"></a>01702           <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()&gt;1) <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>(<span class="stringliteral">&quot;Error, matrix market format is not available yet in parallel.&quot;</span>);
<a name="l01703"></a>01703           <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> filename(<a class="code" href="classObjet__U.html#a7c27c4f80259eeef76ff8fe2d3bc61f7" title="Renvoie une reference constante vers le nom du cas. Cette methode est statique.">Objet_U::nom_du_cas</a>());
<a name="l01704"></a>01704           filename+=<span class="stringliteral">&quot;_matrix&quot;</span>;
<a name="l01705"></a>01705           filename+=(<a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a>)<a class="code" href="classSolv__Petsc.html#a7384c2681936b980c3fa393793e47e87" title="Nombre d&#39;instances en cours de la classe.">instance</a>;
<a name="l01706"></a>01706           filename+=<span class="stringliteral">&quot;.mtx&quot;</span>;
<a name="l01707"></a>01707           <a class="code" href="classSFichier.html" title="Cette classe est a la classe C++ ofstream ce que la classe Sortie est a la classe C++ ostream Elle re...">SFichier</a> mtx(filename);
<a name="l01708"></a>01708           PetscInt rows;
<a name="l01709"></a>01709           <span class="keyword">const</span> PetscInt *ia, *ja;
<a name="l01710"></a>01710           PetscBool done;
<a name="l01711"></a>01711           MatGetRowIJ(MatricePetsc_, 0, PETSC_FALSE, PETSC_FALSE, &amp;rows, &amp;ia, &amp;ja, &amp;done);
<a name="l01712"></a>01712           <span class="keywordflow">if</span> (!done) <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>(<span class="stringliteral">&quot;Error in MatGetRowIJ&quot;</span>);
<a name="l01713"></a>01713           PetscScalar *v;
<a name="l01714"></a>01714           MatType mat_type;
<a name="l01715"></a>01715           MatGetType(MatricePetsc_,&amp;mat_type);
<a name="l01716"></a>01716           <span class="keywordflow">if</span> (strcmp(mat_type,MATSEQAIJ)==0)
<a name="l01717"></a>01717             MatSeqAIJGetArray(MatricePetsc_, &amp;v);
<a name="l01718"></a>01718           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(mat_type,MATSEQSBAIJ)==0)
<a name="l01719"></a>01719             MatSeqSBAIJGetArray(MatricePetsc_, &amp;v);
<a name="l01720"></a>01720           <span class="keywordflow">else</span> <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>(<span class="stringliteral">&quot;Matrix type not supported.&quot;</span>);
<a name="l01721"></a>01721           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Matrix (&quot;</span> &lt;&lt; rows &lt;&lt; <span class="stringliteral">&quot; lines) written into file with RHS and solution: &quot;</span> &lt;&lt; filename &lt;&lt; finl;
<a name="l01722"></a>01722           mtx &lt;&lt; <span class="stringliteral">&quot;%%MatrixMarket matrix coordinate real general&quot;</span> &lt;&lt; finl;
<a name="l01723"></a>01723           mtx &lt;&lt; <span class="stringliteral">&quot;%%AMGX rhs solution&quot;</span> &lt;&lt; finl;
<a name="l01724"></a>01724           mtx &lt;&lt; rows &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; rows &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; ia[rows] &lt;&lt; finl;
<a name="l01725"></a>01725           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> row=0; row&lt;rows; row++)
<a name="l01726"></a>01726             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=ia[row]; j&lt;ia[row+1]; j++)
<a name="l01727"></a>01727               mtx &lt;&lt; row+1 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; ja[j]+1 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; v[j] &lt;&lt; finl;
<a name="l01728"></a>01728           mtx &lt;&lt; <span class="stringliteral">&quot;%%&quot;</span> &lt;&lt; finl &lt;&lt; <span class="stringliteral">&quot;%% optional rhs &quot;</span> &lt;&lt; secmem.<a class="code" href="classArrOfDouble.html#a3c3b33bea0e88b87315c21ee94bee05f" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>() &lt;&lt; finl;
<a name="l01729"></a>01729           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;secmem.<a class="code" href="classArrOfDouble.html#a3c3b33bea0e88b87315c21ee94bee05f" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>(); i++)
<a name="l01730"></a>01730             mtx &lt;&lt; secmem(i) &lt;&lt; finl;
<a name="l01731"></a>01731           mtx &lt;&lt; <span class="stringliteral">&quot;%%&quot;</span> &lt;&lt; finl &lt;&lt; <span class="stringliteral">&quot;%% optional solution &quot;</span> &lt;&lt; solution.<a class="code" href="classArrOfDouble.html#a3c3b33bea0e88b87315c21ee94bee05f" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>() &lt;&lt; finl;
<a name="l01732"></a>01732           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;solution.<a class="code" href="classArrOfDouble.html#a3c3b33bea0e88b87315c21ee94bee05f" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>(); i++)
<a name="l01733"></a>01733             mtx &lt;&lt; solution(i) &lt;&lt; finl;
<a name="l01734"></a>01734         }
<a name="l01735"></a>01735       <span class="keywordflow">if</span> (save_matrix_ &amp;&amp; verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;[Petsc] Time to write matrix: &quot;</span> &lt;&lt; (std::clock() - start) / (<span class="keywordtype">double</span>) CLOCKS_PER_SEC &lt;&lt; finl;
<a name="l01736"></a>01736     }
<a name="l01737"></a>01737 <span class="comment">//</span>
<a name="l01738"></a>01738 <span class="comment">// Solve the linear system</span>
<a name="l01739"></a>01739 <span class="comment">//</span>
<a name="l01740"></a>01740   PetscLogStagePush(KSPSolve_Stage_);
<a name="l01741"></a>01741   <span class="keywordtype">int</span> size_residu = nb_it_max_ + 1;
<a name="l01742"></a>01742 <span class="comment">// DoubleTrav residu(size_residu); // bad_alloc sur gros cas, curie pourquoi ?</span>
<a name="l01743"></a>01743   <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a> residu(size_residu);
<a name="l01744"></a>01744   start = std::clock();
<a name="l01745"></a>01745   <span class="keywordtype">int</span> nbiter = solve(residu);
<a name="l01746"></a>01746   <span class="keywordflow">if</span> (verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;[Petsc] Time to solve system: &quot;</span> &lt;&lt; (std::clock() - start) / (<span class="keywordtype">double</span>) CLOCKS_PER_SEC &lt;&lt; finl;
<a name="l01747"></a>01747   <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>()&gt;-1)
<a name="l01748"></a>01748     {
<a name="l01749"></a>01749       <span class="keywordtype">double</span> residu_relatif=(residu(0)&gt;0?residu(nbiter)/residu(0):residu(nbiter));
<a name="l01750"></a>01750       <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; finl &lt;&lt; <span class="stringliteral">&quot;Final residue: &quot;</span> &lt;&lt; residu(nbiter) &lt;&lt; <span class="stringliteral">&quot; ( &quot;</span> &lt;&lt; residu_relatif &lt;&lt; <span class="stringliteral">&quot; )&quot;</span>&lt;&lt;finl;
<a name="l01751"></a>01751     }
<a name="l01752"></a>01752 
<a name="l01753"></a>01753 <span class="comment">// Recuperation de la solution</span>
<a name="l01754"></a>01754   start = std::clock();
<a name="l01755"></a>01755 <span class="comment">// ToDo un seul VecGetValues comme VecSetValues</span>
<a name="l01756"></a>01756   <span class="keywordflow">if</span> (different_partition_)
<a name="l01757"></a>01757     {
<a name="l01758"></a>01758 <span class="comment">// TRUST and PETSc has different partition, a local vector LocalSolutionPetsc_ is gathered from the global vector SolutionPetsc_ :</span>
<a name="l01759"></a>01759       VecScatterBegin(VecScatter_, SolutionPetsc_, LocalSolutionPetsc_, INSERT_VALUES, SCATTER_FORWARD);
<a name="l01760"></a>01760       VecScatterEnd  (VecScatter_, SolutionPetsc_, LocalSolutionPetsc_, INSERT_VALUES, SCATTER_FORWARD);
<a name="l01761"></a>01761 <span class="comment">// Use the local vector to get the solution:</span>
<a name="l01762"></a>01762       <span class="keywordtype">int</span> colonne_locale=0;
<a name="l01763"></a>01763       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;size; i++)
<a name="l01764"></a>01764         <span class="keywordflow">if</span> (items_to_keep_[i])
<a name="l01765"></a>01765           {
<a name="l01766"></a>01766             VecGetValues(LocalSolutionPetsc_, 1, &amp;colonne_locale, &amp;solution(i));
<a name="l01767"></a>01767             colonne_locale++;
<a name="l01768"></a>01768           }
<a name="l01769"></a>01769       assert(nb_rows_==colonne_locale);
<a name="l01770"></a>01770     }
<a name="l01771"></a>01771   <span class="keywordflow">else</span>
<a name="l01772"></a>01772     {
<a name="l01773"></a>01773 <span class="comment">// TRUST and PETSc has same partition, local solution can be accessed from the global vector:</span>
<a name="l01774"></a>01774       VecGetValues(SolutionPetsc_, size, ix.<a class="code" href="classArrOfInt.html#ad0b31250e60cd9040ea60be55db73c3d" title="Renvoie un pointeur sur le premier element du tableau. Le pointeur est nul si le tableau est &quot;detach...">addr</a>(), solution.<a class="code" href="classArrOfDouble.html#a95357a1390c11dbd481d385257f2e983" title="Renvoie un pointeur sur le premier element du tableau. Le pointeur est nul si le tableau est &quot;detach...">addr</a>());
<a name="l01775"></a>01775     }
<a name="l01776"></a>01776   solution.<a class="code" href="classDoubleVect.html#abfebbc2f685ce7bc4b80c720d7da9bf3">echange_espace_virtuel</a>();
<a name="l01777"></a>01777   <a class="code" href="classSolveurSys__base.html#afcf2c99ad548e18c61cdade93a2e1978">fixer_nouvelle_matrice</a>(0);
<a name="l01778"></a>01778   <span class="keywordflow">if</span> (verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; finl &lt;&lt; <span class="stringliteral">&quot;[Petsc] Time to update solution: &quot;</span> &lt;&lt; (std::clock() - start) / (<span class="keywordtype">double</span>) CLOCKS_PER_SEC &lt;&lt; finl;
<a name="l01779"></a>01779 <span class="comment">// Calcul du vrai residu sur matrice initiale sur GPU:</span>
<a name="l01780"></a>01780   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a> || <a class="code" href="classSolv__Petsc.html#a5f603c229087d42c8bb2fee48290526f" title="Utilisation des solveurs GPU de PETSc.">gpu_</a>)
<a name="l01781"></a>01781     {
<a name="l01782"></a>01782       <a class="code" href="classDoubleVect.html">DoubleVect</a> <a class="code" href="Op__Grad__EF_8cpp.html#abc0897c211f7aa4541da5833388f868b">test</a>(secmem);
<a name="l01783"></a>01783       test*=-1;
<a name="l01784"></a>01784       la_matrice.<a class="code" href="classMatrice__Base.html#a6ccb4d20d3877cf09f5178ff72af5406" title="Operation de multiplication-accumulation (saxpy) matrice vecteur. Operation: r = r + A*x...">ajouter_multvect</a>(solution,test);
<a name="l01785"></a>01785       <span class="keywordtype">double</span> vrai_residu = <a class="code" href="DoubleVect_8cpp.html#afaa33f0032aa927d8d54ff9fb002b749">mp_norme_vect</a>(test);
<a name="l01786"></a>01786       <span class="keywordflow">if</span> (verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;||Ax-b||=&quot;</span> &lt;&lt; vrai_residu &lt;&lt; finl;
<a name="l01787"></a>01787 <span class="comment">// Verification de la solution sur la matrice initiale</span>
<a name="l01788"></a>01788       <span class="keywordflow">if</span> (nbiter&gt;0 &amp;&amp; <a class="code" href="classProcess.html#acd052b99706c577f8a5b6656217cf4c2" title="renvoie 1 si on est sur le processeur maitre du groupe courant (c&#39;est a dire me() == 0)...">Process::je_suis_maitre</a>())
<a name="l01789"></a>01789         {
<a name="l01790"></a>01790           <span class="keywordtype">double</span> precision_machine=1.e-12;
<a name="l01791"></a>01791           <span class="keywordflow">if</span> (residu(0)&gt;0 &amp;&amp; residu(nbiter)/residu(0)&gt;precision_machine &amp;&amp; vrai_residu&gt;10*residu(nbiter))
<a name="l01792"></a>01792             {
<a name="l01793"></a>01793               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error, computed solution x is false !&quot;</span> &lt;&lt; finl;
<a name="l01794"></a>01794               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;True residual (&quot;</span> &lt;&lt; vrai_residu &lt;&lt; <span class="stringliteral">&quot;) is much higher than convergence residual (&quot;</span> &lt;&lt; residu(nbiter) &lt;&lt; <span class="stringliteral">&quot;) !&quot;</span> &lt;&lt; finl;
<a name="l01795"></a>01795               <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l01796"></a>01796             }
<a name="l01797"></a>01797         }
<a name="l01798"></a>01798     }
<a name="l01799"></a>01799   <span class="keywordflow">return</span> nbiter;
<a name="l01800"></a>01800 <span class="preprocessor">#else</span>
<a name="l01801"></a>01801 <span class="preprocessor"></span>  <span class="keywordflow">return</span> -1;
<a name="l01802"></a>01802 <span class="preprocessor">#endif</span>
<a name="l01803"></a>01803 <span class="preprocessor"></span>}
<a name="l01804"></a>01804 
<a name="l01805"></a>01805 <span class="preprocessor">#ifdef PETSCKSP_H</span>
<a name="l01806"></a>01806 <span class="preprocessor"></span><span class="keywordtype">int</span> Solv_Petsc::solve(<a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a>&amp; residu)
<a name="l01807"></a>01807 {
<a name="l01808"></a>01808   std::clock_t start = std::clock();
<a name="l01809"></a>01809 <span class="comment">// Affichage par MyKSPMonitor</span>
<a name="l01810"></a>01810   <span class="keywordflow">if</span> (!<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>)
<a name="l01811"></a>01811     {
<a name="l01812"></a>01812       <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>() == 1)
<a name="l01813"></a>01813         {
<a name="l01814"></a>01814           KSPMonitorSet(SolveurPetsc_, MyKSPMonitor, PETSC_NULL, PETSC_NULL);
<a name="l01815"></a>01815         }
<a name="l01816"></a>01816       <span class="keywordflow">else</span>
<a name="l01817"></a>01817         KSPMonitorCancel(SolveurPetsc_);
<a name="l01818"></a>01818     }
<a name="l01819"></a>01819 <span class="comment">// Historique du residu</span>
<a name="l01820"></a>01820   KSPSetResidualHistory(SolveurPetsc_, residu.<a class="code" href="classArrOfDouble.html#a95357a1390c11dbd481d385257f2e983" title="Renvoie un pointeur sur le premier element du tableau. Le pointeur est nul si le tableau est &quot;detach...">addr</a>(), residu.<a class="code" href="classArrOfDouble.html#a3c3b33bea0e88b87315c21ee94bee05f" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>(), PETSC_TRUE);
<a name="l01821"></a>01821 
<a name="l01822"></a>01822   <span class="keywordflow">if</span> (enable_ksp_view())
<a name="l01823"></a>01823     KSPView(SolveurPetsc_, PETSC_VIEWER_STDOUT_WORLD);
<a name="l01824"></a>01824   KSPSolve(SolveurPetsc_, SecondMembrePetsc_, SolutionPetsc_);
<a name="l01825"></a>01825 <span class="comment">// Analyse de la convergence par Petsc</span>
<a name="l01826"></a>01826   KSPConvergedReason Reason;
<a name="l01827"></a>01827   KSPGetConvergedReason(SolveurPetsc_, &amp;Reason);
<a name="l01828"></a>01828   <span class="keywordflow">if</span> (Reason==KSP_DIVERGED_ITS &amp;&amp; convergence_with_nb_it_max_) Reason = KSP_CONVERGED_ITS;
<a name="l01829"></a>01829   <span class="keywordflow">if</span> (Reason&lt;0 &amp;&amp; <a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>()&gt;-1)
<a name="l01830"></a>01830     {
<a name="l01831"></a>01831       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;No convergence on the resolution with the Petsc solver.&quot;</span> &lt;&lt; finl;
<a name="l01832"></a>01832       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Reason given by Petsc: &quot;</span>;
<a name="l01833"></a>01833       <span class="keywordflow">if</span>      (Reason==KSP_DIVERGED_NULL)                <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;KSP_DIVERGED_NULL&quot;</span> &lt;&lt; finl;
<a name="l01834"></a>01834       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Reason==KSP_DIVERGED_DTOL)                <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;KSP_DIVERGED_DTOL&quot;</span> &lt;&lt; finl;
<a name="l01835"></a>01835       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Reason==KSP_DIVERGED_BREAKDOWN)           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;KSP_DIVERGED_BREAKDOWN&quot;</span> &lt;&lt; finl;
<a name="l01836"></a>01836       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Reason==KSP_DIVERGED_BREAKDOWN_BICG)      <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;KSP_DIVERGED_BREAKDOWN_BICG&quot;</span> &lt;&lt; finl;
<a name="l01837"></a>01837       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Reason==KSP_DIVERGED_NONSYMMETRIC)        <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;KSP_DIVERGED_NONSYMMETRIC&quot;</span> &lt;&lt; finl;
<a name="l01838"></a>01838       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Reason==KSP_DIVERGED_INDEFINITE_PC)       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;KSP_DIVERGED_INDEFINITE_PC&quot;</span> &lt;&lt; finl;
<a name="l01839"></a>01839       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Reason==KSP_DIVERGED_NANORINF)            <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;KSP_DIVERGED_NANORINF&quot;</span> &lt;&lt; finl;
<a name="l01840"></a>01840       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Reason==KSP_DIVERGED_INDEFINITE_MAT)      <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;KSP_DIVERGED_INDEFINITE_MAT&quot;</span> &lt;&lt; finl;
<a name="l01841"></a>01841       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Reason==KSP_DIVERGED_ITS)
<a name="l01842"></a>01842         {
<a name="l01843"></a>01843           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;KSP_DIVERGED_ITS&quot;</span> &lt;&lt; finl;
<a name="l01844"></a>01844           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;That means the solver didn&#39;t converge within the maximal iterations number.&quot;</span> &lt;&lt; finl;
<a name="l01845"></a>01845           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;You can change the maximal number of iterations with the -ksp_max_it option.&quot;</span> &lt;&lt; finl;
<a name="l01846"></a>01846         }
<a name="l01847"></a>01847       <span class="keywordflow">else</span> <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; (int)Reason &lt;&lt; finl;
<a name="l01848"></a>01848     }
<a name="l01849"></a>01849   <span class="keywordflow">if</span> (Reason&lt;0 &amp;&amp; !<a class="code" href="classSolveurSys__base.html#a4051012f254352a50a0e4bfad2f93a8a">return_on_error_</a>) <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l01850"></a>01850   <span class="keywordtype">int</span> nbiter=-1;
<a name="l01851"></a>01851   KSPGetIterationNumber(SolveurPetsc_, &amp;nbiter);
<a name="l01852"></a>01852   <span class="keywordflow">if</span> (<a class="code" href="classSolveurSys__base.html#ab3ef68bcf4e1b402c52905aa78728aef">limpr</a>()&gt;-1)
<a name="l01853"></a>01853     {
<a name="l01854"></a>01854 <span class="comment">// MyKSPMonitor ne marche pas pour certains solveurs (residu(0) n&#39;est pas calcule):</span>
<a name="l01855"></a>01855       <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> || type_ksp_ == KSPIBCGS)
<a name="l01856"></a>01856         {
<a name="l01857"></a>01857 <span class="comment">// Calcul de residu(0)=||B||</span>
<a name="l01858"></a>01858           VecNorm(SecondMembrePetsc_, NORM_2, &amp;residu(0));
<a name="l01859"></a>01859 <span class="comment">// On l&#39;affiche pour les solveurs directs (pour les autres TRUST s&#39;en occupe):</span>
<a name="l01860"></a>01860           <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>) MyKSPMonitor(SolveurPetsc_, 0, residu(0), 0);
<a name="l01861"></a>01861         }
<a name="l01862"></a>01862 <span class="comment">// Idem: l&#39;historique du residu est mal evalue pour certains solveurs:</span>
<a name="l01863"></a>01863 <span class="comment">// donc on le calcul a la derniere iteration:</span>
<a name="l01864"></a>01864       <span class="keywordflow">if</span> (residu(0) &gt; 0 &amp;&amp; (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> || type_ksp_ == KSPIBCGS))
<a name="l01865"></a>01865         {
<a name="l01866"></a>01866 <span class="comment">// Calcul de residu(nbiter)=||Ax-B||</span>
<a name="l01867"></a>01867           VecScale(SecondMembrePetsc_, -1);
<a name="l01868"></a>01868           MatMultAdd(MatricePetsc_, SolutionPetsc_, SecondMembrePetsc_, SecondMembrePetsc_);
<a name="l01869"></a>01869           VecNorm(SecondMembrePetsc_, NORM_2, &amp;residu(nbiter));
<a name="l01870"></a>01870         }
<a name="l01871"></a>01871     }
<a name="l01872"></a>01872   <span class="keywordflow">if</span> (verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;[Petsc] Time to solve system: &quot;</span> &lt;&lt; (std::clock() - start) / (<span class="keywordtype">double</span>) CLOCKS_PER_SEC &lt;&lt; finl;
<a name="l01873"></a>01873   return Reason &lt; 0 ? (<span class="keywordtype">int</span>)Reason : nbiter;
<a name="l01874"></a>01874 }
<a name="l01875"></a>01875 <span class="preprocessor">#endif</span>
<a name="l01876"></a>01876 <span class="preprocessor"></span>
<a name="l01877"></a>01877 <span class="preprocessor">#ifdef PETSCKSP_H</span>
<a name="l01878"></a>01878 <span class="preprocessor"></span><span class="keywordtype">void</span> Solv_Petsc::construit_renum(<span class="keyword">const</span> <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; b)
<a name="l01879"></a>01879 {
<a name="l01880"></a>01880 <span class="comment">// Initialisation du tableau items_to_keep_ si ce n&#39;est pas deja fait</span>
<a name="l01881"></a>01881   <span class="keywordflow">if</span> (items_to_keep_.size_array()==0)
<a name="l01882"></a>01882     nb_items_to_keep_ = <a class="code" href="classMD__Vector__tools.html#ad099d2407b0016920bd8c667a56fddd8">MD_Vector_tools::get_sequential_items_flags</a>(b.<a class="code" href="classDoubleVect.html#a0d16d30580c90526e4895388fb44be5d">get_md_vector</a>(), items_to_keep_, b.<a class="code" href="classDoubleVect.html#ab02d01cd1bdab66fbd66f9a47cc29e10">line_size</a>());
<a name="l01883"></a>01883 
<a name="l01884"></a>01884 <span class="comment">// Compute important value:</span>
<a name="l01885"></a>01885   nb_rows_ = nb_items_to_keep_;
<a name="l01886"></a>01886   nb_rows_tot_ = <a class="code" href="classProcess.html#a7d23bc1ef94b3f0623fbc79d034c27fd" title="Calcule la somme de x sur tous les processeurs du groupe courant. Voir aussi mp_max()">mp_sum</a>(nb_rows_);
<a name="l01887"></a>01887   decalage_local_global_ = <a class="code" href="communications_8cpp.html#a13b5bdc7cfe14771b52a033b1ecbc071" title="Calul de la somme partielle de i sur les processeurs 0 a me()-1 (renvoie 0 sur le processeur 0)...">mppartial_sum</a>(nb_rows_);
<a name="l01888"></a>01888 <span class="comment">// Journal()&lt;&lt;&quot;nb_rows_=&quot; &lt;&lt; nb_rows_ &lt;&lt; &quot; nb_rows_tot_=&quot; &lt;&lt; nb_rows_tot_ &lt;&lt; &quot; decalage_local_global_=&quot; &lt;&lt; decalage_local_global_ &lt;&lt; finl;</span>
<a name="l01889"></a>01889 
<a name="l01890"></a>01890   <span class="comment">/**********************/</span>
<a name="l01891"></a>01891   <span class="comment">/* Build renum_ array */</span>
<a name="l01892"></a>01892   <span class="comment">/**********************/</span>
<a name="l01893"></a>01893   <span class="keywordflow">if</span> (MatricePetsc_==NULL)
<a name="l01894"></a>01894     {
<a name="l01895"></a>01895       <span class="keyword">const</span> <a class="code" href="classMD__Vector.html" title=": Cette classe est un DERIV mais l&#39;objet pointe est partage entre plusieurs instances de cette classe...">MD_Vector</a>&amp; md = b.<a class="code" href="classDoubleVect.html#a0d16d30580c90526e4895388fb44be5d">get_md_vector</a>();
<a name="l01896"></a>01896       renum_.reset();
<a name="l01897"></a>01897       renum_.resize(0, b.<a class="code" href="classDoubleVect.html#ab02d01cd1bdab66fbd66f9a47cc29e10">line_size</a>());
<a name="l01898"></a>01898       <a class="code" href="MD__Vector__tools_8cpp.html#aff1ed2791dba1a76fdb300920147cfdf">MD_Vector_tools::creer_tableau_distribue</a>(md, renum_, <a class="code" href="classArray__base.html#abee342aa9ac59623c4c782dc9d7877ffaf6ae9ba7eb51c5f298ce693345b3ec68">Array_base::NOCOPY_NOINIT</a>);
<a name="l01899"></a>01899     }
<a name="l01900"></a>01900   <span class="keywordtype">int</span> cpt=0;
<a name="l01901"></a>01901   <span class="keywordtype">int</span> size=items_to_keep_.size_array();
<a name="l01902"></a>01902   renum_ = INT_MAX; <span class="comment">//pour crasher si le MD_Vector est incoherent</span>
<a name="l01903"></a>01903   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; renum_array = renum_;  <span class="comment">//!&lt; tableau vu comme lineaire</span>
<a name="l01904"></a>01904 <span class="comment"></span>  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;size; i++)
<a name="l01905"></a>01905     {
<a name="l01906"></a>01906       <span class="keywordflow">if</span>(items_to_keep_[i])
<a name="l01907"></a>01907         {
<a name="l01908"></a>01908           renum_array[i]=cpt+decalage_local_global_;
<a name="l01909"></a>01909           cpt++;
<a name="l01910"></a>01910         }
<a name="l01911"></a>01911     }
<a name="l01912"></a>01912   renum_.echange_espace_virtuel();
<a name="l01913"></a>01913 }
<a name="l01914"></a>01914 
<a name="l01915"></a>01915 <span class="keywordtype">void</span> Solv_Petsc::check_aij(<span class="keyword">const</span> <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; mat)
<a name="l01916"></a>01916 {
<a name="l01917"></a>01917   <span class="comment">/*******************/</span>
<a name="l01918"></a>01918   <span class="comment">/* Setting mataij_ */</span>
<a name="l01919"></a>01919   <span class="comment">/*******************/</span>
<a name="l01920"></a>01920 <span class="comment">// Matrice non symetrique, on utilise le format aij et non sbaij:</span>
<a name="l01921"></a>01921   <span class="keywordflow">if</span> (!matrice_symetrique_) mataij_=1;
<a name="l01922"></a>01922 
<a name="l01923"></a>01923 <span class="comment">// Je n&#39;arrive pas a faire marcher le stockage symetrique avec le preconditionneur PCEISENSTAT</span>
<a name="l01924"></a>01924 <span class="comment">// qui est interessant car necessite 2 fois moins d&#39;operations que le SSOR</span>
<a name="l01925"></a>01925   <span class="keywordflow">if</span> (type_pc_==PCEISENSTAT) mataij_=1;
<a name="l01926"></a>01926 
<a name="l01927"></a>01927 <span class="comment">// Dans le cas de SUPERLU_DIST pour Cholesky, je n&#39;arrive pas a faire marcher le stockage</span>
<a name="l01928"></a>01928 <span class="comment">// symetrique donc l&#39;utilisation de SUPERLU_DIST n&#39;est pas encore optimale en RAM...</span>
<a name="l01929"></a>01929   <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>==<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6ae182fa5e69fe3b70815223024f19cd1b">superlu_dist</a>) mataij_=1;
<a name="l01930"></a>01930 <span class="comment">// IDEM pour UMFPACK qui ne supporte que le format AIJ:</span>
<a name="l01931"></a>01931   <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>==<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6ad25605924f9b1643dcc298a4eba5a84f">umfpack</a>) mataij_=1;
<a name="l01932"></a>01932 
<a name="l01933"></a>01933 <span class="comment">// Dans le cas GPU, seul le format AIJ est supporte pour le moment:</span>
<a name="l01934"></a>01934   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a5f603c229087d42c8bb2fee48290526f" title="Utilisation des solveurs GPU de PETSc.">gpu_</a> || <a class="code" href="classSolv__Petsc.html#a4a4d7d01f00900e4c2ad771be5e6725b" title="Utilisation des solveurs GPU de AMGX.">amgx_</a>) mataij_=1;
<a name="l01935"></a>01935 
<a name="l01936"></a>01936 <span class="preprocessor">#ifdef PETSC_HAVE_OPENMP</span>
<a name="l01937"></a>01937 <span class="preprocessor"></span><span class="comment">// Dans le cas d&#39;OpenMP, seul le format aij est multithreade:</span>
<a name="l01938"></a>01938 <span class="comment">// PL (01/2021): plus vrai</span>
<a name="l01939"></a>01939 <span class="comment">// mataij_=1;</span>
<a name="l01940"></a>01940 <span class="preprocessor">#endif</span>
<a name="l01941"></a>01941 <span class="preprocessor"></span>
<a name="l01942"></a>01942 <span class="comment">// Dans le cas de save_matrix_ en parallele</span>
<a name="l01943"></a>01943 <span class="comment">// Sinon, cela bloque avec sbaij:</span>
<a name="l01944"></a>01944   <span class="keywordflow">if</span> (save_matrix_==1 &amp;&amp; <a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()&gt;1) mataij_=1;
<a name="l01945"></a>01945 
<a name="l01946"></a>01946 <span class="comment">// Error in PETSc when read/save the factored matrix if matrix is sbaij</span>
<a name="l01947"></a>01947 <span class="comment">// so aij is selected instead:</span>
<a name="l01948"></a>01948   <span class="keywordflow">if</span> (factored_matrix_!=<span class="stringliteral">&quot;&quot;</span>) mataij_=1;
<a name="l01949"></a>01949 
<a name="l01950"></a>01950   <span class="keywordflow">if</span> (!<a class="code" href="classSolv__Petsc.html#a9c92c7b3025ccb3f301489141a442211" title="Read constant matrix in a file.">read_matrix_</a>)
<a name="l01951"></a>01951     {
<a name="l01952"></a>01952 <span class="comment">// Ajout d&#39;un test de verification de la symetrie supposee de la matrice PETSc</span>
<a name="l01953"></a>01953 <span class="comment">// Ce test a permis de trouver un defaut de parallelisme sur le remplissage</span>
<a name="l01954"></a>01954 <span class="comment">// de la matrice en pression lors de l&#39;introduction de l&#39;option volume etendu</span>
<a name="l01955"></a>01955       <span class="keywordtype">int</span> check_matrice_symetrique_ = matrice_symetrique_;
<a name="l01956"></a>01956 <span class="comment">// Check cancelled for:</span>
<a name="l01957"></a>01957 <span class="preprocessor">#ifdef PETSC_HAVE_CUDA</span>
<a name="l01958"></a>01958 <span class="preprocessor"></span>      check_matrice_symetrique_=0; <span class="comment">//!&lt; Bug with CUDA ?</span>
<a name="l01959"></a>01959 <span class="comment"></span><span class="preprocessor">#endif</span>
<a name="l01960"></a>01960 <span class="preprocessor"></span><span class="preprocessor">#ifdef NDEBUG</span>
<a name="l01961"></a>01961 <span class="preprocessor"></span>      check_matrice_symetrique_=0; <span class="comment">//!&lt; Not done in production</span>
<a name="l01962"></a>01962 <span class="comment"></span><span class="preprocessor">#endif</span>
<a name="l01963"></a>01963 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (mataij_ == 0)
<a name="l01964"></a>01964         {
<a name="l01965"></a>01965           <span class="comment">/***************************************/</span>
<a name="l01966"></a>01966           <span class="comment">/* Test de verification de la symetrie */</span>
<a name="l01967"></a>01967           <span class="comment">/***************************************/</span>
<a name="l01968"></a>01968           <span class="keywordflow">if</span> (check_matrice_symetrique_)
<a name="l01969"></a>01969             {
<a name="l01970"></a>01970               Mat MatricePetscComplete;
<a name="l01971"></a>01971 <span class="comment">// On construit une matrice PETSc complete sans hypothese sur la symetrie</span>
<a name="l01972"></a>01972               Create_MatricePetsc(MatricePetscComplete, 1, mat);
<a name="l01973"></a>01973               Mat MatricePetsc;
<a name="l01974"></a>01974               Create_MatricePetsc(MatricePetsc, mataij_, mat);
<a name="l01975"></a>01975               PetscBool matrices_identiques;
<a name="l01976"></a>01976 <span class="comment">// On teste l&#39;egalite des 2 matrices en faisant n produits matrice-vecteur</span>
<a name="l01977"></a>01977               <span class="keywordtype">int</span> n = 10;
<a name="l01978"></a>01978               MatMultAddEqual(MatricePetsc, MatricePetscComplete, n, &amp;matrices_identiques);
<a name="l01979"></a>01979               <span class="keywordflow">if</span> (!matrices_identiques)
<a name="l01980"></a>01980                 {
<a name="l01981"></a>01981                   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error: matrix PETSc are different according to the symmetric storage or not.&quot;</span> &lt;&lt; finl;
<a name="l01982"></a>01982                   <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>() &gt; 1) <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Check if the matrix is correct in parallel.&quot;</span> &lt;&lt; finl;
<a name="l01983"></a>01983                   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Contact TRUST support team.&quot;</span> &lt;&lt; finl;
<a name="l01984"></a>01984                   <span class="keywordflow">if</span> (nb_rows_ &lt; 10)
<a name="l01985"></a>01985                     {
<a name="l01986"></a>01986                       MatView(MatricePetsc, PETSC_VIEWER_STDOUT_WORLD);
<a name="l01987"></a>01987                       MatView(MatricePetscComplete, PETSC_VIEWER_STDOUT_WORLD);
<a name="l01988"></a>01988                       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l01989"></a>01989                     }
<a name="l01990"></a>01990                 }
<a name="l01991"></a>01991               MatDestroy(&amp;MatricePetsc);
<a name="l01992"></a>01992               MatDestroy(&amp;MatricePetscComplete);
<a name="l01993"></a>01993             }
<a name="l01994"></a>01994         }
<a name="l01995"></a>01995     }
<a name="l01996"></a>01996 }
<a name="l01997"></a>01997 <span class="comment">// Creation des objets PETSc</span>
<a name="l01998"></a>01998 <span class="keywordtype">void</span> Solv_Petsc::Create_objects(<span class="keyword">const</span> <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; mat)
<a name="l01999"></a>01999 {
<a name="l02000"></a>02000 <span class="comment">// Remplissage d&#39;une matrice de preconditionnement non symetrique</span>
<a name="l02001"></a>02001   Mat MatricePrecondionnementPetsc;
<a name="l02002"></a>02002   <span class="comment">/* Semble plus vrai pour spai dans Petsc 3.10.0:</span>
<a name="l02003"></a>02003 <span class="comment">  if (matrice_symetrique_ &amp;&amp; (type_pc_==&quot;hypre&quot; || type_pc_==&quot;spai&quot;)) */</span>
<a name="l02004"></a>02004   <span class="keywordflow">if</span> (matrice_symetrique_ &amp;&amp; type_pc_ == <span class="stringliteral">&quot;hypre&quot;</span>)
<a name="l02005"></a>02005     preconditionnement_non_symetrique_ = 1;
<a name="l02006"></a>02006 
<a name="l02007"></a>02007   <span class="keywordflow">if</span> (preconditionnement_non_symetrique_)
<a name="l02008"></a>02008     Create_MatricePetsc(MatricePrecondionnementPetsc, 1, mat);
<a name="l02009"></a>02009 
<a name="l02010"></a>02010 <span class="comment">// Creation de la matrice Petsc si necessaire</span>
<a name="l02011"></a>02011   <span class="keywordflow">if</span> (!<a class="code" href="classSolv__Petsc.html#a9c92c7b3025ccb3f301489141a442211" title="Read constant matrix in a file.">read_matrix_</a>)
<a name="l02012"></a>02012     {
<a name="l02013"></a>02013       <span class="keywordflow">if</span> (MatricePetsc_!=NULL) MatDestroy(&amp;MatricePetsc_);
<a name="l02014"></a>02014       Create_MatricePetsc(MatricePetsc_, mataij_, mat);
<a name="l02015"></a>02015     }
<a name="l02016"></a>02016 
<a name="l02017"></a>02017   <span class="comment">/* Seems petsc_decide=1 have no interest. On PETSC_GCP with n=2 (20000cell/n), the ratio is 99%-101% and petsc_decide is slower</span>
<a name="l02018"></a>02018 <span class="comment">  Even with n=9, ratio is 97%-103%, and petsc_decide is slower by 10%. Better load balance but increased MPI cost and lower convergence...</span>
<a name="l02019"></a>02019 <span class="comment">  Hope it will be better with GPU</span>
<a name="l02020"></a>02020 <span class="comment">  if (!petsc_decide_)</span>
<a name="l02021"></a>02021 <span class="comment">  {</span>
<a name="l02022"></a>02022 <span class="comment">     // Try to detect the possible gain with petsc_decide_</span>
<a name="l02023"></a>02023 <span class="comment">     int min_nb_rows = mp_min(nb_rows_);</span>
<a name="l02024"></a>02024 <span class="comment">     int max_nb_rows = mp_max(nb_rows_);</span>
<a name="l02025"></a>02025 <span class="comment">     int new_nb_rows = PETSC_DECIDE;</span>
<a name="l02026"></a>02026 <span class="comment">     PetscSplitOwnership(PETSC_COMM_WORLD, &amp;new_nb_rows, &amp;nb_rows_tot_);</span>
<a name="l02027"></a>02027 <span class="comment">     int min_new_nb_rows = mp_min(new_nb_rows);</span>
<a name="l02028"></a>02028 <span class="comment">     int max_new_nb_rows = mp_max(new_nb_rows);</span>
<a name="l02029"></a>02029 <span class="comment">     Cerr &lt;&lt; min_nb_rows &lt;&lt; &quot; &quot; &lt;&lt; max_nb_rows &lt;&lt; &quot; &quot; &lt;&lt; min_new_nb_rows &lt;&lt; &quot; &quot; &lt;&lt; max_new_nb_rows &lt;&lt; finl;</span>
<a name="l02030"></a>02030 <span class="comment">  }</span>
<a name="l02031"></a>02031 <span class="comment">  */</span>
<a name="l02032"></a>02032 
<a name="l02033"></a>02033   <span class="comment">/*****************************************************************************/</span>
<a name="l02034"></a>02034   <span class="comment">/* Changement du preconditionneur pour profiter de la symetrie de la matrice */</span>
<a name="l02035"></a>02035   <span class="comment">/*****************************************************************************/</span>
<a name="l02036"></a>02036   <span class="keywordflow">if</span> (matrice_symetrique_)
<a name="l02037"></a>02037     {
<a name="l02038"></a>02038       MatSetOption(MatricePetsc_, MAT_SYMMETRIC, PETSC_TRUE); <span class="comment">//!&lt; Utile ?</span>
<a name="l02039"></a>02039 <span class="comment"></span>      <span class="keywordflow">if</span> (type_pc_ == PCLU)
<a name="l02040"></a>02040         {
<a name="l02041"></a>02041 <span class="comment">// PCCHOLESKY is only supported for sbaij format or since PETSc 3.9.2, SUPERLU, CHOLMOD</span>
<a name="l02042"></a>02042           <span class="keywordflow">if</span> (mataij_ == 0 || <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> == <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6ae182fa5e69fe3b70815223024f19cd1b">superlu_dist</a> || <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> == <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6abc3895945aa136c66ea71a53a6fae6c7">cholmod</a>)
<a name="l02043"></a>02043             PCSetType(PreconditionneurPetsc_, PCCHOLESKY); <span class="comment">//!&lt; Precond PCLU -&gt; PCCHOLESKY</span>
<a name="l02044"></a>02044 <span class="comment"></span>        }
<a name="l02045"></a>02045       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type_pc_ == PCSOR)
<a name="l02046"></a>02046         PCSORSetSymmetric(PreconditionneurPetsc_, SOR_LOCAL_SYMMETRIC_SWEEP); <span class="comment">//!&lt; Precond SOR -&gt; SSOR</span>
<a name="l02047"></a>02047 <span class="comment"></span>    }
<a name="l02048"></a>02048 
<a name="l02049"></a>02049   <span class="comment">/*******************************************/</span>
<a name="l02050"></a>02050   <span class="comment">/* Choix du package pour le solveur direct */</span>
<a name="l02051"></a>02051   <span class="comment">/*******************************************/</span>
<a name="l02052"></a>02052   <span class="keyword">static</span> <span class="keywordtype">int</span> message_affi = 1;
<a name="l02053"></a>02053   <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> == <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6a1cb49f862e7fcd552eed7f0145c86db1">mumps</a>)
<a name="l02054"></a>02054     {
<a name="l02055"></a>02055 <span class="comment">// Message pour prevenir</span>
<a name="l02056"></a>02056       <span class="keywordflow">if</span> (message_affi)
<a name="l02057"></a>02057         {
<a name="l02058"></a>02058           <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;The LU decomposition of a matrix with &quot;</span>;
<a name="l02059"></a>02059           <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Cholesky from MUMPS may take several minutes, please wait...&quot;</span> &lt;&lt; finl;
<a name="l02060"></a>02060           <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a>
<a name="l02061"></a>02061               &lt;&lt; <span class="stringliteral">&quot;If the decomposition fails/crashes cause a lack of memory, then increase the number of CPUs for your calculation&quot;</span>
<a name="l02062"></a>02062               &lt;&lt; finl;
<a name="l02063"></a>02063           <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a>
<a name="l02064"></a>02064               &lt;&lt; <span class="stringliteral">&quot;or use Cholesky_out_of_core keyword to write the decomposition on the disk, thus saving memory but with an extra CPU cost during solve.&quot;</span>
<a name="l02065"></a>02065               &lt;&lt; finl;
<a name="l02066"></a>02066           <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a>
<a name="l02067"></a>02067               &lt;&lt; <span class="stringliteral">&quot;To see the RAM required by the decomposition in the .out file, add impr option to the solver: petsc cholesky { impr }&quot;</span>
<a name="l02068"></a>02068               &lt;&lt; finl;
<a name="l02069"></a>02069           <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a>
<a name="l02070"></a>02070               &lt;&lt; <span class="stringliteral">&quot;If an error INFOG(1)=-8|-9|-11|-17|-20 is returned, you can try to increase the ICNTL(14) parameter of MUMPS by using the -mat_mumps_icntl_14 command line option.&quot;</span>
<a name="l02071"></a>02071               &lt;&lt; finl;
<a name="l02072"></a>02072           message_affi = 0;
<a name="l02073"></a>02073         }
<a name="l02074"></a>02074       PCFactorSetMatSolverType(PreconditionneurPetsc_, MATSOLVERMUMPS);
<a name="l02075"></a>02075     }
<a name="l02076"></a>02076   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> == <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6ae182fa5e69fe3b70815223024f19cd1b">superlu_dist</a>)
<a name="l02077"></a>02077     {
<a name="l02078"></a>02078       <span class="keywordflow">if</span> (message_affi)
<a name="l02079"></a>02079         <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Cholesky from SUPERLU_DIST may take several minutes, please wait...&quot;</span> &lt;&lt; finl;
<a name="l02080"></a>02080       PCFactorSetMatSolverType(PreconditionneurPetsc_, MATSOLVERSUPERLU_DIST);
<a name="l02081"></a>02081     }
<a name="l02082"></a>02082   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> == <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6aaf77cfaeac95d5bb680e1b2603d23ae1">petsc</a>)
<a name="l02083"></a>02083     {
<a name="l02084"></a>02084       <span class="keywordflow">if</span> (message_affi)
<a name="l02085"></a>02085         <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Cholesky from PETSc may take several minutes, please wait...&quot;</span>;
<a name="l02086"></a>02086       PCFactorSetMatSolverType(PreconditionneurPetsc_, MATSOLVERPETSC);
<a name="l02087"></a>02087     }
<a name="l02088"></a>02088   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> == <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6ad25605924f9b1643dcc298a4eba5a84f">umfpack</a>)
<a name="l02089"></a>02089     {
<a name="l02090"></a>02090       <span class="keywordflow">if</span> (message_affi)
<a name="l02091"></a>02091         <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Cholesky from UMFPACK may take several minutes, please wait...&quot;</span>;
<a name="l02092"></a>02092       PCFactorSetMatSolverType(PreconditionneurPetsc_, MATSOLVERUMFPACK);
<a name="l02093"></a>02093     }
<a name="l02094"></a>02094   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> == <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6aa663c1c6ebfd318f067db896735d4481">pastix</a>)
<a name="l02095"></a>02095     {
<a name="l02096"></a>02096       <span class="keywordflow">if</span> (message_affi)
<a name="l02097"></a>02097         <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Cholesky from Pastix may take several minutes, please wait...&quot;</span>;
<a name="l02098"></a>02098       PCFactorSetMatSolverType(PreconditionneurPetsc_, MATSOLVERPASTIX);
<a name="l02099"></a>02099     }
<a name="l02100"></a>02100   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> == <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6abc3895945aa136c66ea71a53a6fae6c7">cholmod</a>)
<a name="l02101"></a>02101     {
<a name="l02102"></a>02102       <span class="keywordflow">if</span> (message_affi)
<a name="l02103"></a>02103         <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Cholesky from Cholmod may take several minutes, please wait...&quot;</span>;
<a name="l02104"></a>02104       PCFactorSetMatSolverType(PreconditionneurPetsc_, MATSOLVERCHOLMOD);
<a name="l02105"></a>02105     }
<a name="l02106"></a>02106   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> == cli)
<a name="l02107"></a>02107     {
<a name="l02108"></a>02108       <span class="keywordflow">if</span> (message_affi)
<a name="l02109"></a>02109         <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;LU factorization may take several minutes, please wait...&quot;</span>;
<a name="l02110"></a>02110     }
<a name="l02111"></a>02111   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>)
<a name="l02112"></a>02112     {
<a name="l02113"></a>02113       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;PCFactorSetMatSolverType not called for direct solver, solveur_direct_=&quot;</span> &lt;&lt; <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> &lt;&lt; finl;
<a name="l02114"></a>02114       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Contact TRUST support.&quot;</span> &lt;&lt; finl;
<a name="l02115"></a>02115       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l02116"></a>02116     }
<a name="l02117"></a>02117 
<a name="l02118"></a>02118   <span class="keywordflow">if</span> ((<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a> &gt; <a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6a1cb49f862e7fcd552eed7f0145c86db1">mumps</a>) &amp;&amp; (message_affi))
<a name="l02119"></a>02119     {
<a name="l02120"></a>02120       <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot; OK &quot;</span> &lt;&lt; finl;
<a name="l02121"></a>02121       message_affi = 0;
<a name="l02122"></a>02122     }
<a name="l02123"></a>02123 
<a name="l02124"></a>02124   <span class="comment">/****************************************/</span>
<a name="l02125"></a>02125   <span class="comment">/* Association de la matrice au solveur */</span>
<a name="l02126"></a>02126   <span class="comment">/****************************************/</span>
<a name="l02127"></a>02127   <span class="keywordflow">if</span> (preconditionnement_non_symetrique_)
<a name="l02128"></a>02128     {
<a name="l02129"></a>02129       KSPSetOperators(SolveurPetsc_, MatricePetsc_, MatricePrecondionnementPetsc);
<a name="l02130"></a>02130       MatDestroy(&amp;MatricePrecondionnementPetsc);
<a name="l02131"></a>02131     }
<a name="l02132"></a>02132   <span class="keywordflow">else</span>
<a name="l02133"></a>02133     {
<a name="l02134"></a>02134       KSPSetOperators(SolveurPetsc_, MatricePetsc_, MatricePetsc_);
<a name="l02135"></a>02135     }
<a name="l02136"></a>02136   <span class="comment">/************************************/</span>
<a name="l02137"></a>02137   <span class="comment">/* Factored matrix if direct solver */</span>
<a name="l02138"></a>02138   <span class="comment">/************************************/</span>
<a name="l02139"></a>02139   <span class="keywordflow">if</span> (<a class="code" href="Solv__Petsc_8h.html#a5a0a487c7e0e114f4d92a88e2a5808b6">solveur_direct_</a>)
<a name="l02140"></a>02140     {
<a name="l02141"></a>02141 <span class="comment">// Syntax: factored_matrix save|read|disk</span>
<a name="l02142"></a>02142 <span class="comment">// disk means read the factored_matrix or compute it if not found then save it to disk</span>
<a name="l02143"></a>02143       <a class="code" href="classNom.html" title="class Nom Une chaine de caractere pour nommer les objets de TRUST">Nom</a> filename(<a class="code" href="classObjet__U.html#a7c27c4f80259eeef76ff8fe2d3bc61f7" title="Renvoie une reference constante vers le nom du cas. Cette methode est statique.">Objet_U::nom_du_cas</a>());
<a name="l02144"></a>02144       filename += <span class="stringliteral">&quot;_Factored_Matrix.petsc&quot;</span>;
<a name="l02145"></a>02145       <span class="keywordflow">if</span> (factored_matrix_ == <span class="stringliteral">&quot;read&quot;</span> || factored_matrix_ == <span class="stringliteral">&quot;disk&quot;</span>)
<a name="l02146"></a>02146         {
<a name="l02147"></a>02147           <span class="keywordtype">int</span> filename_found = 0;
<a name="l02148"></a>02148 <span class="comment">// Advice: stat file from master and broadcast</span>
<a name="l02149"></a>02149           <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#acd052b99706c577f8a5b6656217cf4c2" title="renvoie 1 si on est sur le processeur maitre du groupe courant (c&#39;est a dire me() == 0)...">Process::je_suis_maitre</a>())
<a name="l02150"></a>02150             {
<a name="l02151"></a>02151 <span class="comment">// struct stat f {}; pb sur gcc 4.8.5</span>
<a name="l02152"></a>02152               <span class="keyword">struct </span>stat f;
<a name="l02153"></a>02153               <span class="keywordflow">if</span> (!stat(filename, &amp;f)) filename_found = 1;
<a name="l02154"></a>02154             }
<a name="l02155"></a>02155           <a class="code" href="communications_8cpp.html#a2335b36078ae87e23dab400a6e129a3c">envoyer_broadcast</a>(filename_found, 0);
<a name="l02156"></a>02156           <span class="keywordflow">if</span> (filename_found)
<a name="l02157"></a>02157             {
<a name="l02158"></a>02158 <span class="comment">// File found, we read it:</span>
<a name="l02159"></a>02159               factored_matrix_ = <span class="stringliteral">&quot;read&quot;</span>;
<a name="l02160"></a>02160             }
<a name="l02161"></a>02161           <span class="keywordflow">else</span>
<a name="l02162"></a>02162             {
<a name="l02163"></a>02163 <span class="comment">// File not found, two cases:</span>
<a name="l02164"></a>02164               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;File &quot;</span> &lt;&lt; filename &lt;&lt; <span class="stringliteral">&quot; not found&quot;</span>;
<a name="l02165"></a>02165               <span class="keywordflow">if</span> (factored_matrix_ == <span class="stringliteral">&quot;read&quot;</span>)
<a name="l02166"></a>02166                 {
<a name="l02167"></a>02167                   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;!&quot;</span> &lt;&lt; finl;
<a name="l02168"></a>02168                   <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l02169"></a>02169                 }
<a name="l02170"></a>02170               <span class="keywordflow">else</span>
<a name="l02171"></a>02171                 {
<a name="l02172"></a>02172                   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;.&quot;</span> &lt;&lt; finl;
<a name="l02173"></a>02173                   <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;So we will compute the factored matrix and we will save it to disk.&quot;</span> &lt;&lt; finl;
<a name="l02174"></a>02174                   factored_matrix_ = <span class="stringliteral">&quot;save&quot;</span>;
<a name="l02175"></a>02175                 }
<a name="l02176"></a>02176             }
<a name="l02177"></a>02177         }
<a name="l02178"></a>02178       <span class="keywordflow">if</span> (factored_matrix_ == <span class="stringliteral">&quot;read&quot;</span>)
<a name="l02179"></a>02179         {
<a name="l02180"></a>02180           PetscViewer viewer;
<a name="l02181"></a>02181           PetscViewerBinaryOpen(PETSC_COMM_WORLD, filename, FILE_MODE_READ, &amp;viewer);
<a name="l02182"></a>02182           PCFactorSetUpMatSolverType(PreconditionneurPetsc_);
<a name="l02183"></a>02183           Mat FactoredMatrix;
<a name="l02184"></a>02184           PCFactorGetMatrix(PreconditionneurPetsc_, &amp;FactoredMatrix);
<a name="l02185"></a>02185 <span class="comment">// MatCreate(PETSC_COMM_WORLD,&amp;FactoredMatrix);</span>
<a name="l02186"></a>02186 <span class="comment">// MatSetSizes(FactoredMatrix, nb_rows_, nb_rows_, PETSC_DECIDE, PETSC_DECIDE);</span>
<a name="l02187"></a>02187 <span class="comment">// MatSetType(FactoredMatrix,MATSEQAIJ);</span>
<a name="l02188"></a>02188           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Reading the factored matrix in the file &quot;</span> &lt;&lt; filename &lt;&lt; finl;
<a name="l02189"></a>02189           MatLoad(FactoredMatrix, viewer);
<a name="l02190"></a>02190           PetscViewerDestroy(&amp;viewer);
<a name="l02191"></a>02191         }
<a name="l02192"></a>02192       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (factored_matrix_ == <span class="stringliteral">&quot;save&quot;</span>)
<a name="l02193"></a>02193         {
<a name="l02194"></a>02194           Mat FactoredMatrix;
<a name="l02195"></a>02195 <span class="comment">// Compute the factored matrix:</span>
<a name="l02196"></a>02196           PCFactorSetUpMatSolverType(PreconditionneurPetsc_);
<a name="l02197"></a>02197           PCSetUp(PreconditionneurPetsc_);
<a name="l02198"></a>02198 <span class="comment">// Get the factored matrix:</span>
<a name="l02199"></a>02199           PCFactorGetMatrix(PreconditionneurPetsc_, &amp;FactoredMatrix);
<a name="l02200"></a>02200 <span class="comment">// NO   MatConvert(FactoredMatrix,MATSEQDENSE,MAT_INITIAL_MATRIX,&amp;FactoredMatrix);</span>
<a name="l02201"></a>02201 <span class="comment">// MatScalar *a;</span>
<a name="l02202"></a>02202 <span class="comment">// MatDenseGetArray(FactoredMatrix,&amp;a);</span>
<a name="l02203"></a>02203           <span class="keywordflow">if</span> (nb_rows_ &lt; 20)
<a name="l02204"></a>02204             {
<a name="l02205"></a>02205               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;A=&quot;</span> &lt;&lt; finl;
<a name="l02206"></a>02206               MatView(MatricePetsc_, PETSC_VIEWER_STDOUT_WORLD);
<a name="l02207"></a>02207               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;LU=&quot;</span> &lt;&lt; finl;
<a name="l02208"></a>02208               MatView(FactoredMatrix, PETSC_VIEWER_STDOUT_WORLD);
<a name="l02209"></a>02209             }
<a name="l02210"></a>02210 <span class="comment">// Save to disk:</span>
<a name="l02211"></a>02211           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Writing the factored matrix in the file &quot;</span> &lt;&lt; filename &lt;&lt; finl;
<a name="l02212"></a>02212           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Not implemented yet.&quot;</span> &lt;&lt; finl;
<a name="l02213"></a>02213           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l02214"></a>02214           PetscViewer viewer;
<a name="l02215"></a>02215           PetscViewerBinaryOpen(PETSC_COMM_WORLD, filename, FILE_MODE_WRITE, &amp;viewer);
<a name="l02216"></a>02216           MatView(FactoredMatrix, viewer);
<a name="l02217"></a>02217           PetscViewerDestroy(&amp;viewer);
<a name="l02218"></a>02218 
<a name="l02219"></a>02219 <span class="comment">// PetscViewer viewer2;</span>
<a name="l02220"></a>02220 <span class="comment">// PetscViewerBinaryOpen(PETSC_COMM_WORLD,filename,FILE_MODE_READ,&amp;viewer2);</span>
<a name="l02221"></a>02221 <span class="comment">// MatLoad(FactoredMatrix, viewer2);</span>
<a name="l02222"></a>02222 <span class="comment">// PetscViewerDestroy(&amp;viewer2);</span>
<a name="l02223"></a>02223         }
<a name="l02224"></a>02224       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (factored_matrix_ != <span class="stringliteral">&quot;&quot;</span>)
<a name="l02225"></a>02225         {
<a name="l02226"></a>02226           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Unknown option for factored_matrix option: &quot;</span> &lt;&lt; factored_matrix_ &lt;&lt; finl;
<a name="l02227"></a>02227           <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Options are: read|save|disk&quot;</span> &lt;&lt; finl;
<a name="l02228"></a>02228           <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l02229"></a>02229         }
<a name="l02230"></a>02230     }
<a name="l02231"></a>02231 
<a name="l02232"></a>02232   <span class="comment">/*************************************/</span>
<a name="l02233"></a>02233   <span class="comment">/* Mise en place du preconditionneur */</span>
<a name="l02234"></a>02234   <span class="comment">/*************************************/</span>
<a name="l02235"></a>02235   std::clock_t start = std::clock();
<a name="l02236"></a>02236   KSPSetUp(SolveurPetsc_);
<a name="l02237"></a>02237   <span class="keywordflow">if</span> (verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;[Petsc] Time to setup solver: &quot;</span> &lt;&lt; (std::clock() - start) / (<span class="keywordtype">double</span>) CLOCKS_PER_SEC &lt;&lt; finl;
<a name="l02238"></a>02238 }
<a name="l02239"></a>02239 
<a name="l02240"></a>02240 <span class="keywordtype">void</span> <a class="code" href="classSolv__Petsc.html">Solv_Petsc</a>::Create_vectors(const <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; b)
<a name="l02241"></a>02241 {
<a name="l02242"></a>02242 <span class="comment">// Build x</span>
<a name="l02243"></a>02243   VecCreate(PETSC_COMM_WORLD,&amp;SecondMembrePetsc_);
<a name="l02244"></a>02244 <span class="comment">// Set sizes:</span>
<a name="l02245"></a>02245   <span class="keywordflow">if</span> (petsc_decide_)
<a name="l02246"></a>02246     VecSetSizes(SecondMembrePetsc_, PETSC_DECIDE, nb_rows_tot_);
<a name="l02247"></a>02247   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (petsc_cpus_selection_)
<a name="l02248"></a>02248     {
<a name="l02249"></a>02249       <span class="keywordtype">int</span> nb_rows_petsc = compute_nb_rows_petsc(nb_rows_tot_);
<a name="l02250"></a>02250       VecSetSizes(SecondMembrePetsc_, nb_rows_petsc, PETSC_DECIDE);
<a name="l02251"></a>02251     }
<a name="l02252"></a>02252   <span class="keywordflow">else</span>
<a name="l02253"></a>02253     VecSetSizes(SecondMembrePetsc_, nb_rows_, PETSC_DECIDE);
<a name="l02254"></a>02254 
<a name="l02255"></a>02255 <span class="comment">// Set type:</span>
<a name="l02256"></a>02256   <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()&gt;1)
<a name="l02257"></a>02257     VecSetType(SecondMembrePetsc_, <a class="code" href="classSolv__Petsc.html#a5f603c229087d42c8bb2fee48290526f" title="Utilisation des solveurs GPU de PETSc.">gpu_</a> ? VECMPICUDA : VECMPI);
<a name="l02258"></a>02258   <span class="keywordflow">else</span>
<a name="l02259"></a>02259     VecSetType(SecondMembrePetsc_, <a class="code" href="classSolv__Petsc.html#a5f603c229087d42c8bb2fee48290526f" title="Utilisation des solveurs GPU de PETSc.">gpu_</a> ? VECSEQCUDA : VECSEQ);
<a name="l02260"></a>02260   VecSetOptionsPrefix(SecondMembrePetsc_, option_prefix_);
<a name="l02261"></a>02261   VecSetFromOptions(SecondMembrePetsc_);
<a name="l02262"></a>02262 <span class="comment">// Build b</span>
<a name="l02263"></a>02263   VecDuplicate(SecondMembrePetsc_,&amp;SolutionPetsc_);
<a name="l02264"></a>02264 <span class="comment">// Initialize x to avoid a crash on GPU later with VecSetValues... (bug PETSc?)</span>
<a name="l02265"></a>02265   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a5f603c229087d42c8bb2fee48290526f" title="Utilisation des solveurs GPU de PETSc.">gpu_</a>) VecSet(SolutionPetsc_,0.0);
<a name="l02266"></a>02266 
<a name="l02267"></a>02267 <span class="comment">// Only in the case where TRUST and PETSc partitions are not the same</span>
<a name="l02268"></a>02268 <span class="comment">// VecGetValues can only get values on the same processor, so need to gather values from</span>
<a name="l02269"></a>02269 <span class="comment">// global vector SolutionPetsc_ to a local vector LocalSolutionPetsc_ before using VecGetValues</span>
<a name="l02270"></a>02270 <span class="comment">// It will add an extra MPI cost with this operation.</span>
<a name="l02271"></a>02271   <span class="keywordflow">if</span> (different_partition_)
<a name="l02272"></a>02272     {
<a name="l02273"></a>02273 <span class="comment">// Create the local vector of length nb_rows_:</span>
<a name="l02274"></a>02274       VecCreateSeq(PETSC_COMM_SELF, nb_rows_, &amp;LocalSolutionPetsc_);
<a name="l02275"></a>02275 <span class="comment">// Create the Scatter context to gather from the global solution to the local solution</span>
<a name="l02276"></a>02276       <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a> from(nb_rows_);
<a name="l02277"></a>02277       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nb_rows_; i++)
<a name="l02278"></a>02278         from(i)=decalage_local_global_+i; <span class="comment">//!&lt; Global indices in SolutionPetsc_</span>
<a name="l02279"></a>02279 <span class="comment"></span>      IS fromis;
<a name="l02280"></a>02280       ISCreateGeneral(PETSC_COMM_WORLD, from.size_array(), from.addr(), PETSC_COPY_VALUES, &amp;fromis);
<a name="l02281"></a>02281       VecScatterCreate(SolutionPetsc_, fromis, LocalSolutionPetsc_, NULL, &amp;VecScatter_);
<a name="l02282"></a>02282       ISDestroy(&amp;fromis);
<a name="l02283"></a>02283 <span class="comment">// Will permit later with VecScatterBegin/VecScatterEnd something like:</span>
<a name="l02284"></a>02284 <span class="comment">// LocalSolutionPetsc_[tois[i]]=SolutionPetsc_[fromis[i]]</span>
<a name="l02285"></a>02285     }
<a name="l02286"></a>02286 }
<a name="l02287"></a>02287 
<a name="l02288"></a>02288 <span class="keywordtype">void</span> Solv_Petsc::Create_DM(<span class="keyword">const</span> <a class="code" href="classDoubleVect.html">DoubleVect</a>&amp; b)
<a name="l02289"></a>02289 {
<a name="l02290"></a>02290   <span class="comment">/* creation de champs Petsc si des MD_Vector_Composite sont trouves dans b, avec recursion! */</span>
<a name="l02291"></a>02291   <span class="keywordflow">if</span> (<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMD__Vector__composite.html" title="Metadata for a distributed composite vector. This class describes a vector that contains one or more ...">MD_Vector_composite</a>, b.<a class="code" href="classDoubleVect.html#a0d16d30580c90526e4895388fb44be5d">get_md_vector</a>().<a class="code" href="classMD__Vector.html#a41324dfaa7a973091d0a8276908d10e2">valeur</a>()))
<a name="l02292"></a>02292     {
<a name="l02293"></a>02293       std::map&lt;std::string, std::vector&lt;int&gt;&gt; champ;
<a name="l02294"></a>02294 <span class="comment">// liste (MD_Vector_composite, offset de ses elements, multiplicateur (nb d&#39;items du tableau par item du MD_Vector) prefixe des noms de ses champs)</span>
<a name="l02295"></a>02295       std::vector&lt;std::tuple&lt;const MD_Vector_composite *, int, int, std::string&gt;&gt;
<a name="l02296"></a>02296                                                                                mdc_list =
<a name="l02297"></a>02297       {
<a name="l02298"></a>02298         std::make_tuple(&amp;<a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classMD__Vector__composite.html" title="Metadata for a distributed composite vector. This class describes a vector that contains one or more ...">MD_Vector_composite</a>, b.<a class="code" href="classDoubleVect.html#a0d16d30580c90526e4895388fb44be5d">get_md_vector</a>().<a class="code" href="classMD__Vector.html#a41324dfaa7a973091d0a8276908d10e2">valeur</a>()), 0, b.<a class="code" href="classDoubleVect.html#ab02d01cd1bdab66fbd66f9a47cc29e10">line_size</a>(),
<a name="l02299"></a>02299         std::string(<span class="stringliteral">&quot;b&quot;</span>))
<a name="l02300"></a>02300       };
<a name="l02301"></a>02301       <span class="keywordflow">while</span> (mdc_list.size()) <span class="comment">//remplissage recursif de champs_ -&gt; (nom du champ, indices)</span>
<a name="l02302"></a>02302         {
<a name="l02303"></a>02303           <span class="keyword">const</span> <a class="code" href="classMD__Vector__composite.html" title="Metadata for a distributed composite vector. This class describes a vector that contains one or more ...">MD_Vector_composite</a>&amp; mdc = *std::get&lt;0&gt;(mdc_list.back());
<a name="l02304"></a>02304           <span class="keywordtype">int</span> idx = std::get&lt;1&gt;(mdc_list.back()), mult = std::get&lt;2&gt;(mdc_list.back());
<a name="l02305"></a>02305           std::string prefix = std::get&lt;3&gt;(mdc_list.back());
<a name="l02306"></a>02306           mdc_list.pop_back();
<a name="l02307"></a>02307           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; mdc.<a class="code" href="classMD__Vector__composite.html#a6a021dd8750ee96af1d2d93873d13e41">nb_parts</a>(); i++)
<a name="l02308"></a>02308             {
<a name="l02309"></a>02309               <span class="keyword">const</span> <a class="code" href="classMD__Vector__base.html" title="Classe de base des descripteurs de vecteurs distribues. Voir la documentation des methodes dans MD_Ve...">MD_Vector_base</a>&amp; mdb = mdc.<a class="code" href="classMD__Vector__composite.html#a7f91380228a64040d0707dc485f86435">get_desc_part</a>(i).<a class="code" href="classMD__Vector.html#a41324dfaa7a973091d0a8276908d10e2">valeur</a>();
<a name="l02310"></a>02310               <span class="keywordtype">int</span> mult2 = mult * <a class="code" href="Double_8h.html#a1c45761573e6cbc97cfacac78d905016">max</a>(mdc.<a class="code" href="classMD__Vector__composite.html#ac16d35ec24ee9c445a5c42773025bfbe">get_shape</a>(i), 1), nb_seq = mdb.<a class="code" href="classMD__Vector__base.html#af69fca22ab9e37e4e2e72ac4a5143b90">nb_items_seq_local</a>() * mult2;
<a name="l02311"></a>02311               <span class="keywordflow">if</span> (<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMD__Vector__composite.html" title="Metadata for a distributed composite vector. This class describes a vector that contains one or more ...">MD_Vector_composite</a>, mdb)) <span class="comment">//un autre MD_Vector_Composite! on le met dans la liste</span>
<a name="l02312"></a>02312                 mdc_list.push_back(std::make_tuple(&amp;<a class="code" href="Cast_8h.html#ad116a7acb85c9c91e5687c44941a0d0c">ref_cast</a>(<a class="code" href="classMD__Vector__composite.html" title="Metadata for a distributed composite vector. This class describes a vector that contains one or more ...">MD_Vector_composite</a>, mdb), idx, mult2,
<a name="l02313"></a>02313                                                    prefix + std::to_string((<span class="keywordtype">long</span> <span class="keywordtype">long</span>) i)));
<a name="l02314"></a>02314               <span class="keywordflow">else</span>
<a name="l02315"></a>02315                 {
<a name="l02316"></a>02316                   std::vector&lt;int&gt; indices;
<a name="l02317"></a>02317                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; nb_seq; j++) indices.push_back(decalage_local_global_ + idx + j);
<a name="l02318"></a>02318                   champ[prefix + std::to_string((<span class="keywordtype">long</span> <span class="keywordtype">long</span>) i)] = indices;
<a name="l02319"></a>02319                 }
<a name="l02320"></a>02320               idx += nb_seq; <span class="comment">//mise a jour du decalage (idx)</span>
<a name="l02321"></a>02321             }
<a name="l02322"></a>02322         }
<a name="l02323"></a>02323 
<a name="l02324"></a>02324       <span class="comment">/* PetscSection : indique a quel champ appartient chaque variable */</span>
<a name="l02325"></a>02325       PetscSection sec;
<a name="l02326"></a>02326       PetscSectionCreate(PETSC_COMM_WORLD, &amp;sec);
<a name="l02327"></a>02327       PetscSectionSetNumFields(sec, champ.size());
<a name="l02328"></a>02328       PetscSectionSetChart(sec, decalage_local_global_,
<a name="l02329"></a>02329                            decalage_local_global_ + b.<a class="code" href="classDoubleVect.html#ab02d01cd1bdab66fbd66f9a47cc29e10">line_size</a>() * b.<a class="code" href="classDoubleVect.html#a0d16d30580c90526e4895388fb44be5d">get_md_vector</a>().<a class="code" href="classMD__Vector.html#a41324dfaa7a973091d0a8276908d10e2">valeur</a>().<a class="code" href="classMD__Vector__base.html#af69fca22ab9e37e4e2e72ac4a5143b90">nb_items_seq_local</a>());
<a name="l02330"></a>02330       <span class="keywordtype">int</span> idx = 0;
<a name="l02331"></a>02331       <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;&amp;kv : champ)
<a name="l02332"></a>02332         {
<a name="l02333"></a>02333           PetscSectionSetFieldName(sec, idx, kv.first.c_str());
<a name="l02334"></a>02334           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; (int) kv.second.size(); j++)
<a name="l02335"></a>02335             PetscSectionSetDof(sec, kv.second[j], 1), PetscSectionSetFieldDof(sec, kv.second[j], idx, 1);
<a name="l02336"></a>02336           idx++;
<a name="l02337"></a>02337         }
<a name="l02338"></a>02338       PetscSectionSetUp(sec);
<a name="l02339"></a>02339 
<a name="l02340"></a>02340       <span class="comment">/* DMShell : un objet encapsulant la section */</span>
<a name="l02341"></a>02341       DMShellCreate(PETSC_COMM_WORLD, &amp;dm_);
<a name="l02342"></a>02342       DMSetSection(dm_, sec);
<a name="l02343"></a>02343       DMSetUp(dm_);
<a name="l02344"></a>02344       PetscSectionDestroy(&amp;sec);
<a name="l02345"></a>02345     }
<a name="l02346"></a>02346   <span class="keywordflow">if</span> (<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMD__Vector__composite.html" title="Metadata for a distributed composite vector. This class describes a vector that contains one or more ...">MD_Vector_composite</a>, b.<a class="code" href="classDoubleVect.html#a0d16d30580c90526e4895388fb44be5d">get_md_vector</a>().<a class="code" href="classMD__Vector.html#a41324dfaa7a973091d0a8276908d10e2">valeur</a>())) PCSetDM(PreconditionneurPetsc_, dm_);
<a name="l02347"></a>02347 }
<a name="l02348"></a>02348 
<a name="l02349"></a>02349 <span class="keywordtype">int</span> Solv_Petsc::compute_nb_rows_petsc(<span class="keywordtype">int</span> nb_rows_tot)
<a name="l02350"></a>02350 {
<a name="l02351"></a>02351 <span class="comment">// Case the user specifies a number of CPUs:</span>
<a name="l02352"></a>02352   <span class="keywordtype">int</span> nb_rows_petsc = nb_rows_tot / petsc_nb_cpus_;
<a name="l02353"></a>02353 <span class="comment">// Process 0 takes the possible rows in excess:</span>
<a name="l02354"></a>02354   <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#acd052b99706c577f8a5b6656217cf4c2" title="renvoie 1 si on est sur le processeur maitre du groupe courant (c&#39;est a dire me() == 0)...">je_suis_maitre</a>()) nb_rows_petsc = nb_rows_tot - (petsc_nb_cpus_ - 1) * nb_rows_petsc;
<a name="l02355"></a>02355 <span class="comment">// </span>
<a name="l02356"></a>02356   <span class="keywordflow">if</span> (petsc_cpus_selection_==1)
<a name="l02357"></a>02357     {
<a name="l02358"></a>02358 <span class="comment">// First nb_cpus_ CPUs only so:</span>
<a name="l02359"></a>02359       <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#ab55ba07167ec807ed3a145cac0f5dca4" title="renvoie mon rang dans le groupe de communication courant. Voir Comm_Group::rank() et PE_Groups::curre...">Process::me</a>() &gt;= petsc_nb_cpus_) nb_rows_petsc = 0;
<a name="l02360"></a>02360     }
<a name="l02361"></a>02361   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (petsc_cpus_selection_==2)
<a name="l02362"></a>02362     {
<a name="l02363"></a>02363 <span class="comment">// Every nb_cpus CPUs only so:</span>
<a name="l02364"></a>02364       <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#ab55ba07167ec807ed3a145cac0f5dca4" title="renvoie mon rang dans le groupe de communication courant. Voir Comm_Group::rank() et PE_Groups::curre...">Process::me</a>() % petsc_nb_cpus_ != 0) nb_rows_petsc = 0;
<a name="l02365"></a>02365     }
<a name="l02366"></a>02366   <span class="keywordflow">else</span>
<a name="l02367"></a>02367     {
<a name="l02368"></a>02368       <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Error: petsc_cpus_selection_=&quot;</span> &lt;&lt; petsc_cpus_selection_ &lt;&lt; finl;
<a name="l02369"></a>02369       <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">exit</a>();
<a name="l02370"></a>02370     }
<a name="l02371"></a>02371   <span class="keywordflow">return</span> nb_rows_petsc;
<a name="l02372"></a>02372 }
<a name="l02373"></a>02373 
<a name="l02374"></a>02374 <span class="comment">// Creation d&#39;une matrice Petsc depuis une matrice Matrice_Morse</span>
<a name="l02375"></a>02375 <span class="keywordtype">void</span> Solv_Petsc::Create_MatricePetsc(Mat&amp; MatricePetsc, <span class="keywordtype">int</span> mataij, <span class="keyword">const</span> <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; mat_morse)
<a name="l02376"></a>02376 {
<a name="l02377"></a>02377   std::clock_t start = std::clock();
<a name="l02378"></a>02378 <span class="comment">// Recuperation des donnees</span>
<a name="l02379"></a>02379   <span class="keywordtype">bool</span> journal = nb_rows_tot_ &lt; 20 ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l02380"></a>02380   journal = <span class="keyword">false</span>;
<a name="l02381"></a>02381   assert(!<a class="code" href="Cast_8h.html#a9632e68536db6c29c2b754cb55381fbe">sub_type</a>(<a class="code" href="classMatrice__Morse__Sym.html" title="Classe Matrice_Morse_Sym Represente une matrice M (creuse) symetrique stockee au format Morse Symetri...">Matrice_Morse_Sym</a>, mat_morse));
<a name="l02382"></a>02382   <span class="keywordflow">if</span> (journal)   <span class="comment">//!&lt; Impressions provisoires</span>
<a name="l02383"></a>02383 <span class="comment"></span>    {
<a name="l02384"></a>02384       <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; <span class="stringliteral">&quot;mat=&quot;</span> &lt;&lt; finl;
<a name="l02385"></a>02385       mat_morse.<a class="code" href="classMatrice__Morse.html#a60c1de967d05b21b9b96a9bf6d73334e">imprimer_formatte</a>(<a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>());
<a name="l02386"></a>02386       <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; <span class="stringliteral">&quot;renum_=&quot;</span> &lt;&lt; finl;
<a name="l02387"></a>02387       renum_.ecrit(<a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>());
<a name="l02388"></a>02388       <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; <span class="stringliteral">&quot;items_to_keep_=&quot;</span> &lt;&lt; finl;
<a name="l02389"></a>02389       <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; items_to_keep_ &lt;&lt; finl;
<a name="l02390"></a>02390     }
<a name="l02391"></a>02391 
<a name="l02392"></a>02392 <span class="comment">//</span>
<a name="l02393"></a>02393 <span class="comment">// On cree et dimensionne la matrice</span>
<a name="l02394"></a>02394 <span class="comment">//</span>
<a name="l02395"></a>02395 <span class="comment">// Based on src/ksp/ksp/examples/tutorials/ex2.c</span>
<a name="l02396"></a>02396   MatCreate(PETSC_COMM_WORLD, &amp;MatricePetsc);
<a name="l02397"></a>02397   <span class="keywordflow">if</span> (petsc_decide_)
<a name="l02398"></a>02398     MatSetSizes(MatricePetsc, PETSC_DECIDE, PETSC_DECIDE, nb_rows_tot_, nb_rows_tot_);
<a name="l02399"></a>02399   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (petsc_cpus_selection_)
<a name="l02400"></a>02400     {
<a name="l02401"></a>02401       <span class="keywordtype">int</span> nb_rows_petsc = compute_nb_rows_petsc(nb_rows_tot_);
<a name="l02402"></a>02402       <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; <span class="stringliteral">&quot;Process &quot;</span> &lt;&lt; <a class="code" href="classProcess.html#ab55ba07167ec807ed3a145cac0f5dca4" title="renvoie mon rang dans le groupe de communication courant. Voir Comm_Group::rank() et PE_Groups::curre...">Process::me</a>() &lt;&lt; <span class="stringliteral">&quot; has &quot;</span> &lt;&lt; nb_rows_petsc &lt;&lt; <span class="stringliteral">&quot; rows of the matrix PETSc.&quot;</span> &lt;&lt; finl;
<a name="l02403"></a>02403       MatSetSizes(MatricePetsc, nb_rows_petsc, nb_rows_petsc, PETSC_DECIDE, PETSC_DECIDE);
<a name="l02404"></a>02404     }
<a name="l02405"></a>02405   <span class="keywordflow">else</span>     <span class="comment">//!&lt; Normal use: partition of PETSc matrix is dicted by TRUST matrix:</span>
<a name="l02406"></a>02406 <span class="comment"></span>    MatSetSizes(MatricePetsc, nb_rows_, nb_rows_, PETSC_DECIDE, PETSC_DECIDE);
<a name="l02407"></a>02407 
<a name="l02408"></a>02408 <span class="comment">//</span>
<a name="l02409"></a>02409 <span class="comment">// Determination du nombre d&#39;elements non nuls</span>
<a name="l02410"></a>02410 <span class="comment">//</span>
<a name="l02411"></a>02411   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a> nnz(nb_rows_);
<a name="l02412"></a>02412   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a> d_nnz(nb_rows_);
<a name="l02413"></a>02413   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a> o_nnz(nb_rows_);
<a name="l02414"></a>02414   nnz = 0;
<a name="l02415"></a>02415   d_nnz = 0;
<a name="l02416"></a>02416   o_nnz = 0;
<a name="l02417"></a>02417   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; renum_array = renum_;  <span class="comment">//!&lt; tableau vu comme lineaire</span>
<a name="l02418"></a>02418 <span class="comment"></span>  <span class="keywordtype">int</span> premiere_colonne_globale = decalage_local_global_;
<a name="l02419"></a>02419   <span class="keywordtype">int</span> derniere_colonne_globale = nb_rows_ + decalage_local_global_;
<a name="l02420"></a>02420   <span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; tab1 = mat_morse.<a class="code" href="classMatrice__Morse.html#a79b4e334152850bd36e53478debf3061">get_tab1</a>();
<a name="l02421"></a>02421   <span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; tab2 = mat_morse.<a class="code" href="classMatrice__Morse.html#a787b5a63f27063f9c891243d8f188cda">get_tab2</a>();
<a name="l02422"></a>02422 <span class="comment">// const ArrOfDouble&amp; coeff = mat_morse.get_coeff();</span>
<a name="l02423"></a>02423   <span class="keywordtype">int</span> cpt = 0;
<a name="l02424"></a>02424   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; tab1.<a class="code" href="classArrOfInt.html#a0f41611fce0a58c3ef3409dc1af8904d" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>() - 1; i++)
<a name="l02425"></a>02425     {
<a name="l02426"></a>02426       <span class="keywordflow">if</span> (items_to_keep_[i])
<a name="l02427"></a>02427         {
<a name="l02428"></a>02428           nnz(cpt) = tab1(i + 1) - tab1(i); <span class="comment">//!&lt; Nombre d&#39;elements non nuls sur la ligne i</span>
<a name="l02429"></a>02429 <span class="comment"></span>          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = tab1(i) - 1; k &lt; tab1(i + 1) - 1; k++)
<a name="l02430"></a>02430             {
<a name="l02431"></a>02431               <span class="keywordtype">int</span> colonne_locale = tab2(k) - 1;
<a name="l02432"></a>02432               <span class="keywordtype">int</span> colonne_globale = renum_array[colonne_locale];
<a name="l02433"></a>02433               <span class="keywordflow">if</span> (colonne_globale &gt;= premiere_colonne_globale &amp;&amp; colonne_globale &lt; derniere_colonne_globale)
<a name="l02434"></a>02434                 d_nnz(cpt)++;
<a name="l02435"></a>02435               <span class="keywordflow">else</span>
<a name="l02436"></a>02436                 o_nnz(cpt)++;
<a name="l02437"></a>02437             }
<a name="l02438"></a>02438           cpt++;
<a name="l02439"></a>02439         }
<a name="l02440"></a>02440     }
<a name="l02441"></a>02441 
<a name="l02442"></a>02442   <span class="keywordflow">if</span> (journal)
<a name="l02443"></a>02443     {
<a name="l02444"></a>02444       <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; <span class="stringliteral">&quot;nnz=&quot;</span> &lt;&lt; nnz &lt;&lt; finl;
<a name="l02445"></a>02445       <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; <span class="stringliteral">&quot;d_nnz=&quot;</span> &lt;&lt; d_nnz &lt;&lt; finl;
<a name="l02446"></a>02446       <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; <span class="stringliteral">&quot;o_nnz=&quot;</span> &lt;&lt; o_nnz &lt;&lt; finl;
<a name="l02447"></a>02447     }
<a name="l02448"></a>02448   <span class="comment">/************************/</span>
<a name="l02449"></a>02449   <span class="comment">/* Typage de la matrice */</span>
<a name="l02450"></a>02450   <span class="comment">/************************/</span>
<a name="l02451"></a>02451   <span class="keywordflow">if</span> (mataij == 0)
<a name="l02452"></a>02452     {
<a name="l02453"></a>02453 <span class="comment">// On utilise SBAIJ pour une matrice symetrique (plus rapide que AIJ)</span>
<a name="l02454"></a>02454       MatSetType(MatricePetsc, (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>() == 1 ? MATSEQSBAIJ : MATMPISBAIJ));
<a name="l02455"></a>02455     }
<a name="l02456"></a>02456   <span class="keywordflow">else</span>
<a name="l02457"></a>02457     {
<a name="l02458"></a>02458 <span class="comment">// On utilise AIJ car je n&#39;arrive pas a faire marcher avec BAIJ</span>
<a name="l02459"></a>02459 <span class="preprocessor">#ifdef PETSC_HAVE_CUDA</span>
<a name="l02460"></a>02460 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a5f603c229087d42c8bb2fee48290526f" title="Utilisation des solveurs GPU de PETSc.">gpu_</a>)
<a name="l02461"></a>02461         MatSetType(MatricePetsc, (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()==1?MATSEQAIJCUSPARSE:MATMPIAIJCUSPARSE));
<a name="l02462"></a>02462       <span class="keywordflow">else</span>
<a name="l02463"></a>02463 <span class="preprocessor">#endif</span>
<a name="l02464"></a>02464 <span class="preprocessor"></span>        MatSetType(MatricePetsc, (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>() == 1 ? MATSEQAIJ : MATMPIAIJ));
<a name="l02465"></a>02465     }
<a name="l02466"></a>02466 <span class="comment">// Surcharge eventuelle par ligne de commande avec -mat_type:</span>
<a name="l02467"></a>02467 <span class="comment">// Example: now possible to change aijcusparse to aijviennacl via CLI</span>
<a name="l02468"></a>02468   MatSetOptionsPrefix(MatricePetsc, option_prefix_);
<a name="l02469"></a>02469   MatSetFromOptions(MatricePetsc);
<a name="l02470"></a>02470 
<a name="l02471"></a>02471   <span class="comment">/********************************************/</span>
<a name="l02472"></a>02472   <span class="comment">/* Preallocation de la taille de la matrice */</span>
<a name="l02473"></a>02473   <span class="comment">/********************************************/</span>
<a name="l02474"></a>02474 <span class="comment">// TRES important pour la vitesse de construction de la matrice</span>
<a name="l02475"></a>02475   <span class="keywordflow">if</span> (mataij == 0)
<a name="l02476"></a>02476     {
<a name="l02477"></a>02477       <span class="keywordflow">if</span> (different_partition_)
<a name="l02478"></a>02478         {
<a name="l02479"></a>02479 <span class="comment">// If partition of TRUST and PETSc differs, difficult to preallocate the matrix finely so:</span>
<a name="l02480"></a>02480 <span class="comment">// ToDo, try to optimize:</span>
<a name="l02481"></a>02481           <span class="keywordtype">int</span> nz = (int) <a class="code" href="classProcess.html#a1e9d9f9899b71927cfafae14c7bd048d" title="Calcule le max de x sur tous les processeurs du groupe courant. Remarques : Cette methode doit etre a...">mp_max</a>((nnz.size_array() == 0 ? 0 : <a class="code" href="ArrOfDouble_8cpp.html#a95241fccf4bed7fb7a4e2340b7735f14" title="Retourne la valeur maximale.">max_array</a>(nnz)));
<a name="l02482"></a>02482           MatSeqSBAIJSetPreallocation(MatricePetsc, block_size_, nz, PETSC_NULL);
<a name="l02483"></a>02483           MatMPISBAIJSetPreallocation(MatricePetsc, block_size_, nz, PETSC_NULL, nz, PETSC_NULL);
<a name="l02484"></a>02484         }
<a name="l02485"></a>02485       <span class="keywordflow">else</span>
<a name="l02486"></a>02486         {
<a name="l02487"></a>02487           MatSeqSBAIJSetPreallocation(MatricePetsc, block_size_, PETSC_DEFAULT, nnz.addr());
<a name="l02488"></a>02488 <span class="comment">// Test on nb_rows==0 is to avoid PAR_docond_anisoproc hangs</span>
<a name="l02489"></a>02489           MatMPISBAIJSetPreallocation(MatricePetsc, block_size_, (nb_rows_ == 0 ? 0 : PETSC_DEFAULT), d_nnz.addr(),
<a name="l02490"></a>02490                                       (nb_rows_ == 0 ? 0 : PETSC_DEFAULT), o_nnz.addr());
<a name="l02491"></a>02491         }
<a name="l02492"></a>02492     }
<a name="l02493"></a>02493   <span class="keywordflow">else</span>
<a name="l02494"></a>02494     {
<a name="l02495"></a>02495       <span class="keywordflow">if</span> (different_partition_)
<a name="l02496"></a>02496         {
<a name="l02497"></a>02497 <span class="comment">// If partition of TRUST and PETSc differs, difficult to preallocate the matrix finely so:</span>
<a name="l02498"></a>02498 <span class="comment">// ToDo, try to optimize:</span>
<a name="l02499"></a>02499           <span class="keywordtype">int</span> nz = (int) <a class="code" href="classProcess.html#a1e9d9f9899b71927cfafae14c7bd048d" title="Calcule le max de x sur tous les processeurs du groupe courant. Remarques : Cette methode doit etre a...">mp_max</a>((nnz.size_array() == 0 ? 0 : <a class="code" href="ArrOfDouble_8cpp.html#a95241fccf4bed7fb7a4e2340b7735f14" title="Retourne la valeur maximale.">max_array</a>(nnz)));
<a name="l02500"></a>02500           MatSeqAIJSetPreallocation(MatricePetsc, nz, PETSC_NULL);
<a name="l02501"></a>02501           MatMPIAIJSetPreallocation(MatricePetsc, nz, PETSC_NULL, nz, PETSC_NULL);
<a name="l02502"></a>02502         }
<a name="l02503"></a>02503       <span class="keywordflow">else</span>
<a name="l02504"></a>02504         {
<a name="l02505"></a>02505           MatSeqAIJSetPreallocation(MatricePetsc, PETSC_DEFAULT, nnz.addr());
<a name="l02506"></a>02506 <span class="comment">// Test on nb_rows==0 is to avoid PAR_docond_anisoproc hangs</span>
<a name="l02507"></a>02507           MatMPIAIJSetPreallocation(MatricePetsc, (nb_rows_ == 0 ? 0 : PETSC_DEFAULT), d_nnz.addr(),
<a name="l02508"></a>02508                                     (nb_rows_ == 0 ? 0 : PETSC_DEFAULT), o_nnz.addr());
<a name="l02509"></a>02509         }
<a name="l02510"></a>02510     }
<a name="l02511"></a>02511 
<a name="l02512"></a>02512 <span class="comment">// ToDo: nettoyer la matrice TRUST en amont... Car le nnz des matrices peut varier (ex: implicite, Hyd_Cx_impl ou PolyMAC)</span>
<a name="l02513"></a>02513 <span class="comment">// et si on supprime les zeros de la matrice, lors d&#39;un update on peut avoir une allocation -&gt; erreur</span>
<a name="l02514"></a>02514   <span class="keywordflow">if</span> (mataij_)
<a name="l02515"></a>02515     {
<a name="l02516"></a>02516       <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#af13cee34da6194e79945d3a950ee2ed0">clean_matrix_</a>) MatSetOption(MatricePetsc, MAT_IGNORE_ZERO_ENTRIES, PETSC_TRUE); <span class="comment">//!&lt; Ne stocke pas les zeros</span>
<a name="l02517"></a>02517 <span class="comment"></span>      <span class="keywordflow">if</span> (verbose)
<a name="l02518"></a>02518         {
<a name="l02519"></a>02519           <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a> nonzeros(2); <span class="comment">//!&lt; Pas ArrOfInt car nonzeros peut depasser 2^32 facilement</span>
<a name="l02520"></a>02520 <span class="comment"></span>          nonzeros(0) = 0;
<a name="l02521"></a>02521           nonzeros(1) = mat_morse.<a class="code" href="classMatrice__Morse.html#afb2d730697791b429d020575ae3388d0">nb_coeff</a>();
<a name="l02522"></a>02522           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nonzeros(1); i++)
<a name="l02523"></a>02523             <span class="keywordflow">if</span> (mat_morse.<a class="code" href="classMatrice__Morse.html#aacb80dd518dcc0812e3b34edac6ab67e">get_coeff</a>()(i)!=0)
<a name="l02524"></a>02524               nonzeros(0)+=1;
<a name="l02525"></a>02525           <a class="code" href="communications_8cpp.html#a5f15b8a5c15449d3277ff3cde06fa68a">mp_sum_for_each_item</a>(nonzeros);
<a name="l02526"></a>02526           <span class="keywordflow">if</span> (nonzeros[1] &gt; 0)
<a name="l02527"></a>02527             {
<a name="l02528"></a>02528               <span class="keywordtype">double</span> ratio = 1 - (double) nonzeros(0) / (double) nonzeros(1);
<a name="l02529"></a>02529               <span class="keywordflow">if</span> (ratio &gt; 0.2) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;Warning! Trust matrix contains a lot of useless stored zeros: &quot;</span> &lt;&lt; (int) (ratio * 100) &lt;&lt; <span class="stringliteral">&quot;% (&quot;</span> &lt;&lt; nonzeros[0] &lt;&lt; <span class="stringliteral">&quot;/&quot;</span> &lt;&lt; nonzeros[1] &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; finl;
<a name="l02530"></a>02530             }
<a name="l02531"></a>02531           <span class="keywordtype">int</span> zero_discarded = nonzeros[1] - nonzeros[0];
<a name="l02532"></a>02532           <span class="keywordflow">if</span> (zero_discarded) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;[Petsc] Discarding &quot;</span> &lt;&lt; zero_discarded &lt;&lt; <span class="stringliteral">&quot; zeros from TRUST matrix into the PETSc matrix ...&quot;</span> &lt;&lt; finl;
<a name="l02533"></a>02533         }
<a name="l02534"></a>02534     }
<a name="l02535"></a>02535 <span class="comment">// Genere une erreur (ou pas) si une case de la matrice est remplie sans allocation auparavant:</span>
<a name="l02536"></a>02536   MatSetOption(MatricePetsc, MAT_NEW_NONZERO_ALLOCATION_ERR, <a class="code" href="classSolv__Petsc.html#a45df7a11f976ea94cbb622ae8fcbd181">allow_realloc_</a> ? PETSC_FALSE : PETSC_TRUE);
<a name="l02537"></a>02537 
<a name="l02538"></a>02538 <span class="comment">// Hash table (Faster MatAssembly after the first one)</span>
<a name="l02539"></a>02539   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a1d87d8f7f3be6d318bc343e11059cde2">ignore_new_nonzero_</a>)
<a name="l02540"></a>02540     MatSetOption(MatricePetsc, MAT_USE_HASH_TABLE, PETSC_TRUE);
<a name="l02541"></a>02541 
<a name="l02542"></a>02542   <span class="keywordflow">if</span> (verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;[Petsc] Time to create the matrix: &quot;</span> &lt;&lt; (std::clock() - start) / (<span class="keywordtype">double</span>) CLOCKS_PER_SEC &lt;&lt; finl;
<a name="l02543"></a>02543 
<a name="l02544"></a>02544 <span class="comment">// Fill the matrix</span>
<a name="l02545"></a>02545   <a class="code" href="classSolv__Petsc.html">Solv_Petsc</a>::Update_matrix(MatricePetsc, mat_morse);
<a name="l02546"></a>02546 }
<a name="l02547"></a>02547 
<a name="l02548"></a>02548 <span class="keywordtype">void</span> <a class="code" href="classSolv__Petsc.html">Solv_Petsc</a>::Update_matrix(Mat&amp; MatricePetsc, const <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; mat_morse)
<a name="l02549"></a>02549 {
<a name="l02550"></a>02550   std::clock_t start = std::clock();
<a name="l02551"></a>02551   <span class="keywordtype">bool</span> journal = nb_rows_tot_ &lt; 20 ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l02552"></a>02552   journal = <span class="keyword">false</span>;
<a name="l02553"></a>02553 
<a name="l02554"></a>02554   <span class="comment">/*****************************/</span>
<a name="l02555"></a>02555   <span class="comment">/* Remplissage de la matrice */</span>
<a name="l02556"></a>02556   <span class="comment">/*****************************/</span>
<a name="l02557"></a>02557 <span class="comment">// ligne par ligne avec un tableau coeff et tab2 qui contiennent</span>
<a name="l02558"></a>02558 <span class="comment">// les coefficients et les colonnes globales pour chaque ligne</span>
<a name="l02559"></a>02559 <span class="comment">// On dimensionne ces tableaux a la taille la plus grande possible</span>
<a name="l02560"></a>02560 <span class="comment">// ToDo : recalcul de nnz utile ?</span>
<a name="l02561"></a>02561   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a> nnz(nb_rows_);
<a name="l02562"></a>02562   nnz = 0;
<a name="l02563"></a>02563   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; renum_array = renum_;  <span class="comment">//!&lt; tableau vu comme lineaire</span>
<a name="l02564"></a>02564 <span class="comment"></span>  <span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; tab1 = mat_morse.get_tab1();
<a name="l02565"></a>02565   <span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; tab2 = mat_morse.get_tab2();
<a name="l02566"></a>02566   <span class="keywordtype">int</span> cpt = 0;
<a name="l02567"></a>02567   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; tab1.<a class="code" href="classArrOfInt.html#a0f41611fce0a58c3ef3409dc1af8904d" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>() - 1; i++)
<a name="l02568"></a>02568     <span class="keywordflow">if</span> (items_to_keep_[i])
<a name="l02569"></a>02569       {
<a name="l02570"></a>02570         nnz(cpt) = tab1(i + 1) - tab1(i); <span class="comment">//!&lt; Nombre d&#39;elements non nuls sur la ligne i</span>
<a name="l02571"></a>02571 <span class="comment"></span>        cpt++;
<a name="l02572"></a>02572       }
<a name="l02573"></a>02573   <span class="keywordtype">int</span> size = (nb_rows_ == 0 ? 0 : <a class="code" href="ArrOfDouble_8cpp.html#a95241fccf4bed7fb7a4e2340b7735f14" title="Retourne la valeur maximale.">max_array</a>(nnz)); <span class="comment">//!&lt; Test sur nb_rows si nul (cas proc vide) car sinon max_array plante</span>
<a name="l02574"></a>02574 <span class="comment"></span>  <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a> coeff_(size);
<a name="l02575"></a>02575   <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a> tab2_(size);
<a name="l02576"></a>02576   <span class="keyword">const</span> <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a>&amp; <a class="code" href="Champ__P1iP1B__implementation_8cpp.html#aa8c8f49390c3cf7c702d71a71bc977e3">coeff</a> = mat_morse.get_coeff();
<a name="l02577"></a>02577   cpt = 0;
<a name="l02578"></a>02578   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;tab1.<a class="code" href="classArrOfInt.html#a0f41611fce0a58c3ef3409dc1af8904d" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>() - 1; i++)
<a name="l02579"></a>02579     {
<a name="l02580"></a>02580       <span class="keywordflow">if</span> (items_to_keep_[i])
<a name="l02581"></a>02581         {
<a name="l02582"></a>02582           <span class="keywordtype">int</span> ligne_globale = cpt + decalage_local_global_;
<a name="l02583"></a>02583           <span class="keywordtype">int</span> ncol = 0;
<a name="l02584"></a>02584           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = tab1(i) - 1; k &lt; tab1(i + 1) - 1; k++)
<a name="l02585"></a>02585             {
<a name="l02586"></a>02586               coeff_[ncol] = <a class="code" href="Champ__P1iP1B__implementation_8cpp.html#aa8c8f49390c3cf7c702d71a71bc977e3">coeff</a>(k);
<a name="l02587"></a>02587               tab2_[ncol] = renum_array[tab2(k) - 1];
<a name="l02588"></a>02588               ncol++;
<a name="l02589"></a>02589             }
<a name="l02590"></a>02590           assert(ncol == nnz(cpt));
<a name="l02591"></a>02591           <span class="keywordflow">if</span> (journal)
<a name="l02592"></a>02592             {
<a name="l02593"></a>02593               <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; ligne_globale &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l02594"></a>02594               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; ncol; j++) <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; coeff_[j] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l02595"></a>02595               <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; finl;
<a name="l02596"></a>02596             }
<a name="l02597"></a>02597           <span class="keywordflow">try</span>
<a name="l02598"></a>02598             {
<a name="l02599"></a>02599               MatSetValues(MatricePetsc, 1, &amp;ligne_globale, ncol, tab2_.addr(), coeff_.addr(), INSERT_VALUES);
<a name="l02600"></a>02600             }
<a name="l02601"></a>02601           <span class="keywordflow">catch</span>(...)
<a name="l02602"></a>02602             {
<a name="l02603"></a>02603               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;We detect that the PETSc matrix coefficients are changed without pre-allocation.&quot;</span> &lt;&lt; finl;
<a name="l02604"></a>02604               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Try one of the following option:&quot;</span> &lt;&lt; finl;
<a name="l02605"></a>02605               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;- Rebuild the matrix each time instead of updating the coefficients (slower).&quot;</span> &lt;&lt; finl;
<a name="l02606"></a>02606               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;enable_allocation : Enable re-allocation of coefficients (slow).&quot;</span> &lt;&lt; finl;
<a name="l02607"></a>02607               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;- Discard new coefficients (risk!)&quot;</span> &lt;&lt; finl;
<a name="l02608"></a>02608               <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Try the two options and select the costly one.&quot;</span> &lt;&lt; finl;
<a name="l02609"></a>02609               <a class="code" href="classProcess.html#acc2fbbe761e08e5870ae605c0705491c" title="Routine de sortie de Trio-U sur une erreur Sauvegarde la memoire et le hierarchie dans les fichiers &quot;...">Process::exit</a>();
<a name="l02610"></a>02610             }
<a name="l02611"></a>02611           cpt++;
<a name="l02612"></a>02612         }
<a name="l02613"></a>02613     }
<a name="l02614"></a>02614 
<a name="l02615"></a>02615   <span class="comment">/****************************/</span>
<a name="l02616"></a>02616   <span class="comment">/* Assemblage de la matrice */</span>
<a name="l02617"></a>02617   <span class="comment">/****************************/</span>
<a name="l02618"></a>02618   MatAssemblyBegin(MatricePetsc, MAT_FINAL_ASSEMBLY);
<a name="l02619"></a>02619   MatAssemblyEnd(MatricePetsc, MAT_FINAL_ASSEMBLY);
<a name="l02620"></a>02620 
<a name="l02621"></a>02621 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l02622"></a>02622 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (mataij_)
<a name="l02623"></a>02623     {
<a name="l02624"></a>02624 <span class="comment">// Verifie la non symetrie de la matrice (au moins une fois)</span>
<a name="l02625"></a>02625       PetscBool IsSymmetric;
<a name="l02626"></a>02626       MatIsSymmetric(MatricePetsc, 0.0, &amp;IsSymmetric);
<a name="l02627"></a>02627       <span class="keywordflow">if</span> (IsSymmetric) <a class="code" href="EntreeSortie_8h.html#a5ebb6b5243d6167369bddecb78d0b5b8">Cerr</a> &lt;&lt; <span class="stringliteral">&quot;Warning: The PETSc matrix is aij but is symmetric. May be use sbaij ?&quot;</span> &lt;&lt; finl;
<a name="l02628"></a>02628     }
<a name="l02629"></a>02629 <span class="preprocessor">#endif</span>
<a name="l02630"></a>02630 <span class="preprocessor"></span><span class="comment">// Ignore les coefficients ajoutes:</span>
<a name="l02631"></a>02631   <span class="keywordflow">if</span> (!nouveau_stencil_ &amp;&amp; <a class="code" href="classSolv__Petsc.html#a1d87d8f7f3be6d318bc343e11059cde2">ignore_new_nonzero_</a>)
<a name="l02632"></a>02632     MatSetOption(MatricePetsc, MAT_NEW_NONZERO_LOCATIONS, PETSC_FALSE);
<a name="l02633"></a>02633 
<a name="l02634"></a>02634   <span class="comment">/*</span>
<a name="l02635"></a>02635 <span class="comment">  if (limpr()==1)</span>
<a name="l02636"></a>02636 <span class="comment">    {</span>
<a name="l02637"></a>02637 <span class="comment">      MatInfo info;</span>
<a name="l02638"></a>02638 <span class="comment">      MatGetInfo(MatricePetsc,MAT_GLOBAL_MAX,&amp;info);</span>
<a name="l02639"></a>02639 <span class="comment">      Cerr &lt;&lt; &quot;Max memory used by matrix on a MPI rank: &quot; &lt;&lt; (int)(info.memory/1024/1024) &lt;&lt; &quot; MB&quot; &lt;&lt; finl;</span>
<a name="l02640"></a>02640 <span class="comment">// Recuperation de la memoire max</span>
<a name="l02641"></a>02641 <span class="comment">    }*/</span>
<a name="l02642"></a>02642   <span class="keywordflow">if</span> (verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;[Petsc] Time to fill the matrix: &quot;</span> &lt;&lt; (std::clock() - start) / (<span class="keywordtype">double</span>) CLOCKS_PER_SEC &lt;&lt; finl;
<a name="l02643"></a>02643 }
<a name="l02644"></a>02644 
<a name="l02645"></a>02645 <span class="keywordtype">bool</span> <a class="code" href="classSolv__Petsc.html">Solv_Petsc</a>::check_stencil(const <a class="code" href="classMatrice__Morse.html" title="Classe Matrice_Morse Represente une matrice M (creuse), non necessairement carree stockee au format M...">Matrice_Morse</a>&amp; mat_morse)
<a name="l02646"></a>02646 {
<a name="l02647"></a>02647 <span class="comment">// Est ce un nouveau stencil ?</span>
<a name="l02648"></a>02648   std::clock_t start = std::clock();
<a name="l02649"></a>02649   <span class="keywordtype">int</span> new_stencil=0;
<a name="l02650"></a>02650   <span class="keywordflow">if</span> (<a class="code" href="classSolv__Petsc.html#a895816a337ad6bc6fcdfb82037e6a837">rebuild_matrix_</a> || <a class="code" href="classSolv__Petsc.html#a9c92c7b3025ccb3f301489141a442211" title="Read constant matrix in a file.">read_matrix_</a> || !mataij_)
<a name="l02651"></a>02651     new_stencil = 1;
<a name="l02652"></a>02652   <span class="keywordflow">else</span>
<a name="l02653"></a>02653     {
<a name="l02654"></a>02654       PetscBool done;
<a name="l02655"></a>02655       Mat localA;
<a name="l02656"></a>02656       PetscInt nRowsLocal;
<a name="l02657"></a>02657       <span class="keyword">const</span> PetscInt *colIndices = <span class="keyword">nullptr</span>, *rowOffsets = <span class="keyword">nullptr</span>;
<a name="l02658"></a>02658       <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()==1) <span class="comment">//!&lt; sequential AIJ</span>
<a name="l02659"></a>02659 <span class="comment"></span>        {
<a name="l02660"></a>02660 <span class="comment">// Make localA point to the same memory space as A does</span>
<a name="l02661"></a>02661           localA = MatricePetsc_;
<a name="l02662"></a>02662         }
<a name="l02663"></a>02663       <span class="keywordflow">else</span>
<a name="l02664"></a>02664         {
<a name="l02665"></a>02665 <span class="comment">// Get local matrix from redistributed matrix</span>
<a name="l02666"></a>02666           MatMPIAIJGetLocalMat(MatricePetsc_, MAT_INITIAL_MATRIX, &amp;localA);
<a name="l02667"></a>02667         }
<a name="l02668"></a>02668       MatGetRowIJ(localA, 0, PETSC_FALSE, PETSC_FALSE, &amp;nRowsLocal, &amp;rowOffsets, &amp;colIndices, &amp;done);
<a name="l02669"></a>02669 
<a name="l02670"></a>02670       <span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; tab1 = mat_morse.get_tab1();
<a name="l02671"></a>02671       <span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; tab2 = mat_morse.get_tab2();
<a name="l02672"></a>02672       <span class="keyword">const</span> <a class="code" href="classArrOfDouble.html" title="Represente un tableau d&#39;elements de type double. L&#39;etat du tableau est caracterise par la valeur de p...">ArrOfDouble</a>&amp; coeff = mat_morse.get_coeff();
<a name="l02673"></a>02673       <span class="keyword">const</span> <a class="code" href="classArrOfInt.html" title="Represente un tableau d&#39;elements de type int. L&#39;etat du tableau est caracterise par la valeur de p_ e...">ArrOfInt</a>&amp; renum_array = renum_;
<a name="l02674"></a>02674       <span class="keywordtype">int</span> RowLocal = 0;
<a name="l02675"></a>02675       <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; <span class="stringliteral">&quot;Provisoire: nb_rows_=&quot;</span> &lt;&lt; nb_rows_ &lt;&lt; <span class="stringliteral">&quot; nb_rows_tot_=&quot;</span> &lt;&lt; nb_rows_tot_ &lt;&lt; finl;
<a name="l02676"></a>02676       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; tab1.<a class="code" href="classArrOfInt.html#a0f41611fce0a58c3ef3409dc1af8904d" title="Renvoie la taille du tableau (nombre d&#39;elements declares a la construction ou a resize_array()). C&#39;est le nombre d&#39;elements accessibles a operator[].">size_array</a>() - 1; i++)
<a name="l02677"></a>02677         {
<a name="l02678"></a>02678           <span class="keywordflow">if</span> (items_to_keep_[i])
<a name="l02679"></a>02679             {
<a name="l02680"></a>02680               <span class="keywordtype">int</span> nnz_row = 0;
<a name="l02681"></a>02681               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = tab1(i) - 1; k &lt; tab1(i + 1) - 1; k++)
<a name="l02682"></a>02682                 <span class="keywordflow">if</span> (<a class="code" href="Champ__P1iP1B__implementation_8cpp.html#aa8c8f49390c3cf7c702d71a71bc977e3">coeff</a>(k) != 0) nnz_row++;
<a name="l02683"></a>02683               <span class="keywordflow">if</span> (nnz_row != rowOffsets[RowLocal + 1] - rowOffsets[RowLocal])
<a name="l02684"></a>02684                 {
<a name="l02685"></a>02685                   <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; <span class="stringliteral">&quot;Provisoire: Number of non-zero will change from &quot;</span> &lt;&lt; rowOffsets[RowLocal + 1] - rowOffsets[RowLocal] &lt;&lt; <span class="stringliteral">&quot; to &quot;</span> &lt;&lt; nnz_row &lt;&lt; <span class="stringliteral">&quot; on row &quot;</span> &lt;&lt; RowLocal &lt;&lt; finl;
<a name="l02686"></a>02686                   new_stencil = 1;
<a name="l02687"></a>02687                   <span class="keywordflow">break</span>;
<a name="l02688"></a>02688                 }
<a name="l02689"></a>02689               <span class="keywordflow">else</span>
<a name="l02690"></a>02690                 {
<a name="l02691"></a>02691                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = tab1(i) - 1; k &lt; tab1(i + 1) - 1; k++)
<a name="l02692"></a>02692                     {
<a name="l02693"></a>02693                       <span class="keywordflow">if</span> (<a class="code" href="Champ__P1iP1B__implementation_8cpp.html#aa8c8f49390c3cf7c702d71a71bc977e3">coeff</a>(k) != 0)
<a name="l02694"></a>02694                         {
<a name="l02695"></a>02695                           <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
<a name="l02696"></a>02696                           <span class="keywordtype">int</span> col = renum_array[tab2(k) - 1];
<a name="l02697"></a>02697 <span class="comment">// Boucle pour voir si le coeff est sur le GPU:</span>
<a name="l02698"></a>02698                           <span class="keywordtype">int</span> RowGlobal = decalage_local_global_+RowLocal;
<a name="l02699"></a>02699                           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kk = rowOffsets[RowLocal]; kk &lt; rowOffsets[RowLocal + 1]; kk++)
<a name="l02700"></a>02700                             {
<a name="l02701"></a>02701                               <span class="keywordflow">if</span> (colIndices[kk] == col)
<a name="l02702"></a>02702                                 {
<a name="l02703"></a>02703 <span class="comment">// values[kk] = coeff(k); // On met a jour le coefficient</span>
<a name="l02704"></a>02704                                   found = <span class="keyword">true</span>;
<a name="l02705"></a>02705                                   <span class="keywordflow">break</span>;
<a name="l02706"></a>02706                                 }
<a name="l02707"></a>02707                             }
<a name="l02708"></a>02708                           <span class="keywordflow">if</span> (!found)
<a name="l02709"></a>02709                             {
<a name="l02710"></a>02710                               <a class="code" href="classProcess.html#a57e0f54b11e6eaadbea224fa904b18dd" title="Renvoie un objet statique de type Sortie qui sert de journal d&#39;evenements. Si message_level &lt;= verbose...">Journal</a>() &lt;&lt; <span class="stringliteral">&quot;Provisoire: mat_morse(&quot;</span> &lt;&lt; RowGlobal &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; col &lt;&lt; <span class="stringliteral">&quot;)!=0 new &quot;</span> &lt;&lt; finl;
<a name="l02711"></a>02711                               new_stencil = 1;
<a name="l02712"></a>02712                               <span class="keywordflow">break</span>;
<a name="l02713"></a>02713                             }
<a name="l02714"></a>02714                         }
<a name="l02715"></a>02715                     }
<a name="l02716"></a>02716                 }
<a name="l02717"></a>02717               RowLocal++;
<a name="l02718"></a>02718             }
<a name="l02719"></a>02719         }
<a name="l02720"></a>02720       <span class="keywordflow">if</span> (<a class="code" href="classProcess.html#a6bf692ce58d9578aa62ac3c07b8caaa1" title="renvoie le nombre de processeurs dans le groupe courant Voir Comm_Group::nproc() et PE_Groups::curren...">Process::nproc</a>()&gt;1) MatDestroy(&amp;localA);
<a name="l02721"></a>02721       new_stencil = <a class="code" href="classProcess.html#a1e9d9f9899b71927cfafae14c7bd048d" title="Calcule le max de x sur tous les processeurs du groupe courant. Remarques : Cette methode doit etre a...">mp_max</a>(new_stencil);
<a name="l02722"></a>02722     }
<a name="l02723"></a>02723   <span class="keywordflow">if</span> (verbose) <a class="code" href="EntreeSortie_8h.html#a1007c2f57f1c8fc7334a3f62aab08414">Cout</a> &lt;&lt; <span class="stringliteral">&quot;[Petsc] Time to check stencil: &quot;</span> &lt;&lt; (std::clock() - start) / (<span class="keywordtype">double</span>) CLOCKS_PER_SEC &lt;&lt; finl;
<a name="l02724"></a>02724   return new_stencil;
<a name="l02725"></a>02725 }
<a name="l02726"></a>02726 <span class="preprocessor">#endif</span>
<a name="l02727"></a>02727 <span class="preprocessor"></span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Dec 14 2021 19:35:23 for TRUST by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
